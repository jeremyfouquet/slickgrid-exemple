import { booleanFilterCondition } from './booleanFilterCondition';
import { collectionSearchFilterCondition } from './collectionSearchFilterCondition';
import { numberFilterCondition } from './numberFilterCondition';
import { objectFilterCondition } from './objectFilterCondition';
import { stringFilterCondition } from './stringFilterCondition';
import { FieldType, OperatorType } from '../models/index';
import { mapMomentDateFormatWithFieldType } from './../services/utilities';
import { testFilterCondition } from './filterUtilities';
import * as moment_ from 'moment-mini';
const moment = moment_; // patch to fix rollup "moment has no default export" issue, document here https://github.com/rollup/rollup/issues/670
export const executeMappedCondition = (options) => {
    // when using a multi-select ('IN' operator) we will not use the field type but instead go directly with a collection search
    const operator = options && options.operator && options.operator.toUpperCase();
    if (operator === 'IN' || operator === 'NIN' || operator === 'IN_CONTAINS' || operator === 'NIN_CONTAINS') {
        return collectionSearchFilterCondition(options);
    }
    // execute the mapped type, or default to String condition check
    switch (options.fieldType) {
        case FieldType.boolean:
            return booleanFilterCondition(options);
        case FieldType.date:
        case FieldType.dateIso:
        case FieldType.dateUtc:
        case FieldType.dateTime:
        case FieldType.dateTimeIso:
        case FieldType.dateTimeIsoAmPm:
        case FieldType.dateTimeIsoAM_PM:
        case FieldType.dateTimeShortIso:
        case FieldType.dateEuro:
        case FieldType.dateEuroShort:
        case FieldType.dateTimeShortEuro:
        case FieldType.dateTimeEuro:
        case FieldType.dateTimeEuroAmPm:
        case FieldType.dateTimeEuroAM_PM:
        case FieldType.dateTimeEuroShort:
        case FieldType.dateTimeEuroShortAmPm:
        case FieldType.dateTimeEuroShortAM_PM:
        case FieldType.dateUs:
        case FieldType.dateUsShort:
        case FieldType.dateTimeShortUs:
        case FieldType.dateTimeUs:
        case FieldType.dateTimeUsAmPm:
        case FieldType.dateTimeUsAM_PM:
        case FieldType.dateTimeUsShort:
        case FieldType.dateTimeUsShortAmPm:
        case FieldType.dateTimeUsShortAM_PM:
            return executeAssociatedDateCondition(options);
        case FieldType.integer:
        case FieldType.float:
        case FieldType.number:
            return numberFilterCondition(options);
        case FieldType.object:
            return objectFilterCondition(options);
        case FieldType.string:
        case FieldType.text:
        case FieldType.password:
        case FieldType.readonly:
        default:
            return stringFilterCondition(options);
    }
};
/**
 * Execute Date filter condition and use correct date format depending on it's field type (or filterSearchType when that is provided)
 * @param options
 */
function executeAssociatedDateCondition(options) {
    const filterSearchType = options && (options.filterSearchType || options.fieldType) || FieldType.dateIso;
    const FORMAT = mapMomentDateFormatWithFieldType(filterSearchType);
    const searchTerms = Array.isArray(options.searchTerms) && options.searchTerms || [];
    let isRangeSearch = false;
    let dateSearch1;
    let dateSearch2;
    // return when cell value is not a valid date
    if (searchTerms.length === 0 || searchTerms[0] === '' || searchTerms[0] === null || !moment(options.cellValue, FORMAT, true).isValid()) {
        return false;
    }
    // cell value in moment format
    const dateCell = moment(options.cellValue, FORMAT, true);
    if (searchTerms.length === 2 || (typeof searchTerms[0] === 'string' && searchTerms[0].indexOf('..') > 0)) {
        isRangeSearch = true;
        const searchValues = (searchTerms.length === 2) ? searchTerms : searchTerms[0].split('..');
        const searchValue1 = (Array.isArray(searchValues) && searchValues[0] || '');
        const searchValue2 = (Array.isArray(searchValues) && searchValues[1] || '');
        const searchTerm1 = moment(searchValue1, FORMAT, true);
        const searchTerm2 = moment(searchValue2, FORMAT, true);
        // return if any of the 2 values are invalid dates
        if (!moment(searchTerm1, FORMAT, true).isValid() || !moment(searchTerm2, FORMAT, true).isValid()) {
            return false;
        }
        dateSearch1 = moment(searchTerm1, FORMAT, true);
        dateSearch2 = moment(searchTerm2, FORMAT, true);
    }
    else {
        // return if the search term is an invalid date
        if (!moment(searchTerms[0], FORMAT, true).isValid()) {
            return false;
        }
        dateSearch1 = moment(searchTerms[0], FORMAT, true);
    }
    // when comparing with Dates only (without time), we need to disregard the time portion, we can do so by setting our time to start at midnight
    // ref, see https://stackoverflow.com/a/19699447/1212166
    const dateCellTimestamp = FORMAT.toLowerCase().includes('h') ? parseInt(dateCell.format('X'), 10) : parseInt(dateCell.clone().startOf('day').format('X'), 10);
    // run the filter condition with date in Unix Timestamp format
    if (isRangeSearch) {
        const isInclusive = options.operator && options.operator === OperatorType.rangeInclusive;
        const resultCondition1 = testFilterCondition((isInclusive ? '>=' : '>'), dateCellTimestamp, parseInt(dateSearch1.format('X'), 10));
        const resultCondition2 = testFilterCondition((isInclusive ? '<=' : '<'), dateCellTimestamp, parseInt(dateSearch2.format('X'), 10));
        return (resultCondition1 && resultCondition2);
    }
    const dateSearchTimestamp1 = FORMAT.toLowerCase().includes('h') ? parseInt(dateSearch1.format('X'), 10) : parseInt(dateSearch1.clone().startOf('day').format('X'), 10);
    return testFilterCondition(options.operator || '==', dateCellTimestamp, dateSearchTimestamp1);
}
;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZXhlY3V0ZU1hcHBlZENvbmRpdGlvbi5qcyIsInNvdXJjZVJvb3QiOiJuZzovL2FuZ3VsYXItc2xpY2tncmlkLyIsInNvdXJjZXMiOlsiYXBwL21vZHVsZXMvYW5ndWxhci1zbGlja2dyaWQvZmlsdGVyLWNvbmRpdGlvbnMvZXhlY3V0ZU1hcHBlZENvbmRpdGlvbi50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsc0JBQXNCLEVBQUUsTUFBTSwwQkFBMEIsQ0FBQztBQUNsRSxPQUFPLEVBQUUsK0JBQStCLEVBQUUsTUFBTSxtQ0FBbUMsQ0FBQztBQUNwRixPQUFPLEVBQUUscUJBQXFCLEVBQUUsTUFBTSx5QkFBeUIsQ0FBQztBQUNoRSxPQUFPLEVBQUUscUJBQXFCLEVBQUUsTUFBTSx5QkFBeUIsQ0FBQztBQUNoRSxPQUFPLEVBQUUscUJBQXFCLEVBQUUsTUFBTSx5QkFBeUIsQ0FBQztBQUVoRSxPQUFPLEVBQUUsU0FBUyxFQUEwQyxZQUFZLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUNsRyxPQUFPLEVBQUUsZ0NBQWdDLEVBQUUsTUFBTSx5QkFBeUIsQ0FBQztBQUMzRSxPQUFPLEVBQUUsbUJBQW1CLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUN4RCxPQUFPLEtBQUssT0FBTyxNQUFNLGFBQWEsQ0FBQztBQUV2QyxNQUFNLE1BQU0sR0FBRyxPQUFPLENBQUMsQ0FBQyxzSEFBc0g7QUFFOUksTUFBTSxDQUFDLE1BQU0sc0JBQXNCLEdBQW9CLENBQUMsT0FBOEIsRUFBRSxFQUFFO0lBQ3hGLDRIQUE0SDtJQUM1SCxNQUFNLFFBQVEsR0FBRyxPQUFPLElBQUksT0FBTyxDQUFDLFFBQVEsSUFBSSxPQUFPLENBQUMsUUFBUSxDQUFDLFdBQVcsRUFBRSxDQUFDO0lBQy9FLElBQUksUUFBUSxLQUFLLElBQUksSUFBSSxRQUFRLEtBQUssS0FBSyxJQUFJLFFBQVEsS0FBSyxhQUFhLElBQUksUUFBUSxLQUFLLGNBQWMsRUFBRTtRQUN4RyxPQUFP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QVEsS0FBSyxZQUFZLENBQUMsY0FBYyxDQUFDO1FBQ3pGLE1BQU0sZ0JBQWdCLEdBQUcsbUJBQW1CLENBQUMsQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLEVBQUUsaUJBQWlCLEVBQUUsUUFBUSxDQUFDLFdBQVcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQztRQUNuSSxNQUFNLGdCQUFnQixHQUFHLG1CQUFtQixDQUFDLENBQUMsV0FBVyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxFQUFFLGlCQUFpQixFQUFFLFFBQVEsQ0FBQyxXQUFXLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUM7UUFDbkksT0FBTyxDQUFDLGdCQUFnQixJQUFJLGdCQUFnQixDQUFDLENBQUM7S0FDL0M7SUFFRCxNQUFNLG9CQUFvQixHQUFHLE1BQU0sQ0FBQyxXQUFXLEVBQUUsQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxXQUFXLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxRQUFRLENBQUMsV0FBVyxDQUFDLEtBQUssRUFBRSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUM7SUFDdkssT0FBTyxtQkFBbUIsQ0FBQyxPQUFPLENBQUMsUUFBUSxJQUFJLElBQUksRUFBRSxpQkFBaUIsRUFBRSxvQkFBb0IsQ0FBQyxDQUFDO0FBQ2hHLENBQUM7QUFBQSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgYm9vbGVhbkZpbHRlckNvbmRpdGlvbiB9IGZyb20gJy4vYm9vbGVhbkZpbHRlckNvbmRpdGlvbic7XHJcbmltcG9ydCB7IGNvbGxlY3Rpb25TZWFyY2hGaWx0ZXJDb25kaXRpb24gfSBmcm9tICcuL2NvbGxlY3Rpb25TZWFyY2hGaWx0ZXJDb25kaXRpb24nO1xyXG5pbXBvcnQgeyBudW1iZXJGaWx0ZXJDb25kaXRpb24gfSBmcm9tICcuL251bWJlckZpbHRlckNvbmRpdGlvbic7XHJcbmltcG9ydCB7IG9iamVjdEZpbHRlckNvbmRpdGlvbiB9IGZyb20gJy4vb2JqZWN0RmlsdGVyQ29uZGl0aW9uJztcclxuaW1wb3J0IHsgc3RyaW5nRmlsdGVyQ29uZGl0aW9uIH0gZnJvbSAnLi9zdHJpbmdGaWx0ZXJDb25kaXRpb24nO1xyXG5cclxuaW1wb3J0IHsgRmllbGRUeXBlLCBGaWx0ZXJDb25kaXRpb24sIEZpbHRlckNvbmRpdGlvbk9wdGlvbiwgT3BlcmF0b3JUeXBlIH0gZnJvbSAnLi4vbW9kZWxzL2luZGV4JztcclxuaW1wb3J0IHsgbWFwTW9tZW50RGF0ZUZvcm1hdFdpdGhGaWVsZFR5cGUgfSBmcm9tICcuLy4uL3NlcnZpY2VzL3V0aWxpdGllcyc7XHJcbmltcG9ydCB7IHRlc3RGaWx0ZXJDb25kaXRpb24gfSBmcm9tICcuL2ZpbHRlclV0aWxpdGllcyc7XHJcbmltcG9ydCAqIGFzIG1vbWVudF8gZnJvbSAnbW9tZW50LW1pbmknO1xyXG5cclxuY29uc3QgbW9tZW50ID0gbW9tZW50XzsgLy8gcGF0Y2ggdG8gZml4IHJvbGx1cCBcIm1vbWVudCBoYXMgbm8gZGVmYXVsdCBleHBvcnRcIiBpc3N1ZSwgZG9jdW1lbnQgaGVyZSBodHRwczovL2dpdGh1Yi5jb20vcm9sbHVwL3JvbGx1cC9pc3N1ZXMvNjcwXHJcblxyXG5leHBvcnQgY29uc3QgZXhlY3V0ZU1hcHBlZENvbmRpdGlvbjogRmlsdGVyQ29uZGl0aW9uID0gKG9wdGlvbnM6IEZpbHRlckNvbmRpdGlvbk9wdGlvbikgPT4ge1xyXG4gIC8vIHdoZW4gdXNpbmcgYSBtdWx0aS1zZWxlY3QgKCdJTicgb3BlcmF0b3IpIHdlIHdpbGwgbm90IHVzZSB0aGUgZmllbGQgdHlwZSBidXQgaW5zdGVhZCBnbyBkaXJlY3RseSB3aXRoIGEgY29sbGVjdGlvbiBzZWFyY2hcclxuICBjb25zdCBvcGVyYXRvciA9IG9wdGlvbnMgJiYgb3B0aW9ucy5vcGVyYXRvciAmJiBvcHRpb25zLm9wZXJhdG9yLnRvVXBwZXJDYXNlKCk7XHJcbiAgaWYgKG9wZXJhdG9yID09PSAnSU4nIHx8IG9wZXJhdG9yID09PSAnTklOJyB8fCBvcGVyYXRvciA9PT0gJ0lOX0NPTlRBSU5TJyB8fCBvcGVyYXRvciA9PT0gJ05JTl9DT05UQUlOUycpIHtcclxuICAgIHJldHVybiBjb2xsZWN0aW9uU2VhcmNoRmlsdGVyQ29uZGl0aW9uKG9wdGlvbnMpO1xyXG4gIH1cclxuXHJcbiAgLy8gZXhlY3V0ZSB0aGUgbWFwcGVkIHR5cGUsIG9yIGRlZmF1bHQgdG8gU3RyaW5nIGNvbmRpdGlvbiBjaGVja1xyXG4gIHN3aXRjaCAob3B0aW9ucy5maWVsZFR5cGUpIHtcclxuICAgIGNhc2UgRmllbGRUeXBlLmJvb2xlYW46XHJcbiAgICAgIHJldHVybiBib29sZWFuRmlsdGVyQ29uZGl0aW9uKG9wdGlvbnMpO1xyXG4gICAgY2FzZSBGaWVsZFR5cGUuZGF0ZTpcclxuICAgIGNhc2UgRmllbGRUeXBlLmRhdGVJc286XHJcbiAgICBjYXNlIEZpZWxkVHlwZS5kYXRlVXRjOlxyXG4gICAgY2FzZSBGaWVsZFR5cGUuZGF0ZVRpbWU6XHJcbiAgICBjYXNlIEZpZWxkVHlwZS5kYXRlVGltZUlzbzpcclxuICAgIGNhc2UgRmllbGRUeXBlLmRhdGVUaW1lSXNvQW1QbTpcclxuICAgIGNhc2UgRmllbGRUeXBlLmRhdGVUaW1lSXNvQU1fUE06XHJcbiAgICBjYXNlIEZpZWxkVHlwZS5kYXRlVGltZVNob3J0SXNvOlxyXG4gICAgY2FzZSBGaWVsZFR5cGUuZGF0ZUV1cm86XHJcbiAgICBjYXNlIEZpZWxkVHlwZS5kYXRlRXVyb1Nob3J0OlxyXG4gICAgY2FzZSBGaWVsZFR5cGUuZGF0ZVRpbWVTaG9ydEV1cm86XHJcbiAgICBjYXNlIEZpZWxkVHlwZS5kYXRlVGltZUV1cm86XHJcbiAgICBjYXNlIEZpZWxkVHlwZS5kYXRlVGltZUV1cm9BbVBtOlxyXG4gICAgY2FzZSBGaWVsZFR5cGUuZGF0ZVRpbWVFdXJvQU1fUE06XHJcbiAgICBjYXNlIEZpZWxkVHlwZS5kYXRlVGltZUV1cm9TaG9ydDpcclxuICAgIGNhc2UgRmllbGRUeXBlLmRhdGVUaW1lRXVyb1Nob3J0QW1QbTpcclxuICAgIGNhc2UgRmllbGRUeXBlLmRhdGVUaW1lRXVyb1Nob3J0QU1fUE06XHJcbiAgICBjYXNlIEZpZWxkVHlwZS5kYXRlVXM6XHJcbiAgICBjYXNlIEZpZWxkVHlwZS5kYXRlVXNTaG9ydDpcclxuICAgIGNhc2UgRmllbGRUeXBlLmRhdGVUaW1lU2hvcnRVczpcclxuICAgIGNhc2UgRmllbGRUeXBlLmRhdGVUaW1lVXM6XHJcbiAgICBjYXNlIEZpZWxkVHlwZS5kYXRlVGltZVVzQW1QbTpcclxuICAgIGNhc2UgRmllbGRUeXBlLmRhdGVUaW1lVXNBTV9QTTpcclxuICAgIGNhc2UgRmllbGRUeXBlLmRhdGVUaW1lVXNTaG9ydDpcclxuICAgIGNhc2UgRmllbGRUeXBlLmRhdGVUaW1lVXNTaG9ydEFtUG06XHJcbiAgICBjYXNlIEZpZWxkVHlwZS5kYXRlVGltZVVzU2hvcnRBTV9QTTpcclxuICAgICAgcmV0dXJuIGV4ZWN1dGVBc3NvY2lhdGVkRGF0ZUNvbmRpdGlvbihvcHRpb25zKTtcclxuICAgIGNhc2UgRmllbGRUeXBlLmludGVnZXI6XHJcbiAgICBjYXNlIEZpZWxkVHlwZS5mbG9hdDpcclxuICAgIGNhc2UgRmllbGRUeXBlLm51bWJlcjpcclxuICAgICAgcmV0dXJuIG51bWJlckZpbHRlckNvbmRpdGlvbihvcHRpb25zKTtcclxuICAgIGNhc2UgRmllbGRUeXBlLm9iamVjdDpcclxuICAgICAgcmV0dXJuIG9iamVjdEZpbHRlckNvbmRpdGlvbihvcHRpb25zKTtcclxuICAgIGNhc2UgRmllbGRUeXBlLnN0cmluZzpcclxuICAgIGNhc2UgRmllbGRUeXBlLnRleHQ6XHJcbiAgICBjYXNlIEZpZWxkVHlwZS5wYXNzd29yZDpcclxuICAgIGNhc2UgRmllbGRUeXBlLnJlYWRvbmx5OlxyXG4gICAgZGVmYXVsdDpcclxuICAgICAgcmV0dXJuIHN0cmluZ0ZpbHRlckNvbmRpdGlvbihvcHRpb25zKTtcclxuICB9XHJcbn07XHJcblxyXG4vKipcclxuICogRXhlY3V0ZSBEYXRlIGZpbHRlciBjb25kaXRpb24gYW5kIHVzZSBjb3JyZWN0IGRhdGUgZm9ybWF0IGRlcGVuZGluZyBvbiBpdCdzIGZpZWxkIHR5cGUgKG9yIGZpbHRlclNlYXJjaFR5cGUgd2hlbiB0aGF0IGlzIHByb3ZpZGVkKVxyXG4gKiBAcGFyYW0gb3B0aW9uc1xyXG4gKi9cclxuZnVuY3Rpb24gZXhlY3V0ZUFzc29jaWF0ZWREYXRlQ29uZGl0aW9uKG9wdGlvbnM6IEZpbHRlckNvbmRpdGlvbk9wdGlvbik6IGJvb2xlYW4ge1xyXG4gIGNvbnN0IGZpbHRlclNlYXJjaFR5cGUgPSBvcHRpb25zICYmIChvcHRpb25zLmZpbHRlclNlYXJjaFR5cGUgfHwgb3B0aW9ucy5maWVsZFR5cGUpIHx8IEZpZWxkVHlwZS5kYXRlSXNvO1xyXG4gIGNvbnN0IEZPUk1BVCA9IG1hcE1vbWVudERhdGVGb3JtYXRXaXRoRmllbGRUeXBlKGZpbHRlclNlYXJjaFR5cGUpO1xyXG4gIGNvbnN0IHNlYXJjaFRlcm1zID0gQXJyYXkuaXNBcnJheShvcHRpb25zLnNlYXJjaFRlcm1zKSAmJiBvcHRpb25zLnNlYXJjaFRlcm1zIHx8IFtdO1xyXG5cclxuICBsZXQgaXNSYW5nZVNlYXJjaCA9IGZhbHNlO1xyXG4gIGxldCBkYXRlU2VhcmNoMTogYW55O1xyXG4gIGxldCBkYXRlU2VhcmNoMjogYW55O1xyXG5cclxuICAvLyByZXR1cm4gd2hlbiBjZWxsIHZhbHVlIGlzIG5vdCBhIHZhbGlkIGRhdGVcclxuICBpZiAoc2VhcmNoVGVybXMubGVuZ3RoID09PSAwIHx8IHNlYXJjaFRlcm1zWzBdID09PSAnJyB8fCBzZWFyY2hUZXJtc1swXSA9PT0gbnVsbCB8fCAhbW9tZW50KG9wdGlvbnMuY2VsbFZhbHVlLCBGT1JNQVQsIHRydWUpLmlzVmFsaWQoKSkge1xyXG4gICAgcmV0dXJuIGZhbHNlO1xyXG4gIH1cclxuXHJcbiAgLy8gY2VsbCB2YWx1ZSBpbiBtb21lbnQgZm9ybWF0XHJcbiAgY29uc3QgZGF0ZUNlbGwgPSBtb21lbnQob3B0aW9ucy5jZWxsVmFsdWUsIEZPUk1BVCwgdHJ1ZSk7XHJcblxyXG4gIGlmIChzZWFyY2hUZXJtcy5sZW5ndGggPT09IDIgfHwgKHR5cGVvZiBzZWFyY2hUZXJtc1swXSA9PT0gJ3N0cmluZycgJiYgKHNlYXJjaFRlcm1zWzBdIGFzIHN0cmluZykuaW5kZXhPZignLi4nKSA+IDApKSB7XHJcbiAgICBpc1JhbmdlU2VhcmNoID0gdHJ1ZTtcclxuICAgIGNvbnN0IHNlYXJjaFZhbHVlcyA9IChzZWFyY2hUZXJtcy5sZW5ndGggPT09IDIpID8gc2VhcmNoVGVybXMgOiAoc2VhcmNoVGVybXNbMF0gYXMgc3RyaW5nKS5zcGxpdCgnLi4nKTtcclxuICAgIGNvbnN0IHNlYXJjaFZhbHVlMSA9IChBcnJheS5pc0FycmF5KHNlYXJjaFZhbHVlcykgJiYgc2VhcmNoVmFsdWVzWzBdIHx8ICcnKSBhcyBEYXRlIHwgc3RyaW5nO1xyXG4gICAgY29uc3Qgc2VhcmNoVmFsdWUyID0gKEFycmF5LmlzQXJyYXkoc2VhcmNoVmFsdWVzKSAmJiBzZWFyY2hWYWx1ZXNbMV0gfHwgJycpIGFzIERhdGUgfCBzdHJpbmc7XHJcbiAgICBjb25zdCBzZWFyY2hUZXJtMSA9IG1vbWVudChzZWFyY2hWYWx1ZTEsIEZPUk1BVCwgdHJ1ZSk7XHJcbiAgICBjb25zdCBzZWFyY2hUZXJtMiA9IG1vbWVudChzZWFyY2hWYWx1ZTIsIEZPUk1BVCwgdHJ1ZSk7XHJcblxyXG4gICAgLy8gcmV0dXJuIGlmIGFueSBvZiB0aGUgMiB2YWx1ZXMgYXJlIGludmFsaWQgZGF0ZXNcclxuICAgIGlmICghbW9tZW50KHNlYXJjaFRlcm0xLCBGT1JNQVQsIHRydWUpLmlzVmFsaWQoKSB8fCAhbW9tZW50KHNlYXJjaFRlcm0yLCBGT1JNQVQsIHRydWUpLmlzVmFsaWQoKSkge1xyXG4gICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICB9XHJcbiAgICBkYXRlU2VhcmNoMSA9IG1vbWVudChzZWFyY2hUZXJtMSwgRk9STUFULCB0cnVlKTtcclxuICAgIGRhdGVTZWFyY2gyID0gbW9tZW50KHNlYXJjaFRlcm0yLCBGT1JNQVQsIHRydWUpO1xyXG4gIH0gZWxzZSB7XHJcbiAgICAvLyByZXR1cm4gaWYgdGhlIHNlYXJjaCB0ZXJtIGlzIGFuIGludmFsaWQgZGF0ZVxyXG4gICAgaWYgKCFtb21lbnQoc2VhcmNoVGVybXNbMF0gYXMgRGF0ZSB8IHN0cmluZywgRk9STUFULCB0cnVlKS5pc1ZhbGlkKCkpIHtcclxuICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgfVxyXG4gICAgZGF0ZVNlYXJjaDEgPSBtb21lbnQoc2VhcmNoVGVybXNbMF0gYXMgRGF0ZSB8IHN0cmluZywgRk9STUFULCB0cnVlKTtcclxuICB9XHJcblxyXG4gIC8vIHdoZW4gY29tcGFyaW5nIHdpdGggRGF0ZXMgb25seSAod2l0aG91dCB0aW1lKSwgd2UgbmVlZCB0byBkaXNyZWdhcmQgdGhlIHRpbWUgcG9ydGlvbiwgd2UgY2FuIGRvIHNvIGJ5IHNldHRpbmcgb3VyIHRpbWUgdG8gc3RhcnQgYXQgbWlkbmlnaHRcclxuICAvLyByZWYsIHNlZSBodHRwczovL3N0YWNrb3ZlcmZsb3cuY29tL2EvMTk2OTk0NDcvMTIxMjE2NlxyXG4gIGNvbnN0IGRhdGVDZWxsVGltZXN0YW1wID0gRk9STUFULnRvTG93ZXJDYXNlKCkuaW5jbHVkZXMoJ2gnKSA/IHBhcnNlSW50KGRhdGVDZWxsLmZvcm1hdCgnWCcpLCAxMCkgOiBwYXJzZUludChkYXRlQ2VsbC5jbG9uZSgpLnN0YXJ0T2YoJ2RheScpLmZvcm1hdCgnWCcpLCAxMCk7XHJcblxyXG4gIC8vIHJ1biB0aGUgZmlsdGVyIGNvbmRpdGlvbiB3aXRoIGRhdGUgaW4gVW5peCBUaW1lc3RhbXAgZm9ybWF0XHJcbiAgaWYgKGlzUmFuZ2VTZWFyY2gpIHtcclxuICAgIGNvbnN0IGlzSW5jbHVzaXZlID0gb3B0aW9ucy5vcGVyYXRvciAmJiBvcHRpb25zLm9wZXJhdG9yID09PSBPcGVyYXRvclR5cGUucmFuZ2VJbmNsdXNpdmU7XHJcbiAgICBjb25zdCByZXN1bHRDb25kaXRpb24xID0gdGVzdEZpbHRlckNvbmRpdGlvbigoaXNJbmNsdXNpdmUgPyAnPj0nIDogJz4nKSwgZGF0ZUNlbGxUaW1lc3RhbXAsIHBhcnNlSW50KGRhdGVTZWFyY2gxLmZvcm1hdCgnWCcpLCAxMCkpO1xyXG4gICAgY29uc3QgcmVzdWx0Q29uZGl0aW9uMiA9IHRlc3RGaWx0ZXJDb25kaXRpb24oKGlzSW5jbHVzaXZlID8gJzw9JyA6ICc8JyksIGRhdGVDZWxsVGltZXN0YW1wLCBwYXJzZUludChkYXRlU2VhcmNoMi5mb3JtYXQoJ1gnKSwgMTApKTtcclxuICAgIHJldHVybiAocmVzdWx0Q29uZGl0aW9uMSAmJiByZXN1bHRDb25kaXRpb24yKTtcclxuICB9XHJcblxyXG4gIGNvbnN0IGRhdGVTZWFyY2hUaW1lc3RhbXAxID0gRk9STUFULnRvTG93ZXJDYXNlKCkuaW5jbHVkZXMoJ2gnKSA/IHBhcnNlSW50KGRhdGVTZWFyY2gxLmZvcm1hdCgnWCcpLCAxMCkgOiBwYXJzZUludChkYXRlU2VhcmNoMS5jbG9uZSgpLnN0YXJ0T2YoJ2RheScpLmZvcm1hdCgnWCcpLCAxMCk7XHJcbiAgcmV0dXJuIHRlc3RGaWx0ZXJDb25kaXRpb24ob3B0aW9ucy5vcGVyYXRvciB8fCAnPT0nLCBkYXRlQ2VsbFRpbWVzdGFtcCwgZGF0ZVNlYXJjaFRpbWVzdGFtcDEpO1xyXG59O1xyXG4iXX0=