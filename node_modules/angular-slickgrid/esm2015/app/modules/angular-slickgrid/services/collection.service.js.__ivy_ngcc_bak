import * as tslib_1 from "tslib";
import { Injectable, Optional } from '@angular/core';
import { TranslateService } from '@ngx-translate/core';
import { FilterMultiplePassType, FieldType, OperatorType, SortDirectionNumber, } from './../models/index';
import { sortByFieldType } from '../sorters/sorterUtilities';
import { uniqueArray } from './utilities';
let CollectionService = class CollectionService {
    constructor(translate) {
        this.translate = translate;
    }
    /**
     * Filter 1 or more items from a collection
     * @param collection
     * @param filterByOptions
     */
    filterCollection(collection, filterByOptions, filterResultBy = FilterMultiplePassType.chain) {
        let filteredCollection = [];
        // when it's array, we will use the new filtered collection after every pass
        // basically if input collection has 10 items on 1st pass and 1 item is filtered out, then on 2nd pass the input collection will be 9 items
        if (Array.isArray(filterByOptions)) {
            filteredCollection = (filterResultBy === FilterMultiplePassType.merge) ? [] : collection;
            for (const filter of filterByOptions) {
                if (filterResultBy === FilterMultiplePassType.merge) {
                    const filteredPass = this.singleFilterCollection(collection, filter);
                    filteredCollection = uniqueArray([...filteredCollection, ...filteredPass]);
                }
                else {
                    filteredCollection = this.singleFilterCollection(filteredCollection, filter);
                }
            }
        }
        else {
            filteredCollection = this.singleFilterCollection(collection, filterByOptions);
        }
        return filteredCollection;
    }
    /**
     * Filter an item from a collection
     * @param collection
     * @param filterBy
     */
    singleFilterCollection(collection, filterBy) {
        let filteredCollection = [];
        if (filterBy) {
            const objectProperty = filterBy.property;
            const operator = filterBy.operator || OperatorType.equal;
            // just check for undefined since the filter value could be null, 0, '', false etc
            const value = typeof filterBy.value === 'undefined' ? '' : filterBy.value;
            switch (operator) {
                case OperatorType.equal:
                    if (objectProperty) {
                        filteredCollection = collection.filter((item) => item[objectProperty] === value);
                    }
                    else {
                        filteredCollection = collection.filter((item) => item === value);
                    }
                    break;
                case OperatorType.contains:
                    if (objectProperty) {
                        filteredCollection = collection.filter((item) => item[objectProperty].toString().indexOf(value.toString()) !== -1);
                    }
                    else {
                        filteredCollection = collection.filter((item) => (item !== null && item !== undefined) && item.toString().indexOf(value.toString()) !== -1);
                    }
                    break;
                case OperatorType.notContains:
                    if (objectProperty) {
                        filteredCollection = collection.filter((item) => item[objectProperty].toString().indexOf(value.toString()) === -1);
                    }
                    else {
                        filteredCollection = collection.filter((item) => (item !== null && item !== undefined) && item.toString().indexOf(value.toString()) === -1);
                    }
                    break;
                case OperatorType.notEqual:
                default:
                    if (objectProperty) {
                        filteredCollection = collection.filter((item) => item[objectProperty] !== value);
                    }
                    else {
                        filteredCollection = collection.filter((item) => item !== value);
                    }
            }
        }
        return filteredCollection;
    }
    /**
     * Sort 1 or more items in a collection
     * @param column definition
     * @param collection
     * @param sortByOptions
     * @param enableTranslateLabel
     */
    sortCollection(columnDef, collection, sortByOptions, enableTranslateLabel) {
        if (enableTranslateLabel && (!this.translate || !this.translate.instant)) {
            throw new Error('[Angular-Slickgrid] requires "ngx-translate" to be installed and configured when the grid option "enableTranslate" is enabled.');
        }
        let sortedCollection = [];
        if (sortByOptions) {
            if (Array.isArray(sortByOptions)) {
                // multi-sort
                sortedCollection = collection.sort((dataRow1, dataRow2) => {
                    for (let i = 0, l = sortByOptions.length; i < l; i++) {
                        const sortBy = sortByOptions[i];
                        if (sortBy && sortBy.property) {
                            // collection of objects with a property name provided
                            const sortDirection = sortBy.sortDesc ? SortDirectionNumber.desc : SortDirectionNumber.asc;
                            const objectProperty = sortBy.property;
                            const fieldType = sortBy.fieldType || FieldType.string;
                            const value1 = (enableTranslateLabel) ? this.translate && this.translate.currentLang && this.translate.instant(dataRow1[objectProperty] || ' ') : dataRow1[objectProperty];
                            const value2 = (enableTranslateLabel) ? this.translate && this.translate.currentLang && this.translate.instant(dataRow2[objectProperty] || ' ') : dataRow2[objectProperty];
                            const sortResult = sortByFieldType(fieldType, value1, value2, sortDirection, columnDef);
                            if (sortResult !== SortDirectionNumber.neutral) {
                                return sortResult;
                            }
                        }
                    }
                    return SortDirectionNumber.neutral;
                });
            }
            else if (sortByOptions && sortByOptions.property) {
                // single sort
                // collection of objects with a property name provided
                const objectProperty = sortByOptions.property;
                const sortDirection = sortByOptions.sortDesc ? SortDirectionNumber.desc : SortDirectionNumber.asc;
                const fieldType = sortByOptions.fieldType || FieldType.string;
                if (objectProperty) {
                    sortedCollection = collection.sort((dataRow1, dataRow2) => {
                        const value1 = (enableTranslateLabel) ? this.translate && this.translate.currentLang && this.translate.instant(dataRow1[objectProperty] || ' ') : dataRow1[objectProperty];
                        const value2 = (enableTranslateLabel) ? this.translate && this.translate.currentLang && this.translate.instant(dataRow2[objectProperty] || ' ') : dataRow2[objectProperty];
                        const sortResult = sortByFieldType(fieldType, value1, value2, sortDirection, columnDef);
                        if (sortResult !== SortDirectionNumber.neutral) {
                            return sortResult;
                        }
                        return SortDirectionNumber.neutral;
                    });
                }
            }
            else if (sortByOptions && !sortByOptions.property) {
                const sortDirection = sortByOptions.sortDesc ? SortDirectionNumber.desc : SortDirectionNumber.asc;
                const fieldType = sortByOptions.fieldType || FieldType.string;
                sortedCollection = collection.sort((dataRow1, dataRow2) => {
                    const value1 = (enableTranslateLabel) ? this.translate && this.translate.currentLang && this.translate.instant(dataRow1 || ' ') : dataRow1;
                    const value2 = (enableTranslateLabel) ? this.translate && this.translate.currentLang && this.translate.instant(dataRow2 || ' ') : dataRow2;
                    const sortResult = sortByFieldType(fieldType, value1, value2, sortDirection, columnDef);
                    if (sortResult !== SortDirectionNumber.neutral) {
                        return sortResult;
                    }
                    return SortDirectionNumber.neutral;
                });
            }
        }
        return sortedCollection;
    }
};
CollectionService.ctorParameters = () => [
    { type: TranslateService, decorators: [{ type: Optional }] }
];
CollectionService = tslib_1.__decorate([
    Injectable(),
    tslib_1.__param(0, Optional())
], CollectionService);
export { CollectionService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29sbGVjdGlvbi5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vYW5ndWxhci1zbGlja2dyaWQvIiwic291cmNlcyI6WyJhcHAvbW9kdWxlcy9hbmd1bGFyLXNsaWNrZ3JpZC9zZXJ2aWNlcy9jb2xsZWN0aW9uLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsUUFBUSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ3JELE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBQ3ZELE9BQU8sRUFJTCxzQkFBc0IsRUFFdEIsU0FBUyxFQUNULFlBQVksRUFDWixtQkFBbUIsR0FDcEIsTUFBTSxtQkFBbUIsQ0FBQztBQUMzQixPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sNEJBQTRCLENBQUM7QUFDN0QsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLGFBQWEsQ0FBQztBQUcxQyxJQUFhLGlCQUFpQixHQUE5QixNQUFhLGlCQUFpQjtJQUM1QixZQUFnQyxTQUEyQjtRQUEzQixjQUFTLEdBQVQsU0FBUyxDQUFrQjtJQUFJLENBQUM7SUFFaEU7Ozs7T0FJRztJQUNILGdCQUFnQixDQUFDLFVBQWUsRUFBRSxlQUEwRCxFQUFFLGlCQUErRSxzQkFBc0IsQ0FBQyxLQUFLO1FBQ3ZNLElBQUksa0JBQWtCLEdBQVEsRUFBRSxDQUFDO1FBRWpDLDRFQUE0RTtRQUM1RSwySUFBMkk7UUFDM0ksSUFBSSxLQUFLLENBQUMsT0FBTyxDQUFDLGVBQWUsQ0FBQyxFQUFFO1lBQ2xDLGtCQUFrQixHQUFHLENBQUMsY0FBYyxLQUFLLHNCQUFzQixDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLFVBQVUsQ0FBQztZQUV6RixLQUFLLE1BQU0sTUFBTSxJQUFJLGVBQWUsRUFBRTtnQkFDcEMsSUFBSSxjQUFjLEtBQUssc0JBQXNCLENBQUMsS0FBSyxFQUFFO29CQUNuRCxN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LFVBQVUsQ0FBQztxQkFDbkI7b0JBQ0QsT0FBTyxtQkFBbUIsQ0FBQyxPQUFPLENBQUM7Z0JBQ3JDLENBQUMsQ0FBQyxDQUFDO2FBQ0o7U0FDRjtRQUVELE9BQU8sZ0JBQWdCLENBQUM7SUFDMUIsQ0FBQztDQUNGLENBQUE7O1lBeEo0QyxnQkFBZ0IsdUJBQTlDLFFBQVE7O0FBRFYsaUJBQWlCO0lBRDdCLFVBQVUsRUFBRTtJQUVFLG1CQUFBLFFBQVEsRUFBRSxDQUFBO0dBRFosaUJBQWlCLENBeUo3QjtTQXpKWSxpQkFBaUIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlLCBPcHRpb25hbCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBUcmFuc2xhdGVTZXJ2aWNlIH0gZnJvbSAnQG5neC10cmFuc2xhdGUvY29yZSc7XHJcbmltcG9ydCB7XHJcbiAgQ29sbGVjdGlvbkZpbHRlckJ5LFxyXG4gIENvbGxlY3Rpb25Tb3J0QnksXHJcbiAgQ29sdW1uLFxyXG4gIEZpbHRlck11bHRpcGxlUGFzc1R5cGUsXHJcbiAgRmlsdGVyTXVsdGlwbGVQYXNzVHlwZVN0cmluZyxcclxuICBGaWVsZFR5cGUsXHJcbiAgT3BlcmF0b3JUeXBlLFxyXG4gIFNvcnREaXJlY3Rpb25OdW1iZXIsXHJcbn0gZnJvbSAnLi8uLi9tb2RlbHMvaW5kZXgnO1xyXG5pbXBvcnQgeyBzb3J0QnlGaWVsZFR5cGUgfSBmcm9tICcuLi9zb3J0ZXJzL3NvcnRlclV0aWxpdGllcyc7XHJcbmltcG9ydCB7IHVuaXF1ZUFycmF5IH0gZnJvbSAnLi91dGlsaXRpZXMnO1xyXG5cclxuQEluamVjdGFibGUoKVxyXG5leHBvcnQgY2xhc3MgQ29sbGVjdGlvblNlcnZpY2U8VCA9IGFueT4ge1xyXG4gIGNvbnN0cnVjdG9yKEBPcHRpb25hbCgpIHByaXZhdGUgdHJhbnNsYXRlOiBUcmFuc2xhdGVTZXJ2aWNlKSB7IH1cclxuXHJcbiAgLyoqXHJcbiAgICogRmlsdGVyIDEgb3IgbW9yZSBpdGVtcyBmcm9tIGEgY29sbGVjdGlvblxyXG4gICAqIEBwYXJhbSBjb2xsZWN0aW9uXHJcbiAgICogQHBhcmFtIGZpbHRlckJ5T3B0aW9uc1xyXG4gICAqL1xyXG4gIGZpbHRlckNvbGxlY3Rpb24oY29sbGVjdGlvbjogVFtdLCBmaWx0ZXJCeU9wdGlvbnM6IENvbGxlY3Rpb25GaWx0ZXJCeSB8IENvbGxlY3Rpb25GaWx0ZXJCeVtdLCBmaWx0ZXJSZXN1bHRCeTogRmlsdGVyTXVsdGlwbGVQYXNzVHlwZSB8IEZpbHRlck11bHRpcGxlUGFzc1R5cGVTdHJpbmcgfCBudWxsID0gRmlsdGVyTXVsdGlwbGVQYXNzVHlwZS5jaGFpbik6IFRbXSB7XHJcbiAgICBsZXQgZmlsdGVyZWRDb2xsZWN0aW9uOiBUW10gPSBbXTtcclxuXHJcbiAgICAvLyB3aGVuIGl0J3MgYXJyYXksIHdlIHdpbGwgdXNlIHRoZSBuZXcgZmlsdGVyZWQgY29sbGVjdGlvbiBhZnRlciBldmVyeSBwYXNzXHJcbiAgICAvLyBiYXNpY2FsbHkgaWYgaW5wdXQgY29sbGVjdGlvbiBoYXMgMTAgaXRlbXMgb24gMXN0IHBhc3MgYW5kIDEgaXRlbSBpcyBmaWx0ZXJlZCBvdXQsIHRoZW4gb24gMm5kIHBhc3MgdGhlIGlucHV0IGNvbGxlY3Rpb24gd2lsbCBiZSA5IGl0ZW1zXHJcbiAgICBpZiAoQXJyYXkuaXNBcnJheShmaWx0ZXJCeU9wdGlvbnMpKSB7XHJcbiAgICAgIGZpbHRlcmVkQ29sbGVjdGlvbiA9IChmaWx0ZXJSZXN1bHRCeSA9PT0gRmlsdGVyTXVsdGlwbGVQYXNzVHlwZS5tZXJnZSkgPyBbXSA6IGNvbGxlY3Rpb247XHJcblxyXG4gICAgICBmb3IgKGNvbnN0IGZpbHRlciBvZiBmaWx0ZXJCeU9wdGlvbnMpIHtcclxuICAgICAgICBpZiAoZmlsdGVyUmVzdWx0QnkgPT09IEZpbHRlck11bHRpcGxlUGFzc1R5cGUubWVyZ2UpIHtcclxuICAgICAgICAgIGNvbnN0IGZpbHRlcmVkUGFzcyA9IHRoaXMuc2luZ2xlRmlsdGVyQ29sbGVjdGlvbihjb2xsZWN0aW9uLCBmaWx0ZXIpO1xyXG4gICAgICAgICAgZmlsdGVyZWRDb2xsZWN0aW9uID0gdW5pcXVlQXJyYXkoWy4uLmZpbHRlcmVkQ29sbGVjdGlvbiwgLi4uZmlsdGVyZWRQYXNzXSk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgIGZpbHRlcmVkQ29sbGVjdGlvbiA9IHRoaXMuc2luZ2xlRmlsdGVyQ29sbGVjdGlvbihmaWx0ZXJlZENvbGxlY3Rpb24sIGZpbHRlcik7XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICBmaWx0ZXJlZENvbGxlY3Rpb24gPSB0aGlzLnNpbmdsZUZpbHRlckNvbGxlY3Rpb24oY29sbGVjdGlvbiwgZmlsdGVyQnlPcHRpb25zKTtcclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4gZmlsdGVyZWRDb2xsZWN0aW9uO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogRmlsdGVyIGFuIGl0ZW0gZnJvbSBhIGNvbGxlY3Rpb25cclxuICAgKiBAcGFyYW0gY29sbGVjdGlvblxyXG4gICAqIEBwYXJhbSBmaWx0ZXJCeVxyXG4gICAqL1xyXG4gIHNpbmdsZUZpbHRlckNvbGxlY3Rpb24oY29sbGVjdGlvbjogVFtdLCBmaWx0ZXJCeTogQ29sbGVjdGlvbkZpbHRlckJ5KTogVFtdIHtcclxuICAgIGxldCBmaWx0ZXJlZENvbGxlY3Rpb246IFRbXSA9IFtdO1xyXG5cclxuICAgIGlmIChmaWx0ZXJCeSkge1xyXG4gICAgICBjb25zdCBvYmplY3RQcm9wZXJ0eSA9IGZpbHRlckJ5LnByb3BlcnR5O1xyXG4gICAgICBjb25zdCBvcGVyYXRvciA9IGZpbHRlckJ5Lm9wZXJhdG9yIHx8IE9wZXJhdG9yVHlwZS5lcXVhbDtcclxuICAgICAgLy8ganVzdCBjaGVjayBmb3IgdW5kZWZpbmVkIHNpbmNlIHRoZSBmaWx0ZXIgdmFsdWUgY291bGQgYmUgbnVsbCwgMCwgJycsIGZhbHNlIGV0Y1xyXG4gICAgICBjb25zdCB2YWx1ZSA9IHR5cGVvZiBmaWx0ZXJCeS52YWx1ZSA9PT0gJ3VuZGVmaW5lZCcgPyAnJyA6IGZpbHRlckJ5LnZhbHVlO1xyXG5cclxuICAgICAgc3dpdGNoIChvcGVyYXRvcikge1xyXG4gICAgICAgIGNhc2UgT3BlcmF0b3JUeXBlLmVxdWFsOlxyXG4gICAgICAgICAgaWYgKG9iamVjdFByb3BlcnR5KSB7XHJcbiAgICAgICAgICAgIGZpbHRlcmVkQ29sbGVjdGlvbiA9IGNvbGxlY3Rpb24uZmlsdGVyKChpdGVtKSA9PiBpdGVtW29iamVjdFByb3BlcnR5XSA9PT0gdmFsdWUpO1xyXG4gICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgZmlsdGVyZWRDb2xsZWN0aW9uID0gY29sbGVjdGlvbi5maWx0ZXIoKGl0ZW0pID0+IGl0ZW0gPT09IHZhbHVlKTtcclxuICAgICAgICAgIH1cclxuICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgIGNhc2UgT3BlcmF0b3JUeXBlLmNvbnRhaW5zOlxyXG4gICAgICAgICAgaWYgKG9iamVjdFByb3BlcnR5KSB7XHJcbiAgICAgICAgICAgIGZpbHRlcmVkQ29sbGVjdGlvbiA9IGNvbGxlY3Rpb24uZmlsdGVyKChpdGVtKSA9PiBpdGVtW29iamVjdFByb3BlcnR5XS50b1N0cmluZygpLmluZGV4T2YodmFsdWUudG9TdHJpbmcoKSkgIT09IC0xKTtcclxuICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIGZpbHRlcmVkQ29sbGVjdGlvbiA9IGNvbGxlY3Rpb24uZmlsdGVyKChpdGVtOiBhbnkpID0+IChpdGVtICE9PSBudWxsICYmIGl0ZW0gIT09IHVuZGVmaW5lZCkgJiYgaXRlbS50b1N0cmluZygpLmluZGV4T2YodmFsdWUudG9TdHJpbmcoKSkgIT09IC0xKTtcclxuICAgICAgICAgIH1cclxuICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgIGNhc2UgT3BlcmF0b3JUeXBlLm5vdENvbnRhaW5zOlxyXG4gICAgICAgICAgaWYgKG9iamVjdFByb3BlcnR5KSB7XHJcbiAgICAgICAgICAgIGZpbHRlcmVkQ29sbGVjdGlvbiA9IGNvbGxlY3Rpb24uZmlsdGVyKChpdGVtKSA9PiBpdGVtW29iamVjdFByb3BlcnR5XS50b1N0cmluZygpLmluZGV4T2YodmFsdWUudG9TdHJpbmcoKSkgPT09IC0xKTtcclxuICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIGZpbHRlcmVkQ29sbGVjdGlvbiA9IGNvbGxlY3Rpb24uZmlsdGVyKChpdGVtOiBhbnkpID0+IChpdGVtICE9PSBudWxsICYmIGl0ZW0gIT09IHVuZGVmaW5lZCkgJiYgaXRlbS50b1N0cmluZygpLmluZGV4T2YodmFsdWUudG9TdHJpbmcoKSkgPT09IC0xKTtcclxuICAgICAgICAgIH1cclxuICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgIGNhc2UgT3BlcmF0b3JUeXBlLm5vdEVxdWFsOlxyXG4gICAgICAgIGRlZmF1bHQ6XHJcbiAgICAgICAgICBpZiAob2JqZWN0UHJvcGVydHkpIHtcclxuICAgICAgICAgICAgZmlsdGVyZWRDb2xsZWN0aW9uID0gY29sbGVjdGlvbi5maWx0ZXIoKGl0ZW0pID0+IGl0ZW1bb2JqZWN0UHJvcGVydHldICE9PSB2YWx1ZSk7XHJcbiAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBmaWx0ZXJlZENvbGxlY3Rpb24gPSBjb2xsZWN0aW9uLmZpbHRlcigoaXRlbSkgPT4gaXRlbSAhPT0gdmFsdWUpO1xyXG4gICAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIGZpbHRlcmVkQ29sbGVjdGlvbjtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFNvcnQgMSBvciBtb3JlIGl0ZW1zIGluIGEgY29sbGVjdGlvblxyXG4gICAqIEBwYXJhbSBjb2x1bW4gZGVmaW5pdGlvblxyXG4gICAqIEBwYXJhbSBjb2xsZWN0aW9uXHJcbiAgICogQHBhcmFtIHNvcnRCeU9wdGlvbnNcclxuICAgKiBAcGFyYW0gZW5hYmxlVHJhbnNsYXRlTGFiZWxcclxuICAgKi9cclxuICBzb3J0Q29sbGVjdGlvbihjb2x1bW5EZWY6IENvbHVtbiwgY29sbGVjdGlvbjogVFtdLCBzb3J0QnlPcHRpb25zOiBDb2xsZWN0aW9uU29ydEJ5IHwgQ29sbGVjdGlvblNvcnRCeVtdLCBlbmFibGVUcmFuc2xhdGVMYWJlbD86IGJvb2xlYW4pOiBUW10ge1xyXG4gICAgaWYgKGVuYWJsZVRyYW5zbGF0ZUxhYmVsICYmICghdGhpcy50cmFuc2xhdGUgfHwgIXRoaXMudHJhbnNsYXRlLmluc3RhbnQpKSB7XHJcbiAgICAgIHRocm93IG5ldyBFcnJvcignW0FuZ3VsYXItU2xpY2tncmlkXSByZXF1aXJlcyBcIm5neC10cmFuc2xhdGVcIiB0byBiZSBpbnN0YWxsZWQgYW5kIGNvbmZpZ3VyZWQgd2hlbiB0aGUgZ3JpZCBvcHRpb24gXCJlbmFibGVUcmFuc2xhdGVcIiBpcyBlbmFibGVkLicpO1xyXG4gICAgfVxyXG5cclxuICAgIGxldCBzb3J0ZWRDb2xsZWN0aW9uOiBUW10gPSBbXTtcclxuXHJcbiAgICBpZiAoc29ydEJ5T3B0aW9ucykge1xyXG4gICAgICBpZiAoQXJyYXkuaXNBcnJheShzb3J0QnlPcHRpb25zKSkge1xyXG4gICAgICAgIC8vIG11bHRpLXNvcnRcclxuICAgICAgICBzb3J0ZWRDb2xsZWN0aW9uID0gY29sbGVjdGlvbi5zb3J0KChkYXRhUm93MTogYW55LCBkYXRhUm93MjogYW55KSA9PiB7XHJcbiAgICAgICAgICBmb3IgKGxldCBpID0gMCwgbCA9IHNvcnRCeU9wdGlvbnMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IHNvcnRCeSA9IHNvcnRCeU9wdGlvbnNbaV07XHJcblxyXG4gICAgICAgICAgICBpZiAoc29ydEJ5ICYmIHNvcnRCeS5wcm9wZXJ0eSkge1xyXG4gICAgICAgICAgICAgIC8vIGNvbGxlY3Rpb24gb2Ygb2JqZWN0cyB3aXRoIGEgcHJvcGVydHkgbmFtZSBwcm92aWRlZFxyXG4gICAgICAgICAgICAgIGNvbnN0IHNvcnREaXJlY3Rpb24gPSBzb3J0Qnkuc29ydERlc2MgPyBTb3J0RGlyZWN0aW9uTnVtYmVyLmRlc2MgOiBTb3J0RGlyZWN0aW9uTnVtYmVyLmFzYztcclxuICAgICAgICAgICAgICBjb25zdCBvYmplY3RQcm9wZXJ0eSA9IHNvcnRCeS5wcm9wZXJ0eTtcclxuICAgICAgICAgICAgICBjb25zdCBmaWVsZFR5cGUgPSBzb3J0QnkuZmllbGRUeXBlIHx8IEZpZWxkVHlwZS5zdHJpbmc7XHJcbiAgICAgICAgICAgICAgY29uc3QgdmFsdWUxID0gKGVuYWJsZVRyYW5zbGF0ZUxhYmVsKSA/IHRoaXMudHJhbnNsYXRlICYmIHRoaXMudHJhbnNsYXRlLmN1cnJlbnRMYW5nICYmIHRoaXMudHJhbnNsYXRlLmluc3RhbnQoZGF0YVJvdzFbb2JqZWN0UHJvcGVydHldIHx8ICcgJykgOiBkYXRhUm93MVtvYmplY3RQcm9wZXJ0eV07XHJcbiAgICAgICAgICAgICAgY29uc3QgdmFsdWUyID0gKGVuYWJsZVRyYW5zbGF0ZUxhYmVsKSA/IHRoaXMudHJhbnNsYXRlICYmIHRoaXMudHJhbnNsYXRlLmN1cnJlbnRMYW5nICYmIHRoaXMudHJhbnNsYXRlLmluc3RhbnQoZGF0YVJvdzJbb2JqZWN0UHJvcGVydHldIHx8ICcgJykgOiBkYXRhUm93MltvYmplY3RQcm9wZXJ0eV07XHJcblxyXG4gICAgICAgICAgICAgIGNvbnN0IHNvcnRSZXN1bHQgPSBzb3J0QnlGaWVsZFR5cGUoZmllbGRUeXBlLCB2YWx1ZTEsIHZhbHVlMiwgc29ydERpcmVjdGlvbiwgY29sdW1uRGVmKTtcclxuICAgICAgICAgICAgICBpZiAoc29ydFJlc3VsdCAhPT0gU29ydERpcmVjdGlvbk51bWJlci5uZXV0cmFsKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gc29ydFJlc3VsdDtcclxuICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgIH1cclxuICAgICAgICAgIHJldHVybiBTb3J0RGlyZWN0aW9uTnVtYmVyLm5ldXRyYWw7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgIH0gZWxzZSBpZiAoc29ydEJ5T3B0aW9ucyAmJiBzb3J0QnlPcHRpb25zLnByb3BlcnR5KSB7XHJcbiAgICAgICAgLy8gc2luZ2xlIHNvcnRcclxuICAgICAgICAvLyBjb2xsZWN0aW9uIG9mIG9iamVjdHMgd2l0aCBhIHByb3BlcnR5IG5hbWUgcHJvdmlkZWRcclxuICAgICAgICBjb25zdCBvYmplY3RQcm9wZXJ0eSA9IHNvcnRCeU9wdGlvbnMucHJvcGVydHk7XHJcbiAgICAgICAgY29uc3Qgc29ydERpcmVjdGlvbiA9IHNvcnRCeU9wdGlvbnMuc29ydERlc2MgPyBTb3J0RGlyZWN0aW9uTnVtYmVyLmRlc2MgOiBTb3J0RGlyZWN0aW9uTnVtYmVyLmFzYztcclxuICAgICAgICBjb25zdCBmaWVsZFR5cGUgPSBzb3J0QnlPcHRpb25zLmZpZWxkVHlwZSB8fCBGaWVsZFR5cGUuc3RyaW5nO1xyXG5cclxuICAgICAgICBpZiAob2JqZWN0UHJvcGVydHkpIHtcclxuICAgICAgICAgIHNvcnRlZENvbGxlY3Rpb24gPSBjb2xsZWN0aW9uLnNvcnQoKGRhdGFSb3cxOiBhbnksIGRhdGFSb3cyOiBhbnkpID0+IHtcclxuICAgICAgICAgICAgY29uc3QgdmFsdWUxID0gKGVuYWJsZVRyYW5zbGF0ZUxhYmVsKSA/IHRoaXMudHJhbnNsYXRlICYmIHRoaXMudHJhbnNsYXRlLmN1cnJlbnRMYW5nICYmIHRoaXMudHJhbnNsYXRlLmluc3RhbnQoZGF0YVJvdzFbb2JqZWN0UHJvcGVydHldIHx8ICcgJykgOiBkYXRhUm93MVtvYmplY3RQcm9wZXJ0eV07XHJcbiAgICAgICAgICAgIGNvbnN0IHZhbHVlMiA9IChlbmFibGVUcmFuc2xhdGVMYWJlbCkgPyB0aGlzLnRyYW5zbGF0ZSAmJiB0aGlzLnRyYW5zbGF0ZS5jdXJyZW50TGFuZyAmJiB0aGlzLnRyYW5zbGF0ZS5pbnN0YW50KGRhdGFSb3cyW29iamVjdFByb3BlcnR5XSB8fCAnICcpIDogZGF0YVJvdzJbb2JqZWN0UHJvcGVydHldO1xyXG4gICAgICAgICAgICBjb25zdCBzb3J0UmVzdWx0ID0gc29ydEJ5RmllbGRUeXBlKGZpZWxkVHlwZSwgdmFsdWUxLCB2YWx1ZTIsIHNvcnREaXJlY3Rpb24sIGNvbHVtbkRlZik7XHJcbiAgICAgICAgICAgIGlmIChzb3J0UmVzdWx0ICE9PSBTb3J0RGlyZWN0aW9uTnVtYmVyLm5ldXRyYWwpIHtcclxuICAgICAgICAgICAgICByZXR1cm4gc29ydFJlc3VsdDtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICByZXR1cm4gU29ydERpcmVjdGlvbk51bWJlci5uZXV0cmFsO1xyXG4gICAgICAgICAgfSk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9IGVsc2UgaWYgKHNvcnRCeU9wdGlvbnMgJiYgIXNvcnRCeU9wdGlvbnMucHJvcGVydHkpIHtcclxuICAgICAgICBjb25zdCBzb3J0RGlyZWN0aW9uID0gc29ydEJ5T3B0aW9ucy5zb3J0RGVzYyA/IFNvcnREaXJlY3Rpb25OdW1iZXIuZGVzYyA6IFNvcnREaXJlY3Rpb25OdW1iZXIuYXNjO1xyXG4gICAgICAgIGNvbnN0IGZpZWxkVHlwZSA9IHNvcnRCeU9wdGlvbnMuZmllbGRUeXBlIHx8IEZpZWxkVHlwZS5zdHJpbmc7XHJcblxyXG4gICAgICAgIHNvcnRlZENvbGxlY3Rpb24gPSBjb2xsZWN0aW9uLnNvcnQoKGRhdGFSb3cxOiBhbnksIGRhdGFSb3cyOiBhbnkpID0+IHtcclxuICAgICAgICAgIGNvbnN0IHZhbHVlMSA9IChlbmFibGVUcmFuc2xhdGVMYWJlbCkgPyB0aGlzLnRyYW5zbGF0ZSAmJiB0aGlzLnRyYW5zbGF0ZS5jdXJyZW50TGFuZyAmJiB0aGlzLnRyYW5zbGF0ZS5pbnN0YW50KGRhdGFSb3cxIHx8ICcgJykgOiBkYXRhUm93MTtcclxuICAgICAgICAgIGNvbnN0IHZhbHVlMiA9IChlbmFibGVUcmFuc2xhdGVMYWJlbCkgPyB0aGlzLnRyYW5zbGF0ZSAmJiB0aGlzLnRyYW5zbGF0ZS5jdXJyZW50TGFuZyAmJiB0aGlzLnRyYW5zbGF0ZS5pbnN0YW50KGRhdGFSb3cyIHx8ICcgJykgOiBkYXRhUm93MjtcclxuICAgICAgICAgIGNvbnN0IHNvcnRSZXN1bHQgPSBzb3J0QnlGaWVsZFR5cGUoZmllbGRUeXBlLCB2YWx1ZTEsIHZhbHVlMiwgc29ydERpcmVjdGlvbiwgY29sdW1uRGVmKTtcclxuICAgICAgICAgIGlmIChzb3J0UmVzdWx0ICE9PSBTb3J0RGlyZWN0aW9uTnVtYmVyLm5ldXRyYWwpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHNvcnRSZXN1bHQ7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgICByZXR1cm4gU29ydERpcmVjdGlvbk51bWJlci5uZXV0cmFsO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIHNvcnRlZENvbGxlY3Rpb247XHJcbiAgfVxyXG59XHJcbiJdfQ==