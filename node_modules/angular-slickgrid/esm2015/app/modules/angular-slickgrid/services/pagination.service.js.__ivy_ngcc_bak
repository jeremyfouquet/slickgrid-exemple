import * as tslib_1 from "tslib";
import { Injectable } from '@angular/core';
import { isObservable, Subject } from 'rxjs';
import * as isequal_ from 'lodash.isequal';
const isequal = isequal_; // patch to fix rollup to work
import { FilterService } from './filter.service';
import { GridService } from './grid.service';
import { SharedService } from './shared.service';
import { executeBackendProcessesCallback, onBackendError } from './backend-utilities';
import { unsubscribeAllObservables } from './utilities';
let PaginationService = class PaginationService {
    /** Constructor */
    constructor(filterService, gridService, sharedService) {
        this.filterService = filterService;
        this.gridService = gridService;
        this.sharedService = sharedService;
        this._initialized = false;
        this._isLocalGrid = true;
        this._dataFrom = 1;
        this._dataTo = 1;
        this._pageCount = 1;
        this._pageNumber = 1;
        this._totalItems = 0;
        this._eventHandler = new Slick.EventHandler();
        this._subscriptions = [];
        this.onPaginationChanged = new Subject();
        this.onPaginationVisibilityChanged = new Subject();
    }
    get paginationOptions() {
        return this._paginationOptions;
    }
    set paginationOptions(paginationOptions) {
        this._paginationOptions = paginationOptions;
    }
    get availablePageSizes() {
        return this._availablePageSizes;
    }
    get dataFrom() {
        return this._dataFrom;
    }
    get dataTo() {
        return this._dataTo;
    }
    get itemsPerPage() {
        return this._itemsPerPage;
    }
    get pageCount() {
        return this._pageCount;
    }
    get pageNumber() {
        return this._pageNumber;
    }
    set totalItems(totalItems) {
        this._totalItems = totalItems;
        if (this._initialized) {
            this.refreshPagination();
        }
    }
    get totalItems() {
        return this._totalItems;
    }
    init(grid, dataView, paginationOptions, backendServiceApi) {
        this._availablePageSizes = paginationOptions.pageSizes;
        this.dataView = dataView;
        this.grid = grid;
        this._backendServiceApi = backendServiceApi;
        this._paginationOptions = paginationOptions;
        this._isLocalGrid = !backendServiceApi;
        this._pageNumber = paginationOptions.pageNumber || 1;
        if (backendServiceApi && (!backendServiceApi.service || !backendServiceApi.process)) {
            throw new Error(`BackendServiceApi requires the following 2 properties "process" and "service" to be defined.`);
        }
        if (this._isLocalGrid && this.dataView) {
            this._eventHandler.subscribe(this.dataView.onPagingInfoChanged, (e, pagingInfo) => {
                if (this._totalItems !== pagingInfo.totalRows) {
                    this.updateTotalItems(pagingInfo.totalRows);
                }
            });
            dataView.setRefreshHints({ isFilterUnchanged: true });
            dataView.setPagingOptions({ pageSize: this.paginationOptions.pageSize, pageNum: (this._pageNumber - 1) }); // dataView page starts at 0 instead of 1
        }
        // Subscribe to Filter Clear & Changed and go back to page 1 when that happen
        this._subscriptions.push(this.filterService.onFilterChanged.subscribe(() => this.resetPagination()));
        this._subscriptions.push(this.filterService.onFilterCleared.subscribe(() => this.resetPagination()));
        // Subscribe to any dataview row count changed so that when Adding/Deleting item(s) through the DataView
        // that would trigger a refresh of the pagination numbers
        if (this.dataView) {
            this._subscriptions.push(this.gridService.onItemAdded.subscribe((items) => this.processOnItemAddedOrRemoved(items, true)));
            this._subscriptions.push(this.gridService.onItemDeleted.subscribe((items) => this.processOnItemAddedOrRemoved(items, false)));
        }
        this.refreshPagination(false, false);
        this._initialized = true;
    }
    dispose() {
        this._initialized = false;
        // unsubscribe all SlickGrid events
        this._eventHandler.unsubscribeAll();
        // also unsubscribe all Angular Subscriptions
        this._subscriptions = unsubscribeAllObservables(this._subscriptions);
    }
    getCurrentPageNumber() {
        return this._pageNumber;
    }
    getCurrentPagination() {
        return {
            pageNumber: this._pageNumber,
            pageSize: this._itemsPerPage,
            pageSizes: this._availablePageSizes,
        };
    }
    getFullPagination() {
        return {
            pageCount: this._pageCount,
            pageNumber: this._pageNumber,
            pageSize: this._itemsPerPage,
            pageSizes: this._availablePageSizes,
            totalItems: this._totalItems,
            dataFrom: this._dataFrom,
            dataTo: this._dataTo,
        };
    }
    getCurrentItemPerPage() {
        return this._itemsPerPage;
    }
    changeItemPerPage(itemsPerPage, event) {
        this._pageNumber = 1;
        this._pageCount = Math.ceil(this._totalItems / itemsPerPage);
        this._itemsPerPage = itemsPerPage;
        return this.processOnPageChanged(this._pageNumber, event);
    }
    goToFirstPage(event) {
        this._pageNumber = 1;
        return this.processOnPageChanged(this._pageNumber, event);
    }
    goToLastPage(event) {
        this._pageNumber = this._pageCount || 1;
        return this.processOnPageChanged(this._pageNumber, event);
    }
    goToNextPage(event) {
        if (this._pageNumber < this._pageCount) {
            this._pageNumber++;
            return this.processOnPageChanged(this._pageNumber, event);
        }
        else {
            return new Promise(resolve => resolve(false));
        }
    }
    goToPageNumber(pageNumber, event) {
        const previousPageNumber = this._pageNumber;
        if (pageNumber < 1) {
            this._pageNumber = 1;
        }
        else if (pageNumber > this._pageCount) {
            this._pageNumber = this._pageCount;
        }
        else {
            this._pageNumber = pageNumber;
        }
        if (this._pageNumber !== previousPageNumber) {
            return this.processOnPageChanged(this._pageNumber, event);
        }
        else {
            return new Promise(resolve => resolve(false));
        }
    }
    goToPreviousPage(event) {
        if (this._pageNumber > 1) {
            this._pageNumber--;
            return this.processOnPageChanged(this._pageNumber, event);
        }
        else {
            return new Promise(resolve => resolve(false));
        }
    }
    refreshPagination(isPageNumberReset = false, triggerChangedEvent = true) {
        const previousPagination = Object.assign({}, this.getCurrentPagination());
        if (this._paginationOptions) {
            const pagination = this._paginationOptions;
            // set the number of items per page if not already set
            if (!this._itemsPerPage) {
                if (this._isLocalGrid) {
                    this._itemsPerPage = pagination.pageSize;
                }
                else {
                    this._itemsPerPage = +((this._backendServiceApi && this._backendServiceApi.options && this._backendServiceApi.options.paginationOptions && this._backendServiceApi.options.paginationOptions.first) ? this._backendServiceApi.options.paginationOptions.first : pagination.pageSize);
                }
            }
            // if totalItems changed, we should always go back to the first page and recalculation the From-To indexes
            if (isPageNumberReset || this._totalItems !== pagination.totalItems) {
                if (isPageNumberReset) {
                    this._pageNumber = 1;
                    this.paginationOptions.pageNumber = 1;
                }
                else if (!this._initialized && pagination.pageNumber && pagination.pageNumber > 1) {
                    this._pageNumber = pagination.pageNumber || 1;
                }
                // when page number is set to 1 then also reset the "offset" of backend service
                if (this._pageNumber === 1 && this._backendServiceApi) {
                    this._backendServiceApi.service.resetPaginationOptions();
                }
            }
            // calculate and refresh the multiple properties of the pagination UI
            this._availablePageSizes = pagination.pageSizes;
            if (!this._totalItems && pagination.totalItems) {
                this._totalItems = pagination.totalItems;
            }
            this.recalculateFromToIndexes();
        }
        this._pageCount = Math.ceil(this._totalItems / this._itemsPerPage);
        const currentPagination = this.getCurrentPagination();
        this.sharedService.currentPagination = currentPagination;
        if (triggerChangedEvent && !isequal(previousPagination, currentPagination)) {
            this.onPaginationChanged.next(currentPagination);
        }
    }
    processOnPageChanged(pageNumber, event) {
        return new Promise((resolve, reject) => {
            this.recalculateFromToIndexes();
            if (this._isLocalGrid && this.dataView) {
                this.dataView.setPagingOptions({ pageSize: this._itemsPerPage, pageNum: (pageNumber - 1) }); // dataView page starts at 0 instead of 1
                this.onPaginationChanged.next(this.getFullPagination());
            }
            else {
                const itemsPerPage = +this._itemsPerPage;
                // keep start time & end timestamps & return it after process execution
                const startTime = new Date();
                // run any pre-process, if defined, for example a spinner
                if (this._backendServiceApi.preProcess) {
                    this._backendServiceApi.preProcess();
                }
                const query = this._backendServiceApi.service.processOnPaginationChanged(event, { newPage: pageNumber, pageSize: itemsPerPage });
                // the processes can be Promises or an Observables (like HttpClient)
                const process = this._backendServiceApi.process(query);
                if (process instanceof Promise) {
                    process
                        .then((processResult) => {
                        resolve(executeBackendProcessesCallback(startTime, processResult, this._backendServiceApi, this._totalItems));
                    })
                        .catch((error) => {
                        onBackendError(error, this._backendServiceApi);
                        reject(process);
                    });
                }
                else if (isObservable(process)) {
                    this._subscriptions.push(process.subscribe((processResult) => {
                        resolve(executeBackendProcessesCallback(startTime, processResult, this._backendServiceApi, this._totalItems));
                    }, (error) => {
                        onBackendError(error, this._backendServiceApi);
                        reject(process);
                    }));
                }
                this.onPaginationChanged.next(this.getFullPagination());
            }
        });
    }
    recalculateFromToIndexes() {
        if (this._totalItems === 0) {
            this._dataFrom = 0;
            this._dataTo = 1;
            this._pageNumber = 0;
        }
        else {
            this._dataFrom = this._pageNumber > 1 ? ((this._pageNumber * this._itemsPerPage) - this._itemsPerPage + 1) : 1;
            this._dataTo = (this._totalItems < this._itemsPerPage) ? this._totalItems : ((this._pageNumber || 1) * this._itemsPerPage);
            if (this._dataTo > this._totalItems) {
                this._dataTo = this._totalItems;
            }
        }
        this._pageNumber = (this._totalItems > 0 && this._pageNumber === 0) ? 1 : this._pageNumber;
        // do a final check on the From/To and make sure they are not over or below min/max acceptable values
        if (this._dataTo > this._totalItems) {
            this._dataTo = this._totalItems;
        }
        else if (this._totalItems < this._itemsPerPage) {
            this._dataTo = this._totalItems;
        }
    }
    /** Reset the Pagination to first page and recalculate necessary numbers */
    resetPagination(triggerChangedEvent = true) {
        if (this._isLocalGrid) {
            // on a local grid we also need to reset the DataView paging to 1st page
            this.dataView.setPagingOptions({ pageSize: this._itemsPerPage, pageNum: 0 });
        }
        this.refreshPagination(true, triggerChangedEvent);
    }
    /**
     * Toggle the Pagination (show/hide), it will use the visible if defined else it will automatically inverse when called without argument
     *
     * IMPORTANT NOTE:
     * The Pagination must be created on initial page load, then only after can you toggle it.
     * Basically this method WILL NOT WORK to show the Pagination if it was not there from the start.
     */
    togglePaginationVisibility(visible) {
        if (this.grid && this.sharedService && this.sharedService.gridOptions) {
            const isVisible = visible !== undefined ? visible : !this.sharedService.gridOptions.enablePagination;
            this.sharedService.gridOptions.enablePagination = isVisible;
            this.onPaginationVisibilityChanged.next({ visible: isVisible });
            // make sure to reset the Pagination and go back to first page to avoid any issues with Pagination being offset
            if (isVisible) {
                this.goToFirstPage();
            }
            // when using a local grid, we can reset the DataView pagination by changing its page size
            // page size of 0 would show all, hence cancel the pagination
            if (this._isLocalGrid) {
                const pageSize = visible ? this._itemsPerPage : 0;
                this.dataView.setPagingOptions({ pageSize, pageNum: 0 });
            }
        }
    }
    // --
    // private functions
    // --------------------
    updateTotalItems(totalItems, triggerChangedEvent = false) {
        this._totalItems = totalItems;
        if (this._paginationOptions) {
            this._paginationOptions.totalItems = totalItems;
            this.refreshPagination(false, triggerChangedEvent);
        }
    }
    /**
     * When item is added or removed, we will refresh the numbers on the pagination however we won't trigger a backend change
     * This will have a side effect though, which is that the "To" count won't be matching the "items per page" count,
     * that is a necessary side effect to avoid triggering a backend query just to refresh the paging,
     * basically we assume that this offset is fine for the time being,
     * until user does an action which will refresh the data hence the pagination which will then become normal again
     */
    processOnItemAddedOrRemoved(items, isItemAdded = true) {
        if (items !== null) {
            const previousDataTo = this._dataTo;
            const itemCount = Array.isArray(items) ? items.length : 1;
            const itemCountWithDirection = isItemAdded ? +itemCount : -itemCount;
            // refresh the total count in the pagination and in the UI
            this._totalItems += itemCountWithDirection;
            this.recalculateFromToIndexes();
            // finally refresh the "To" count and we know it might be different than the "items per page" count
            // but this is necessary since we don't want an actual backend refresh
            this._dataTo = previousDataTo + itemCountWithDirection;
            this.onPaginationChanged.next(this.getFullPagination());
        }
    }
};
PaginationService.ctorParameters = () => [
    { type: FilterService },
    { type: GridService },
    { type: SharedService }
];
PaginationService = tslib_1.__decorate([
    Injectable()
], PaginationService);
export { PaginationService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGFnaW5hdGlvbi5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vYW5ndWxhci1zbGlja2dyaWQvIiwic291cmNlcyI6WyJhcHAvbW9kdWxlcy9hbmd1bGFyLXNsaWNrZ3JpZC9zZXJ2aWNlcy9wYWdpbmF0aW9uLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDM0MsT0FBTyxFQUFnQixZQUFZLEVBQUUsT0FBTyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQzNELE9BQU8sS0FBSyxRQUFRLE1BQU0sZ0JBQWdCLENBQUM7QUFDM0MsTUFBTSxPQUFPLEdBQUcsUUFBUSxDQUFDLENBQUMsOEJBQThCO0FBR3hELE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSxrQkFBa0IsQ0FBQztBQUNqRCxPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDN0MsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLGtCQUFrQixDQUFDO0FBQ2pELE9BQU8sRUFBRSwrQkFBK0IsRUFBRSxjQUFjLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUN0RixPQUFPLEVBQUUseUJBQXlCLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFNeEQsSUFBYSxpQkFBaUIsR0FBOUIsTUFBYSxpQkFBaUI7SUFvQjVCLGtCQUFrQjtJQUNsQixZQUFvQixhQUE0QixFQUFVLFdBQXdCLEVBQVUsYUFBNEI7UUFBcEcsa0JBQWEsR0FBYixhQUFhLENBQWU7UUFBVSxnQkFBVyxHQUFYLFdBQVcsQ0FBYTtRQUFVLGtCQUFhLEdBQWIsYUFBYSxDQUFlO1FBcEJoSCxpQkFBWSxHQUFHLEtBQUssQ0FBQztRQUNyQixpQkFBWSxHQUFHLElBQUksQ0FBQztRQUVwQixjQUFTLEdBQUcsQ0FBQyxDQUFDO1FBQ2QsWUFBTyxHQUFHLENBQUMsQ0FBQztRQUVaLGVBQVUsR0FBRyxDQUFDLENBQUM7UUFDZixnQkFBVyxHQUFHLENB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LENBQUMsd0JBQXdCLEVBQUUsQ0FBQztZQUVoQyxtR0FBbUc7WUFDbkcsc0VBQXNFO1lBQ3RFLElBQUksQ0FBQyxPQUFPLEdBQUcsY0FBYyxHQUFHLHNCQUFzQixDQUFDO1lBQ3ZELElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLGlCQUFpQixFQUFFLENBQUMsQ0FBQztTQUN6RDtJQUNILENBQUM7Q0FDRixDQUFBOztZQXpXb0MsYUFBYTtZQUF1QixXQUFXO1lBQXlCLGFBQWE7O0FBckI3RyxpQkFBaUI7SUFEN0IsVUFBVSxFQUFFO0dBQ0EsaUJBQWlCLENBOFg3QjtTQTlYWSxpQkFBaUIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IFN1YnNjcmlwdGlvbiwgaXNPYnNlcnZhYmxlLCBTdWJqZWN0IH0gZnJvbSAncnhqcyc7XHJcbmltcG9ydCAqIGFzIGlzZXF1YWxfIGZyb20gJ2xvZGFzaC5pc2VxdWFsJztcclxuY29uc3QgaXNlcXVhbCA9IGlzZXF1YWxfOyAvLyBwYXRjaCB0byBmaXggcm9sbHVwIHRvIHdvcmtcclxuXHJcbmltcG9ydCB7IEJhY2tlbmRTZXJ2aWNlQXBpLCBDdXJyZW50UGFnaW5hdGlvbiwgR3JhcGhxbFJlc3VsdCwgR3JhcGhxbFBhZ2luYXRlZFJlc3VsdCwgR3JpZE9wdGlvbiwgUGFnaW5hdGlvbiwgU2VydmljZVBhZ2luYXRpb24gfSBmcm9tICcuLi9tb2RlbHMnO1xyXG5pbXBvcnQgeyBGaWx0ZXJTZXJ2aWNlIH0gZnJvbSAnLi9maWx0ZXIuc2VydmljZSc7XHJcbmltcG9ydCB7IEdyaWRTZXJ2aWNlIH0gZnJvbSAnLi9ncmlkLnNlcnZpY2UnO1xyXG5pbXBvcnQgeyBTaGFyZWRTZXJ2aWNlIH0gZnJvbSAnLi9zaGFyZWQuc2VydmljZSc7XHJcbmltcG9ydCB7IGV4ZWN1dGVCYWNrZW5kUHJvY2Vzc2VzQ2FsbGJhY2ssIG9uQmFja2VuZEVycm9yIH0gZnJvbSAnLi9iYWNrZW5kLXV0aWxpdGllcyc7XHJcbmltcG9ydCB7IHVuc3Vic2NyaWJlQWxsT2JzZXJ2YWJsZXMgfSBmcm9tICcuL3V0aWxpdGllcyc7XHJcblxyXG4vLyB1c2luZyBleHRlcm5hbCBub24tdHlwZWQganMgbGlicmFyaWVzXHJcbmRlY2xhcmUgY29uc3QgU2xpY2s6IGFueTtcclxuXHJcbkBJbmplY3RhYmxlKClcclxuZXhwb3J0IGNsYXNzIFBhZ2luYXRpb25TZXJ2aWNlIHtcclxuICBwcml2YXRlIF9pbml0aWFsaXplZCA9IGZhbHNlO1xyXG4gIHByaXZhdGUgX2lzTG9jYWxHcmlkID0gdHJ1ZTtcclxuICBwcml2YXRlIF9iYWNrZW5kU2VydmljZUFwaTogQmFja2VuZFNlcnZpY2VBcGk7XHJcbiAgcHJpdmF0ZSBfZGF0YUZyb20gPSAxO1xyXG4gIHByaXZhdGUgX2RhdGFUbyA9IDE7XHJcbiAgcHJpdmF0ZSBfaXRlbXNQZXJQYWdlOiBudW1iZXI7XHJcbiAgcHJpdmF0ZSBfcGFnZUNvdW50ID0gMTtcclxuICBwcml2YXRlIF9wYWdlTnVtYmVyID0gMTtcclxuICBwcml2YXRlIF90b3RhbEl0ZW1zID0gMDtcclxuICBwcml2YXRlIF9hdmFpbGFibGVQYWdlU2l6ZXM6IG51bWJlcltdO1xyXG4gIHByaXZhdGUgX2V2ZW50SGFuZGxlciA9IG5ldyBTbGljay5FdmVudEhhbmRsZXIoKTtcclxuICBwcml2YXRlIF9wYWdpbmF0aW9uT3B0aW9uczogUGFnaW5hdGlvbjtcclxuICBwcml2YXRlIF9zdWJzY3JpcHRpb25zOiBTdWJzY3JpcHRpb25bXSA9IFtdO1xyXG4gIG9uUGFnaW5hdGlvbkNoYW5nZWQgPSBuZXcgU3ViamVjdDxTZXJ2aWNlUGFnaW5hdGlvbj4oKTtcclxuICBvblBhZ2luYXRpb25WaXNpYmlsaXR5Q2hhbmdlZCA9IG5ldyBTdWJqZWN0PHsgdmlzaWJsZTogYm9vbGVhbiB9PigpO1xyXG5cclxuICBkYXRhVmlldzogYW55O1xyXG4gIGdyaWQ6IGFueTtcclxuXHJcbiAgLyoqIENvbnN0cnVjdG9yICovXHJcbiAgY29uc3RydWN0b3IocHJpdmF0ZSBmaWx0ZXJTZXJ2aWNlOiBGaWx0ZXJTZXJ2aWNlLCBwcml2YXRlIGdyaWRTZXJ2aWNlOiBHcmlkU2VydmljZSwgcHJpdmF0ZSBzaGFyZWRTZXJ2aWNlOiBTaGFyZWRTZXJ2aWNlKSB7IH1cclxuXHJcbiAgZ2V0IHBhZ2luYXRpb25PcHRpb25zKCk6IFBhZ2luYXRpb24ge1xyXG4gICAgcmV0dXJuIHRoaXMuX3BhZ2luYXRpb25PcHRpb25zO1xyXG4gIH1cclxuICBzZXQgcGFnaW5hdGlvbk9wdGlvbnMocGFnaW5hdGlvbk9wdGlvbnM6IFBhZ2luYXRpb24pIHtcclxuICAgIHRoaXMuX3BhZ2luYXRpb25PcHRpb25zID0gcGFnaW5hdGlvbk9wdGlvbnM7XHJcbiAgfVxyXG5cclxuICBnZXQgYXZhaWxhYmxlUGFnZVNpemVzKCk6IG51bWJlcltdIHtcclxuICAgIHJldHVybiB0aGlzLl9hdmFpbGFibGVQYWdlU2l6ZXM7XHJcbiAgfVxyXG5cclxuICBnZXQgZGF0YUZyb20oKTogbnVtYmVyIHtcclxuICAgIHJldHVybiB0aGlzLl9kYXRhRnJvbTtcclxuICB9XHJcblxyXG4gIGdldCBkYXRhVG8oKTogbnVtYmVyIHtcclxuICAgIHJldHVybiB0aGlzLl9kYXRhVG87XHJcbiAgfVxyXG5cclxuICBnZXQgaXRlbXNQZXJQYWdlKCk6IG51bWJlciB7XHJcbiAgICByZXR1cm4gdGhpcy5faXRlbXNQZXJQYWdlO1xyXG4gIH1cclxuXHJcbiAgZ2V0IHBhZ2VDb3VudCgpOiBudW1iZXIge1xyXG4gICAgcmV0dXJuIHRoaXMuX3BhZ2VDb3VudDtcclxuICB9XHJcblxyXG4gIGdldCBwYWdlTnVtYmVyKCk6IG51bWJlciB7XHJcbiAgICByZXR1cm4gdGhpcy5fcGFnZU51bWJlcjtcclxuICB9XHJcblxyXG4gIHNldCB0b3RhbEl0ZW1zKHRvdGFsSXRlbXM6IG51bWJlcikge1xyXG4gICAgdGhpcy5fdG90YWxJdGVtcyA9IHRvdGFsSXRlbXM7XHJcbiAgICBpZiAodGhpcy5faW5pdGlhbGl6ZWQpIHtcclxuICAgICAgdGhpcy5yZWZyZXNoUGFnaW5hdGlvbigpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgZ2V0IHRvdGFsSXRlbXMoKTogbnVtYmVyIHtcclxuICAgIHJldHVybiB0aGlzLl90b3RhbEl0ZW1zO1xyXG4gIH1cclxuXHJcbiAgaW5pdChncmlkOiBhbnksIGRhdGFWaWV3OiBhbnksIHBhZ2luYXRpb25PcHRpb25zOiBQYWdpbmF0aW9uLCBiYWNrZW5kU2VydmljZUFwaT86IEJhY2tlbmRTZXJ2aWNlQXBpKSB7XHJcbiAgICB0aGlzLl9hdmFpbGFibGVQYWdlU2l6ZXMgPSBwYWdpbmF0aW9uT3B0aW9ucy5wYWdlU2l6ZXM7XHJcbiAgICB0aGlzLmRhdGFWaWV3ID0gZGF0YVZpZXc7XHJcbiAgICB0aGlzLmdyaWQgPSBncmlkO1xyXG4gICAgdGhpcy5fYmFja2VuZFNlcnZpY2VBcGkgPSBiYWNrZW5kU2VydmljZUFwaTtcclxuICAgIHRoaXMuX3BhZ2luYXRpb25PcHRpb25zID0gcGFnaW5hdGlvbk9wdGlvbnM7XHJcbiAgICB0aGlzLl9pc0xvY2FsR3JpZCA9ICFiYWNrZW5kU2VydmljZUFwaTtcclxuICAgIHRoaXMuX3BhZ2VOdW1iZXIgPSBwYWdpbmF0aW9uT3B0aW9ucy5wYWdlTnVtYmVyIHx8IDE7XHJcblxyXG4gICAgaWYgKGJhY2tlbmRTZXJ2aWNlQXBpICYmICghYmFja2VuZFNlcnZpY2VBcGkuc2VydmljZSB8fCAhYmFja2VuZFNlcnZpY2VBcGkucHJvY2VzcykpIHtcclxuICAgICAgdGhyb3cgbmV3IEVycm9yKGBCYWNrZW5kU2VydmljZUFwaSByZXF1aXJlcyB0aGUgZm9sbG93aW5nIDIgcHJvcGVydGllcyBcInByb2Nlc3NcIiBhbmQgXCJzZXJ2aWNlXCIgdG8gYmUgZGVmaW5lZC5gKTtcclxuICAgIH1cclxuXHJcbiAgICBpZiAodGhpcy5faXNMb2NhbEdyaWQgJiYgdGhpcy5kYXRhVmlldykge1xyXG4gICAgICB0aGlzLl9ldmVudEhhbmRsZXIuc3Vic2NyaWJlKHRoaXMuZGF0YVZpZXcub25QYWdpbmdJbmZvQ2hhbmdlZCwgKGUsIHBhZ2luZ0luZm8pID0+IHtcclxuICAgICAgICBpZiAodGhpcy5fdG90YWxJdGVtcyAhPT0gcGFnaW5nSW5mby50b3RhbFJvd3MpIHtcclxuICAgICAgICAgIHRoaXMudXBkYXRlVG90YWxJdGVtcyhwYWdpbmdJbmZvLnRvdGFsUm93cyk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9KTtcclxuICAgICAgZGF0YVZpZXcuc2V0UmVmcmVzaEhpbnRzKHsgaXNGaWx0ZXJVbmNoYW5nZWQ6IHRydWUgfSk7XHJcbiAgICAgIGRhdGFWaWV3LnNldFBhZ2luZ09wdGlvbnMoeyBwYWdlU2l6ZTogdGhpcy5wYWdpbmF0aW9uT3B0aW9ucy5wYWdlU2l6ZSwgcGFnZU51bTogKHRoaXMuX3BhZ2VOdW1iZXIgLSAxKSB9KTsgLy8gZGF0YVZpZXcgcGFnZSBzdGFydHMgYXQgMCBpbnN0ZWFkIG9mIDFcclxuICAgIH1cclxuXHJcbiAgICAvLyBTdWJzY3JpYmUgdG8gRmlsdGVyIENsZWFyICYgQ2hhbmdlZCBhbmQgZ28gYmFjayB0byBwYWdlIDEgd2hlbiB0aGF0IGhhcHBlblxyXG4gICAgdGhpcy5fc3Vic2NyaXB0aW9ucy5wdXNoKHRoaXMuZmlsdGVyU2VydmljZS5vbkZpbHRlckNoYW5nZWQuc3Vic2NyaWJlKCgpID0+IHRoaXMucmVzZXRQYWdpbmF0aW9uKCkpKTtcclxuICAgIHRoaXMuX3N1YnNjcmlwdGlvbnMucHVzaCh0aGlzLmZpbHRlclNlcnZpY2Uub25GaWx0ZXJDbGVhcmVkLnN1YnNjcmliZSgoKSA9PiB0aGlzLnJlc2V0UGFnaW5hdGlvbigpKSk7XHJcblxyXG4gICAgLy8gU3Vic2NyaWJlIHRvIGFueSBkYXRhdmlldyByb3cgY291bnQgY2hhbmdlZCBzbyB0aGF0IHdoZW4gQWRkaW5nL0RlbGV0aW5nIGl0ZW0ocykgdGhyb3VnaCB0aGUgRGF0YVZpZXdcclxuICAgIC8vIHRoYXQgd291bGQgdHJpZ2dlciBhIHJlZnJlc2ggb2YgdGhlIHBhZ2luYXRpb24gbnVtYmVyc1xyXG4gICAgaWYgKHRoaXMuZGF0YVZpZXcpIHtcclxuICAgICAgdGhpcy5fc3Vic2NyaXB0aW9ucy5wdXNoKHRoaXMuZ3JpZFNlcnZpY2Uub25JdGVtQWRkZWQuc3Vic2NyaWJlKChpdGVtczogYW55IHwgYW55W10pID0+IHRoaXMucHJvY2Vzc09uSXRlbUFkZGVkT3JSZW1vdmVkKGl0ZW1zLCB0cnVlKSkpO1xyXG4gICAgICB0aGlzLl9zdWJzY3JpcHRpb25zLnB1c2godGhpcy5ncmlkU2VydmljZS5vbkl0ZW1EZWxldGVkLnN1YnNjcmliZSgoaXRlbXM6IGFueSB8IGFueVtdKSA9PiB0aGlzLnByb2Nlc3NPbkl0ZW1BZGRlZE9yUmVtb3ZlZChpdGVtcywgZmFsc2UpKSk7XHJcbiAgICB9XHJcblxyXG4gICAgdGhpcy5yZWZyZXNoUGFnaW5hdGlvbihmYWxzZSwgZmFsc2UpO1xyXG4gICAgdGhpcy5faW5pdGlhbGl6ZWQgPSB0cnVlO1xyXG4gIH1cclxuXHJcbiAgZGlzcG9zZSgpIHtcclxuICAgIHRoaXMuX2luaXRpYWxpemVkID0gZmFsc2U7XHJcblxyXG4gICAgLy8gdW5zdWJzY3JpYmUgYWxsIFNsaWNrR3JpZCBldmVudHNcclxuICAgIHRoaXMuX2V2ZW50SGFuZGxlci51bnN1YnNjcmliZUFsbCgpO1xyXG5cclxuICAgIC8vIGFsc28gdW5zdWJzY3JpYmUgYWxsIEFuZ3VsYXIgU3Vic2NyaXB0aW9uc1xyXG4gICAgdGhpcy5fc3Vic2NyaXB0aW9ucyA9IHVuc3Vic2NyaWJlQWxsT2JzZXJ2YWJsZXModGhpcy5fc3Vic2NyaXB0aW9ucyk7XHJcbiAgfVxyXG5cclxuICBnZXRDdXJyZW50UGFnZU51bWJlcigpOiBudW1iZXIge1xyXG4gICAgcmV0dXJuIHRoaXMuX3BhZ2VOdW1iZXI7XHJcbiAgfVxyXG5cclxuICBnZXRDdXJyZW50UGFnaW5hdGlvbigpOiBDdXJyZW50UGFnaW5hdGlvbiAmIHsgcGFnZVNpemVzOiBudW1iZXJbXSB9IHtcclxuICAgIHJldHVybiB7XHJcbiAgICAgIHBhZ2VOdW1iZXI6IHRoaXMuX3BhZ2VOdW1iZXIsXHJcbiAgICAgIHBhZ2VTaXplOiB0aGlzLl9pdGVtc1BlclBhZ2UsXHJcbiAgICAgIHBhZ2VTaXplczogdGhpcy5fYXZhaWxhYmxlUGFnZVNpemVzLFxyXG4gICAgfTtcclxuICB9XHJcblxyXG4gIGdldEZ1bGxQYWdpbmF0aW9uKCk6IFNlcnZpY2VQYWdpbmF0aW9uIHtcclxuICAgIHJldHVybiB7XHJcbiAgICAgIHBhZ2VDb3VudDogdGhpcy5fcGFnZUNvdW50LFxyXG4gICAgICBwYWdlTnVtYmVyOiB0aGlzLl9wYWdlTnVtYmVyLFxyXG4gICAgICBwYWdlU2l6ZTogdGhpcy5faXRlbXNQZXJQYWdlLFxyXG4gICAgICBwYWdlU2l6ZXM6IHRoaXMuX2F2YWlsYWJsZVBhZ2VTaXplcyxcclxuICAgICAgdG90YWxJdGVtczogdGhpcy5fdG90YWxJdGVtcyxcclxuICAgICAgZGF0YUZyb206IHRoaXMuX2RhdGFGcm9tLFxyXG4gICAgICBkYXRhVG86IHRoaXMuX2RhdGFUbyxcclxuICAgIH07XHJcbiAgfVxyXG5cclxuICBnZXRDdXJyZW50SXRlbVBlclBhZ2UoKTogbnVtYmVyIHtcclxuICAgIHJldHVybiB0aGlzLl9pdGVtc1BlclBhZ2U7XHJcbiAgfVxyXG5cclxuICBjaGFuZ2VJdGVtUGVyUGFnZShpdGVtc1BlclBhZ2U6IG51bWJlciwgZXZlbnQ/OiBhbnkpOiBQcm9taXNlPGFueT4ge1xyXG4gICAgdGhpcy5fcGFnZU51bWJlciA9IDE7XHJcbiAgICB0aGlzLl9wYWdlQ291bnQgPSBNYXRoLmNlaWwodGhpcy5fdG90YWxJdGVtcyAvIGl0ZW1zUGVyUGFnZSk7XHJcbiAgICB0aGlzLl9pdGVtc1BlclBhZ2UgPSBpdGVtc1BlclBhZ2U7XHJcbiAgICByZXR1cm4gdGhpcy5wcm9jZXNzT25QYWdlQ2hhbmdlZCh0aGlzLl9wYWdlTnVtYmVyLCBldmVudCk7XHJcbiAgfVxyXG5cclxuICBnb1RvRmlyc3RQYWdlKGV2ZW50PzogYW55KTogUHJvbWlzZTxhbnk+IHtcclxuICAgIHRoaXMuX3BhZ2VOdW1iZXIgPSAxO1xyXG4gICAgcmV0dXJuIHRoaXMucHJvY2Vzc09uUGFnZUNoYW5nZWQodGhpcy5fcGFnZU51bWJlciwgZXZlbnQpO1xyXG4gIH1cclxuXHJcbiAgZ29Ub0xhc3RQYWdlKGV2ZW50PzogYW55KTogUHJvbWlzZTxhbnk+IHtcclxuICAgIHRoaXMuX3BhZ2VOdW1iZXIgPSB0aGlzLl9wYWdlQ291bnQgfHwgMTtcclxuICAgIHJldHVybiB0aGlzLnByb2Nlc3NPblBhZ2VDaGFuZ2VkKHRoaXMuX3BhZ2VOdW1iZXIsIGV2ZW50KTtcclxuICB9XHJcblxyXG4gIGdvVG9OZXh0UGFnZShldmVudD86IGFueSk6IFByb21pc2U8YW55PiB7XHJcbiAgICBpZiAodGhpcy5fcGFnZU51bWJlciA8IHRoaXMuX3BhZ2VDb3VudCkge1xyXG4gICAgICB0aGlzLl9wYWdlTnVtYmVyKys7XHJcbiAgICAgIHJldHVybiB0aGlzLnByb2Nlc3NPblBhZ2VDaGFuZ2VkKHRoaXMuX3BhZ2VOdW1iZXIsIGV2ZW50KTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHJldHVybiBuZXcgUHJvbWlzZShyZXNvbHZlID0+IHJlc29sdmUoZmFsc2UpKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIGdvVG9QYWdlTnVtYmVyKHBhZ2VOdW1iZXI6IG51bWJlciwgZXZlbnQ/OiBhbnkpOiBQcm9taXNlPGFueT4ge1xyXG4gICAgY29uc3QgcHJldmlvdXNQYWdlTnVtYmVyID0gdGhpcy5fcGFnZU51bWJlcjtcclxuXHJcbiAgICBpZiAocGFnZU51bWJlciA8IDEpIHtcclxuICAgICAgdGhpcy5fcGFnZU51bWJlciA9IDE7XHJcbiAgICB9IGVsc2UgaWYgKHBhZ2VOdW1iZXIgPiB0aGlzLl9wYWdlQ291bnQpIHtcclxuICAgICAgdGhpcy5fcGFnZU51bWJlciA9IHRoaXMuX3BhZ2VDb3VudDtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHRoaXMuX3BhZ2VOdW1iZXIgPSBwYWdlTnVtYmVyO1xyXG4gICAgfVxyXG5cclxuICAgIGlmICh0aGlzLl9wYWdlTnVtYmVyICE9PSBwcmV2aW91c1BhZ2VOdW1iZXIpIHtcclxuICAgICAgcmV0dXJuIHRoaXMucHJvY2Vzc09uUGFnZUNoYW5nZWQodGhpcy5fcGFnZU51bWJlciwgZXZlbnQpO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKHJlc29sdmUgPT4gcmVzb2x2ZShmYWxzZSkpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgZ29Ub1ByZXZpb3VzUGFnZShldmVudD86IGFueSk6IFByb21pc2U8YW55PiB7XHJcbiAgICBpZiAodGhpcy5fcGFnZU51bWJlciA+IDEpIHtcclxuICAgICAgdGhpcy5fcGFnZU51bWJlci0tO1xyXG4gICAgICByZXR1cm4gdGhpcy5wcm9jZXNzT25QYWdlQ2hhbmdlZCh0aGlzLl9wYWdlTnVtYmVyLCBldmVudCk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICByZXR1cm4gbmV3IFByb21pc2UocmVzb2x2ZSA9PiByZXNvbHZlKGZhbHNlKSk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICByZWZyZXNoUGFnaW5hdGlvbihpc1BhZ2VOdW1iZXJSZXNldDogYm9vbGVhbiA9IGZhbHNlLCB0cmlnZ2VyQ2hhbmdlZEV2ZW50ID0gdHJ1ZSkge1xyXG4gICAgY29uc3QgcHJldmlvdXNQYWdpbmF0aW9uID0geyAuLi50aGlzLmdldEN1cnJlbnRQYWdpbmF0aW9uKCkgfTtcclxuXHJcbiAgICBpZiAodGhpcy5fcGFnaW5hdGlvbk9wdGlvbnMpIHtcclxuICAgICAgY29uc3QgcGFnaW5hdGlvbiA9IHRoaXMuX3BhZ2luYXRpb25PcHRpb25zO1xyXG5cclxuICAgICAgLy8gc2V0IHRoZSBudW1iZXIgb2YgaXRlbXMgcGVyIHBhZ2UgaWYgbm90IGFscmVhZHkgc2V0XHJcbiAgICAgIGlmICghdGhpcy5faXRlbXNQZXJQYWdlKSB7XHJcbiAgICAgICAgaWYgKHRoaXMuX2lzTG9jYWxHcmlkKSB7XHJcbiAgICAgICAgICB0aGlzLl9pdGVtc1BlclBhZ2UgPSBwYWdpbmF0aW9uLnBhZ2VTaXplO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICB0aGlzLl9pdGVtc1BlclBhZ2UgPSArKCh0aGlzLl9iYWNrZW5kU2VydmljZUFwaSAmJiB0aGlzLl9iYWNrZW5kU2VydmljZUFwaS5vcHRpb25zICYmIHRoaXMuX2JhY2tlbmRTZXJ2aWNlQXBpLm9wdGlvbnMucGFnaW5hdGlvbk9wdGlvbnMgJiYgdGhpcy5fYmFja2VuZFNlcnZpY2VBcGkub3B0aW9ucy5wYWdpbmF0aW9uT3B0aW9ucy5maXJzdCkgPyB0aGlzLl9iYWNrZW5kU2VydmljZUFwaS5vcHRpb25zLnBhZ2luYXRpb25PcHRpb25zLmZpcnN0IDogcGFnaW5hdGlvbi5wYWdlU2l6ZSk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcblxyXG4gICAgICAvLyBpZiB0b3RhbEl0ZW1zIGNoYW5nZWQsIHdlIHNob3VsZCBhbHdheXMgZ28gYmFjayB0byB0aGUgZmlyc3QgcGFnZSBhbmQgcmVjYWxjdWxhdGlvbiB0aGUgRnJvbS1UbyBpbmRleGVzXHJcbiAgICAgIGlmIChpc1BhZ2VOdW1iZXJSZXNldCB8fCB0aGlzLl90b3RhbEl0ZW1zICE9PSBwYWdpbmF0aW9uLnRvdGFsSXRlbXMpIHtcclxuICAgICAgICBpZiAoaXNQYWdlTnVtYmVyUmVzZXQpIHtcclxuICAgICAgICAgIHRoaXMuX3BhZ2VOdW1iZXIgPSAxO1xyXG4gICAgICAgICAgdGhpcy5wYWdpbmF0aW9uT3B0aW9ucy5wYWdlTnVtYmVyID0gMTtcclxuICAgICAgICB9IGVsc2UgaWYgKCF0aGlzLl9pbml0aWFsaXplZCAmJiBwYWdpbmF0aW9uLnBhZ2VOdW1iZXIgJiYgcGFnaW5hdGlvbi5wYWdlTnVtYmVyID4gMSkge1xyXG4gICAgICAgICAgdGhpcy5fcGFnZU51bWJlciA9IHBhZ2luYXRpb24ucGFnZU51bWJlciB8fCAxO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgLy8gd2hlbiBwYWdlIG51bWJlciBpcyBzZXQgdG8gMSB0aGVuIGFsc28gcmVzZXQgdGhlIFwib2Zmc2V0XCIgb2YgYmFja2VuZCBzZXJ2aWNlXHJcbiAgICAgICAgaWYgKHRoaXMuX3BhZ2VOdW1iZXIgPT09IDEgJiYgdGhpcy5fYmFja2VuZFNlcnZpY2VBcGkpIHtcclxuICAgICAgICAgIHRoaXMuX2JhY2tlbmRTZXJ2aWNlQXBpLnNlcnZpY2UucmVzZXRQYWdpbmF0aW9uT3B0aW9ucygpO1xyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG5cclxuICAgICAgLy8gY2FsY3VsYXRlIGFuZCByZWZyZXNoIHRoZSBtdWx0aXBsZSBwcm9wZXJ0aWVzIG9mIHRoZSBwYWdpbmF0aW9uIFVJXHJcbiAgICAgIHRoaXMuX2F2YWlsYWJsZVBhZ2VTaXplcyA9IHBhZ2luYXRpb24ucGFnZVNpemVzO1xyXG4gICAgICBpZiAoIXRoaXMuX3RvdGFsSXRlbXMgJiYgcGFnaW5hdGlvbi50b3RhbEl0ZW1zKSB7XHJcbiAgICAgICAgdGhpcy5fdG90YWxJdGVtcyA9IHBhZ2luYXRpb24udG90YWxJdGVtcztcclxuICAgICAgfVxyXG4gICAgICB0aGlzLnJlY2FsY3VsYXRlRnJvbVRvSW5kZXhlcygpO1xyXG4gICAgfVxyXG4gICAgdGhpcy5fcGFnZUNvdW50ID0gTWF0aC5jZWlsKHRoaXMuX3RvdGFsSXRlbXMgLyB0aGlzLl9pdGVtc1BlclBhZ2UpO1xyXG4gICAgY29uc3QgY3VycmVudFBhZ2luYXRpb24gPSB0aGlzLmdldEN1cnJlbnRQYWdpbmF0aW9uKCk7XHJcbiAgICB0aGlzLnNoYXJlZFNlcnZpY2UuY3VycmVudFBhZ2luYXRpb24gPSBjdXJyZW50UGFnaW5hdGlvbjtcclxuXHJcbiAgICBpZiAodHJpZ2dlckNoYW5nZWRFdmVudCAmJiAhaXNlcXVhbChwcmV2aW91c1BhZ2luYXRpb24sIGN1cnJlbnRQYWdpbmF0aW9uKSkge1xyXG4gICAgICB0aGlzLm9uUGFnaW5hdGlvbkNoYW5nZWQubmV4dChjdXJyZW50UGFnaW5hdGlvbik7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBwcm9jZXNzT25QYWdlQ2hhbmdlZChwYWdlTnVtYmVyOiBudW1iZXIsIGV2ZW50PzogRXZlbnQgfCB1bmRlZmluZWQpOiBQcm9taXNlPGFueT4ge1xyXG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcclxuICAgICAgdGhpcy5yZWNhbGN1bGF0ZUZyb21Ub0luZGV4ZXMoKTtcclxuXHJcbiAgICAgIGlmICh0aGlzLl9pc0xvY2FsR3JpZCAmJiB0aGlzLmRhdGFWaWV3KSB7XHJcbiAgICAgICAgdGhpcy5kYXRhVmlldy5zZXRQYWdpbmdPcHRpb25zKHsgcGFnZVNpemU6IHRoaXMuX2l0ZW1zUGVyUGFnZSwgcGFnZU51bTogKHBhZ2VOdW1iZXIgLSAxKSB9KTsgLy8gZGF0YVZpZXcgcGFnZSBzdGFydHMgYXQgMCBpbnN0ZWFkIG9mIDFcclxuICAgICAgICB0aGlzLm9uUGFnaW5hdGlvbkNoYW5nZWQubmV4dCh0aGlzLmdldEZ1bGxQYWdpbmF0aW9uKCkpO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIGNvbnN0IGl0ZW1zUGVyUGFnZSA9ICt0aGlzLl9pdGVtc1BlclBhZ2U7XHJcblxyXG4gICAgICAgIC8vIGtlZXAgc3RhcnQgdGltZSAmIGVuZCB0aW1lc3RhbXBzICYgcmV0dXJuIGl0IGFmdGVyIHByb2Nlc3MgZXhlY3V0aW9uXHJcbiAgICAgICAgY29uc3Qgc3RhcnRUaW1lID0gbmV3IERhdGUoKTtcclxuXHJcbiAgICAgICAgLy8gcnVuIGFueSBwcmUtcHJvY2VzcywgaWYgZGVmaW5lZCwgZm9yIGV4YW1wbGUgYSBzcGlubmVyXHJcbiAgICAgICAgaWYgKHRoaXMuX2JhY2tlbmRTZXJ2aWNlQXBpLnByZVByb2Nlc3MpIHtcclxuICAgICAgICAgIHRoaXMuX2JhY2tlbmRTZXJ2aWNlQXBpLnByZVByb2Nlc3MoKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGNvbnN0IHF1ZXJ5ID0gdGhpcy5fYmFja2VuZFNlcnZpY2VBcGkuc2VydmljZS5wcm9jZXNzT25QYWdpbmF0aW9uQ2hhbmdlZChldmVudCwgeyBuZXdQYWdlOiBwYWdlTnVtYmVyLCBwYWdlU2l6ZTogaXRlbXNQZXJQYWdlIH0pO1xyXG5cclxuICAgICAgICAvLyB0aGUgcHJvY2Vzc2VzIGNhbiBiZSBQcm9taXNlcyBvciBhbiBPYnNlcnZhYmxlcyAobGlrZSBIdHRwQ2xpZW50KVxyXG4gICAgICAgIGNvbnN0IHByb2Nlc3MgPSB0aGlzLl9iYWNrZW5kU2VydmljZUFwaS5wcm9jZXNzKHF1ZXJ5KTtcclxuICAgICAgICBpZiAocHJvY2VzcyBpbnN0YW5jZW9mIFByb21pc2UpIHtcclxuICAgICAgICAgIHByb2Nlc3NcclxuICAgICAgICAgICAgLnRoZW4oKHByb2Nlc3NSZXN1bHQ6IEdyYXBocWxSZXN1bHQgfCBHcmFwaHFsUGFnaW5hdGVkUmVzdWx0IHwgYW55KSA9PiB7XHJcbiAgICAgICAgICAgICAgcmVzb2x2ZShleGVjdXRlQmFja2VuZFByb2Nlc3Nlc0NhbGxiYWNrKHN0YXJ0VGltZSwgcHJvY2Vzc1Jlc3VsdCwgdGhpcy5fYmFja2VuZFNlcnZpY2VBcGksIHRoaXMuX3RvdGFsSXRlbXMpKTtcclxuICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgLmNhdGNoKChlcnJvcikgPT4ge1xyXG4gICAgICAgICAgICAgIG9uQmFja2VuZEVycm9yKGVycm9yLCB0aGlzLl9iYWNrZW5kU2VydmljZUFwaSk7XHJcbiAgICAgICAgICAgICAgcmVqZWN0KHByb2Nlc3MpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9IGVsc2UgaWYgKGlzT2JzZXJ2YWJsZShwcm9jZXNzKSkge1xyXG4gICAgICAgICAgdGhpcy5fc3Vic2NyaXB0aW9ucy5wdXNoKFxyXG4gICAgICAgICAgICBwcm9jZXNzLnN1YnNjcmliZShcclxuICAgICAgICAgICAgICAocHJvY2Vzc1Jlc3VsdDogR3JhcGhxbFJlc3VsdCB8IEdyYXBocWxQYWdpbmF0ZWRSZXN1bHQgfCBhbnkpID0+IHtcclxuICAgICAgICAgICAgICAgIHJlc29sdmUoZXhlY3V0ZUJhY2tlbmRQcm9jZXNzZXNDYWxsYmFjayhzdGFydFRpbWUsIHByb2Nlc3NSZXN1bHQsIHRoaXMuX2JhY2tlbmRTZXJ2aWNlQXBpLCB0aGlzLl90b3RhbEl0ZW1zKSk7XHJcbiAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAoZXJyb3I6IGFueSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgb25CYWNrZW5kRXJyb3IoZXJyb3IsIHRoaXMuX2JhY2tlbmRTZXJ2aWNlQXBpKTtcclxuICAgICAgICAgICAgICAgIHJlamVjdChwcm9jZXNzKTtcclxuICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIClcclxuICAgICAgICAgICk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXMub25QYWdpbmF0aW9uQ2hhbmdlZC5uZXh0KHRoaXMuZ2V0RnVsbFBhZ2luYXRpb24oKSk7XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgcmVjYWxjdWxhdGVGcm9tVG9JbmRleGVzKCkge1xyXG4gICAgaWYgKHRoaXMuX3RvdGFsSXRlbXMgPT09IDApIHtcclxuICAgICAgdGhpcy5fZGF0YUZyb20gPSAwO1xyXG4gICAgICB0aGlzLl9kYXRhVG8gPSAxO1xyXG4gICAgICB0aGlzLl9wYWdlTnVtYmVyID0gMDtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHRoaXMuX2RhdGFGcm9tID0gdGhpcy5fcGFnZU51bWJlciA+IDEgPyAoKHRoaXMuX3BhZ2VOdW1iZXIgKiB0aGlzLl9pdGVtc1BlclBhZ2UpIC0gdGhpcy5faXRlbXNQZXJQYWdlICsgMSkgOiAxO1xyXG4gICAgICB0aGlzLl9kYXRhVG8gPSAodGhpcy5fdG90YWxJdGVtcyA8IHRoaXMuX2l0ZW1zUGVyUGFnZSkgPyB0aGlzLl90b3RhbEl0ZW1zIDogKCh0aGlzLl9wYWdlTnVtYmVyIHx8IDEpICogdGhpcy5faXRlbXNQZXJQYWdlKTtcclxuICAgICAgaWYgKHRoaXMuX2RhdGFUbyA+IHRoaXMuX3RvdGFsSXRlbXMpIHtcclxuICAgICAgICB0aGlzLl9kYXRhVG8gPSB0aGlzLl90b3RhbEl0ZW1zO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgICB0aGlzLl9wYWdlTnVtYmVyID0gKHRoaXMuX3RvdGFsSXRlbXMgPiAwICYmIHRoaXMuX3BhZ2VOdW1iZXIgPT09IDApID8gMSA6IHRoaXMuX3BhZ2VOdW1iZXI7XHJcblxyXG4gICAgLy8gZG8gYSBmaW5hbCBjaGVjayBvbiB0aGUgRnJvbS9UbyBhbmQgbWFrZSBzdXJlIHRoZXkgYXJlIG5vdCBvdmVyIG9yIGJlbG93IG1pbi9tYXggYWNjZXB0YWJsZSB2YWx1ZXNcclxuICAgIGlmICh0aGlzLl9kYXRhVG8gPiB0aGlzLl90b3RhbEl0ZW1zKSB7XHJcbiAgICAgIHRoaXMuX2RhdGFUbyA9IHRoaXMuX3RvdGFsSXRlbXM7XHJcbiAgICB9IGVsc2UgaWYgKHRoaXMuX3RvdGFsSXRlbXMgPCB0aGlzLl9pdGVtc1BlclBhZ2UpIHtcclxuICAgICAgdGhpcy5fZGF0YVRvID0gdGhpcy5fdG90YWxJdGVtcztcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8qKiBSZXNldCB0aGUgUGFnaW5hdGlvbiB0byBmaXJzdCBwYWdlIGFuZCByZWNhbGN1bGF0ZSBuZWNlc3NhcnkgbnVtYmVycyAqL1xyXG4gIHJlc2V0UGFnaW5hdGlvbih0cmlnZ2VyQ2hhbmdlZEV2ZW50ID0gdHJ1ZSkge1xyXG4gICAgaWYgKHRoaXMuX2lzTG9jYWxHcmlkKSB7XHJcbiAgICAgIC8vIG9uIGEgbG9jYWwgZ3JpZCB3ZSBhbHNvIG5lZWQgdG8gcmVzZXQgdGhlIERhdGFWaWV3IHBhZ2luZyB0byAxc3QgcGFnZVxyXG4gICAgICB0aGlzLmRhdGFWaWV3LnNldFBhZ2luZ09wdGlvbnMoeyBwYWdlU2l6ZTogdGhpcy5faXRlbXNQZXJQYWdlLCBwYWdlTnVtOiAwIH0pO1xyXG4gICAgfVxyXG4gICAgdGhpcy5yZWZyZXNoUGFnaW5hdGlvbih0cnVlLCB0cmlnZ2VyQ2hhbmdlZEV2ZW50KTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFRvZ2dsZSB0aGUgUGFnaW5hdGlvbiAoc2hvdy9oaWRlKSwgaXQgd2lsbCB1c2UgdGhlIHZpc2libGUgaWYgZGVmaW5lZCBlbHNlIGl0IHdpbGwgYXV0b21hdGljYWxseSBpbnZlcnNlIHdoZW4gY2FsbGVkIHdpdGhvdXQgYXJndW1lbnRcclxuICAgKlxyXG4gICAqIElNUE9SVEFOVCBOT1RFOlxyXG4gICAqIFRoZSBQYWdpbmF0aW9uIG11c3QgYmUgY3JlYXRlZCBvbiBpbml0aWFsIHBhZ2UgbG9hZCwgdGhlbiBvbmx5IGFmdGVyIGNhbiB5b3UgdG9nZ2xlIGl0LlxyXG4gICAqIEJhc2ljYWxseSB0aGlzIG1ldGhvZCBXSUxMIE5PVCBXT1JLIHRvIHNob3cgdGhlIFBhZ2luYXRpb24gaWYgaXQgd2FzIG5vdCB0aGVyZSBmcm9tIHRoZSBzdGFydC5cclxuICAgKi9cclxuICB0b2dnbGVQYWdpbmF0aW9uVmlzaWJpbGl0eSh2aXNpYmxlPzogYm9vbGVhbikge1xyXG4gICAgaWYgKHRoaXMuZ3JpZCAmJiB0aGlzLnNoYXJlZFNlcnZpY2UgJiYgdGhpcy5zaGFyZWRTZXJ2aWNlLmdyaWRPcHRpb25zKSB7XHJcbiAgICAgIGNvbnN0IGlzVmlzaWJsZSA9IHZpc2libGUgIT09IHVuZGVmaW5lZCA/IHZpc2libGUgOiAhdGhpcy5zaGFyZWRTZXJ2aWNlLmdyaWRPcHRpb25zLmVuYWJsZVBhZ2luYXRpb247XHJcbiAgICAgIHRoaXMuc2hhcmVkU2VydmljZS5ncmlkT3B0aW9ucy5lbmFibGVQYWdpbmF0aW9uID0gaXNWaXNpYmxlO1xyXG4gICAgICB0aGlzLm9uUGFnaW5hdGlvblZpc2liaWxpdHlDaGFuZ2VkLm5leHQoeyB2aXNpYmxlOiBpc1Zpc2libGUgfSk7XHJcblxyXG4gICAgICAvLyBtYWtlIHN1cmUgdG8gcmVzZXQgdGhlIFBhZ2luYXRpb24gYW5kIGdvIGJhY2sgdG8gZmlyc3QgcGFnZSB0byBhdm9pZCBhbnkgaXNzdWVzIHdpdGggUGFnaW5hdGlvbiBiZWluZyBvZmZzZXRcclxuICAgICAgaWYgKGlzVmlzaWJsZSkge1xyXG4gICAgICAgIHRoaXMuZ29Ub0ZpcnN0UGFnZSgpO1xyXG4gICAgICB9XHJcblxyXG4gICAgICAvLyB3aGVuIHVzaW5nIGEgbG9jYWwgZ3JpZCwgd2UgY2FuIHJlc2V0IHRoZSBEYXRhVmlldyBwYWdpbmF0aW9uIGJ5IGNoYW5naW5nIGl0cyBwYWdlIHNpemVcclxuICAgICAgLy8gcGFnZSBzaXplIG9mIDAgd291bGQgc2hvdyBhbGwsIGhlbmNlIGNhbmNlbCB0aGUgcGFnaW5hdGlvblxyXG4gICAgICBpZiAodGhpcy5faXNMb2NhbEdyaWQpIHtcclxuICAgICAgICBjb25zdCBwYWdlU2l6ZSA9IHZpc2libGUgPyB0aGlzLl9pdGVtc1BlclBhZ2UgOiAwO1xyXG4gICAgICAgIHRoaXMuZGF0YVZpZXcuc2V0UGFnaW5nT3B0aW9ucyh7IHBhZ2VTaXplLCBwYWdlTnVtOiAwIH0pO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvLyAtLVxyXG4gIC8vIHByaXZhdGUgZnVuY3Rpb25zXHJcbiAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS1cclxuXHJcbiAgdXBkYXRlVG90YWxJdGVtcyh0b3RhbEl0ZW1zOiBudW1iZXIsIHRyaWdnZXJDaGFuZ2VkRXZlbnQgPSBmYWxzZSkge1xyXG4gICAgdGhpcy5fdG90YWxJdGVtcyA9IHRvdGFsSXRlbXM7XHJcbiAgICBpZiAodGhpcy5fcGFnaW5hdGlvbk9wdGlvbnMpIHtcclxuICAgICAgdGhpcy5fcGFnaW5hdGlvbk9wdGlvbnMudG90YWxJdGVtcyA9IHRvdGFsSXRlbXM7XHJcbiAgICAgIHRoaXMucmVmcmVzaFBhZ2luYXRpb24oZmFsc2UsIHRyaWdnZXJDaGFuZ2VkRXZlbnQpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogV2hlbiBpdGVtIGlzIGFkZGVkIG9yIHJlbW92ZWQsIHdlIHdpbGwgcmVmcmVzaCB0aGUgbnVtYmVycyBvbiB0aGUgcGFnaW5hdGlvbiBob3dldmVyIHdlIHdvbid0IHRyaWdnZXIgYSBiYWNrZW5kIGNoYW5nZVxyXG4gICAqIFRoaXMgd2lsbCBoYXZlIGEgc2lkZSBlZmZlY3QgdGhvdWdoLCB3aGljaCBpcyB0aGF0IHRoZSBcIlRvXCIgY291bnQgd29uJ3QgYmUgbWF0Y2hpbmcgdGhlIFwiaXRlbXMgcGVyIHBhZ2VcIiBjb3VudCxcclxuICAgKiB0aGF0IGlzIGEgbmVjZXNzYXJ5IHNpZGUgZWZmZWN0IHRvIGF2b2lkIHRyaWdnZXJpbmcgYSBiYWNrZW5kIHF1ZXJ5IGp1c3QgdG8gcmVmcmVzaCB0aGUgcGFnaW5nLFxyXG4gICAqIGJhc2ljYWxseSB3ZSBhc3N1bWUgdGhhdCB0aGlzIG9mZnNldCBpcyBmaW5lIGZvciB0aGUgdGltZSBiZWluZyxcclxuICAgKiB1bnRpbCB1c2VyIGRvZXMgYW4gYWN0aW9uIHdoaWNoIHdpbGwgcmVmcmVzaCB0aGUgZGF0YSBoZW5jZSB0aGUgcGFnaW5hdGlvbiB3aGljaCB3aWxsIHRoZW4gYmVjb21lIG5vcm1hbCBhZ2FpblxyXG4gICAqL1xyXG4gIHByaXZhdGUgcHJvY2Vzc09uSXRlbUFkZGVkT3JSZW1vdmVkKGl0ZW1zOiBhbnkgfCBhbnlbXSwgaXNJdGVtQWRkZWQgPSB0cnVlKSB7XHJcbiAgICBpZiAoaXRlbXMgIT09IG51bGwpIHtcclxuICAgICAgY29uc3QgcHJldmlvdXNEYXRhVG8gPSB0aGlzLl9kYXRhVG87XHJcbiAgICAgIGNvbnN0IGl0ZW1Db3VudCA9IEFycmF5LmlzQXJyYXkoaXRlbXMpID8gaXRlbXMubGVuZ3RoIDogMTtcclxuICAgICAgY29uc3QgaXRlbUNvdW50V2l0aERpcmVjdGlvbiA9IGlzSXRlbUFkZGVkID8gK2l0ZW1Db3VudCA6IC1pdGVtQ291bnQ7XHJcblxyXG4gICAgICAvLyByZWZyZXNoIHRoZSB0b3RhbCBjb3VudCBpbiB0aGUgcGFnaW5hdGlvbiBhbmQgaW4gdGhlIFVJXHJcbiAgICAgIHRoaXMuX3RvdGFsSXRlbXMgKz0gaXRlbUNvdW50V2l0aERpcmVjdGlvbjtcclxuICAgICAgdGhpcy5yZWNhbGN1bGF0ZUZyb21Ub0luZGV4ZXMoKTtcclxuXHJcbiAgICAgIC8vIGZpbmFsbHkgcmVmcmVzaCB0aGUgXCJUb1wiIGNvdW50IGFuZCB3ZSBrbm93IGl0IG1pZ2h0IGJlIGRpZmZlcmVudCB0aGFuIHRoZSBcIml0ZW1zIHBlciBwYWdlXCIgY291bnRcclxuICAgICAgLy8gYnV0IHRoaXMgaXMgbmVjZXNzYXJ5IHNpbmNlIHdlIGRvbid0IHdhbnQgYW4gYWN0dWFsIGJhY2tlbmQgcmVmcmVzaFxyXG4gICAgICB0aGlzLl9kYXRhVG8gPSBwcmV2aW91c0RhdGFUbyArIGl0ZW1Db3VudFdpdGhEaXJlY3Rpb247XHJcbiAgICAgIHRoaXMub25QYWdpbmF0aW9uQ2hhbmdlZC5uZXh0KHRoaXMuZ2V0RnVsbFBhZ2luYXRpb24oKSk7XHJcbiAgICB9XHJcbiAgfVxyXG59XHJcbiJdfQ==