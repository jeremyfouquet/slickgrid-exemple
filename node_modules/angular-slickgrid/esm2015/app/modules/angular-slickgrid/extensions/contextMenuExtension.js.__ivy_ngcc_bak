import * as tslib_1 from "tslib";
import { Injectable, Optional } from '@angular/core';
import { TranslateService } from '@ngx-translate/core';
import { DelimiterType, ExtensionName, FileType, } from '../models/index';
import { ExtensionUtility } from './extensionUtility';
import { SharedService } from '../services/shared.service';
import { ExportService } from '../services/export.service';
import { ExcelExportService } from '../services/excelExport.service';
import { TreeDataService } from '../services/treeData.service';
import { exportWithFormatterWhenDefined } from '../services/export-utilities';
import { getDescendantProperty, getTranslationPrefix } from '../services/utilities';
let ContextMenuExtension = class ContextMenuExtension {
    constructor(excelExportService, exportService, extensionUtility, sharedService, treeDataService, translate) {
        this.excelExportService = excelExportService;
        this.exportService = exportService;
        this.extensionUtility = extensionUtility;
        this.sharedService = sharedService;
        this.treeDataService = treeDataService;
        this.translate = translate;
        this._eventHandler = new Slick.EventHandler();
    }
    get eventHandler() {
        return this._eventHandler;
    }
    dispose() {
        // unsubscribe all SlickGrid events
        this._eventHandler.unsubscribeAll();
        if (this._addon && this._addon.destroy) {
            this._addon.destroy();
        }
        if (this.sharedService.gridOptions && this.sharedService.gridOptions.contextMenu && this.sharedService.gridOptions.contextMenu.commandItems) {
            this.sharedService.gridOptions.contextMenu = this._userOriginalContextMenu;
        }
        this.extensionUtility.nullifyFunctionNameStartingWithOn(this._contextMenuOptions);
        this._addon = null;
        this._contextMenuOptions = null;
    }
    /** Get the instance of the SlickGrid addon (control or plugin). */
    getAddonInstance() {
        return this._addon;
    }
    /**
     * Create the Action Cell Menu and expose all the available hooks that user can subscribe (onCommand, onBeforeMenuShow, ...)
     * @param grid
     * @param dataView
     * @param columnDefinitions
     */
    register() {
        if (this.sharedService.gridOptions && this.sharedService.gridOptions.enableTranslate && (!this.translate || !this.translate.instant)) {
            throw new Error('[Angular-Slickgrid] requires "ngx-translate" to be installed and configured when the grid option "enableTranslate" is enabled.');
        }
        if (this.sharedService && this.sharedService.grid && this.sharedService.gridOptions && this.sharedService.gridOptions.contextMenu) {
            this._contextMenuOptions = this.sharedService.gridOptions.contextMenu;
            // keep original user context menu, useful when switching locale to translate
            this._userOriginalContextMenu = Object.assign({}, this._contextMenuOptions);
            // dynamically import the SlickGrid plugin (addon) with RequireJS
            this.extensionUtility.loadExtensionDynamically(ExtensionName.contextMenu);
            // merge the original commands with the built-in internal commands
            const originalCommandItems = this._userOriginalContextMenu && Array.isArray(this._userOriginalContextMenu.commandItems) ? this._userOriginalContextMenu.commandItems : [];
            this._contextMenuOptions.commandItems = [...originalCommandItems, ...this.addMenuCustomCommands(originalCommandItems)];
            this._contextMenuOptions = Object.assign({}, this._contextMenuOptions);
            this.sharedService.gridOptions.contextMenu = this._contextMenuOptions;
            // sort all menu items by their position order when defined
            this.extensionUtility.sortItems(this._contextMenuOptions.commandItems || [], 'positionOrder');
            this.extensionUtility.sortItems(this._contextMenuOptions.optionItems || [], 'positionOrder');
            this._addon = new Slick.Plugins.ContextMenu(this._contextMenuOptions);
            this.sharedService.grid.registerPlugin(this._addon);
            // translate the item keys when necessary
            if (this.sharedService.gridOptions.enableTranslate) {
                this.translateContextMenu();
            }
            // hook all events
            if (this.sharedService.grid && this._contextMenuOptions) {
                if (this._contextMenuOptions.onExtensionRegistered) {
                    this._contextMenuOptions.onExtensionRegistered(this._addon);
                }
                if (this._contextMenuOptions && typeof this._contextMenuOptions.onCommand === 'function') {
                    this._eventHandler.subscribe(this._addon.onCommand, (event, args) => {
                        this._contextMenuOptions.onCommand(event, args);
                    });
                }
                if (this._contextMenuOptions && typeof this._contextMenuOptions.onOptionSelected === 'function') {
                    this._eventHandler.subscribe(this._addon.onOptionSelected, (event, args) => {
                        this._contextMenuOptions.onOptionSelected(event, args);
                    });
                }
                if (this._contextMenuOptions && typeof this._contextMenuOptions.onBeforeMenuShow === 'function') {
                    this._eventHandler.subscribe(this._addon.onBeforeMenuShow, (event, args) => {
                        this._contextMenuOptions.onBeforeMenuShow(event, args);
                    });
                }
                if (this._contextMenuOptions && typeof this._contextMenuOptions.onBeforeMenuClose === 'function') {
                    this._eventHandler.subscribe(this._addon.onBeforeMenuClose, (event, args) => {
                        this._contextMenuOptions.onBeforeMenuClose(event, args);
                    });
                }
                if (this._contextMenuOptions && typeof this._contextMenuOptions.onAfterMenuShow === 'function') {
                    this._eventHandler.subscribe(this._addon.onAfterMenuShow, (event, args) => {
                        this._contextMenuOptions.onAfterMenuShow(event, args);
                    });
                }
            }
            return this._addon;
        }
        return null;
    }
    /** Translate the Cell Menu titles, we need to loop through all column definition to re-translate them */
    translateContextMenu() {
        if (this.sharedService && this.sharedService.gridOptions && this.sharedService.gridOptions.contextMenu) {
            const contextMenu = this.sharedService.gridOptions.contextMenu;
            const menuOptions = {};
            if (contextMenu.commandTitleKey) {
                contextMenu.commandTitle = this.translate && this.translate.currentLang && this.translate.instant && this.translate.instant(contextMenu.commandTitleKey) || contextMenu.commandTitle;
                menuOptions.commandTitle = contextMenu.commandTitle;
            }
            if (contextMenu.optionTitleKey) {
                contextMenu.optionTitle = this.translate && this.translate.currentLang && this.translate.instant && this.translate.instant(contextMenu.optionTitleKey) || contextMenu.optionTitle;
                menuOptions.optionTitle = contextMenu.optionTitle;
            }
            const originalCommandItems = this._userOriginalContextMenu && Array.isArray(this._userOriginalContextMenu.commandItems) ? this._userOriginalContextMenu.commandItems : [];
            contextMenu.commandItems = [...originalCommandItems, ...this.addMenuCustomCommands(originalCommandItems)];
            menuOptions.commandItems = contextMenu.commandItems; // copy it also to the menuOptions else they won't be translated when locale changes
            // translate all command/options and resort them afterward
            this.extensionUtility.translateItems(contextMenu.commandItems || [], 'titleKey', 'title');
            this.extensionUtility.translateItems(contextMenu.optionItems || [], 'titleKey', 'title');
            this.extensionUtility.sortItems(contextMenu.commandItems || [], 'positionOrder');
            this.extensionUtility.sortItems(contextMenu.optionItems || [], 'positionOrder');
            // update the title options so that it has latest translated values
            if (this._addon && this._addon.setOptions) {
                this._addon.setOptions(menuOptions);
            }
        }
    }
    // --
    // private functions
    // ------------------
    /** Create Context Menu with Custom Commands (copy cell value, export) */
    addMenuCustomCommands(originalCustomItems) {
        const menuCustomItems = [];
        const gridOptions = this.sharedService && this.sharedService.gridOptions || {};
        const contextMenu = gridOptions && gridOptions.contextMenu;
        const dataView = this.sharedService && this.sharedService.dataView;
        const translationPrefix = getTranslationPrefix(gridOptions);
        // show context menu: Copy (cell value)
        if (contextMenu && !contextMenu.hideCopyCellValueCommand) {
            const commandName = 'copy';
            if (!originalCustomItems.find((item) => item.hasOwnProperty('command') && item.command === commandName)) {
                menuCustomItems.push({
                    iconCssClass: contextMenu.iconCopyCellValueCommand || 'fa fa-clone',
                    title: this.extensionUtility.translateWhenEnabledAndServiceExist(`${translationPrefix}COPY`, 'TEXT_COPY'),
                    disabled: false,
                    command: commandName,
                    positionOrder: 50,
                    action: (e, args) => {
                        this.copyToClipboard(args);
                    },
                    itemUsabilityOverride: (args) => {
                        // make sure there's an item to copy before enabling this command
                        const columnDef = args && args.column;
                        const dataContext = args && args.dataContext;
                        if (typeof columnDef.queryFieldNameGetterFn === 'function') {
                            const cellValue = this.getCellValueFromQueryFieldGetter(columnDef, dataContext);
                            if (cellValue !== '' && cellValue !== undefined) {
                                return true;
                            }
                        }
                        else if (columnDef && dataContext.hasOwnProperty(columnDef.field)) {
                            return dataContext[columnDef.field] !== '' && dataContext[columnDef.field] !== null && dataContext[columnDef.field] !== undefined;
                        }
                        return false;
                    }
                });
            }
        }
        // show context menu: Export to file
        if (gridOptions && gridOptions.enableExport && contextMenu && !contextMenu.hideExportCsvCommand) {
            const commandName = 'export-csv';
            if (!originalCustomItems.find((item) => item.hasOwnProperty('command') && item.command === commandName)) {
                menuCustomItems.push({
                    iconCssClass: contextMenu.iconExportCsvCommand || 'fa fa-download',
                    title: this.extensionUtility.translateWhenEnabledAndServiceExist(`${translationPrefix}EXPORT_TO_CSV`, 'TEXT_EXPORT_TO_CSV'),
                    disabled: false,
                    command: commandName,
                    positionOrder: 51,
                    action: () => this.exportService.exportToFile({
                        delimiter: DelimiterType.comma,
                        filename: 'export',
                        format: FileType.csv,
                        useUtf8WithBom: true,
                    }),
                });
            }
        }
        // show context menu: Export to Excel
        if (gridOptions && gridOptions.enableExcelExport && contextMenu && !contextMenu.hideExportExcelCommand) {
            const commandName = 'export-excel';
            if (!originalCustomItems.find((item) => item.hasOwnProperty('command') && item.command === commandName)) {
                menuCustomItems.push({
                    iconCssClass: contextMenu.iconExportExcelCommand || 'fa fa-file-excel-o text-success',
                    title: this.extensionUtility.translateWhenEnabledAndServiceExist(`${translationPrefix}EXPORT_TO_EXCEL`, 'TEXT_EXPORT_TO_EXCEL'),
                    disabled: false,
                    command: commandName,
                    positionOrder: 52,
                    action: () => this.excelExportService.exportToExcel({
                        filename: 'export',
                        format: FileType.xlsx,
                    }),
                });
            }
        }
        // show context menu: export to text file as tab delimited
        if (gridOptions && gridOptions.enableExport && contextMenu && !contextMenu.hideExportTextDelimitedCommand) {
            const commandName = 'export-text-delimited';
            if (!originalCustomItems.find((item) => item.hasOwnProperty('command') && item.command === commandName)) {
                menuCustomItems.push({
                    iconCssClass: contextMenu.iconExportTextDelimitedCommand || 'fa fa-download',
                    title: this.extensionUtility.translateWhenEnabledAndServiceExist(`${translationPrefix}EXPORT_TO_TAB_DELIMITED`, 'TEXT_EXPORT_TO_TAB_DELIMITED'),
                    disabled: false,
                    command: commandName,
                    positionOrder: 53,
                    action: () => this.exportService.exportToFile({
                        delimiter: DelimiterType.tab,
                        filename: 'export',
                        format: FileType.txt,
                        useUtf8WithBom: true,
                    }),
                });
            }
        }
        // -- Grouping Commands
        if (gridOptions && (gridOptions.enableGrouping || gridOptions.enableDraggableGrouping || gridOptions.enableTreeData)) {
            // add a divider (separator) between the top sort commands and the other clear commands
            if (contextMenu && !contextMenu.hideCopyCellValueCommand) {
                menuCustomItems.push({ divider: true, command: '', positionOrder: 54 });
            }
            // show context menu: Clear Grouping
            if (gridOptions && !gridOptions.enableTreeData && contextMenu && !contextMenu.hideClearAllGrouping) {
                const commandName = 'clear-grouping';
                if (!originalCustomItems.find((item) => item.hasOwnProperty('command') && item.command === commandName)) {
                    menuCustomItems.push({
                        iconCssClass: contextMenu.iconClearGroupingCommand || 'fa fa-times',
                        title: this.extensionUtility.translateWhenEnabledAndServiceExist(`${translationPrefix}CLEAR_ALL_GROUPING`, 'TEXT_CLEAR_ALL_GROUPING'),
                        disabled: false,
                        command: commandName,
                        positionOrder: 55,
                        action: () => dataView.setGrouping([]),
                        itemUsabilityOverride: () => {
                            // only enable the command when there's an actually grouping in play
                            const groupingArray = dataView && dataView.getGrouping && dataView.getGrouping();
                            return Array.isArray(groupingArray) && groupingArray.length > 0;
                        }
                    });
                }
            }
            // show context menu: Collapse all Groups
            if (gridOptions && contextMenu && !contextMenu.hideCollapseAllGroups) {
                const commandName = 'collapse-all-groups';
                if (!originalCustomItems.find((item) => item.hasOwnProperty('command') && item.command === commandName)) {
                    menuCustomItems.push({
                        iconCssClass: contextMenu.iconCollapseAllGroupsCommand || 'fa fa-compress',
                        title: this.extensionUtility.translateWhenEnabledAndServiceExist(`${translationPrefix}COLLAPSE_ALL_GROUPS`, 'TEXT_COLLAPSE_ALL_GROUPS'),
                        disabled: false,
                        command: commandName,
                        positionOrder: 56,
                        action: () => {
                            if (gridOptions.enableTreeData) {
                                this.treeDataService.toggleTreeDataCollapse(true);
                            }
                            else {
                                dataView.collapseAllGroups();
                            }
                        },
                        itemUsabilityOverride: () => {
                            if (gridOptions.enableTreeData) {
                                return true;
                            }
                            // only enable the command when there's an actually grouping in play
                            const groupingArray = dataView && dataView.getGrouping && dataView.getGrouping();
                            return Array.isArray(groupingArray) && groupingArray.length > 0;
                        }
                    });
                }
            }
            // show context menu: Expand all Groups
            if (gridOptions && contextMenu && !contextMenu.hideExpandAllGroups) {
                const commandName = 'expand-all-groups';
                if (!originalCustomItems.find((item) => item.hasOwnProperty('command') && item.command === commandName)) {
                    menuCustomItems.push({
                        iconCssClass: contextMenu.iconExpandAllGroupsCommand || 'fa fa-expand',
                        title: this.extensionUtility.translateWhenEnabledAndServiceExist(`${translationPrefix}EXPAND_ALL_GROUPS`, 'TEXT_EXPAND_ALL_GROUPS'),
                        disabled: false,
                        command: commandName,
                        positionOrder: 57,
                        action: () => {
                            if (gridOptions.enableTreeData) {
                                this.treeDataService.toggleTreeDataCollapse(false);
                            }
                            else {
                                dataView.expandAllGroups();
                            }
                        },
                        itemUsabilityOverride: () => {
                            if (gridOptions.enableTreeData) {
                                return true;
                            }
                            // only enable the command when there's an actually grouping in play
                            const groupingArray = dataView && dataView.getGrouping && dataView.getGrouping();
                            return Array.isArray(groupingArray) && groupingArray.length > 0;
                        }
                    });
                }
            }
        }
        return menuCustomItems;
    }
    /**
     * First get the value, if "exportWithFormatter" is set then we'll use the formatter output
     * Then we create the DOM trick to copy a text value by creating a fake <div> that is not shown to the user
     * and from there we can call the execCommand 'copy' command and expect the value to be in clipboard
     * @param args
     */
    copyToClipboard(args) {
        try {
            if (args && args.grid && args.command) {
                // get the value, if "exportWithFormatter" is set then we'll use the formatter output
                const gridOptions = this.sharedService && this.sharedService.gridOptions || {};
                const cell = args && args.cell || 0;
                const row = args && args.row || 0;
                const columnDef = args && args.column;
                const dataContext = args && args.dataContext;
                const grid = this.sharedService && this.sharedService.grid;
                const exportOptions = gridOptions && (gridOptions.excelExportOptions || gridOptions.exportOptions);
                let textToCopy = exportWithFormatterWhenDefined(row, cell, dataContext, columnDef, grid, exportOptions);
                if (typeof columnDef.queryFieldNameGetterFn === 'function') {
                    textToCopy = this.getCellValueFromQueryFieldGetter(columnDef, dataContext);
                }
                // create fake <div> to copy into clipboard & delete it from the DOM once we're done
                const range = document.createRange();
                const tmpElem = $('<div>').css({ position: 'absolute', left: '-1000px', top: '-1000px' }).text(textToCopy);
                $('body').append(tmpElem);
                range.selectNodeContents(tmpElem.get(0));
                const selection = window.getSelection();
                if (selection && selection.addRange && selection.removeAllRanges) {
                    selection.removeAllRanges();
                    selection.addRange(range);
                    const success = document.execCommand('copy', false, textToCopy);
                    if (success) {
                        tmpElem.remove();
                    }
                }
            }
        }
        catch (e) { }
    }
    /**
     * When a queryFieldNameGetterFn is defined, then get the value from that getter callback function
     * @param columnDef
     * @param dataContext
     * @return cellValue
     */
    getCellValueFromQueryFieldGetter(columnDef, dataContext) {
        let cellValue = '';
        if (typeof columnDef.queryFieldNameGetterFn === 'function') {
            const queryFieldName = columnDef.queryFieldNameGetterFn(dataContext);
            // get the cell value from the item or when it's a dot notation then exploded the item and get the final value
            if (queryFieldName && queryFieldName.indexOf('.') >= 0) {
                cellValue = getDescendantProperty(dataContext, queryFieldName);
            }
            else {
                cellValue = dataContext[queryFieldName];
            }
        }
        return cellValue;
    }
};
ContextMenuExtension.ctorParameters = () => [
    { type: ExcelExportService },
    { type: ExportService },
    { type: ExtensionUtility },
    { type: SharedService },
    { type: TreeDataService },
    { type: TranslateService, decorators: [{ type: Optional }] }
];
ContextMenuExtension = tslib_1.__decorate([
    Injectable(),
    tslib_1.__param(5, Optional())
], ContextMenuExtension);
export { ContextMenuExtension };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29udGV4dE1lbnVFeHRlbnNpb24uanMiLCJzb3VyY2VSb290Ijoibmc6Ly9hbmd1bGFyLXNsaWNrZ3JpZC8iLCJzb3VyY2VzIjpbImFwcC9tb2R1bGVzL2FuZ3VsYXItc2xpY2tncmlkL2V4dGVuc2lvbnMvY29udGV4dE1lbnVFeHRlbnNpb24udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsUUFBUSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ3JELE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBRXZELE9BQU8sRUFHTCxhQUFhLEVBRWIsYUFBYSxFQUNiLFFBQVEsR0FNVCxNQUFNLGlCQUFpQixDQUFDO0FBQ3pCLE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBQ3RELE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSw0QkFBNEIsQ0FBQztBQUMzRCxPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0sNEJBQTRCLENBQUM7QUFDM0QsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0saUNBQWlDLENBQUM7QUFDckUsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLDhCQUE4QixDQUFDO0FBQy9ELE9BQU8sRUFBRSw4QkFBOEIsRUFBRSxNQUFNLDhCQUE4QixDQUFDO0FBQzlFLE9BQU8sRUFBRSxxQkFBcUIsRUFBRSxvQkFBb0IsRUFBRSxNQUFNLHVCQUF1QixDQUFDO0FBTXBGLElBQWEsb0JBQW9CLEdBQWpDLE1BQWEsb0JBQW9CO0lBTS9CLFlBQ1Usa0JBQXNDLEVBQ3RDLGFBQTRCLEVBQzVCLGdCQUFrQyxFQUNsQyxhQUE0QixFQUM1QixlQUFnQyxFQUNwQixTQUEyQjtRQUx2Qyx1QkFBa0IsR0FBbEIsa0JBQWtCLENBQW9CO1FBQ3RDLGtCQUFhLEdBQWIsYUFBYSxDQUFlO1FBQzVCLHFCQUFnQixHQUFoQixnQkFBZ0IsQ0FBa0I7UUFDbEMsa0JBQWEsR0FBYixhQUFhLENBQWU7UUFDNUIsb0JBQWUsR0FBZixlQUFlLENBQWlCO1FBQ3BCLGNBQVMsR0FBVCxTQUFTLENBQWtCO1FBRS9DLElBQUksQ0FBQyxhQUFhLEdBQUcsSUFBSSxLQUFLLENBQUMsWUFBWSxFQUFFLENBQUM7SUFDaEQsQ0FBQztJQUVELElBQUksWUFBWTtRQUNkLE9BQU8sSUFBSSxDQUFDLGFBQWEsQ0FBQztJQUM1QixDQUFDO0lBRUQsT0FBTztRQUNMLG1DQUFtQztRQUNuQyxJQUFJLENBQUMsYUFBYSxDQUFDLGNBQWMsRUFBRSxDQUFDO1FBRXBDLElBQUksSUFBSSxDQUFDLE1BQU0sSUFBSSxJQUFJLENBQUMsTUFBTSxDQUFDLE9BQU8sRUFBRTtZQUN0QyxJQUFJLENBQUMsTUFBTSxDQUFDLE9BQU8sRUFBRSxDQUFDO1NBQ3ZCO1FBQ0QsSUFBSSxJQUFJLENBQUMsYUFBYSxDQUFDLFdBQVcsSUFBSSxJQUFJLENBQUMsYUFBYSxDQUFDLFdBQVcsQ0FBQyxXQUFXLElBQUksSUFBSSxDQUFDLGFBQWEsQ0FBQyxXQUFXLENBQUMsV0FBVyxDQUFDLFlBQVksRUFBRTtZQUMzSSxJQUFJLENBQUMsYUFBYSxDQUFDLFdBQVcsQ0FBQyxXQUFXLEdBQUcsSUFBSSxDQUFDLHdCQUF3QixDQUFDO1NBQzVFO1FBQ0QsSUFBSSxDQUFDLGdCQUFnQixDQUFDLGlDQUFpQyxDQUFDLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxDQUFDO1FBQ2xGLElBQUksQ0FBQyxNQUFNLEdBQUcsSUFBSSxDQUFDO1FBQ25CLElBQUksQ0FBQyxtQkFBbUIsR0FBRyxJQUFJLENBQUM7SUFDbEMsQ0FBQztJQUVELG1FQUFtRTtJQUNuRSxnQkFBZ0I7UUFDZCxPQUFPLElBQUksQ0FBQyxNQUFNLENBQUM7SUFDckIsQ0FBQztJQUVEOzs7OztPQUtHO0lBQ0gsUUFBUTtRQUNOLElBQUksSUFBSSxDQUFDLGFBQWEsQ0FBQyxXQUFXLElBQUksSUFBSSxDQUFDLGFBQWEsQ0FBQyxXQUFXLENBQUMsZUFBZSxJQUFJLENBQUMsQ0FBQyxJQUFJLENBQUMsU0FBUyxJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxPQUFPLENBQUMsRUFBRTtZQUNwSSxNQUFNLElBQUksS0FBSyxDQUFDLGdJQUFnSSxDQUFDLENBQUM7U0FDbko7UUFFRCxJQUFJLElBQUksQ0FBQyxhQUFhLElBQUksSUFBSSxDQUFDLGFBQWEsQ0FBQyxJQUFJLElBQUksSUFBSSxDQUFDLGFBQWEsQ0FBQyxXQUFXLElBQUksSUFBSSxDQUFDLGFBQWEsQ0FBQyxXQUFXLENBQUMsV0FBVyxFQUFFO1lBQ2pJLElBQUksQ0FBQyxtQkFBbUIsR0FBRyxJQUFJLENBQUMsYUFBYSxDQUFDLFdBQVcsQ0FBQyxXQUFXLENBQUM7WUFFdEUsNkVBQTZFO1lBQzdFLElBQUksQ0FBQyx3QkFBd0IscUJBQVEsSUFBSSxDQUFDLG1CQUFtQixDQUFFLENBQUM7WUFFaEUsaUVBQWlFO1lBQ2pFLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyx3QkFBd0IsQ0FBQyxhQUFhLENBQUMsV0FBVyxDQUFDLENBQUM7WUFFMUUsa0VBQWtFO1lBQ2xFLE1BQU0sb0JBQW9CLEdBQUcsSUFBSSxDQUFDLHdCQUF3QixJQUFJLEtBQUssQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLHdCQUF3QixDQUFDLFlBQVksQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsd0JBQXdCLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUM7WUFDMUssSUFBSSxDQUFDLG1CQUFtQixDQUFDLFlBQVksR0FBRyxDQUFDLEdBQUcsb0JBQW9CLEVBQUUsR0FBRyxJQUFJLENBQUMscUJBQXFCLENBQUMsb0JBQW9CLENBQUMsQ0FBQyxDQUFDO1lBQ3ZILElBQUksQ0FBQyxtQkFBbUIscUJBQVEsSUFBSSxDQUFDLG1CQUFtQixDQUFFLENBQUM7WUFDM0QsSUFBSSxDQUFDLGFBQWEsQ0FBQyxXQUFXLENBQUMsV0FBVyxHQUFHLElBQUksQ0FBQyxtQkFBbUIsQ0FBQztZQUV0RSwyREFBMkQ7WUFDM0QsSUFBSSxDQUFDLGdCQUFnQixDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsbUJBQW1CLENBQUMsWUFBWSxJQUFJLEVBQUUsRUFBRSxlQUFlLENBQUMsQ0FBQztZQUM5RixJQUFJLENBQUMsZ0JBQWdCLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxXQUFXLElBQUksRUFBRSxFQUFFLGVBQWUsQ0FBQyxDQUFDO1lBRTdGLElBQUksQ0FBQyxNQUFNLEdBQUcsSUFBSSxLQUFLLENBQUMsT0FBTyxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsbUJBQW1CLENBQUMsQ0FBQztZQUN0RSxJQUFJLENBQUMsYUFBYSxDQUFDLElBQUksQ0FBQyxjQUFjLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDO1lBRXBELHlDQUF5QztZQUN6QyxJQUFJLElBQUksQ0FBQyxhQUFhLENBQUMsV0FBVyxDQUFDLGVBQWUsRUFBRTtnQkFDbEQsSUFBSSxDQUFDLG9CQUFvQixFQUFFLENBQUM7YUFDN0I7WUFFRCxrQkFBa0I7WUFDbEIsSUFBSSxJQUFJLENBQUMsYUFBYSxDQUFDLElBQUksSUFBSSxJQUFJLENBQUMsbUJBQW1CLEVBQUU7Z0JBQ3ZELElBQUksSUFBSSxDQUFDLG1CQUFtQixDQUFDLHFCQUFxQixFQUFFO29CQUNsRCxJQUFJLENBQUMsbUJBQW1CLENBQUMscUJBQXFCLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDO2lCQUM3RDtnQkFDRCxJQUFJLElBQUksQ0FBQyxtQkFBbUIsSUFBSSxPQUFPLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxTQUFTLEtBQUssVUFBVSxFQUFFO29CQUN4RixJQUFJLENBQUMsYUFBYSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLFNBQVMsRUFBRSxDQUFDLEtBQVksRUFBRSxJQUFpQyxFQUFFLEVBQUU7d0JBQ3RHLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxTQUFTLENBQUMsS0FBSyxFQUFFLElBQUksQ0FBQyxDQUFDO29CQUNsRCxDQUFDLENBQUMsQ0FBQztpQkFDSjtnQkFDRCxJQUFJLElBQUksQ0FBQyxtQkFBbUIsSUFBSSxPQUFPLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxnQkFBZ0IsS0FBSyxVQUFVLEVBQUU7b0JBQy9GLElBQUksQ0FBQyxhQUFhLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQyxLQUFZLEVBQUUsSUFBZ0MsRUFBRSxFQUFFO3dCQUM1RyxJQUFJLENBQUMsbUJBQW1CLENBQUMsZ0JBQWdCLENBQUMsS0FBSyxFQUFFLElBQUksQ0FBQyxDQUFDO29CQUN6RCxDQUFDLENBQUMsQ0FBQztpQkFDSjtnQkFDRCxJQUFJLElBQUksQ0FBQyxtQkFBbUIsSUFBSSxPQUFPLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxnQkFBZ0IsS0FBSyxVQUFVLEVBQUU7b0JBQy9GLElBQUksQ0FBQyxhQUFhLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQyxLQUFZLEVBQUUsSUFBK0MsRUFBRSxFQUFFO3dCQUMzSCxJQUFJLENBQUMsbUJBQW1CLENBQUMsZ0JBQWdCLENBQUMsS0FBSyxFQUFFLElBQUksQ0FBQyxDQUFDO29CQUN6RCxDQUFDLENBQUMsQ0FBQztpQkFDSjtnQkFDRCxJQUFJLElBQUksQ0FBQyxtQkFBbUIsSUFBSSxPQUFPLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxpQkFBaUIsS0FBSyxVQUFVLEVBQUU7b0JBQ2hHLElBQUksQ0FBQyxhQUFhLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsaUJBQWlCLEVBQUUsQ0FBQyxLQUFZLEVBQUUsSUFBMEQsRUFBRSxFQUFFO3dCQUN2SSxJQUFJLENBQUMsbUJBQW1CLENBQUMsaUJBQWlCLENBQUMsS0FBSyxFQUFFLElBQUksQ0FBQyxDQUFDO29CQUMxRCxDQUFDLENBQUMsQ0FBQztpQkFDSjtnQkFDRCxJQUFJLElBQUksQ0FBQyxtQkFBbUIsSUFBSSxPQUFPLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxlQUFlLEtBQUssVUFBVSxFQUFFO29CQUM5RixJQUFJLENBQUMsYUFBYSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLGVBQWUsRUFBRSxDQUFDLEtBQVksRUFBRSxJQUErQyxFQUFFLEVBQUU7d0JBQzFILElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxlQUFlLENBQUMsS0FBSyxFQUFFLElBQUksQ0FBQyxDQUFDO29CQUN4RCxDQUFDLENBQUMsQ0FBQztpQkFDSjthQUNGO1lBQ0QsT0FBTyxJQUFJLENBQUMsTUFBTSxDQUFDO1NBQ3BCO1FBQ0QsT0FBTyxJQUFJLENBQUM7SUFDZCxDQUFDO0lBRUQseUdBQXlHO0lBQ3pHLG9CQUFvQjtRQUNsQixJQUFJLElBQUksQ0FBQyxhQUFhLElBQUksSUFBSSxDQUFDLGFBQWEsQ0FBQyxXQUFXLElBQUksSUFBSSxDQUFDLGFBQWEsQ0FBQyxXQUFXLENBQUMsV0FBVyxFQUFFO1lBQ3RHLE1BQU0sV0FBVyxHQUFHLElBQUksQ0FBQyxhQUFhLENBQUMsV0FBVyxDQUFDLFdBQVcsQ0FBQztZQUMvRCxNQUFNLFdBQVcsR0FBeUIsRUFBRSxDQUFDO1lBRTdDLElBQUksV0FBVyxDQUFDLGVBQWUsRUFBRTtnQkFDL0IsV0FBVyxDQUFDLFlBQVksR0FBRyxJQUFJLENBQUMsU0FBUyxJQUFJLElBQUksQ0FBQyxTQUFTLENBQUMsV0FBVyxJQUFJLElBQUksQ0FBQyxTQUFTLENBQUMsT0FBTyxJQUFJLElBQUksQ0FBQyxTQUFTLENBQUMsT0FBTyxDQUFDLFdBQVcsQ0FBQyxlQUFlLENBQUMsSUFBSSxXQUFXLENBQUMsWUFBWSxDQUFDO2dCQUNyTCxXQUFXLENBQUMsWUFBWSxHQUFHLFdBQVcsQ0FBQyxZQUFZLENBQUM7YUFDckQ7WUFDRCxJQUFJLFdBQVcsQ0FBQyxjQUFjLEVBQUU7Z0JBQzlCLFdBQVcsQ0FBQyxXQUFXLEdBQUcsSUFBSSxDQUFDLFNBQVMsSUFBSSxJQUFJLENBQUMsU0FBUyxDQUFDLFdBQVcsSUFBSSxJQUFJLENBQUMsU0FBUyxDQUFDLE9BQU8sSUFBSSxJQUFJLENBQUMsU0FBUyxDQUFDLE9BQU8sQ0FBQyxXQUFXLENBQUMsY0FBYyxDQUFDLElBQUksV0FBVyxDQUFDLFdBQVcsQ0FBQztnQkFDbEwsV0FBVyxDQUFDLFdBQVcsR0FBRyxXQUFXLENBQUMsV0FBVyxDQUFDO2FBQ25EO1lBQ0QsTUFBTSxvQkFBb0IsR0FBRyxJQUFJLENBQUMsd0JBQXdCLElBQUksS0FBSyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsd0JBQXdCLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyx3QkFBd0IsQ0FBQyxZQUFZLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQztZQUMxSyxXQUFXLENBQUMsWUFBWSxHQUFHLENBQUMsR0FBRyxvQkFBb0IsRUFBRSxHQUFHLElBQUksQ0FBQyxxQkFBcUIsQ0FBQyxvQkFBb0IsQ0FBQyxDQUFDLENBQUM7WUFDMUcsV0FBVyxDQUFDLFlBQVksR0FBRyxXQUFXLENBQUMsWUFBWSxDQUFDLENBQUMsb0ZBQW9GO1lBRXpJLDBEQUEwRDtZQUMxRCxJQUFJLENBQUMsZ0JBQWdCLENBQUMsY0FBYyxDQUFDLFdBQVcsQ0FBQyxZQUFZLElBQUksRUFBRSxFQUFFLFVBQVUsRUFBRSxPQUFPLENBQUMsQ0FBQztZQUMxRixJQUFJLENBQUMsZ0JBQWdCLENBQUMsY0FBYyxDQUFDLFdBQVcsQ0FBQyxXQUFXLElBQUksRUFBRSxFQUFFLFVBQVUsRUFBRSxPQUFPLENBQUMsQ0FBQztZQUN6RixJQUFJLENBQUMsZ0JBQWdCLENBQUMsU0FBUyxDQUFDLFdBQVcsQ0FBQyxZQUFZLElBQUksRUFBRSxFQUFFLGVBQWUsQ0FBQyxDQUFDO1lBQ2pGLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxTQUFTLENBQUMsV0FBVyxDQUFDLFdBQVcsSUFBSSxFQUFFLEVBQUUsZUFBZSxDQUFDLENBQUM7WUFFaEYsbUVBQW1FO1lBQ25FLElBQUksSUFBSSxDQUFDLE1BQU0sSUFBSSxJQUFJLENBQUMsTUFBTSxDQUFDLFVBQVUsRUFBRTtnQkFDekMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxVQUFVLENBQUMsV0FBVyxDQUFDLENBQUM7YUFDckM7U0FDRjtJQUNILENBQUM7SUFFRCxLQUFLO0lBQ0wsb0JBQW9CO0lBQ3BCLHFCQUFxQjtJQUVyQix5RUFBeUU7SUFDakUscUJBQXFCLENBQUMsbUJBQXVEO1FBQ25GLE1BQU0sZUFBZSxHQUF1QyxFQUFFLENBQUM7UUFDL0QsTUFBTSxXQUFXLEdBQUcsSUFBSSxDQUFDLGFBQWEsSUFBSSxJQUFJLENBQUMsYUFBYSxDQUFDLFdBQVcsSUFBSSxFQUFFLENBQUM7UUFDL0UsTUFBTSxXQUFXLEdBQUcsV0FBVyxJQUFJLFdBQVcsQ0FBQyxXQUFXLENBQUM7UUFDM0QsTUFBTSxRQUFRLEdBQUcsSUFBSSxDQUFDLGFBQWEsSUFBSSxJQUFJLENBQUMsYUFBYSxDQUFDLFFBQVEsQ0FBQztRQUNuRSxNQUFNLGlCQUFpQixHQUFHLG9CQUFvQixDQUFDLFdBQVcsQ0FBQyxDQUFDO1FBRTVELHVDQUF1QztRQUN2QyxJQUFJLFdBQVcsSUFBSSxDQUFDLFdBQVcsQ0FBQyx3QkFBd0IsRUFBRTtZQUN4RCxNQUFNLFdBQVcsR0FBRyxNQUFNLENBQUM7WUFDM0IsSUFBSSxDQUFDLG1CQUFtQixDQUFDLElBQUksQ0FBQyxDQUFDLElBQXFCLEVBQUUsRUFBRSxDQUFDLElBQUksQ0FBQyxjQUFjLENBQUMsU0FBUyxDQUFDLElBQUksSUFBSSxDQUFDLE9BQU8sS0FBSyxXQUFXLENBQUMsRUFBRTtnQkFDeEgsZUFBZSxDQUFDLElBQUksQ0FDbEI7b0JBQ0UsWUFBWSxFQUFFLFdBQVcsQ0FBQyx3QkFBd0IsSUFBSSxhQUFhO29CQUNuRSxLQUFLLEVBQUUsSUFBSSxDQUFDLGdCQUFnQixDQUFDLG1DQUFtQyxDQUFDLEdBQUcsaUJBQWlCLE1BQU0sRUFBRSxXQUFXLENBQUM7b0JBQ3pHLFFBQVEsRUFBRSxLQUFLO29CQUNmLE9BQU8sRUFBRSxXQUFXO29CQUNwQixhQUFhLEVBQUUsRUFBRTtvQkFDakIsTUFBTSxFQUFFLENBQUMsQ0FBUSxFQUFFLElBQWlDLEVBQUUsRUFBRTt3QkFDdEQsSUFBSSxDQUFDLGVBQWUsQ0FBQyxJQUFJLENBQUMsQ0FBQztvQkFDN0IsQ0FBQztvQkFDRCxxQkFBcUIsRUFBRSxDQUFDLElBQXNCLEVBQUUsRUFBRTt3QkFDaEQsaUVBQWlFO3dCQUNqRSxNQUFNLFNBQVMsR0FBRyxJQUFJLElBQUksSUFBSSxDQUFDLE1BQWdCLENBQUM7d0JBQ2hELE1BQU0sV0FBVyxHQUFHLElBQUksSUFBSSxJQUFJLENBQUMsV0FBVyxDQUFDO3dCQUM3QyxJQUFJLE9BQU8sU0FBUyxDQUFDLHNCQUFzQixLQUFLLFVBQVUsRUFBRTs0QkFDMUQsTUFBTSxTQUFTLEdBQUcsSUFBSSxDQUFDLGdDQUFnQyxDQUFDLFNBQVMsRUFBRSxXQUFXLENBQUMsQ0FBQzs0QkFDaEYsSUFBSSxTQUFTLEtBQUssRUFBRSxJQUFJLFNBQVMsS0FBSyxTQUFTLEVBQUU7Z0NBQy9DLE9BQU8sSUFBSSxDQUFDOzZCQUNiO3lCQUNGOzZCQUFNLElBQUksU0FBUyxJQUFJLFdBQVcsQ0FBQyxjQUFjLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQyxFQUFFOzRCQUNuRSxPQUFPLFdBQVcsQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLEtBQUssRUFBRSxJQUFJLFdBQVcsQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLEtBQUssSUFBSSxJQUFJLFdBQVcsQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLEtBQUssU0FBUyxDQUFDO3lCQUNuSTt3QkFDRCxPQUFPLEtBQUssQ0FBQztvQkFDZixDQUFDO2lCQUNGLENBQ0YsQ0FBQzthQUNIO1NBQ0Y7UUFFRCxvQ0FBb0M7UUFDcEMsSUFBSSxXQUFXLElBQUksV0FBVyxDQUFDLFlBQVksSUFBSSxXQUFXLElBQUksQ0FBQyxXQUFXLENBQUMsb0JBQW9CLEVBQUU7WUFDL0YsTUFBTSxXQUFXLEdBQUcsWUFBWSxDQUFDO1lBQ2pDLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxJQUFJLENBQUMsQ0FBQyxJQUFxQixFQUFFLEVBQUUsQ0FBQyxJQUFJLENBQUMsY0FBYyxDQUFDLFNBQVMsQ0FBQyxJQUFJLElBQUksQ0FBQyxPQUFPLEtBQUssV0FBVyxDQUFDLEVBQUU7Z0JBQ3hILGVBQWUsQ0FBQyxJQUFJLENBQ2xCO29CQUNFLFlBQVksRUFBRSxXQUFXLENBQUMsb0JBQW9CLElBQUksZ0JBQWdCO29CQUNsRSxLQUFLLEVBQUUsSUFBSSxDQUFDLGdCQUFnQixDQUFDLG1DQUFtQyxDQUFDLEdBQUcsaUJBQWlCLGVBQWUsRUFBRSxvQkFBb0IsQ0FBQztvQkFDM0gsUUFBUSxFQUFFLEtBQUs7b0JBQ2YsT0FBTyxFQUFFLFdBQVc7b0JBQ3BCLGFBQWEsRUFBRSxFQUFFO29CQUNqQixNQUFNLEVBQUUsR0FBRyxFQUFFLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxZQUFZLENBQUM7d0JBQzVDLFNBQVMsRUFBRSxhQUFhLENBQUMsS0FBSzt3QkFDOUIsUUFBUSxFQUFFLFFBQVE7d0JBQ2xCLE1BQU0sRUFBRSxRQUFRLENBQUMsR0FBRzt3QkFDcEIsY0FBYyxFQUFFLElBQUk7cUJBQ3JCLENBQUM7aUJBQ0gsQ0FDRixDQUFDO2FBQ0g7U0FDRjtRQUVELHFDQUFxQztRQUNyQyxJQUFJLFdBQVcsSUFBSSxXQUFXLENBQUMsaUJBQWlCLElBQUksV0FBVyxJQUFJLENBQUMsV0FBVyxDQUFDLHNCQUFzQixFQUFFO1lBQ3RHLE1BQU0sV0FBVyxHQUFHLGNBQWMsQ0FBQztZQUNuQyxJQUFJLENBQUMsbUJBQW1CLENBQUMsSUFBSSxDQUFDLENBQUMsSUFBcUIsRUFBRSxFQUFFLENBQUMsSUFBSSxDQUFDLGNBQWMsQ0FBQyxTQUFTLENBQUMsSUFBSSxJQUFJLENBQUMsT0FBTyxLQUFLLFdBQVcsQ0FBQyxFQUFFO2dCQUN4SCxlQUFlLENBQUMsSUFBSSxDQUNsQjtvQkFDRSxZQUFZLEVBQUUsV0FBVyxDQUFDLHNCQUFzQixJQUFJLGlDQUFpQztvQkFDckYsS0FBSyxFQUFFLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxtQ0FBbUMsQ0FBQyxHQUFHLGlCQUFpQixpQkFBaUIsRUFBRSxzQkFBc0IsQ0FBQztvQkFDL0gsUUFBUSxFQUFFLEtBQUs7b0JBQ2YsT0FBTyxFQUFFLFdBQVc7b0JBQ3BCLGFBQWEsRUFBRSxFQUFFO29CQUNqQixNQUFNLEVBQUUsR0FBRyxFQUFFLENBQUMsSUFBSSxDQUFDLGtCQUFrQixDQUFDLGFBQWEsQ0FBQzt3QkFDbEQsUUFBUSxFQUFFLFFBQVE7d0JBQ2xCLE1BQU0sRUFBRSxRQUFRLENBQUMsSUFBSTtxQkFDdEIsQ0FBQztpQkFDSCxDQUNGLENBQUM7YUFDSDtTQUNGO1FBRUQsMERBQTBEO1FBQzFELElBQUksV0FBVyxJQUFJLFdBQVcsQ0FBQyxZQUFZLElBQUksV0FBVyxJQUFJLENBQUMsV0FBVyxDQUFDLDhCQUE4QixFQUFFO1lBQ3pHLE1BQU0sV0FBVyxHQUFHLHVCQUF1QixDQUFDO1lBQzVDLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxJQUFJLENBQUMsQ0FBQyxJQUFxQixFQUFFLEVBQUUsQ0FBQyxJQUFJLENBQUMsY0FBYyxDQUFDLFNBQVMsQ0FBQyxJQUFJLElBQUksQ0FBQyxPQUFPLEtBQUssV0FBVyxDQUFDLEVBQUU7Z0JBQ3hILGVBQWUsQ0FBQyxJQUFJLENBQ2xCO29CQUNFLFlBQVksRUFBRSxXQUFXLENBQUMsOEJBQThCLElBQUksZ0JBQWdCO29CQUM1RSxLQUFLLEVBQUUsSUFBSSxDQUFDLGdCQUFnQixDQUFDLG1DQUFtQyxDQUFDLEdBQUcsaUJBQWlCLHlCQUF5QixFQUFFLDhCQUE4QixDQUFDO29CQUMvSSxRQUFRLEVBQUUsS0FBSztvQkFDZixPQUFPLEVBQUUsV0FBVztvQkFDcEIsYUFBYSxFQUFFLEVBQUU7b0JBQ2pCLE1BQU0sRUFBRSxHQUFHLEVBQUUsQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLFlBQVksQ0FBQzt3QkFDNUMsU0FBUyxFQUFFLGFBQWEsQ0FBQyxHQUFHO3dCQUM1QixRQUFRLEVBQUUsUUFBUTt3QkFDbEIsTUFBTSxFQUFFLFFBQVEsQ0FBQyxHQUFHO3dCQUNwQixjQUFjLEVBQUUsSUFBSTtxQkFDckIsQ0FBQztpQkFDSCxDQUNGLENBQUM7YUFDSDtTQUNGO1FBRUQsdUJBQXVCO1FBQ3ZCLElBQUksV0FBVyxJQUFJLENBQUMsV0FBVyxDQUFDLGNBQWMsSUFBSSxXQUFXLENBQUMsdUJBQXVCLElBQUksV0FBVyxDQUFDLGNBQWMsQ0FBQyxFQUFFO1lBQ3BILHVGQUF1RjtZQUN2RixJQUFJLFdBQVcsSUFBSSxDQUFDLFdBQVcsQ0FBQyx3QkFBd0IsRUFBRTtnQkFDeEQsZUFBZSxDQUFDLElBQUksQ0FBQyxFQUFFLE9BQU8sRUFBRSxJQUFJLEVBQUUsT0FBTyxFQUFFLEVBQUUsRUFBRSxhQUFhLEVBQUUsRUFBRSxFQUFFLENBQUMsQ0FBQzthQUN6RTtZQUVELG9DQUFvQztZQUNwQyxJQUFJLFdBQVcsSUFBSSxDQUFDLFdBQVcsQ0FBQyxjQUFjLElBQUksV0FBVyxJQUFJLENBQUMsV0FBVyxDQUFDLG9CQUFvQixFQUFFO2dCQUNsRyxNQUFNLFdBQVcsR0FBRyxnQkFBZ0IsQ0FBQztnQkFDckMsSUFBSSxDQUFDLG1CQUFtQixDQUFDLElBQUksQ0FBQyxDQUFDLElBQXFCLEVBQUUsRUFBRSxDQUFDLElBQUksQ0FBQyxjQUFjLENBQUMsU0FBUyxDQUFDLElBQUksSUFBSSxDQUFDLE9BQU8sS0FBSyxXQUFXLENBQUMsRUFBRTtvQkFDeEgsZUFBZSxDQUFDLElBQUksQ0FDbEI7d0JBQ0UsWUFBWSxFQUFFLFdBQVcsQ0FBQyx3QkFBd0IsSUFBSSxhQUFhO3dCQUNuRSxLQUFLLEVBQUUsSUFBSSxDQUFDLGdCQUFnQixDQUFDLG1DQUFtQyxDQUFDLEdBQUcsaUJBQWlCLG9CQUFvQixFQUFFLHlCQUF5QixDQUFDO3dCQUNySSxRQUFRLEVBQUUsS0FBSzt3QkFDZixPQUFPLEVBQUUsV0FBVzt3QkFDcEIsYUFBYSxFQUFFLEVBQUU7d0JBQ2pCLE1BQU0sRUFBRSxHQUFHLEVBQUUsQ0FBQyxRQUFRLENBQUMsV0FBVyxDQUFDLEVBQUUsQ0FBQzt3QkFDdEMscUJBQXFCLEVBQUUsR0FBRyxFQUFFOzRCQUMxQixvRUFBb0U7NEJBQ3BFLE1BQU0sYUFBYSxHQUFHLFFBQVEsSUFBSSxRQUFRLENBQUMsV0FBVyxJQUFJLFFBQVEsQ0FBQyxXQUFXLEVBQUUsQ0FBQzs0QkFDakYsT0FBTyxLQUFLLENBQUMsT0FBTyxDQUFDLGFBQWEsQ0FBQyxJQUFJLGFBQWEsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDO3dCQUNsRSxDQUFDO3FCQUNGLENBQ0YsQ0FBQztpQkFDSDthQUNGO1lBRUQseUNBQXlDO1lBQ3pDLElBQUksV0FBVyxJQUFJLFdBQVcsSUFBSSxDQUFDLFdBQVcsQ0FBQyxxQkFBcUIsRUFBRTtnQkFDcEUsTUFBTSxXQUFXLEdBQUcscUJBQXFCLENBQUM7Z0JBQzFDLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxJQUFJLENBQUMsQ0FBQyxJQUFxQixFQUFFLEVBQUUsQ0FBQyxJQUFJLENBQUMsY0FBYyxDQUFDLFNBQVMsQ0FBQyxJQUFJLElBQUksQ0FBQyxPQUFPLEtBQUssV0FBVyxDQUFDLEVBQUU7b0JBQ3hILGVBQWUsQ0FBQyxJQUFJLENBQ2xCO3dCQUNFLFlBQVksRUFBRSxXQUFXLENBQUMsNEJBQTRCLElBQUksZ0JBQWdCO3dCQUMxRSxLQUFLLEVBQUUsSUFBSSxDQUFDLGdCQUFnQixDQUFDLG1DQUFtQyxDQUFDLEdBQUcsaUJBQWlCLHFCQUFxQixFQUFFLDBCQUEwQixDQUFDO3dCQUN2SSxRQUFRLEVBQUUsS0FBSzt3QkFDZixPQUFPLEVBQUUsV0FBVzt3QkFDcEIsYUFBYSxFQUFFLEVBQUU7d0JBQ2pCLE1BQU0sRUFBRSxHQUFHLEVBQUU7NEJBQ1gsSUFBSSxXQUFXLENBQUMsY0FBYyxFQUFFO2dDQUM5QixJQUFJLENBQUMsZUFBZSxDQUFDLHNCQUFzQixDQUFDLElBQUksQ0FBQyxDQUFDOzZCQUNuRDtpQ0FBTTtnQ0FDTCxRQUFRLENBQUMsaUJBQWlCLEVBQUUsQ0FBQzs2QkFDOUI7d0JBQ0gsQ0FBQzt3QkFDRCxxQkFBcUIsRUFBRSxHQUFHLEVBQUU7NEJBQzFCLElBQUksV0FBVyxDQUFDLGNBQWMsRUFBRTtnQ0FDOUIsT0FBTyxJQUFJLENBQUM7NkJBQ2I7NEJBQ0Qsb0VBQW9FOzRCQUNwRSxNQUFNLGFBQWEsR0FBRyxRQUFRLElBQUksUUFBUSxDQUFDLFdBQVcsSUFBSSxRQUFRLENBQUMsV0FBVyxFQUFFLENBQUM7NEJBQ2pGLE9BQU8sS0FBSyxDQUFDLE9BQU8sQ0FBQyxhQUFhLENBQUMsSUFBSSxhQUFhLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQzt3QkFDbEUsQ0FBQztxQkFDRixDQUNGLENBQUM7aUJBQ0g7YUFDRjtZQUVELHVDQUF1QztZQUN2QyxJQUFJLFdBQVcsSUFBSSxXQUFXLElBQUksQ0FBQyxXQUFXLENBQUMsbUJBQW1CLEVBQUU7Z0JBQ2xFLE1BQU0sV0FBVyxHQUFHLG1CQUFtQixDQUFDO2dCQUN4QyxJQUFJLENBQUMsbUJBQW1CLENBQUMsSUFBSSxDQUFDLENBQUMsSUFBcUIsRUFBRSxFQUFFLENBQUMsSUFBSSxDQUFDLGNBQWMsQ0FBQyxTQUFTLENBQUMsSUFBSSxJQUFJLENBQUMsT0FBTyxLQUFLLFdBQVcsQ0FBQyxFQUFFO29CQUN4SCxlQUFlLENBQUMsSUFBSSxDQUNsQjt3QkFDRSxZQUFZLEVBQUUsV0FBVyxDQUFDLDBCQUEwQixJQUFJLGNBQWM7d0JBQ3RFLEtBQUssRUFBRSxJQUFJLENBQUMsZ0JBQWdCLENBQUMsbUNBQW1DLENBQUMsR0FBRyxpQkFBaUIsbUJBQW1CLEVBQUUsd0JBQXdCLENBQUM7d0JBQ25JLFFBQVEsRUFBRSxLQUFLO3dCQUNmLE9BQU8sRUFBRSxXQUFXO3dCQUNwQixhQUFhLEVBQUUsRUFBRTt3QkFDakIsTUFBTSxFQUFFLEdBQUcsRUFBRTs0QkFDWCxJQUFJLFdBQVcsQ0FBQyxjQUFjLEVBQUU7Z0NBQzlCLElBQUksQ0FBQyxlQUFlLENBQUMsc0JBQXNCLENBQUMsS0FBSyxDQUFDLENBQUM7NkJBQ3BEO2lDQUFNO2dDQUNMLFFBQVEsQ0FBQyxlQUFlLEVBQUUsQ0FBQzs2QkFDNUI7d0JBQ0gsQ0FBQzt3QkFDRCxxQkFBcUIsRUFBRSxHQUFHLEVBQUU7NEJBQzFCLElBQUksV0FBVyxDQUFDLGNBQWMsRUFBRTtnQ0FDOUIsT0FBTyxJQUFJLENBQUM7NkJBQ2I7NEJBQ0Qsb0VBQW9FOzRCQUNwRSxNQUFNLGFBQWEsR0FBRyxRQUFRLElBQUksUUFBUSxDQUFDLFdBQVcsSUFBSSxRQUFRLENBQUMsV0FBVyxFQUFFLENBQUM7NEJBQ2pGLE9BQU8sS0FBSyxDQUFDLE9BQU8sQ0FBQyxhQUFhLENBQUMsSUFBSSxhQUFhLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQzt3QkFDbEUsQ0FBQztxQkFDRixDQUNGLENBQUM7aUJBQ0g7YUFDRjtTQUNGO1FBRUQsT0FBTyxlQUFlLENBQUM7SUFDekIsQ0FBQztJQUVEOzs7OztPQUtHO0lBQ0ssZUFBZSxDQUFDLElBQWlDO1FBQ3ZELElBQUk7WUFDRixJQUFJLElBQUksSUFBSSxJQUFJLENBQUMsSUFBSSxJQUFJLElBQUksQ0FBQyxPQUFPLEVBQUU7Z0JBQ3JDLHFGQUFxRjtnQkFDckYsTUFBTSxXQUFXLEdBQUcsSUFBSSxDQUFDLGFBQWEsSUFBSSxJQUFJLENBQUMsYUFBYSxDQUFDLFdBQVcsSUFBSSxFQUFFLENBQUM7Z0JBQy9FLE1BQU0sSUFBSSxHQUFHLElBQUksSUFBSSxJQUFJLENBQUMsSUFBSSxJQUFJLENBQUMsQ0FBQztnQkFDcEMsTUFBTSxHQUFHLEdBQUcsSUFBSSxJQUFJLElBQUksQ0FBQyxHQUFHLElBQUksQ0FBQyxDQUFDO2dCQUNsQyxNQUFNLFNBQVMsR0FBRyxJQUFJLElBQUksSUFBSSxDQUFDLE1BQU0sQ0FBQztnQkFDdEMsTUFBTSxXQUFXLEdBQUcsSUFBSSxJQUFJLElBQUksQ0FBQyxXQUFXLENBQUM7Z0JBQzdDLE1BQU0sSUFBSSxHQUFHLElBQUksQ0FBQyxhQUFhLElBQUksSUFBSSxDQUFDLGFBQWEsQ0FBQyxJQUFJLENBQUM7Z0JBQzNELE1BQU0sYUFBYSxHQUFHLFdBQVcsSUFBSSxDQUFDLFdBQVcsQ0FBQyxrQkFBa0IsSUFBSSxXQUFXLENBQUMsYUFBYSxDQUFDLENBQUM7Z0JBQ25HLElBQUksVUFBVSxHQUFHLDhCQUE4QixDQUFDLEdBQUcsRUFBRSxJQUFJLEVBQUUsV0FBVyxFQUFFLFNBQVMsRUFBRSxJQUFJLEVBQUUsYUFBYSxDQUFDLENBQUM7Z0JBRXhHLElBQUksT0FBTyxTQUFTLENBQUMsc0JBQXNCLEtBQUssVUFBVSxFQUFFO29CQUMxRCxVQUFVLEdBQUcsSUFBSSxDQUFDLGdDQUFnQyxDQUFDLFNBQVMsRUFBRSxXQUFXLENBQUMsQ0FBQztpQkFDNUU7Z0JBRUQsb0ZBQW9GO2dCQUNwRixNQUFNLEtBQUssR0FBRyxRQUFRLENBQUMsV0FBVyxFQUFFLENBQUM7Z0JBQ3JDLE1BQU0sT0FBTyxHQUFHLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxHQUFHLENBQUMsRUFBRSxRQUFRLEVBQUUsVUFBVSxFQUFFLElBQUksRUFBRSxTQUFTLEVBQUUsR0FBRyxFQUFFLFNBQVMsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDO2dCQUMzRyxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFDO2dCQUMxQixLQUFLLENBQUMsa0JBQWtCLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO2dCQUN6QyxNQUFNLFNBQVMsR0FBRyxNQUFNLENBQUMsWUFBWSxFQUFFLENBQUM7Z0JBQ3hDLElBQUksU0FBUyxJQUFJLFNBQVMsQ0FBQyxRQUFRLElBQUksU0FBUyxDQUFDLGVBQWUsRUFBRTtvQkFDaEUsU0FBUyxDQUFDLGVBQWUsRUFBRSxDQUFDO29CQUM1QixTQUFTLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxDQUFDO29CQUMxQixNQUFNLE9BQU8sR0FBRyxRQUFRLENBQUMsV0FBVyxDQUFDLE1BQU0sRUFBRSxLQUFLLEVBQUUsVUFBVSxDQUFDLENBQUM7b0JBQ2hFLElBQUksT0FBTyxFQUFFO3dCQUNYLE9BQU8sQ0FBQyxNQUFNLEVBQUUsQ0FBQztxQkFDbEI7aUJBQ0Y7YUFDRjtTQUNGO1FBQUMsT0FBTyxDQUFDLEVBQUUsR0FBRztJQUNqQixDQUFDO0lBRUQ7Ozs7O09BS0c7SUFDSyxnQ0FBZ0MsQ0FBQyxTQUFpQixFQUFFLFdBQWdCO1FBQzFFLElBQUksU0FBUyxHQUFHLEVBQUUsQ0FBQztRQUVuQixJQUFJLE9BQU8sU0FBUyxDQUFDLHNCQUFzQixLQUFLLFVBQVUsRUFBRTtZQUMxRCxNQUFNLGNBQWMsR0FBRyxTQUFTLENBQUMsc0JBQXNCLENBQUMsV0FBVyxDQUFDLENBQUM7WUFFckUsOEdBQThHO1lBQzlHLElBQUksY0FBYyxJQUFJLGNBQWMsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxFQUFFO2dCQUN0RCxTQUFTLEdBQUcscUJBQXFCLENBQUMsV0FBVyxFQUFFLGNBQWMsQ0FBQyxDQUFDO2FBQ2hFO2lCQUFNO2dCQUNMLFNBQVMsR0FBRyxXQUFXLENBQUMsY0FBYyxDQUFDLENBQUM7YUFDekM7U0FDRjtRQUVELE9BQU8sU0FBUyxDQUFDO0lBQ25CLENBQUM7Q0FDRixDQUFBOztZQXRaK0Isa0JBQWtCO1lBQ3ZCLGFBQWE7WUFDVixnQkFBZ0I7WUFDbkIsYUFBYTtZQUNYLGVBQWU7WUFDVCxnQkFBZ0IsdUJBQTlDLFFBQVE7O0FBWkEsb0JBQW9CO0lBRGhDLFVBQVUsRUFBRTtJQWFSLG1CQUFBLFFBQVEsRUFBRSxDQUFBO0dBWkYsb0JBQW9CLENBNlpoQztTQTdaWSxvQkFBb0IiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlLCBPcHRpb25hbCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBUcmFuc2xhdGVTZXJ2aWNlIH0gZnJvbSAnQG5neC10cmFuc2xhdGUvY29yZSc7XHJcblxyXG5pbXBvcnQge1xyXG4gIENvbHVtbixcclxuICBDb250ZXh0TWVudSxcclxuICBEZWxpbWl0ZXJUeXBlLFxyXG4gIEV4dGVuc2lvbixcclxuICBFeHRlbnNpb25OYW1lLFxyXG4gIEZpbGVUeXBlLFxyXG4gIE1lbnVDYWxsYmFja0FyZ3MsXHJcbiAgTWVudUNvbW1hbmRJdGVtLFxyXG4gIE1lbnVDb21tYW5kSXRlbUNhbGxiYWNrQXJncyxcclxuICBNZW51T3B0aW9uSXRlbUNhbGxiYWNrQXJncyxcclxuICBTbGlja0V2ZW50SGFuZGxlcixcclxufSBmcm9tICcuLi9tb2RlbHMvaW5kZXgnO1xyXG5pbXBvcnQgeyBFeHRlbnNpb25VdGlsaXR5IH0gZnJvbSAnLi9leHRlbnNpb25VdGlsaXR5JztcclxuaW1wb3J0IHsgU2hhcmVkU2VydmljZSB9IGZyb20gJy4uL3NlcnZpY2VzL3NoYXJlZC5zZXJ2aWNlJztcclxuaW1wb3J0IHsgRXhwb3J0U2VydmljZSB9IGZyb20gJy4uL3NlcnZpY2VzL2V4cG9ydC5zZXJ2aWNlJztcclxuaW1wb3J0IHsgRXhjZWxFeHBvcnRTZXJ2aWNlIH0gZnJvbSAnLi4vc2VydmljZXMvZXhjZWxFeHBvcnQuc2VydmljZSc7XHJcbmltcG9ydCB7IFRyZWVEYXRhU2VydmljZSB9IGZyb20gJy4uL3NlcnZpY2VzL3RyZWVEYXRhLnNlcnZpY2UnO1xyXG5pbXBvcnQgeyBleHBvcnRXaXRoRm9ybWF0dGVyV2hlbkRlZmluZWQgfSBmcm9tICcuLi9zZXJ2aWNlcy9leHBvcnQtdXRpbGl0aWVzJztcclxuaW1wb3J0IHsgZ2V0RGVzY2VuZGFudFByb3BlcnR5LCBnZXRUcmFuc2xhdGlvblByZWZpeCB9IGZyb20gJy4uL3NlcnZpY2VzL3V0aWxpdGllcyc7XHJcblxyXG4vLyB1c2luZyBleHRlcm5hbCBub24tdHlwZWQganMgbGlicmFyaWVzXHJcbmRlY2xhcmUgY29uc3QgU2xpY2s6IGFueTtcclxuXHJcbkBJbmplY3RhYmxlKClcclxuZXhwb3J0IGNsYXNzIENvbnRleHRNZW51RXh0ZW5zaW9uIGltcGxlbWVudHMgRXh0ZW5zaW9uIHtcclxuICBwcml2YXRlIF9hZGRvbjogYW55O1xyXG4gIHByaXZhdGUgX2NvbnRleHRNZW51T3B0aW9uczogQ29udGV4dE1lbnUgfCBudWxsO1xyXG4gIHByaXZhdGUgX2V2ZW50SGFuZGxlcjogU2xpY2tFdmVudEhhbmRsZXI7XHJcbiAgcHJpdmF0ZSBfdXNlck9yaWdpbmFsQ29udGV4dE1lbnU6IENvbnRleHRNZW51IHwgdW5kZWZpbmVkO1xyXG5cclxuICBjb25zdHJ1Y3RvcihcclxuICAgIHByaXZhdGUgZXhjZWxFeHBvcnRTZXJ2aWNlOiBFeGNlbEV4cG9ydFNlcnZpY2UsXHJcbiAgICBwcml2YXRlIGV4cG9ydFNlcnZpY2U6IEV4cG9ydFNlcnZpY2UsXHJcbiAgICBwcml2YXRlIGV4dGVuc2lvblV0aWxpdHk6IEV4dGVuc2lvblV0aWxpdHksXHJcbiAgICBwcml2YXRlIHNoYXJlZFNlcnZpY2U6IFNoYXJlZFNlcnZpY2UsXHJcbiAgICBwcml2YXRlIHRyZWVEYXRhU2VydmljZTogVHJlZURhdGFTZXJ2aWNlLFxyXG4gICAgQE9wdGlvbmFsKCkgcHJpdmF0ZSB0cmFuc2xhdGU6IFRyYW5zbGF0ZVNlcnZpY2UsXHJcbiAgKSB7XHJcbiAgICB0aGlzLl9ldmVudEhhbmRsZXIgPSBuZXcgU2xpY2suRXZlbnRIYW5kbGVyKCk7XHJcbiAgfVxyXG5cclxuICBnZXQgZXZlbnRIYW5kbGVyKCk6IFNsaWNrRXZlbnRIYW5kbGVyIHtcclxuICAgIHJldHVybiB0aGlzLl9ldmVudEhhbmRsZXI7XHJcbiAgfVxyXG5cclxuICBkaXNwb3NlKCkge1xyXG4gICAgLy8gdW5zdWJzY3JpYmUgYWxsIFNsaWNrR3JpZCBldmVudHNcclxuICAgIHRoaXMuX2V2ZW50SGFuZGxlci51bnN1YnNjcmliZUFsbCgpO1xyXG5cclxuICAgIGlmICh0aGlzLl9hZGRvbiAmJiB0aGlzLl9hZGRvbi5kZXN0cm95KSB7XHJcbiAgICAgIHRoaXMuX2FkZG9uLmRlc3Ryb3koKTtcclxuICAgIH1cclxuICAgIGlmICh0aGlzLnNoYXJlZFNlcnZpY2UuZ3JpZE9wdGlvbnMgJiYgdGhpcy5zaGFyZWRTZXJ2aWNlLmdyaWRPcHRpb25zLmNvbnRleHRNZW51ICYmIHRoaXMuc2hhcmVkU2VydmljZS5ncmlkT3B0aW9ucy5jb250ZXh0TWVudS5jb21tYW5kSXRlbXMpIHtcclxuICAgICAgdGhpcy5zaGFyZWRTZXJ2aWNlLmdyaWRPcHRpb25zLmNvbnRleHRNZW51ID0gdGhpcy5fdXNlck9yaWdpbmFsQ29udGV4dE1lbnU7XHJcbiAgICB9XHJcbiAgICB0aGlzLmV4dGVuc2lvblV0aWxpdHkubnVsbGlmeUZ1bmN0aW9uTmFtZVN0YXJ0aW5nV2l0aE9uKHRoaXMuX2NvbnRleHRNZW51T3B0aW9ucyk7XHJcbiAgICB0aGlzLl9hZGRvbiA9IG51bGw7XHJcbiAgICB0aGlzLl9jb250ZXh0TWVudU9wdGlvbnMgPSBudWxsO1xyXG4gIH1cclxuXHJcbiAgLyoqIEdldCB0aGUgaW5zdGFuY2Ugb2YgdGhlIFNsaWNrR3JpZCBhZGRvbiAoY29udHJvbCBvciBwbHVnaW4pLiAqL1xyXG4gIGdldEFkZG9uSW5zdGFuY2UoKSB7XHJcbiAgICByZXR1cm4gdGhpcy5fYWRkb247XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBDcmVhdGUgdGhlIEFjdGlvbiBDZWxsIE1lbnUgYW5kIGV4cG9zZSBhbGwgdGhlIGF2YWlsYWJsZSBob29rcyB0aGF0IHVzZXIgY2FuIHN1YnNjcmliZSAob25Db21tYW5kLCBvbkJlZm9yZU1lbnVTaG93LCAuLi4pXHJcbiAgICogQHBhcmFtIGdyaWRcclxuICAgKiBAcGFyYW0gZGF0YVZpZXdcclxuICAgKiBAcGFyYW0gY29sdW1uRGVmaW5pdGlvbnNcclxuICAgKi9cclxuICByZWdpc3RlcigpOiBhbnkge1xyXG4gICAgaWYgKHRoaXMuc2hhcmVkU2VydmljZS5ncmlkT3B0aW9ucyAmJiB0aGlzLnNoYXJlZFNlcnZpY2UuZ3JpZE9wdGlvbnMuZW5hYmxlVHJhbnNsYXRlICYmICghdGhpcy50cmFuc2xhdGUgfHwgIXRoaXMudHJhbnNsYXRlLmluc3RhbnQpKSB7XHJcbiAgICAgIHRocm93IG5ldyBFcnJvcignW0FuZ3VsYXItU2xpY2tncmlkXSByZXF1aXJlcyBcIm5neC10cmFuc2xhdGVcIiB0byBiZSBpbnN0YWxsZWQgYW5kIGNvbmZpZ3VyZWQgd2hlbiB0aGUgZ3JpZCBvcHRpb24gXCJlbmFibGVUcmFuc2xhdGVcIiBpcyBlbmFibGVkLicpO1xyXG4gICAgfVxyXG5cclxuICAgIGlmICh0aGlzLnNoYXJlZFNlcnZpY2UgJiYgdGhpcy5zaGFyZWRTZXJ2aWNlLmdyaWQgJiYgdGhpcy5zaGFyZWRTZXJ2aWNlLmdyaWRPcHRpb25zICYmIHRoaXMuc2hhcmVkU2VydmljZS5ncmlkT3B0aW9ucy5jb250ZXh0TWVudSkge1xyXG4gICAgICB0aGlzLl9jb250ZXh0TWVudU9wdGlvbnMgPSB0aGlzLnNoYXJlZFNlcnZpY2UuZ3JpZE9wdGlvbnMuY29udGV4dE1lbnU7XHJcblxyXG4gICAgICAvLyBrZWVwIG9yaWdpbmFsIHVzZXIgY29udGV4dCBtZW51LCB1c2VmdWwgd2hlbiBzd2l0Y2hpbmcgbG9jYWxlIHRvIHRyYW5zbGF0ZVxyXG4gICAgICB0aGlzLl91c2VyT3JpZ2luYWxDb250ZXh0TWVudSA9IHsgLi4udGhpcy5fY29udGV4dE1lbnVPcHRpb25zIH07XHJcblxyXG4gICAgICAvLyBkeW5hbWljYWxseSBpbXBvcnQgdGhlIFNsaWNrR3JpZCBwbHVnaW4gKGFkZG9uKSB3aXRoIFJlcXVpcmVKU1xyXG4gICAgICB0aGlzLmV4dGVuc2lvblV0aWxpdHkubG9hZEV4dGVuc2lvbkR5bmFtaWNhbGx5KEV4dGVuc2lvbk5hbWUuY29udGV4dE1lbnUpO1xyXG5cclxuICAgICAgLy8gbWVyZ2UgdGhlIG9yaWdpbmFsIGNvbW1hbmRzIHdpdGggdGhlIGJ1aWx0LWluIGludGVybmFsIGNvbW1hbmRzXHJcbiAgICAgIGNvbnN0IG9yaWdpbmFsQ29tbWFuZEl0ZW1zID0gdGhpcy5fdXNlck9yaWdpbmFsQ29udGV4dE1lbnUgJiYgQXJyYXkuaXNBcnJheSh0aGlzLl91c2VyT3JpZ2luYWxDb250ZXh0TWVudS5jb21tYW5kSXRlbXMpID8gdGhpcy5fdXNlck9yaWdpbmFsQ29udGV4dE1lbnUuY29tbWFuZEl0ZW1zIDogW107XHJcbiAgICAgIHRoaXMuX2NvbnRleHRNZW51T3B0aW9ucy5jb21tYW5kSXRlbXMgPSBbLi4ub3JpZ2luYWxDb21tYW5kSXRlbXMsIC4uLnRoaXMuYWRkTWVudUN1c3RvbUNvbW1hbmRzKG9yaWdpbmFsQ29tbWFuZEl0ZW1zKV07XHJcbiAgICAgIHRoaXMuX2NvbnRleHRNZW51T3B0aW9ucyA9IHsgLi4udGhpcy5fY29udGV4dE1lbnVPcHRpb25zIH07XHJcbiAgICAgIHRoaXMuc2hhcmVkU2VydmljZS5ncmlkT3B0aW9ucy5jb250ZXh0TWVudSA9IHRoaXMuX2NvbnRleHRNZW51T3B0aW9ucztcclxuXHJcbiAgICAgIC8vIHNvcnQgYWxsIG1lbnUgaXRlbXMgYnkgdGhlaXIgcG9zaXRpb24gb3JkZXIgd2hlbiBkZWZpbmVkXHJcbiAgICAgIHRoaXMuZXh0ZW5zaW9uVXRpbGl0eS5zb3J0SXRlbXModGhpcy5fY29udGV4dE1lbnVPcHRpb25zLmNvbW1hbmRJdGVtcyB8fCBbXSwgJ3Bvc2l0aW9uT3JkZXInKTtcclxuICAgICAgdGhpcy5leHRlbnNpb25VdGlsaXR5LnNvcnRJdGVtcyh0aGlzLl9jb250ZXh0TWVudU9wdGlvbnMub3B0aW9uSXRlbXMgfHwgW10sICdwb3NpdGlvbk9yZGVyJyk7XHJcblxyXG4gICAgICB0aGlzLl9hZGRvbiA9IG5ldyBTbGljay5QbHVnaW5zLkNvbnRleHRNZW51KHRoaXMuX2NvbnRleHRNZW51T3B0aW9ucyk7XHJcbiAgICAgIHRoaXMuc2hhcmVkU2VydmljZS5ncmlkLnJlZ2lzdGVyUGx1Z2luKHRoaXMuX2FkZG9uKTtcclxuXHJcbiAgICAgIC8vIHRyYW5zbGF0ZSB0aGUgaXRlbSBrZXlzIHdoZW4gbmVjZXNzYXJ5XHJcbiAgICAgIGlmICh0aGlzLnNoYXJlZFNlcnZpY2UuZ3JpZE9wdGlvbnMuZW5hYmxlVHJhbnNsYXRlKSB7XHJcbiAgICAgICAgdGhpcy50cmFuc2xhdGVDb250ZXh0TWVudSgpO1xyXG4gICAgICB9XHJcblxyXG4gICAgICAvLyBob29rIGFsbCBldmVudHNcclxuICAgICAgaWYgKHRoaXMuc2hhcmVkU2VydmljZS5ncmlkICYmIHRoaXMuX2NvbnRleHRNZW51T3B0aW9ucykge1xyXG4gICAgICAgIGlmICh0aGlzLl9jb250ZXh0TWVudU9wdGlvbnMub25FeHRlbnNpb25SZWdpc3RlcmVkKSB7XHJcbiAgICAgICAgICB0aGlzLl9jb250ZXh0TWVudU9wdGlvbnMub25FeHRlbnNpb25SZWdpc3RlcmVkKHRoaXMuX2FkZG9uKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKHRoaXMuX2NvbnRleHRNZW51T3B0aW9ucyAmJiB0eXBlb2YgdGhpcy5fY29udGV4dE1lbnVPcHRpb25zLm9uQ29tbWFuZCA9PT0gJ2Z1bmN0aW9uJykge1xyXG4gICAgICAgICAgdGhpcy5fZXZlbnRIYW5kbGVyLnN1YnNjcmliZSh0aGlzLl9hZGRvbi5vbkNvbW1hbmQsIChldmVudDogRXZlbnQsIGFyZ3M6IE1lbnVDb21tYW5kSXRlbUNhbGxiYWNrQXJncykgPT4ge1xyXG4gICAgICAgICAgICB0aGlzLl9jb250ZXh0TWVudU9wdGlvbnMub25Db21tYW5kKGV2ZW50LCBhcmdzKTtcclxuICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAodGhpcy5fY29udGV4dE1lbnVPcHRpb25zICYmIHR5cGVvZiB0aGlzLl9jb250ZXh0TWVudU9wdGlvbnMub25PcHRpb25TZWxlY3RlZCA9PT0gJ2Z1bmN0aW9uJykge1xyXG4gICAgICAgICAgdGhpcy5fZXZlbnRIYW5kbGVyLnN1YnNjcmliZSh0aGlzLl9hZGRvbi5vbk9wdGlvblNlbGVjdGVkLCAoZXZlbnQ6IEV2ZW50LCBhcmdzOiBNZW51T3B0aW9uSXRlbUNhbGxiYWNrQXJncykgPT4ge1xyXG4gICAgICAgICAgICB0aGlzLl9jb250ZXh0TWVudU9wdGlvbnMub25PcHRpb25TZWxlY3RlZChldmVudCwgYXJncyk7XHJcbiAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKHRoaXMuX2NvbnRleHRNZW51T3B0aW9ucyAmJiB0eXBlb2YgdGhpcy5fY29udGV4dE1lbnVPcHRpb25zLm9uQmVmb3JlTWVudVNob3cgPT09ICdmdW5jdGlvbicpIHtcclxuICAgICAgICAgIHRoaXMuX2V2ZW50SGFuZGxlci5zdWJzY3JpYmUodGhpcy5fYWRkb24ub25CZWZvcmVNZW51U2hvdywgKGV2ZW50OiBFdmVudCwgYXJnczogeyBjZWxsOiBudW1iZXI7IHJvdzogbnVtYmVyOyBncmlkOiBhbnk7IH0pID0+IHtcclxuICAgICAgICAgICAgdGhpcy5fY29udGV4dE1lbnVPcHRpb25zLm9uQmVmb3JlTWVudVNob3coZXZlbnQsIGFyZ3MpO1xyXG4gICAgICAgICAgfSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmICh0aGlzLl9jb250ZXh0TWVudU9wdGlvbnMgJiYgdHlwZW9mIHRoaXMuX2NvbnRleHRNZW51T3B0aW9ucy5vbkJlZm9yZU1lbnVDbG9zZSA9PT0gJ2Z1bmN0aW9uJykge1xyXG4gICAgICAgICAgdGhpcy5fZXZlbnRIYW5kbGVyLnN1YnNjcmliZSh0aGlzLl9hZGRvbi5vbkJlZm9yZU1lbnVDbG9zZSwgKGV2ZW50OiBFdmVudCwgYXJnczogeyBjZWxsOiBudW1iZXI7IHJvdzogbnVtYmVyOyBncmlkOiBhbnk7IG1lbnU6IGFueTsgfSkgPT4ge1xyXG4gICAgICAgICAgICB0aGlzLl9jb250ZXh0TWVudU9wdGlvbnMub25CZWZvcmVNZW51Q2xvc2UoZXZlbnQsIGFyZ3MpO1xyXG4gICAgICAgICAgfSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmICh0aGlzLl9jb250ZXh0TWVudU9wdGlvbnMgJiYgdHlwZW9mIHRoaXMuX2NvbnRleHRNZW51T3B0aW9ucy5vbkFmdGVyTWVudVNob3cgPT09ICdmdW5jdGlvbicpIHtcclxuICAgICAgICAgIHRoaXMuX2V2ZW50SGFuZGxlci5zdWJzY3JpYmUodGhpcy5fYWRkb24ub25BZnRlck1lbnVTaG93LCAoZXZlbnQ6IEV2ZW50LCBhcmdzOiB7IGNlbGw6IG51bWJlcjsgcm93OiBudW1iZXI7IGdyaWQ6IGFueTsgfSkgPT4ge1xyXG4gICAgICAgICAgICB0aGlzLl9jb250ZXh0TWVudU9wdGlvbnMub25BZnRlck1lbnVTaG93KGV2ZW50LCBhcmdzKTtcclxuICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgICByZXR1cm4gdGhpcy5fYWRkb247XHJcbiAgICB9XHJcbiAgICByZXR1cm4gbnVsbDtcclxuICB9XHJcblxyXG4gIC8qKiBUcmFuc2xhdGUgdGhlIENlbGwgTWVudSB0aXRsZXMsIHdlIG5lZWQgdG8gbG9vcCB0aHJvdWdoIGFsbCBjb2x1bW4gZGVmaW5pdGlvbiB0byByZS10cmFuc2xhdGUgdGhlbSAqL1xyXG4gIHRyYW5zbGF0ZUNvbnRleHRNZW51KCkge1xyXG4gICAgaWYgKHRoaXMuc2hhcmVkU2VydmljZSAmJiB0aGlzLnNoYXJlZFNlcnZpY2UuZ3JpZE9wdGlvbnMgJiYgdGhpcy5zaGFyZWRTZXJ2aWNlLmdyaWRPcHRpb25zLmNvbnRleHRNZW51KSB7XHJcbiAgICAgIGNvbnN0IGNvbnRleHRNZW51ID0gdGhpcy5zaGFyZWRTZXJ2aWNlLmdyaWRPcHRpb25zLmNvbnRleHRNZW51O1xyXG4gICAgICBjb25zdCBtZW51T3B0aW9uczogUGFydGlhbDxDb250ZXh0TWVudT4gPSB7fTtcclxuXHJcbiAgICAgIGlmIChjb250ZXh0TWVudS5jb21tYW5kVGl0bGVLZXkpIHtcclxuICAgICAgICBjb250ZXh0TWVudS5jb21tYW5kVGl0bGUgPSB0aGlzLnRyYW5zbGF0ZSAmJiB0aGlzLnRyYW5zbGF0ZS5jdXJyZW50TGFuZyAmJiB0aGlzLnRyYW5zbGF0ZS5pbnN0YW50ICYmIHRoaXMudHJhbnNsYXRlLmluc3RhbnQoY29udGV4dE1lbnUuY29tbWFuZFRpdGxlS2V5KSB8fCBjb250ZXh0TWVudS5jb21tYW5kVGl0bGU7XHJcbiAgICAgICAgbWVudU9wdGlvbnMuY29tbWFuZFRpdGxlID0gY29udGV4dE1lbnUuY29tbWFuZFRpdGxlO1xyXG4gICAgICB9XHJcbiAgICAgIGlmIChjb250ZXh0TWVudS5vcHRpb25UaXRsZUtleSkge1xyXG4gICAgICAgIGNvbnRleHRNZW51Lm9wdGlvblRpdGxlID0gdGhpcy50cmFuc2xhdGUgJiYgdGhpcy50cmFuc2xhdGUuY3VycmVudExhbmcgJiYgdGhpcy50cmFuc2xhdGUuaW5zdGFudCAmJiB0aGlzLnRyYW5zbGF0ZS5pbnN0YW50KGNvbnRleHRNZW51Lm9wdGlvblRpdGxlS2V5KSB8fCBjb250ZXh0TWVudS5vcHRpb25UaXRsZTtcclxuICAgICAgICBtZW51T3B0aW9ucy5vcHRpb25UaXRsZSA9IGNvbnRleHRNZW51Lm9wdGlvblRpdGxlO1xyXG4gICAgICB9XHJcbiAgICAgIGNvbnN0IG9yaWdpbmFsQ29tbWFuZEl0ZW1zID0gdGhpcy5fdXNlck9yaWdpbmFsQ29udGV4dE1lbnUgJiYgQXJyYXkuaXNBcnJheSh0aGlzLl91c2VyT3JpZ2luYWxDb250ZXh0TWVudS5jb21tYW5kSXRlbXMpID8gdGhpcy5fdXNlck9yaWdpbmFsQ29udGV4dE1lbnUuY29tbWFuZEl0ZW1zIDogW107XHJcbiAgICAgIGNvbnRleHRNZW51LmNvbW1hbmRJdGVtcyA9IFsuLi5vcmlnaW5hbENvbW1hbmRJdGVtcywgLi4udGhpcy5hZGRNZW51Q3VzdG9tQ29tbWFuZHMob3JpZ2luYWxDb21tYW5kSXRlbXMpXTtcclxuICAgICAgbWVudU9wdGlvbnMuY29tbWFuZEl0ZW1zID0gY29udGV4dE1lbnUuY29tbWFuZEl0ZW1zOyAvLyBjb3B5IGl0IGFsc28gdG8gdGhlIG1lbnVPcHRpb25zIGVsc2UgdGhleSB3b24ndCBiZSB0cmFuc2xhdGVkIHdoZW4gbG9jYWxlIGNoYW5nZXNcclxuXHJcbiAgICAgIC8vIHRyYW5zbGF0ZSBhbGwgY29tbWFuZC9vcHRpb25zIGFuZCByZXNvcnQgdGhlbSBhZnRlcndhcmRcclxuICAgICAgdGhpcy5leHRlbnNpb25VdGlsaXR5LnRyYW5zbGF0ZUl0ZW1zKGNvbnRleHRNZW51LmNvbW1hbmRJdGVtcyB8fCBbXSwgJ3RpdGxlS2V5JywgJ3RpdGxlJyk7XHJcbiAgICAgIHRoaXMuZXh0ZW5zaW9uVXRpbGl0eS50cmFuc2xhdGVJdGVtcyhjb250ZXh0TWVudS5vcHRpb25JdGVtcyB8fCBbXSwgJ3RpdGxlS2V5JywgJ3RpdGxlJyk7XHJcbiAgICAgIHRoaXMuZXh0ZW5zaW9uVXRpbGl0eS5zb3J0SXRlbXMoY29udGV4dE1lbnUuY29tbWFuZEl0ZW1zIHx8IFtdLCAncG9zaXRpb25PcmRlcicpO1xyXG4gICAgICB0aGlzLmV4dGVuc2lvblV0aWxpdHkuc29ydEl0ZW1zKGNvbnRleHRNZW51Lm9wdGlvbkl0ZW1zIHx8IFtdLCAncG9zaXRpb25PcmRlcicpO1xyXG5cclxuICAgICAgLy8gdXBkYXRlIHRoZSB0aXRsZSBvcHRpb25zIHNvIHRoYXQgaXQgaGFzIGxhdGVzdCB0cmFuc2xhdGVkIHZhbHVlc1xyXG4gICAgICBpZiAodGhpcy5fYWRkb24gJiYgdGhpcy5fYWRkb24uc2V0T3B0aW9ucykge1xyXG4gICAgICAgIHRoaXMuX2FkZG9uLnNldE9wdGlvbnMobWVudU9wdGlvbnMpO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvLyAtLVxyXG4gIC8vIHByaXZhdGUgZnVuY3Rpb25zXHJcbiAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tXHJcblxyXG4gIC8qKiBDcmVhdGUgQ29udGV4dCBNZW51IHdpdGggQ3VzdG9tIENvbW1hbmRzIChjb3B5IGNlbGwgdmFsdWUsIGV4cG9ydCkgKi9cclxuICBwcml2YXRlIGFkZE1lbnVDdXN0b21Db21tYW5kcyhvcmlnaW5hbEN1c3RvbUl0ZW1zOiBBcnJheTxNZW51Q29tbWFuZEl0ZW0gfCAnZGl2aWRlcic+KSB7XHJcbiAgICBjb25zdCBtZW51Q3VzdG9tSXRlbXM6IEFycmF5PE1lbnVDb21tYW5kSXRlbSB8ICdkaXZpZGVyJz4gPSBbXTtcclxuICAgIGNvbnN0IGdyaWRPcHRpb25zID0gdGhpcy5zaGFyZWRTZXJ2aWNlICYmIHRoaXMuc2hhcmVkU2VydmljZS5ncmlkT3B0aW9ucyB8fCB7fTtcclxuICAgIGNvbnN0IGNvbnRleHRNZW51ID0gZ3JpZE9wdGlvbnMgJiYgZ3JpZE9wdGlvbnMuY29udGV4dE1lbnU7XHJcbiAgICBjb25zdCBkYXRhVmlldyA9IHRoaXMuc2hhcmVkU2VydmljZSAmJiB0aGlzLnNoYXJlZFNlcnZpY2UuZGF0YVZpZXc7XHJcbiAgICBjb25zdCB0cmFuc2xhdGlvblByZWZpeCA9IGdldFRyYW5zbGF0aW9uUHJlZml4KGdyaWRPcHRpb25zKTtcclxuXHJcbiAgICAvLyBzaG93IGNvbnRleHQgbWVudTogQ29weSAoY2VsbCB2YWx1ZSlcclxuICAgIGlmIChjb250ZXh0TWVudSAmJiAhY29udGV4dE1lbnUuaGlkZUNvcHlDZWxsVmFsdWVDb21tYW5kKSB7XHJcbiAgICAgIGNvbnN0IGNvbW1hbmROYW1lID0gJ2NvcHknO1xyXG4gICAgICBpZiAoIW9yaWdpbmFsQ3VzdG9tSXRlbXMuZmluZCgoaXRlbTogTWVudUNvbW1hbmRJdGVtKSA9PiBpdGVtLmhhc093blByb3BlcnR5KCdjb21tYW5kJykgJiYgaXRlbS5jb21tYW5kID09PSBjb21tYW5kTmFtZSkpIHtcclxuICAgICAgICBtZW51Q3VzdG9tSXRlbXMucHVzaChcclxuICAgICAgICAgIHtcclxuICAgICAgICAgICAgaWNvbkNzc0NsYXNzOiBjb250ZXh0TWVudS5pY29uQ29weUNlbGxWYWx1ZUNvbW1hbmQgfHwgJ2ZhIGZhLWNsb25lJyxcclxuICAgICAgICAgICAgdGl0bGU6IHRoaXMuZXh0ZW5zaW9uVXRpbGl0eS50cmFuc2xhdGVXaGVuRW5hYmxlZEFuZFNlcnZpY2VFeGlzdChgJHt0cmFuc2xhdGlvblByZWZpeH1DT1BZYCwgJ1RFWFRfQ09QWScpLFxyXG4gICAgICAgICAgICBkaXNhYmxlZDogZmFsc2UsXHJcbiAgICAgICAgICAgIGNvbW1hbmQ6IGNvbW1hbmROYW1lLFxyXG4gICAgICAgICAgICBwb3NpdGlvbk9yZGVyOiA1MCxcclxuICAgICAgICAgICAgYWN0aW9uOiAoZTogRXZlbnQsIGFyZ3M6IE1lbnVDb21tYW5kSXRlbUNhbGxiYWNrQXJncykgPT4ge1xyXG4gICAgICAgICAgICAgIHRoaXMuY29weVRvQ2xpcGJvYXJkKGFyZ3MpO1xyXG4gICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICBpdGVtVXNhYmlsaXR5T3ZlcnJpZGU6IChhcmdzOiBNZW51Q2FsbGJhY2tBcmdzKSA9PiB7XHJcbiAgICAgICAgICAgICAgLy8gbWFrZSBzdXJlIHRoZXJlJ3MgYW4gaXRlbSB0byBjb3B5IGJlZm9yZSBlbmFibGluZyB0aGlzIGNvbW1hbmRcclxuICAgICAgICAgICAgICBjb25zdCBjb2x1bW5EZWYgPSBhcmdzICYmIGFyZ3MuY29sdW1uIGFzIENvbHVtbjtcclxuICAgICAgICAgICAgICBjb25zdCBkYXRhQ29udGV4dCA9IGFyZ3MgJiYgYXJncy5kYXRhQ29udGV4dDtcclxuICAgICAgICAgICAgICBpZiAodHlwZW9mIGNvbHVtbkRlZi5xdWVyeUZpZWxkTmFtZUdldHRlckZuID09PSAnZnVuY3Rpb24nKSB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBjZWxsVmFsdWUgPSB0aGlzLmdldENlbGxWYWx1ZUZyb21RdWVyeUZpZWxkR2V0dGVyKGNvbHVtbkRlZiwgZGF0YUNvbnRleHQpO1xyXG4gICAgICAgICAgICAgICAgaWYgKGNlbGxWYWx1ZSAhPT0gJycgJiYgY2VsbFZhbHVlICE9PSB1bmRlZmluZWQpIHtcclxuICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgfSBlbHNlIGlmIChjb2x1bW5EZWYgJiYgZGF0YUNvbnRleHQuaGFzT3duUHJvcGVydHkoY29sdW1uRGVmLmZpZWxkKSkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGRhdGFDb250ZXh0W2NvbHVtbkRlZi5maWVsZF0gIT09ICcnICYmIGRhdGFDb250ZXh0W2NvbHVtbkRlZi5maWVsZF0gIT09IG51bGwgJiYgZGF0YUNvbnRleHRbY29sdW1uRGVmLmZpZWxkXSAhPT0gdW5kZWZpbmVkO1xyXG4gICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgIH1cclxuICAgICAgICApO1xyXG4gICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgLy8gc2hvdyBjb250ZXh0IG1lbnU6IEV4cG9ydCB0byBmaWxlXHJcbiAgICBpZiAoZ3JpZE9wdGlvbnMgJiYgZ3JpZE9wdGlvbnMuZW5hYmxlRXhwb3J0ICYmIGNvbnRleHRNZW51ICYmICFjb250ZXh0TWVudS5oaWRlRXhwb3J0Q3N2Q29tbWFuZCkge1xyXG4gICAgICBjb25zdCBjb21tYW5kTmFtZSA9ICdleHBvcnQtY3N2JztcclxuICAgICAgaWYgKCFvcmlnaW5hbEN1c3RvbUl0ZW1zLmZpbmQoKGl0ZW06IE1lbnVDb21tYW5kSXRlbSkgPT4gaXRlbS5oYXNPd25Qcm9wZXJ0eSgnY29tbWFuZCcpICYmIGl0ZW0uY29tbWFuZCA9PT0gY29tbWFuZE5hbWUpKSB7XHJcbiAgICAgICAgbWVudUN1c3RvbUl0ZW1zLnB1c2goXHJcbiAgICAgICAgICB7XHJcbiAgICAgICAgICAgIGljb25Dc3NDbGFzczogY29udGV4dE1lbnUuaWNvbkV4cG9ydENzdkNvbW1hbmQgfHwgJ2ZhIGZhLWRvd25sb2FkJyxcclxuICAgICAgICAgICAgdGl0bGU6IHRoaXMuZXh0ZW5zaW9uVXRpbGl0eS50cmFuc2xhdGVXaGVuRW5hYmxlZEFuZFNlcnZpY2VFeGlzdChgJHt0cmFuc2xhdGlvblByZWZpeH1FWFBPUlRfVE9fQ1NWYCwgJ1RFWFRfRVhQT1JUX1RPX0NTVicpLFxyXG4gICAgICAgICAgICBkaXNhYmxlZDogZmFsc2UsXHJcbiAgICAgICAgICAgIGNvbW1hbmQ6IGNvbW1hbmROYW1lLFxyXG4gICAgICAgICAgICBwb3NpdGlvbk9yZGVyOiA1MSxcclxuICAgICAgICAgICAgYWN0aW9uOiAoKSA9PiB0aGlzLmV4cG9ydFNlcnZpY2UuZXhwb3J0VG9GaWxlKHtcclxuICAgICAgICAgICAgICBkZWxpbWl0ZXI6IERlbGltaXRlclR5cGUuY29tbWEsXHJcbiAgICAgICAgICAgICAgZmlsZW5hbWU6ICdleHBvcnQnLFxyXG4gICAgICAgICAgICAgIGZvcm1hdDogRmlsZVR5cGUuY3N2LFxyXG4gICAgICAgICAgICAgIHVzZVV0ZjhXaXRoQm9tOiB0cnVlLFxyXG4gICAgICAgICAgICB9KSxcclxuICAgICAgICAgIH1cclxuICAgICAgICApO1xyXG4gICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgLy8gc2hvdyBjb250ZXh0IG1lbnU6IEV4cG9ydCB0byBFeGNlbFxyXG4gICAgaWYgKGdyaWRPcHRpb25zICYmIGdyaWRPcHRpb25zLmVuYWJsZUV4Y2VsRXhwb3J0ICYmIGNvbnRleHRNZW51ICYmICFjb250ZXh0TWVudS5oaWRlRXhwb3J0RXhjZWxDb21tYW5kKSB7XHJcbiAgICAgIGNvbnN0IGNvbW1hbmROYW1lID0gJ2V4cG9ydC1leGNlbCc7XHJcbiAgICAgIGlmICghb3JpZ2luYWxDdXN0b21JdGVtcy5maW5kKChpdGVtOiBNZW51Q29tbWFuZEl0ZW0pID0+IGl0ZW0uaGFzT3duUHJvcGVydHkoJ2NvbW1hbmQnKSAmJiBpdGVtLmNvbW1hbmQgPT09IGNvbW1hbmROYW1lKSkge1xyXG4gICAgICAgIG1lbnVDdXN0b21JdGVtcy5wdXNoKFxyXG4gICAgICAgICAge1xyXG4gICAgICAgICAgICBpY29uQ3NzQ2xhc3M6IGNvbnRleHRNZW51Lmljb25FeHBvcnRFeGNlbENvbW1hbmQgfHwgJ2ZhIGZhLWZpbGUtZXhjZWwtbyB0ZXh0LXN1Y2Nlc3MnLFxyXG4gICAgICAgICAgICB0aXRsZTogdGhpcy5leHRlbnNpb25VdGlsaXR5LnRyYW5zbGF0ZVdoZW5FbmFibGVkQW5kU2VydmljZUV4aXN0KGAke3RyYW5zbGF0aW9uUHJlZml4fUVYUE9SVF9UT19FWENFTGAsICdURVhUX0VYUE9SVF9UT19FWENFTCcpLFxyXG4gICAgICAgICAgICBkaXNhYmxlZDogZmFsc2UsXHJcbiAgICAgICAgICAgIGNvbW1hbmQ6IGNvbW1hbmROYW1lLFxyXG4gICAgICAgICAgICBwb3NpdGlvbk9yZGVyOiA1MixcclxuICAgICAgICAgICAgYWN0aW9uOiAoKSA9PiB0aGlzLmV4Y2VsRXhwb3J0U2VydmljZS5leHBvcnRUb0V4Y2VsKHtcclxuICAgICAgICAgICAgICBmaWxlbmFtZTogJ2V4cG9ydCcsXHJcbiAgICAgICAgICAgICAgZm9ybWF0OiBGaWxlVHlwZS54bHN4LFxyXG4gICAgICAgICAgICB9KSxcclxuICAgICAgICAgIH1cclxuICAgICAgICApO1xyXG4gICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgLy8gc2hvdyBjb250ZXh0IG1lbnU6IGV4cG9ydCB0byB0ZXh0IGZpbGUgYXMgdGFiIGRlbGltaXRlZFxyXG4gICAgaWYgKGdyaWRPcHRpb25zICYmIGdyaWRPcHRpb25zLmVuYWJsZUV4cG9ydCAmJiBjb250ZXh0TWVudSAmJiAhY29udGV4dE1lbnUuaGlkZUV4cG9ydFRleHREZWxpbWl0ZWRDb21tYW5kKSB7XHJcbiAgICAgIGNvbnN0IGNvbW1hbmROYW1lID0gJ2V4cG9ydC10ZXh0LWRlbGltaXRlZCc7XHJcbiAgICAgIGlmICghb3JpZ2luYWxDdXN0b21JdGVtcy5maW5kKChpdGVtOiBNZW51Q29tbWFuZEl0ZW0pID0+IGl0ZW0uaGFzT3duUHJvcGVydHkoJ2NvbW1hbmQnKSAmJiBpdGVtLmNvbW1hbmQgPT09IGNvbW1hbmROYW1lKSkge1xyXG4gICAgICAgIG1lbnVDdXN0b21JdGVtcy5wdXNoKFxyXG4gICAgICAgICAge1xyXG4gICAgICAgICAgICBpY29uQ3NzQ2xhc3M6IGNvbnRleHRNZW51Lmljb25FeHBvcnRUZXh0RGVsaW1pdGVkQ29tbWFuZCB8fCAnZmEgZmEtZG93bmxvYWQnLFxyXG4gICAgICAgICAgICB0aXRsZTogdGhpcy5leHRlbnNpb25VdGlsaXR5LnRyYW5zbGF0ZVdoZW5FbmFibGVkQW5kU2VydmljZUV4aXN0KGAke3RyYW5zbGF0aW9uUHJlZml4fUVYUE9SVF9UT19UQUJfREVMSU1JVEVEYCwgJ1RFWFRfRVhQT1JUX1RPX1RBQl9ERUxJTUlURUQnKSxcclxuICAgICAgICAgICAgZGlzYWJsZWQ6IGZhbHNlLFxyXG4gICAgICAgICAgICBjb21tYW5kOiBjb21tYW5kTmFtZSxcclxuICAgICAgICAgICAgcG9zaXRpb25PcmRlcjogNTMsXHJcbiAgICAgICAgICAgIGFjdGlvbjogKCkgPT4gdGhpcy5leHBvcnRTZXJ2aWNlLmV4cG9ydFRvRmlsZSh7XHJcbiAgICAgICAgICAgICAgZGVsaW1pdGVyOiBEZWxpbWl0ZXJUeXBlLnRhYixcclxuICAgICAgICAgICAgICBmaWxlbmFtZTogJ2V4cG9ydCcsXHJcbiAgICAgICAgICAgICAgZm9ybWF0OiBGaWxlVHlwZS50eHQsXHJcbiAgICAgICAgICAgICAgdXNlVXRmOFdpdGhCb206IHRydWUsXHJcbiAgICAgICAgICAgIH0pLFxyXG4gICAgICAgICAgfVxyXG4gICAgICAgICk7XHJcbiAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICAvLyAtLSBHcm91cGluZyBDb21tYW5kc1xyXG4gICAgaWYgKGdyaWRPcHRpb25zICYmIChncmlkT3B0aW9ucy5lbmFibGVHcm91cGluZyB8fCBncmlkT3B0aW9ucy5lbmFibGVEcmFnZ2FibGVHcm91cGluZyB8fCBncmlkT3B0aW9ucy5lbmFibGVUcmVlRGF0YSkpIHtcclxuICAgICAgLy8gYWRkIGEgZGl2aWRlciAoc2VwYXJhdG9yKSBiZXR3ZWVuIHRoZSB0b3Agc29ydCBjb21tYW5kcyBhbmQgdGhlIG90aGVyIGNsZWFyIGNvbW1hbmRzXHJcbiAgICAgIGlmIChjb250ZXh0TWVudSAmJiAhY29udGV4dE1lbnUuaGlkZUNvcHlDZWxsVmFsdWVDb21tYW5kKSB7XHJcbiAgICAgICAgbWVudUN1c3RvbUl0ZW1zLnB1c2goeyBkaXZpZGVyOiB0cnVlLCBjb21tYW5kOiAnJywgcG9zaXRpb25PcmRlcjogNTQgfSk7XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIC8vIHNob3cgY29udGV4dCBtZW51OiBDbGVhciBHcm91cGluZ1xyXG4gICAgICBpZiAoZ3JpZE9wdGlvbnMgJiYgIWdyaWRPcHRpb25zLmVuYWJsZVRyZWVEYXRhICYmIGNvbnRleHRNZW51ICYmICFjb250ZXh0TWVudS5oaWRlQ2xlYXJBbGxHcm91cGluZykge1xyXG4gICAgICAgIGNvbnN0IGNvbW1hbmROYW1lID0gJ2NsZWFyLWdyb3VwaW5nJztcclxuICAgICAgICBpZiAoIW9yaWdpbmFsQ3VzdG9tSXRlbXMuZmluZCgoaXRlbTogTWVudUNvbW1hbmRJdGVtKSA9PiBpdGVtLmhhc093blByb3BlcnR5KCdjb21tYW5kJykgJiYgaXRlbS5jb21tYW5kID09PSBjb21tYW5kTmFtZSkpIHtcclxuICAgICAgICAgIG1lbnVDdXN0b21JdGVtcy5wdXNoKFxyXG4gICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgaWNvbkNzc0NsYXNzOiBjb250ZXh0TWVudS5pY29uQ2xlYXJHcm91cGluZ0NvbW1hbmQgfHwgJ2ZhIGZhLXRpbWVzJyxcclxuICAgICAgICAgICAgICB0aXRsZTogdGhpcy5leHRlbnNpb25VdGlsaXR5LnRyYW5zbGF0ZVdoZW5FbmFibGVkQW5kU2VydmljZUV4aXN0KGAke3RyYW5zbGF0aW9uUHJlZml4fUNMRUFSX0FMTF9HUk9VUElOR2AsICdURVhUX0NMRUFSX0FMTF9HUk9VUElORycpLFxyXG4gICAgICAgICAgICAgIGRpc2FibGVkOiBmYWxzZSxcclxuICAgICAgICAgICAgICBjb21tYW5kOiBjb21tYW5kTmFtZSxcclxuICAgICAgICAgICAgICBwb3NpdGlvbk9yZGVyOiA1NSxcclxuICAgICAgICAgICAgICBhY3Rpb246ICgpID0+IGRhdGFWaWV3LnNldEdyb3VwaW5nKFtdKSxcclxuICAgICAgICAgICAgICBpdGVtVXNhYmlsaXR5T3ZlcnJpZGU6ICgpID0+IHtcclxuICAgICAgICAgICAgICAgIC8vIG9ubHkgZW5hYmxlIHRoZSBjb21tYW5kIHdoZW4gdGhlcmUncyBhbiBhY3R1YWxseSBncm91cGluZyBpbiBwbGF5XHJcbiAgICAgICAgICAgICAgICBjb25zdCBncm91cGluZ0FycmF5ID0gZGF0YVZpZXcgJiYgZGF0YVZpZXcuZ2V0R3JvdXBpbmcgJiYgZGF0YVZpZXcuZ2V0R3JvdXBpbmcoKTtcclxuICAgICAgICAgICAgICAgIHJldHVybiBBcnJheS5pc0FycmF5KGdyb3VwaW5nQXJyYXkpICYmIGdyb3VwaW5nQXJyYXkubGVuZ3RoID4gMDtcclxuICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcblxyXG4gICAgICAvLyBzaG93IGNvbnRleHQgbWVudTogQ29sbGFwc2UgYWxsIEdyb3Vwc1xyXG4gICAgICBpZiAoZ3JpZE9wdGlvbnMgJiYgY29udGV4dE1lbnUgJiYgIWNvbnRleHRNZW51LmhpZGVDb2xsYXBzZUFsbEdyb3Vwcykge1xyXG4gICAgICAgIGNvbnN0IGNvbW1hbmROYW1lID0gJ2NvbGxhcHNlLWFsbC1ncm91cHMnO1xyXG4gICAgICAgIGlmICghb3JpZ2luYWxDdXN0b21JdGVtcy5maW5kKChpdGVtOiBNZW51Q29tbWFuZEl0ZW0pID0+IGl0ZW0uaGFzT3duUHJvcGVydHkoJ2NvbW1hbmQnKSAmJiBpdGVtLmNvbW1hbmQgPT09IGNvbW1hbmROYW1lKSkge1xyXG4gICAgICAgICAgbWVudUN1c3RvbUl0ZW1zLnB1c2goXHJcbiAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICBpY29uQ3NzQ2xhc3M6IGNvbnRleHRNZW51Lmljb25Db2xsYXBzZUFsbEdyb3Vwc0NvbW1hbmQgfHwgJ2ZhIGZhLWNvbXByZXNzJyxcclxuICAgICAgICAgICAgICB0aXRsZTogdGhpcy5leHRlbnNpb25VdGlsaXR5LnRyYW5zbGF0ZVdoZW5FbmFibGVkQW5kU2VydmljZUV4aXN0KGAke3RyYW5zbGF0aW9uUHJlZml4fUNPTExBUFNFX0FMTF9HUk9VUFNgLCAnVEVYVF9DT0xMQVBTRV9BTExfR1JPVVBTJyksXHJcbiAgICAgICAgICAgICAgZGlzYWJsZWQ6IGZhbHNlLFxyXG4gICAgICAgICAgICAgIGNvbW1hbmQ6IGNvbW1hbmROYW1lLFxyXG4gICAgICAgICAgICAgIHBvc2l0aW9uT3JkZXI6IDU2LFxyXG4gICAgICAgICAgICAgIGFjdGlvbjogKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgaWYgKGdyaWRPcHRpb25zLmVuYWJsZVRyZWVEYXRhKSB7XHJcbiAgICAgICAgICAgICAgICAgIHRoaXMudHJlZURhdGFTZXJ2aWNlLnRvZ2dsZVRyZWVEYXRhQ29sbGFwc2UodHJ1ZSk7XHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICBkYXRhVmlldy5jb2xsYXBzZUFsbEdyb3VwcygpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgaXRlbVVzYWJpbGl0eU92ZXJyaWRlOiAoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBpZiAoZ3JpZE9wdGlvbnMuZW5hYmxlVHJlZURhdGEpIHtcclxuICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAvLyBvbmx5IGVuYWJsZSB0aGUgY29tbWFuZCB3aGVuIHRoZXJlJ3MgYW4gYWN0dWFsbHkgZ3JvdXBpbmcgaW4gcGxheVxyXG4gICAgICAgICAgICAgICAgY29uc3QgZ3JvdXBpbmdBcnJheSA9IGRhdGFWaWV3ICYmIGRhdGFWaWV3LmdldEdyb3VwaW5nICYmIGRhdGFWaWV3LmdldEdyb3VwaW5nKCk7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gQXJyYXkuaXNBcnJheShncm91cGluZ0FycmF5KSAmJiBncm91cGluZ0FycmF5Lmxlbmd0aCA+IDA7XHJcbiAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICApO1xyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG5cclxuICAgICAgLy8gc2hvdyBjb250ZXh0IG1lbnU6IEV4cGFuZCBhbGwgR3JvdXBzXHJcbiAgICAgIGlmIChncmlkT3B0aW9ucyAmJiBjb250ZXh0TWVudSAmJiAhY29udGV4dE1lbnUuaGlkZUV4cGFuZEFsbEdyb3Vwcykge1xyXG4gICAgICAgIGNvbnN0IGNvbW1hbmROYW1lID0gJ2V4cGFuZC1hbGwtZ3JvdXBzJztcclxuICAgICAgICBpZiAoIW9yaWdpbmFsQ3VzdG9tSXRlbXMuZmluZCgoaXRlbTogTWVudUNvbW1hbmRJdGVtKSA9PiBpdGVtLmhhc093blByb3BlcnR5KCdjb21tYW5kJykgJiYgaXRlbS5jb21tYW5kID09PSBjb21tYW5kTmFtZSkpIHtcclxuICAgICAgICAgIG1lbnVDdXN0b21JdGVtcy5wdXNoKFxyXG4gICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgaWNvbkNzc0NsYXNzOiBjb250ZXh0TWVudS5pY29uRXhwYW5kQWxsR3JvdXBzQ29tbWFuZCB8fCAnZmEgZmEtZXhwYW5kJyxcclxuICAgICAgICAgICAgICB0aXRsZTogdGhpcy5leHRlbnNpb25VdGlsaXR5LnRyYW5zbGF0ZVdoZW5FbmFibGVkQW5kU2VydmljZUV4aXN0KGAke3RyYW5zbGF0aW9uUHJlZml4fUVYUEFORF9BTExfR1JPVVBTYCwgJ1RFWFRfRVhQQU5EX0FMTF9HUk9VUFMnKSxcclxuICAgICAgICAgICAgICBkaXNhYmxlZDogZmFsc2UsXHJcbiAgICAgICAgICAgICAgY29tbWFuZDogY29tbWFuZE5hbWUsXHJcbiAgICAgICAgICAgICAgcG9zaXRpb25PcmRlcjogNTcsXHJcbiAgICAgICAgICAgICAgYWN0aW9uOiAoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBpZiAoZ3JpZE9wdGlvbnMuZW5hYmxlVHJlZURhdGEpIHtcclxuICAgICAgICAgICAgICAgICAgdGhpcy50cmVlRGF0YVNlcnZpY2UudG9nZ2xlVHJlZURhdGFDb2xsYXBzZShmYWxzZSk7XHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICBkYXRhVmlldy5leHBhbmRBbGxHcm91cHMoKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgIGl0ZW1Vc2FiaWxpdHlPdmVycmlkZTogKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgaWYgKGdyaWRPcHRpb25zLmVuYWJsZVRyZWVEYXRhKSB7XHJcbiAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgLy8gb25seSBlbmFibGUgdGhlIGNvbW1hbmQgd2hlbiB0aGVyZSdzIGFuIGFjdHVhbGx5IGdyb3VwaW5nIGluIHBsYXlcclxuICAgICAgICAgICAgICAgIGNvbnN0IGdyb3VwaW5nQXJyYXkgPSBkYXRhVmlldyAmJiBkYXRhVmlldy5nZXRHcm91cGluZyAmJiBkYXRhVmlldy5nZXRHcm91cGluZygpO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIEFycmF5LmlzQXJyYXkoZ3JvdXBpbmdBcnJheSkgJiYgZ3JvdXBpbmdBcnJheS5sZW5ndGggPiAwO1xyXG4gICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgKTtcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4gbWVudUN1c3RvbUl0ZW1zO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogRmlyc3QgZ2V0IHRoZSB2YWx1ZSwgaWYgXCJleHBvcnRXaXRoRm9ybWF0dGVyXCIgaXMgc2V0IHRoZW4gd2UnbGwgdXNlIHRoZSBmb3JtYXR0ZXIgb3V0cHV0XHJcbiAgICogVGhlbiB3ZSBjcmVhdGUgdGhlIERPTSB0cmljayB0byBjb3B5IGEgdGV4dCB2YWx1ZSBieSBjcmVhdGluZyBhIGZha2UgPGRpdj4gdGhhdCBpcyBub3Qgc2hvd24gdG8gdGhlIHVzZXJcclxuICAgKiBhbmQgZnJvbSB0aGVyZSB3ZSBjYW4gY2FsbCB0aGUgZXhlY0NvbW1hbmQgJ2NvcHknIGNvbW1hbmQgYW5kIGV4cGVjdCB0aGUgdmFsdWUgdG8gYmUgaW4gY2xpcGJvYXJkXHJcbiAgICogQHBhcmFtIGFyZ3NcclxuICAgKi9cclxuICBwcml2YXRlIGNvcHlUb0NsaXBib2FyZChhcmdzOiBNZW51Q29tbWFuZEl0ZW1DYWxsYmFja0FyZ3MpIHtcclxuICAgIHRyeSB7XHJcbiAgICAgIGlmIChhcmdzICYmIGFyZ3MuZ3JpZCAmJiBhcmdzLmNvbW1hbmQpIHtcclxuICAgICAgICAvLyBnZXQgdGhlIHZhbHVlLCBpZiBcImV4cG9ydFdpdGhGb3JtYXR0ZXJcIiBpcyBzZXQgdGhlbiB3ZSdsbCB1c2UgdGhlIGZvcm1hdHRlciBvdXRwdXRcclxuICAgICAgICBjb25zdCBncmlkT3B0aW9ucyA9IHRoaXMuc2hhcmVkU2VydmljZSAmJiB0aGlzLnNoYXJlZFNlcnZpY2UuZ3JpZE9wdGlvbnMgfHwge307XHJcbiAgICAgICAgY29uc3QgY2VsbCA9IGFyZ3MgJiYgYXJncy5jZWxsIHx8IDA7XHJcbiAgICAgICAgY29uc3Qgcm93ID0gYXJncyAmJiBhcmdzLnJvdyB8fCAwO1xyXG4gICAgICAgIGNvbnN0IGNvbHVtbkRlZiA9IGFyZ3MgJiYgYXJncy5jb2x1bW47XHJcbiAgICAgICAgY29uc3QgZGF0YUNvbnRleHQgPSBhcmdzICYmIGFyZ3MuZGF0YUNvbnRleHQ7XHJcbiAgICAgICAgY29uc3QgZ3JpZCA9IHRoaXMuc2hhcmVkU2VydmljZSAmJiB0aGlzLnNoYXJlZFNlcnZpY2UuZ3JpZDtcclxuICAgICAgICBjb25zdCBleHBvcnRPcHRpb25zID0gZ3JpZE9wdGlvbnMgJiYgKGdyaWRPcHRpb25zLmV4Y2VsRXhwb3J0T3B0aW9ucyB8fCBncmlkT3B0aW9ucy5leHBvcnRPcHRpb25zKTtcclxuICAgICAgICBsZXQgdGV4dFRvQ29weSA9IGV4cG9ydFdpdGhGb3JtYXR0ZXJXaGVuRGVmaW5lZChyb3csIGNlbGwsIGRhdGFDb250ZXh0LCBjb2x1bW5EZWYsIGdyaWQsIGV4cG9ydE9wdGlvbnMpO1xyXG5cclxuICAgICAgICBpZiAodHlwZW9mIGNvbHVtbkRlZi5xdWVyeUZpZWxkTmFtZUdldHRlckZuID09PSAnZnVuY3Rpb24nKSB7XHJcbiAgICAgICAgICB0ZXh0VG9Db3B5ID0gdGhpcy5nZXRDZWxsVmFsdWVGcm9tUXVlcnlGaWVsZEdldHRlcihjb2x1bW5EZWYsIGRhdGFDb250ZXh0KTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIC8vIGNyZWF0ZSBmYWtlIDxkaXY+IHRvIGNvcHkgaW50byBjbGlwYm9hcmQgJiBkZWxldGUgaXQgZnJvbSB0aGUgRE9NIG9uY2Ugd2UncmUgZG9uZVxyXG4gICAgICAgIGNvbnN0IHJhbmdlID0gZG9jdW1lbnQuY3JlYXRlUmFuZ2UoKTtcclxuICAgICAgICBjb25zdCB0bXBFbGVtID0gJCgnPGRpdj4nKS5jc3MoeyBwb3NpdGlvbjogJ2Fic29sdXRlJywgbGVmdDogJy0xMDAwcHgnLCB0b3A6ICctMTAwMHB4JyB9KS50ZXh0KHRleHRUb0NvcHkpO1xyXG4gICAgICAgICQoJ2JvZHknKS5hcHBlbmQodG1wRWxlbSk7XHJcbiAgICAgICAgcmFuZ2Uuc2VsZWN0Tm9kZUNvbnRlbnRzKHRtcEVsZW0uZ2V0KDApKTtcclxuICAgICAgICBjb25zdCBzZWxlY3Rpb24gPSB3aW5kb3cuZ2V0U2VsZWN0aW9uKCk7XHJcbiAgICAgICAgaWYgKHNlbGVjdGlvbiAmJiBzZWxlY3Rpb24uYWRkUmFuZ2UgJiYgc2VsZWN0aW9uLnJlbW92ZUFsbFJhbmdlcykge1xyXG4gICAgICAgICAgc2VsZWN0aW9uLnJlbW92ZUFsbFJhbmdlcygpO1xyXG4gICAgICAgICAgc2VsZWN0aW9uLmFkZFJhbmdlKHJhbmdlKTtcclxuICAgICAgICAgIGNvbnN0IHN1Y2Nlc3MgPSBkb2N1bWVudC5leGVjQ29tbWFuZCgnY29weScsIGZhbHNlLCB0ZXh0VG9Db3B5KTtcclxuICAgICAgICAgIGlmIChzdWNjZXNzKSB7XHJcbiAgICAgICAgICAgIHRtcEVsZW0ucmVtb3ZlKCk7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICB9IGNhdGNoIChlKSB7IH1cclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFdoZW4gYSBxdWVyeUZpZWxkTmFtZUdldHRlckZuIGlzIGRlZmluZWQsIHRoZW4gZ2V0IHRoZSB2YWx1ZSBmcm9tIHRoYXQgZ2V0dGVyIGNhbGxiYWNrIGZ1bmN0aW9uXHJcbiAgICogQHBhcmFtIGNvbHVtbkRlZlxyXG4gICAqIEBwYXJhbSBkYXRhQ29udGV4dFxyXG4gICAqIEByZXR1cm4gY2VsbFZhbHVlXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBnZXRDZWxsVmFsdWVGcm9tUXVlcnlGaWVsZEdldHRlcihjb2x1bW5EZWY6IENvbHVtbiwgZGF0YUNvbnRleHQ6IGFueSk6IHN0cmluZyB7XHJcbiAgICBsZXQgY2VsbFZhbHVlID0gJyc7XHJcblxyXG4gICAgaWYgKHR5cGVvZiBjb2x1bW5EZWYucXVlcnlGaWVsZE5hbWVHZXR0ZXJGbiA9PT0gJ2Z1bmN0aW9uJykge1xyXG4gICAgICBjb25zdCBxdWVyeUZpZWxkTmFtZSA9IGNvbHVtbkRlZi5xdWVyeUZpZWxkTmFtZUdldHRlckZuKGRhdGFDb250ZXh0KTtcclxuXHJcbiAgICAgIC8vIGdldCB0aGUgY2VsbCB2YWx1ZSBmcm9tIHRoZSBpdGVtIG9yIHdoZW4gaXQncyBhIGRvdCBub3RhdGlvbiB0aGVuIGV4cGxvZGVkIHRoZSBpdGVtIGFuZCBnZXQgdGhlIGZpbmFsIHZhbHVlXHJcbiAgICAgIGlmIChxdWVyeUZpZWxkTmFtZSAmJiBxdWVyeUZpZWxkTmFtZS5pbmRleE9mKCcuJykgPj0gMCkge1xyXG4gICAgICAgIGNlbGxWYWx1ZSA9IGdldERlc2NlbmRhbnRQcm9wZXJ0eShkYXRhQ29udGV4dCwgcXVlcnlGaWVsZE5hbWUpO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIGNlbGxWYWx1ZSA9IGRhdGFDb250ZXh0W3F1ZXJ5RmllbGROYW1lXTtcclxuICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHJldHVybiBjZWxsVmFsdWU7XHJcbiAgfVxyXG59XHJcbiJdfQ==