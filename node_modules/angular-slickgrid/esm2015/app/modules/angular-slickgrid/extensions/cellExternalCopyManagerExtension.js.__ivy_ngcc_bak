import * as tslib_1 from "tslib";
import { Injectable } from '@angular/core';
import { ExtensionName, } from '../models/index';
import { ExtensionUtility } from './extensionUtility';
import { BindingEventService } from '../services/bindingEvent.service';
import { sanitizeHtmlToText } from '../services/utilities';
import { SharedService } from '../services/shared.service';
let CellExternalCopyManagerExtension = class CellExternalCopyManagerExtension {
    constructor(extensionUtility, sharedService) {
        this.extensionUtility = extensionUtility;
        this.sharedService = sharedService;
        this._eventHandler = new Slick.EventHandler();
        this._bindingEventService = new BindingEventService();
    }
    get addonOptions() {
        return this._addonOptions;
    }
    get eventHandler() {
        return this._eventHandler;
    }
    get commandQueue() {
        return this._commandQueue;
    }
    get undoRedoBuffer() {
        return this._undoRedoBuffer;
    }
    dispose() {
        // unsubscribe all SlickGrid events
        this._eventHandler.unsubscribeAll();
        this._bindingEventService.unbindAll();
        if (this._addon && this._addon.destroy) {
            this._addon.destroy();
        }
        if (this._cellSelectionModel && this._cellSelectionModel.destroy) {
            this._cellSelectionModel.destroy();
        }
        this.extensionUtility.nullifyFunctionNameStartingWithOn(this._addonOptions);
        this._addon = null;
        this._addonOptions = null;
    }
    /** Get the instance of the SlickGrid addon (control or plugin). */
    getAddonInstance() {
        return this._addon;
    }
    register() {
        if (this.sharedService && this.sharedService.grid && this.sharedService.gridOptions) {
            // dynamically import the SlickGrid plugin (addon) with RequireJS
            this.extensionUtility.loadExtensionDynamically(ExtensionName.cellExternalCopyManager);
            this.createUndoRedoBuffer();
            this._bindingEventService.bind(document.body, 'keydown', this.handleKeyDown.bind(this));
            this._addonOptions = Object.assign({}, this.getDefaultOptions(), this.sharedService.gridOptions.excelCopyBufferOptions);
            this._cellSelectionModel = new Slick.CellSelectionModel();
            this.sharedService.grid.setSelectionModel(this._cellSelectionModel);
            this._addon = new Slick.CellExternalCopyManager(this._addonOptions);
            if (this._addon) {
                this.sharedService.grid.registerPlugin(this._addon);
            }
            // hook to all possible events
            if (this.sharedService.grid && this._addonOptions) {
                if (this._addonOptions.onExtensionRegistered) {
                    this._addonOptions.onExtensionRegistered(this._addon);
                }
                this._eventHandler.subscribe(this._addon.onCopyCells, (e, args) => {
                    if (this._addonOptions && typeof this._addonOptions.onCopyCells === 'function') {
                        this._addonOptions.onCopyCells(e, args);
                    }
                });
                this._eventHandler.subscribe(this._addon.onCopyCancelled, (e, args) => {
                    if (this._addonOptions && typeof this._addonOptions.onCopyCancelled === 'function') {
                        this._addonOptions.onCopyCancelled(e, args);
                    }
                });
                this._eventHandler.subscribe(this._addon.onPasteCells, (e, args) => {
                    if (this._addonOptions && typeof this._addonOptions.onPasteCells === 'function') {
                        this._addonOptions.onPasteCells(e, args);
                    }
                });
            }
            return this._addon;
        }
        return null;
    }
    /** Create an undo redo buffer used by the Excel like copy */
    createUndoRedoBuffer() {
        let commandCtr = 0;
        this._commandQueue = [];
        this._undoRedoBuffer = {
            queueAndExecuteCommand: (editCommand) => {
                this._commandQueue[commandCtr] = editCommand;
                commandCtr++;
                editCommand.execute();
            },
            undo: () => {
                if (commandCtr === 0) {
                    return;
                }
                commandCtr--;
                const command = this._commandQueue[commandCtr];
                if (command && Slick.GlobalEditorLock.cancelCurrentEdit()) {
                    command.undo();
                }
            },
            redo: () => {
                if (commandCtr >= this._commandQueue.length) {
                    return;
                }
                const command = this._commandQueue[commandCtr];
                commandCtr++;
                if (command && Slick.GlobalEditorLock.cancelCurrentEdit()) {
                    command.execute();
                }
            }
        };
    }
    /** @return default plugin (addon) options */
    getDefaultOptions() {
        let newRowIds = 0;
        return {
            clipboardCommandHandler: (editCommand) => {
                this._undoRedoBuffer.queueAndExecuteCommand.call(this._undoRedoBuffer, editCommand);
            },
            dataItemColumnValueExtractor: (item, columnDef) => {
                // when grid or cell is not editable, we will possibly evaluate the Formatter if it was passed
                // to decide if we evaluate the Formatter, we will use the same flag from Export which is "exportWithFormatter"
                if (!this.sharedService.gridOptions.editable || !columnDef.editor) {
                    const isEvaluatingFormatter = (columnDef.exportWithFormatter !== undefined) ? columnDef.exportWithFormatter : (this.sharedService.gridOptions.exportOptions && this.sharedService.gridOptions.exportOptions.exportWithFormatter);
                    if (columnDef.formatter && isEvaluatingFormatter) {
                        const formattedOutput = columnDef.formatter(0, 0, item[columnDef.field], columnDef, item, this.sharedService.grid);
                        if (columnDef.sanitizeDataExport || (this.sharedService.gridOptions.exportOptions && this.sharedService.gridOptions.exportOptions.sanitizeDataExport)) {
                            let outputString = formattedOutput;
                            if (formattedOutput && typeof formattedOutput === 'object' && formattedOutput.hasOwnProperty('text')) {
                                outputString = formattedOutput.text;
                            }
                            if (outputString === null) {
                                outputString = '';
                            }
                            return sanitizeHtmlToText(outputString);
                        }
                        return formattedOutput;
                    }
                }
                // else use the default "dataItemColumnValueExtractor" from the plugin itself
                // we can do that by setting back the getter with null
                return null;
            },
            readOnlyMode: false,
            includeHeaderWhenCopying: false,
            newRowCreator: (count) => {
                for (let i = 0; i < count; i++) {
                    const item = {
                        id: 'newRow_' + newRowIds++
                    };
                    this.sharedService.grid.getData().addItem(item);
                }
            }
        };
    }
    /** Hook an undo shortcut key hook that will redo/undo the copy buffer using Ctrl+(Shift)+Z keyboard events */
    handleKeyDown(e) {
        const keyCode = e.keyCode || e.code;
        if (keyCode === 90 && (e.ctrlKey || e.metaKey)) {
            if (e.shiftKey) {
                this._undoRedoBuffer.redo(); // Ctrl + Shift + Z
            }
            else {
                this._undoRedoBuffer.undo(); // Ctrl + Z
            }
        }
    }
};
CellExternalCopyManagerExtension.ctorParameters = () => [
    { type: ExtensionUtility },
    { type: SharedService }
];
CellExternalCopyManagerExtension = tslib_1.__decorate([
    Injectable()
], CellExternalCopyManagerExtension);
export { CellExternalCopyManagerExtension };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2VsbEV4dGVybmFsQ29weU1hbmFnZXJFeHRlbnNpb24uanMiLCJzb3VyY2VSb290Ijoibmc6Ly9hbmd1bGFyLXNsaWNrZ3JpZC8iLCJzb3VyY2VzIjpbImFwcC9tb2R1bGVzL2FuZ3VsYXItc2xpY2tncmlkL2V4dGVuc2lvbnMvY2VsbEV4dGVybmFsQ29weU1hbmFnZXJFeHRlbnNpb24udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDM0MsT0FBTyxFQU1MLGFBQWEsR0FHZCxNQUFNLGlCQUFpQixDQUFDO0FBQ3pCLE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBQ3RELE9BQU8sRUFBRSxtQkFBbUIsRUFBRSxNQUFNLGtDQUFrQyxDQUFDO0FBQ3ZFLE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLHVCQUF1QixDQUFDO0FBQzNELE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSw0QkFBNEIsQ0FBQztBQU8zRCxJQUFhLGdDQUFnQyxHQUE3QyxNQUFhLGdDQUFnQztJQVMzQyxZQUFvQixnQkFBa0MsRUFBVSxhQUE0QjtRQUF4RSxxQkFBZ0IsR0FBaEIsZ0JBQWdCLENBQWtCO1FBQVUsa0JBQWEsR0FBYixhQUFhLENBQWU7UUFDMUYsSUFBSSxDQUFDLGFBQWEsR0FBRyxJQUFJLEtBQUssQ0FBQyxZQUFZLEVBQUUsQ0FBQztRQUM5QyxJQUFJLENBQUMsb0JBQW9CLEdBQUcsSUFBSSxtQkFBbUIsRUFBRSxDQUFDO0lBQ3hELENBQUM7SUFFRCxJQUFJLFlBQVk7UUFDZCxPQUFPLElBQUksQ0FBQyxhQUFhLENBQUM7SUFDNUIsQ0FBQztJQUVELElBQUksWUFBWTtRQUNkLE9BQU8sSUFBSSxDQUFDLGFBQWEsQ0FBQztJQUM1QixDQUFDO0lBRUQsSUFBSSxZQUFZO1FBQ2QsT0FBTyxJQUFJLENBQUMsYUFBYSxDQUFDO0lBQzVCLENBQUM7SUFFRCxJQUFJLGNBQWM7UUFD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LEtBQUs7WUFDbkIsd0JBQXdCLEVBQUUsS0FBSztZQUMvQixhQUFhLEVBQUUsQ0FBQyxLQUFhLEVBQUUsRUFBRTtnQkFDL0IsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLEtBQUssRUFBRSxDQUFDLEVBQUUsRUFBRTtvQkFDOUIsTUFBTSxJQUFJLEdBQUc7d0JBQ1gsRUFBRSxFQUFFLFNBQVMsR0FBRyxTQUFTLEVBQUU7cUJBQzVCLENBQUM7b0JBQ0YsSUFBSSxDQUFDLGFBQWEsQ0FBQyxJQUFJLENBQUMsT0FBTyxFQUFFLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDO2lCQUNqRDtZQUNILENBQUM7U0FDRixDQUFDO0lBQ0osQ0FBQztJQUVELDhHQUE4RztJQUN0RyxhQUFhLENBQUMsQ0FBZ0I7UUFDcEMsTUFBTSxPQUFPLEdBQUcsQ0FBQyxDQUFDLE9BQU8sSUFBSSxDQUFDLENBQUMsSUFBSSxDQUFDO1FBQ3BDLElBQUksT0FBTyxLQUFLLEVBQUUsSUFBSSxDQUFDLENBQUMsQ0FBQyxPQUFPLElBQUksQ0FBQyxDQUFDLE9BQU8sQ0FBQyxFQUFFO1lBQzlDLElBQUksQ0FBQyxDQUFDLFFBQVEsRUFBRTtnQkFDZCxJQUFJLENBQUMsZUFBZSxDQUFDLElBQUksRUFBRSxDQUFDLENBQUMsbUJBQW1CO2FBQ2pEO2lCQUFNO2dCQUNMLElBQUksQ0FBQyxlQUFlLENBQUMsSUFBSSxFQUFFLENBQUMsQ0FBQyxXQUFXO2FBQ3pDO1NBQ0Y7SUFDSCxDQUFDO0NBQ0YsQ0FBQTs7WUE5S3VDLGdCQUFnQjtZQUF5QixhQUFhOztBQVRqRixnQ0FBZ0M7SUFENUMsVUFBVSxFQUFFO0dBQ0EsZ0NBQWdDLENBdUw1QztTQXZMWSxnQ0FBZ0MiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7XHJcbiAgQ29sdW1uLFxyXG4gIEVkaXRDb21tYW5kLFxyXG4gIEVkaXRVbmRvUmVkb0J1ZmZlcixcclxuICBFeGNlbENvcHlCdWZmZXJPcHRpb24sXHJcbiAgRXh0ZW5zaW9uLFxyXG4gIEV4dGVuc2lvbk5hbWUsXHJcbiAgU2VsZWN0ZWRSYW5nZSxcclxuICBTbGlja0V2ZW50SGFuZGxlcixcclxufSBmcm9tICcuLi9tb2RlbHMvaW5kZXgnO1xyXG5pbXBvcnQgeyBFeHRlbnNpb25VdGlsaXR5IH0gZnJvbSAnLi9leHRlbnNpb25VdGlsaXR5JztcclxuaW1wb3J0IHsgQmluZGluZ0V2ZW50U2VydmljZSB9IGZyb20gJy4uL3NlcnZpY2VzL2JpbmRpbmdFdmVudC5zZXJ2aWNlJztcclxuaW1wb3J0IHsgc2FuaXRpemVIdG1sVG9UZXh0IH0gZnJvbSAnLi4vc2VydmljZXMvdXRpbGl0aWVzJztcclxuaW1wb3J0IHsgU2hhcmVkU2VydmljZSB9IGZyb20gJy4uL3NlcnZpY2VzL3NoYXJlZC5zZXJ2aWNlJztcclxuXHJcbi8vIHVzaW5nIGV4dGVybmFsIG5vbi10eXBlZCBqcyBsaWJyYXJpZXNcclxuZGVjbGFyZSBjb25zdCBTbGljazogYW55O1xyXG5kZWNsYXJlIGNvbnN0ICQ6IGFueTtcclxuXHJcbkBJbmplY3RhYmxlKClcclxuZXhwb3J0IGNsYXNzIENlbGxFeHRlcm5hbENvcHlNYW5hZ2VyRXh0ZW5zaW9uIGltcGxlbWVudHMgRXh0ZW5zaW9uIHtcclxuICBwcml2YXRlIF9hZGRvbjogYW55O1xyXG4gIHByaXZhdGUgX2FkZG9uT3B0aW9uczogRXhjZWxDb3B5QnVmZmVyT3B0aW9uIHwgbnVsbDtcclxuICBwcml2YXRlIF9iaW5kaW5nRXZlbnRTZXJ2aWNlOiBCaW5kaW5nRXZlbnRTZXJ2aWNlO1xyXG4gIHByaXZhdGUgX2NlbGxTZWxlY3Rpb25Nb2RlbDogYW55O1xyXG4gIHByaXZhdGUgX2V2ZW50SGFuZGxlcjogU2xpY2tFdmVudEhhbmRsZXI7XHJcbiAgcHJpdmF0ZSBfY29tbWFuZFF1ZXVlOiBFZGl0Q29tbWFuZFtdO1xyXG4gIHByaXZhdGUgX3VuZG9SZWRvQnVmZmVyOiBFZGl0VW5kb1JlZG9CdWZmZXI7XHJcblxyXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgZXh0ZW5zaW9uVXRpbGl0eTogRXh0ZW5zaW9uVXRpbGl0eSwgcHJpdmF0ZSBzaGFyZWRTZXJ2aWNlOiBTaGFyZWRTZXJ2aWNlKSB7XHJcbiAgICB0aGlzLl9ldmVudEhhbmRsZXIgPSBuZXcgU2xpY2suRXZlbnRIYW5kbGVyKCk7XHJcbiAgICB0aGlzLl9iaW5kaW5nRXZlbnRTZXJ2aWNlID0gbmV3IEJpbmRpbmdFdmVudFNlcnZpY2UoKTtcclxuICB9XHJcblxyXG4gIGdldCBhZGRvbk9wdGlvbnMoKTogRXhjZWxDb3B5QnVmZmVyT3B0aW9uIHwgbnVsbCB7XHJcbiAgICByZXR1cm4gdGhpcy5fYWRkb25PcHRpb25zO1xyXG4gIH1cclxuXHJcbiAgZ2V0IGV2ZW50SGFuZGxlcigpOiBTbGlja0V2ZW50SGFuZGxlciB7XHJcbiAgICByZXR1cm4gdGhpcy5fZXZlbnRIYW5kbGVyO1xyXG4gIH1cclxuXHJcbiAgZ2V0IGNvbW1hbmRRdWV1ZSgpOiBFZGl0Q29tbWFuZFtdIHtcclxuICAgIHJldHVybiB0aGlzLl9jb21tYW5kUXVldWU7XHJcbiAgfVxyXG5cclxuICBnZXQgdW5kb1JlZG9CdWZmZXIoKTogRWRpdFVuZG9SZWRvQnVmZmVyIHtcclxuICAgIHJldHVybiB0aGlzLl91bmRvUmVkb0J1ZmZlcjtcclxuICB9XHJcblxyXG4gIGRpc3Bvc2UoKSB7XHJcbiAgICAvLyB1bnN1YnNjcmliZSBhbGwgU2xpY2tHcmlkIGV2ZW50c1xyXG4gICAgdGhpcy5fZXZlbnRIYW5kbGVyLnVuc3Vic2NyaWJlQWxsKCk7XHJcbiAgICB0aGlzLl9iaW5kaW5nRXZlbnRTZXJ2aWNlLnVuYmluZEFsbCgpO1xyXG5cclxuICAgIGlmICh0aGlzLl9hZGRvbiAmJiB0aGlzLl9hZGRvbi5kZXN0cm95KSB7XHJcbiAgICAgIHRoaXMuX2FkZG9uLmRlc3Ryb3koKTtcclxuICAgIH1cclxuICAgIGlmICh0aGlzLl9jZWxsU2VsZWN0aW9uTW9kZWwgJiYgdGhpcy5fY2VsbFNlbGVjdGlvbk1vZGVsLmRlc3Ryb3kpIHtcclxuICAgICAgdGhpcy5fY2VsbFNlbGVjdGlvbk1vZGVsLmRlc3Ryb3koKTtcclxuICAgIH1cclxuICAgIHRoaXMuZXh0ZW5zaW9uVXRpbGl0eS5udWxsaWZ5RnVuY3Rpb25OYW1lU3RhcnRpbmdXaXRoT24odGhpcy5fYWRkb25PcHRpb25zKTtcclxuICAgIHRoaXMuX2FkZG9uID0gbnVsbDtcclxuICAgIHRoaXMuX2FkZG9uT3B0aW9ucyA9IG51bGw7XHJcbiAgfVxyXG5cclxuICAvKiogR2V0IHRoZSBpbnN0YW5jZSBvZiB0aGUgU2xpY2tHcmlkIGFkZG9uIChjb250cm9sIG9yIHBsdWdpbikuICovXHJcbiAgZ2V0QWRkb25JbnN0YW5jZSgpOiBhbnkge1xyXG4gICAgcmV0dXJuIHRoaXMuX2FkZG9uO1xyXG4gIH1cclxuXHJcbiAgcmVnaXN0ZXIoKTogYW55IHtcclxuICAgIGlmICh0aGlzLnNoYXJlZFNlcnZpY2UgJiYgdGhpcy5zaGFyZWRTZXJ2aWNlLmdyaWQgJiYgdGhpcy5zaGFyZWRTZXJ2aWNlLmdyaWRPcHRpb25zKSB7XHJcbiAgICAgIC8vIGR5bmFtaWNhbGx5IGltcG9ydCB0aGUgU2xpY2tHcmlkIHBsdWdpbiAoYWRkb24pIHdpdGggUmVxdWlyZUpTXHJcbiAgICAgIHRoaXMuZXh0ZW5zaW9uVXRpbGl0eS5sb2FkRXh0ZW5zaW9uRHluYW1pY2FsbHkoRXh0ZW5zaW9uTmFtZS5jZWxsRXh0ZXJuYWxDb3B5TWFuYWdlcik7XHJcbiAgICAgIHRoaXMuY3JlYXRlVW5kb1JlZG9CdWZmZXIoKTtcclxuICAgICAgdGhpcy5fYmluZGluZ0V2ZW50U2VydmljZS5iaW5kKGRvY3VtZW50LmJvZHksICdrZXlkb3duJywgdGhpcy5oYW5kbGVLZXlEb3duLmJpbmQodGhpcykpO1xyXG5cclxuICAgICAgdGhpcy5fYWRkb25PcHRpb25zID0geyAuLi50aGlzLmdldERlZmF1bHRPcHRpb25zKCksIC4uLnRoaXMuc2hhcmVkU2VydmljZS5ncmlkT3B0aW9ucy5leGNlbENvcHlCdWZmZXJPcHRpb25zIH0gYXMgRXhjZWxDb3B5QnVmZmVyT3B0aW9uO1xyXG4gICAgICB0aGlzLl9jZWxsU2VsZWN0aW9uTW9kZWwgPSBuZXcgU2xpY2suQ2VsbFNlbGVjdGlvbk1vZGVsKCk7XHJcbiAgICAgIHRoaXMuc2hhcmVkU2VydmljZS5ncmlkLnNldFNlbGVjdGlvbk1vZGVsKHRoaXMuX2NlbGxTZWxlY3Rpb25Nb2RlbCk7XHJcbiAgICAgIHRoaXMuX2FkZG9uID0gbmV3IFNsaWNrLkNlbGxFeHRlcm5hbENvcHlNYW5hZ2VyKHRoaXMuX2FkZG9uT3B0aW9ucyk7XHJcbiAgICAgIGlmICh0aGlzLl9hZGRvbikge1xyXG4gICAgICAgIHRoaXMuc2hhcmVkU2VydmljZS5ncmlkLnJlZ2lzdGVyUGx1Z2luKHRoaXMuX2FkZG9uKTtcclxuICAgICAgfVxyXG5cclxuICAgICAgLy8gaG9vayB0byBhbGwgcG9zc2libGUgZXZlbnRzXHJcbiAgICAgIGlmICh0aGlzLnNoYXJlZFNlcnZpY2UuZ3JpZCAmJiB0aGlzLl9hZGRvbk9wdGlvbnMpIHtcclxuICAgICAgICBpZiAodGhpcy5fYWRkb25PcHRpb25zLm9uRXh0ZW5zaW9uUmVnaXN0ZXJlZCkge1xyXG4gICAgICAgICAgdGhpcy5fYWRkb25PcHRpb25zLm9uRXh0ZW5zaW9uUmVnaXN0ZXJlZCh0aGlzLl9hZGRvbik7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXMuX2V2ZW50SGFuZGxlci5zdWJzY3JpYmUodGhpcy5fYWRkb24ub25Db3B5Q2VsbHMsIChlOiBhbnksIGFyZ3M6IHsgcmFuZ2VzOiBTZWxlY3RlZFJhbmdlW10gfSkgPT4ge1xyXG4gICAgICAgICAgaWYgKHRoaXMuX2FkZG9uT3B0aW9ucyAmJiB0eXBlb2YgdGhpcy5fYWRkb25PcHRpb25zLm9uQ29weUNlbGxzID09PSAnZnVuY3Rpb24nKSB7XHJcbiAgICAgICAgICAgIHRoaXMuX2FkZG9uT3B0aW9ucy5vbkNvcHlDZWxscyhlLCBhcmdzKTtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuICAgICAgICB0aGlzLl9ldmVudEhhbmRsZXIuc3Vic2NyaWJlKHRoaXMuX2FkZG9uLm9uQ29weUNhbmNlbGxlZCwgKGU6IGFueSwgYXJnczogeyByYW5nZXM6IFNlbGVjdGVkUmFuZ2VbXSB9KSA9PiB7XHJcbiAgICAgICAgICBpZiAodGhpcy5fYWRkb25PcHRpb25zICYmIHR5cGVvZiB0aGlzLl9hZGRvbk9wdGlvbnMub25Db3B5Q2FuY2VsbGVkID09PSAnZnVuY3Rpb24nKSB7XHJcbiAgICAgICAgICAgIHRoaXMuX2FkZG9uT3B0aW9ucy5vbkNvcHlDYW5jZWxsZWQoZSwgYXJncyk7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgdGhpcy5fZXZlbnRIYW5kbGVyLnN1YnNjcmliZSh0aGlzLl9hZGRvbi5vblBhc3RlQ2VsbHMsIChlOiBhbnksIGFyZ3M6IHsgcmFuZ2VzOiBTZWxlY3RlZFJhbmdlW10gfSkgPT4ge1xyXG4gICAgICAgICAgaWYgKHRoaXMuX2FkZG9uT3B0aW9ucyAmJiB0eXBlb2YgdGhpcy5fYWRkb25PcHRpb25zLm9uUGFzdGVDZWxscyA9PT0gJ2Z1bmN0aW9uJykge1xyXG4gICAgICAgICAgICB0aGlzLl9hZGRvbk9wdGlvbnMub25QYXN0ZUNlbGxzKGUsIGFyZ3MpO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG4gICAgICB9XHJcblxyXG4gICAgICByZXR1cm4gdGhpcy5fYWRkb247XHJcbiAgICB9XHJcbiAgICByZXR1cm4gbnVsbDtcclxuICB9XHJcblxyXG4gIC8qKiBDcmVhdGUgYW4gdW5kbyByZWRvIGJ1ZmZlciB1c2VkIGJ5IHRoZSBFeGNlbCBsaWtlIGNvcHkgKi9cclxuICBwcml2YXRlIGNyZWF0ZVVuZG9SZWRvQnVmZmVyKCkge1xyXG4gICAgbGV0IGNvbW1hbmRDdHIgPSAwO1xyXG4gICAgdGhpcy5fY29tbWFuZFF1ZXVlID0gW107XHJcblxyXG4gICAgdGhpcy5fdW5kb1JlZG9CdWZmZXIgPSB7XHJcbiAgICAgIHF1ZXVlQW5kRXhlY3V0ZUNvbW1hbmQ6IChlZGl0Q29tbWFuZDogRWRpdENvbW1hbmQpID0+IHtcclxuICAgICAgICB0aGlzLl9jb21tYW5kUXVldWVbY29tbWFuZEN0cl0gPSBlZGl0Q29tbWFuZDtcclxuICAgICAgICBjb21tYW5kQ3RyKys7XHJcbiAgICAgICAgZWRpdENvbW1hbmQuZXhlY3V0ZSgpO1xyXG4gICAgICB9LFxyXG4gICAgICB1bmRvOiAoKSA9PiB7XHJcbiAgICAgICAgaWYgKGNvbW1hbmRDdHIgPT09IDApIHtcclxuICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgY29tbWFuZEN0ci0tO1xyXG4gICAgICAgIGNvbnN0IGNvbW1hbmQgPSB0aGlzLl9jb21tYW5kUXVldWVbY29tbWFuZEN0cl07XHJcbiAgICAgICAgaWYgKGNvbW1hbmQgJiYgU2xpY2suR2xvYmFsRWRpdG9yTG9jay5jYW5jZWxDdXJyZW50RWRpdCgpKSB7XHJcbiAgICAgICAgICBjb21tYW5kLnVuZG8oKTtcclxuICAgICAgICB9XHJcbiAgICAgIH0sXHJcbiAgICAgIHJlZG86ICgpID0+IHtcclxuICAgICAgICBpZiAoY29tbWFuZEN0ciA+PSB0aGlzLl9jb21tYW5kUXVldWUubGVuZ3RoKSB7XHJcbiAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNvbnN0IGNvbW1hbmQgPSB0aGlzLl9jb21tYW5kUXVldWVbY29tbWFuZEN0cl07XHJcbiAgICAgICAgY29tbWFuZEN0cisrO1xyXG4gICAgICAgIGlmIChjb21tYW5kICYmIFNsaWNrLkdsb2JhbEVkaXRvckxvY2suY2FuY2VsQ3VycmVudEVkaXQoKSkge1xyXG4gICAgICAgICAgY29tbWFuZC5leGVjdXRlKCk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICB9O1xyXG4gIH1cclxuXHJcbiAgLyoqIEByZXR1cm4gZGVmYXVsdCBwbHVnaW4gKGFkZG9uKSBvcHRpb25zICovXHJcbiAgcHJpdmF0ZSBnZXREZWZhdWx0T3B0aW9ucygpOiBFeGNlbENvcHlCdWZmZXJPcHRpb24ge1xyXG4gICAgbGV0IG5ld1Jvd0lkcyA9IDA7XHJcblxyXG4gICAgcmV0dXJuIHtcclxuICAgICAgY2xpcGJvYXJkQ29tbWFuZEhhbmRsZXI6IChlZGl0Q29tbWFuZDogYW55KSA9PiB7XHJcbiAgICAgICAgdGhpcy5fdW5kb1JlZG9CdWZmZXIucXVldWVBbmRFeGVjdXRlQ29tbWFuZC5jYWxsKHRoaXMuX3VuZG9SZWRvQnVmZmVyLCBlZGl0Q29tbWFuZCk7XHJcbiAgICAgIH0sXHJcbiAgICAgIGRhdGFJdGVtQ29sdW1uVmFsdWVFeHRyYWN0b3I6IChpdGVtOiBhbnksIGNvbHVtbkRlZjogQ29sdW1uKSA9PiB7XHJcbiAgICAgICAgLy8gd2hlbiBncmlkIG9yIGNlbGwgaXMgbm90IGVkaXRhYmxlLCB3ZSB3aWxsIHBvc3NpYmx5IGV2YWx1YXRlIHRoZSBGb3JtYXR0ZXIgaWYgaXQgd2FzIHBhc3NlZFxyXG4gICAgICAgIC8vIHRvIGRlY2lkZSBpZiB3ZSBldmFsdWF0ZSB0aGUgRm9ybWF0dGVyLCB3ZSB3aWxsIHVzZSB0aGUgc2FtZSBmbGFnIGZyb20gRXhwb3J0IHdoaWNoIGlzIFwiZXhwb3J0V2l0aEZvcm1hdHRlclwiXHJcbiAgICAgICAgaWYgKCF0aGlzLnNoYXJlZFNlcnZpY2UuZ3JpZE9wdGlvbnMuZWRpdGFibGUgfHwgIWNvbHVtbkRlZi5lZGl0b3IpIHtcclxuICAgICAgICAgIGNvbnN0IGlzRXZhbHVhdGluZ0Zvcm1hdHRlciA9IChjb2x1bW5EZWYuZXhwb3J0V2l0aEZvcm1hdHRlciAhPT0gdW5kZWZpbmVkKSA/IGNvbHVtbkRlZi5leHBvcnRXaXRoRm9ybWF0dGVyIDogKHRoaXMuc2hhcmVkU2VydmljZS5ncmlkT3B0aW9ucy5leHBvcnRPcHRpb25zICYmIHRoaXMuc2hhcmVkU2VydmljZS5ncmlkT3B0aW9ucy5leHBvcnRPcHRpb25zLmV4cG9ydFdpdGhGb3JtYXR0ZXIpO1xyXG4gICAgICAgICAgaWYgKGNvbHVtbkRlZi5mb3JtYXR0ZXIgJiYgaXNFdmFsdWF0aW5nRm9ybWF0dGVyKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGZvcm1hdHRlZE91dHB1dCA9IGNvbHVtbkRlZi5mb3JtYXR0ZXIoMCwgMCwgaXRlbVtjb2x1bW5EZWYuZmllbGRdLCBjb2x1bW5EZWYsIGl0ZW0sIHRoaXMuc2hhcmVkU2VydmljZS5ncmlkKTtcclxuICAgICAgICAgICAgaWYgKGNvbHVtbkRlZi5zYW5pdGl6ZURhdGFFeHBvcnQgfHwgKHRoaXMuc2hhcmVkU2VydmljZS5ncmlkT3B0aW9ucy5leHBvcnRPcHRpb25zICYmIHRoaXMuc2hhcmVkU2VydmljZS5ncmlkT3B0aW9ucy5leHBvcnRPcHRpb25zLnNhbml0aXplRGF0YUV4cG9ydCkpIHtcclxuICAgICAgICAgICAgICBsZXQgb3V0cHV0U3RyaW5nID0gZm9ybWF0dGVkT3V0cHV0IGFzIHN0cmluZztcclxuICAgICAgICAgICAgICBpZiAoZm9ybWF0dGVkT3V0cHV0ICYmIHR5cGVvZiBmb3JtYXR0ZWRPdXRwdXQgPT09ICdvYmplY3QnICYmIGZvcm1hdHRlZE91dHB1dC5oYXNPd25Qcm9wZXJ0eSgndGV4dCcpKSB7XHJcbiAgICAgICAgICAgICAgICBvdXRwdXRTdHJpbmcgPSBmb3JtYXR0ZWRPdXRwdXQudGV4dDtcclxuICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgaWYgKG91dHB1dFN0cmluZyA9PT0gbnVsbCkge1xyXG4gICAgICAgICAgICAgICAgb3V0cHV0U3RyaW5nID0gJyc7XHJcbiAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgIHJldHVybiBzYW5pdGl6ZUh0bWxUb1RleHQob3V0cHV0U3RyaW5nKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICByZXR1cm4gZm9ybWF0dGVkT3V0cHV0O1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICAvLyBlbHNlIHVzZSB0aGUgZGVmYXVsdCBcImRhdGFJdGVtQ29sdW1uVmFsdWVFeHRyYWN0b3JcIiBmcm9tIHRoZSBwbHVnaW4gaXRzZWxmXHJcbiAgICAgICAgLy8gd2UgY2FuIGRvIHRoYXQgYnkgc2V0dGluZyBiYWNrIHRoZSBnZXR0ZXIgd2l0aCBudWxsXHJcbiAgICAgICAgcmV0dXJuIG51bGw7XHJcbiAgICAgIH0sXHJcbiAgICAgIHJlYWRPbmx5TW9kZTogZmFsc2UsXHJcbiAgICAgIGluY2x1ZGVIZWFkZXJXaGVuQ29weWluZzogZmFsc2UsXHJcbiAgICAgIG5ld1Jvd0NyZWF0b3I6IChjb3VudDogbnVtYmVyKSA9PiB7XHJcbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBjb3VudDsgaSsrKSB7XHJcbiAgICAgICAgICBjb25zdCBpdGVtID0ge1xyXG4gICAgICAgICAgICBpZDogJ25ld1Jvd18nICsgbmV3Um93SWRzKytcclxuICAgICAgICAgIH07XHJcbiAgICAgICAgICB0aGlzLnNoYXJlZFNlcnZpY2UuZ3JpZC5nZXREYXRhKCkuYWRkSXRlbShpdGVtKTtcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgIH07XHJcbiAgfVxyXG5cclxuICAvKiogSG9vayBhbiB1bmRvIHNob3J0Y3V0IGtleSBob29rIHRoYXQgd2lsbCByZWRvL3VuZG8gdGhlIGNvcHkgYnVmZmVyIHVzaW5nIEN0cmwrKFNoaWZ0KStaIGtleWJvYXJkIGV2ZW50cyAqL1xyXG4gIHByaXZhdGUgaGFuZGxlS2V5RG93bihlOiBLZXlib2FyZEV2ZW50KSB7XHJcbiAgICBjb25zdCBrZXlDb2RlID0gZS5rZXlDb2RlIHx8IGUuY29kZTtcclxuICAgIGlmIChrZXlDb2RlID09PSA5MCAmJiAoZS5jdHJsS2V5IHx8IGUubWV0YUtleSkpIHtcclxuICAgICAgaWYgKGUuc2hpZnRLZXkpIHtcclxuICAgICAgICB0aGlzLl91bmRvUmVkb0J1ZmZlci5yZWRvKCk7IC8vIEN0cmwgKyBTaGlmdCArIFpcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICB0aGlzLl91bmRvUmVkb0J1ZmZlci51bmRvKCk7IC8vIEN0cmwgKyBaXHJcbiAgICAgIH1cclxuICAgIH1cclxuICB9XHJcbn1cclxuIl19