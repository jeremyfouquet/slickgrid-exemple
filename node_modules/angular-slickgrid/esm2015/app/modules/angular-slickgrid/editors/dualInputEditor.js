import { KeyCode, } from '../models/index';
import { BindingEventService } from '../services/bindingEvent.service';
import { getDescendantProperty, setDeepValue } from '../services/utilities';
import { floatValidator, integerValidator, textValidator } from '../editorValidators';
/*
 * An example of a 'detached' editor.
 * KeyDown events are also handled to provide handling for Tab, Shift-Tab, Esc and Ctrl-Enter.
 */
export class DualInputEditor {
    constructor(args) {
        this.args = args;
        this._isValueSaveCalled = false;
        if (!args) {
            throw new Error('[Angular-Slickgrid] Something is wrong with this grid, an Editor must always have valid arguments.');
        }
        this.grid = args.grid;
        this.gridOptions = (this.grid.getOptions() || {});
        this._eventHandler = new Slick.EventHandler();
        this._bindEventService = new BindingEventService();
        this.init();
        this._eventHandler.subscribe(this.grid.onValidationError, () => this._isValueSaveCalled = true);
    }
    /** Get Column Definition object */
    get columnDef() {
        return this.args && this.args.column;
    }
    /** Get Column Editor object */
    get columnEditor() {
        return this.columnDef && this.columnDef.internalColumnEditor || {};
    }
    /** Get the Editor DOM Element */
    get editorDomElement() {
        return { leftInput: this._leftInput, rightInput: this._rightInput };
    }
    get editorParams() {
        return this.columnEditor.params || {};
    }
    get eventHandler() {
        return this._eventHandler;
    }
    get hasAutoCommitEdit() {
        return this.grid.getOptions().autoCommitEdit;
    }
    get isValueSaveCalled() {
        return this._isValueSaveCalled;
    }
    /** Get the Shared Validator function, can be passed in Editor property or Column Definition */
    get validator() {
        return (this.columnEditor && this.columnEditor.validator) || (this.columnDef && this.columnDef.validator);
    }
    init() {
        if (!this.editorParams || !this.editorParams.leftInput || !this.editorParams.leftInput.field || !this.editorParams.rightInput || !this.editorParams.rightInput.field) {
            throw new Error(`[Angular-Slickgrid] Please make sure that your Combo Input Editor has params defined with "leftInput" and "rightInput" (example: { editor: { model: Editors.comboInput, params: { leftInput: { field: 'firstName' }, { rightSide: { field: 'lastName' } }}}`);
        }
        this._leftFieldName = this.editorParams && this.editorParams.leftInput && this.editorParams.leftInput.field;
        this._rightFieldName = this.editorParams && this.editorParams.rightInput && this.editorParams.rightInput.field;
        this._leftInput = this.createInput('leftInput');
        this._rightInput = this.createInput('rightInput');
        const containerElm = this.args.container;
        if (containerElm && typeof containerElm.appendChild === 'function') {
            containerElm.appendChild(this._leftInput);
            containerElm.appendChild(this._rightInput);
        }
        this._leftInput.onkeydown = this.handleKeyDown.bind(this);
        this._rightInput.onkeydown = this.handleKeyDown.bind(this);
        // the lib does not get the focus out event for some reason, so register it here
        if (this.hasAutoCommitEdit) {
            this._bindEventService.bind(this._leftInput, 'focusout', (event) => this.handleFocusOut(event, 'leftInput'));
            this._bindEventService.bind(this._rightInput, 'focusout', (event) => this.handleFocusOut(event, 'rightInput'));
        }
        setTimeout(() => this._leftInput.select(), 50);
    }
    handleFocusOut(event, position) {
        // when clicking outside the editable cell OR when focusing out of it
        const targetClassNames = event.relatedTarget && event.relatedTarget.className || '';
        if (targetClassNames.indexOf('dual-editor') === -1 && this._lastEventType !== 'focusout-right') {
            if (position === 'rightInput' || (position === 'leftInput' && this._lastEventType !== 'focusout-left')) {
                this.save();
            }
        }
        const side = (position === 'leftInput') ? 'left' : 'right';
        this._lastEventType = `${event && event.type}-${side}`;
    }
    handleKeyDown(event) {
        this._lastInputKeyEvent = event;
        if (event.keyCode === KeyCode.LEFT || event.keyCode === KeyCode.RIGHT || event.keyCode === KeyCode.TAB) {
            event.stopImmediatePropagation();
        }
    }
    destroy() {
        // unsubscribe all SlickGrid events
        this._eventHandler.unsubscribeAll();
        this._bindEventService.unbindAll();
    }
    createInput(position) {
        const editorSideParams = this.editorParams[position];
        const columnId = this.columnDef && this.columnDef.id;
        const idPropName = this.gridOptions.datasetIdPropertyName || 'id';
        const itemId = this.args && this.args.item && this.args.item[idPropName] || 0;
        let fieldType = editorSideParams.type || 'text';
        if (fieldType === 'float' || fieldType === 'integer') {
            fieldType = 'number';
        }
        const input = document.createElement('input');
        input.id = `item-${itemId}-${position}`;
        input.className = `dual-editor-text editor-${columnId} ${position.replace(/input/gi, '')}`;
        if (fieldType === 'readonly') {
            // when the custom type is defined as readonly, we'll make a readonly text input
            input.readOnly = true;
            fieldType = 'text';
        }
        input.type = fieldType || 'text';
        input.setAttribute('role', 'presentation');
        input.autocomplete = 'off';
        input.placeholder = editorSideParams.placeholder || '';
        input.title = editorSideParams.title || '';
        if (fieldType === 'number') {
            input.step = this.getInputDecimalSteps(position);
        }
        return input;
    }
    focus() {
        // do nothing since we have 2 inputs and we might focus on left/right depending on which is invalid and/or new
    }
    getValues() {
        const obj = {};
        const leftInputValue = this._leftInput.value;
        const rightInputValue = this._rightInput.value;
        const isLeftInputTypeNumber = (this.editorParams.leftInput && (this.editorParams.leftInput.type === 'float' || this.editorParams.leftInput.type === 'integer'));
        const isRightInputTypeNumber = (this.editorParams.rightInput && (this.editorParams.rightInput.type === 'float' || this.editorParams.rightInput.type === 'integer'));
        const resultLeftValue = (leftInputValue !== '' && isLeftInputTypeNumber) ? +this._leftInput.value : (leftInputValue || '');
        const resultRightValue = (rightInputValue !== '' && isRightInputTypeNumber) ? +this._rightInput.value : (rightInputValue || '');
        setDeepValue(obj, this._leftFieldName, resultLeftValue);
        setDeepValue(obj, this._rightFieldName, resultRightValue);
        return obj;
    }
    setValues(values) {
        if (Array.isArray(values) && values.length === 2) {
            this._leftInput.value = `${values[0]}`;
            this._rightInput.value = `${values[1]}`;
        }
    }
    applyValue(item, state) {
        this.applyValueByPosition(item, state, 'leftInput');
        this.applyValueByPosition(item, state, 'rightInput');
    }
    applyValueByPosition(item, state, position) {
        const fieldName = position === 'leftInput' ? this._leftFieldName : this._rightFieldName;
        if (fieldName !== undefined) {
            const isComplexObject = fieldName && fieldName.indexOf('.') > 0; // is the field a complex object, "address.streetNumber"
            let fieldNameToUse = fieldName;
            if (isComplexObject) {
                const complexFieldNames = fieldName.split(/\.(.*)/);
                fieldNameToUse = (complexFieldNames.length > 1 ? complexFieldNames[1] : complexFieldNames);
            }
            // validate the value before applying it (if not valid we'll set an empty string)
            const stateValue = isComplexObject ? getDescendantProperty(state, fieldNameToUse) : state[fieldName];
            const validation = this.validate({ position, inputValue: stateValue });
            // set the new value to the item datacontext
            if (isComplexObject) {
                const newValueFromComplex = getDescendantProperty(state, fieldNameToUse);
                const newValue = (validation && validation.valid) ? newValueFromComplex : '';
                setDeepValue(item, fieldName, newValue);
            }
            else if (fieldName) {
                item[fieldName] = (validation && validation.valid) ? state[fieldName] : '';
            }
        }
    }
    isValueChanged() {
        const leftElmValue = this._leftInput.value;
        const rightElmValue = this._rightInput.value;
        const leftEditorParams = this.editorParams && this.editorParams.leftInput;
        const rightEditorParams = this.editorParams && this.editorParams.rightInput;
        const lastKeyEvent = this._lastInputKeyEvent && this._lastInputKeyEvent.keyCode;
        if ((leftEditorParams && leftEditorParams.alwaysSaveOnEnterKey || rightEditorParams && rightEditorParams.alwaysSaveOnEnterKey) && lastKeyEvent === KeyCode.ENTER) {
            return true;
        }
        const leftResult = (!(leftElmValue === '' && (this.originalLeftValue === null || this.originalLeftValue === undefined))) && (leftElmValue !== this.originalLeftValue);
        const rightResult = (!(rightElmValue === '' && (this.originalRightValue === null || this.originalRightValue === undefined))) && (rightElmValue !== this.originalRightValue);
        return leftResult || rightResult;
    }
    loadValue(item) {
        this.loadValueByPosition(item, 'leftInput');
        this.loadValueByPosition(item, 'rightInput');
        this._leftInput.select();
    }
    loadValueByPosition(item, position) {
        // is the field a complex object, "address.streetNumber"
        const fieldName = (position === 'leftInput') ? this._leftFieldName : this._rightFieldName;
        const originalValuePosition = (position === 'leftInput') ? 'originalLeftValue' : 'originalRightValue';
        const inputVarPosition = (position === 'leftInput') ? '_leftInput' : '_rightInput';
        if (item && fieldName !== undefined) {
            const isComplexObject = fieldName && fieldName.indexOf('.') > 0;
            const itemValue = (isComplexObject) ? getDescendantProperty(item, fieldName) : (item.hasOwnProperty(fieldName) ? item[fieldName] : '');
            this[originalValuePosition] = itemValue;
            if (this.editorParams[position].type === 'float') {
                const decimalPlaces = this.getDecimalPlaces(position);
                if (decimalPlaces !== null && (this[originalValuePosition] || this[originalValuePosition] === 0) && (+this[originalValuePosition]).toFixed) {
                    this[originalValuePosition] = (+this[originalValuePosition]).toFixed(decimalPlaces);
                }
            }
            if (this[inputVarPosition]) {
                const originalValue = this[originalValuePosition];
                this[inputVarPosition].value = `${originalValue}`;
            }
        }
    }
    save() {
        const validation = this.validate();
        const isValid = (validation && validation.valid) || false;
        if (!this._isValueSaveCalled) {
            if (this.hasAutoCommitEdit && isValid) {
                this.grid.getEditorLock().commitCurrentEdit();
            }
            else {
                this.args.commitChanges();
            }
            this._isValueSaveCalled = true;
        }
    }
    serializeValue() {
        const obj = {};
        const leftValue = this.serializeValueByPosition('leftInput');
        const rightValue = this.serializeValueByPosition('rightInput');
        setDeepValue(obj, this._leftFieldName, leftValue);
        setDeepValue(obj, this._rightFieldName, rightValue);
        return obj;
    }
    serializeValueByPosition(position) {
        const elmValue = position === 'leftInput' ? this._leftInput.value : this._rightInput.value;
        if (elmValue === '' || isNaN(+elmValue)) {
            return elmValue;
        }
        let rtn = parseFloat(elmValue);
        const decPlaces = this.getDecimalPlaces(position);
        if (decPlaces !== null && (rtn || rtn === 0) && rtn.toFixed) {
            rtn = parseFloat(rtn.toFixed(decPlaces));
        }
        return rtn;
    }
    getDecimalPlaces(position) {
        const defaultDecimalPlaces = 0; // TODO move into a constant
        // returns the number of fixed decimal places or null
        const positionSide = position === 'leftInput' ? 'leftInput' : 'rightInput';
        const sideParams = this.editorParams[positionSide];
        const rtn = sideParams && sideParams.decimal;
        if (rtn === undefined) {
            return defaultDecimalPlaces;
        }
        return rtn;
    }
    getInputDecimalSteps(position) {
        const decimals = this.getDecimalPlaces(position);
        let zeroString = '';
        for (let i = 1; i < decimals; i++) {
            zeroString += '0';
        }
        if (decimals > 0) {
            return `0.${zeroString}1`;
        }
        return '1';
    }
    validate(inputValidation) {
        if (inputValidation) {
            const posValidation = this.validateByPosition(inputValidation.position, inputValidation.inputValue);
            if (!posValidation.valid) {
                inputValidation.position === 'leftInput' ? this._leftInput.select() : this._rightInput.select();
                return posValidation;
            }
        }
        else {
            const leftValidation = this.validateByPosition('leftInput');
            const rightValidation = this.validateByPosition('rightInput');
            if (!leftValidation.valid) {
                this._leftInput.select();
                return leftValidation;
            }
            if (!rightValidation.valid) {
                this._rightInput.select();
                return rightValidation;
            }
        }
        return { valid: true, msg: '' };
    }
    validateByPosition(position, inputValue) {
        const positionEditorParams = this.editorParams[position];
        let currentVal = '';
        if (inputValue) {
            currentVal = inputValue;
        }
        else {
            const input = position === 'leftInput' ? this._leftInput : this._rightInput;
            currentVal = input && input.value;
        }
        // there are 2 ways of passing a Validator, 1-independent validator on each side, 2-shared validator
        const commonValidator = this.validator;
        currentVal = typeof commonValidator === 'function' ? this.getValues() : currentVal;
        const baseValidatorOptions = {
            editorArgs: this.args,
            errorMessage: positionEditorParams.errorMessage,
            required: positionEditorParams.required,
            validator: typeof commonValidator === 'function' ? commonValidator : positionEditorParams.validator,
        };
        switch (positionEditorParams.type) {
            case 'float':
                return floatValidator(currentVal, Object.assign({}, baseValidatorOptions, { decimal: this.getDecimalPlaces(position), minValue: positionEditorParams.minValue, maxValue: positionEditorParams.maxValue, operatorConditionalType: positionEditorParams.operatorConditionalType }));
            case 'integer':
                return integerValidator(currentVal, Object.assign({}, baseValidatorOptions, { minValue: positionEditorParams.minValue, maxValue: positionEditorParams.maxValue, operatorConditionalType: positionEditorParams.operatorConditionalType }));
            case 'text':
            case 'password':
            default:
                return textValidator(currentVal, baseValidatorOptions);
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZHVhbElucHV0RWRpdG9yLmpzIiwic291cmNlUm9vdCI6Im5nOi8vYW5ndWxhci1zbGlja2dyaWQvIiwic291cmNlcyI6WyJhcHAvbW9kdWxlcy9hbmd1bGFyLXNsaWNrZ3JpZC9lZGl0b3JzL2R1YWxJbnB1dEVkaXRvci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBVUwsT0FBTyxHQUVSLE1BQU0saUJBQWlCLENBQUM7QUFDekIsT0FBTyxFQUFFLG1CQUFtQixFQUFFLE1BQU0sa0NBQWtDLENBQUM7QUFDdkUsT0FBTyxFQUFFLHFCQUFxQixFQUFFLFlBQVksRUFBRSxNQUFNLHVCQUF1QixDQUFDO0FBQzVFLE9BQU8sRUFBRSxjQUFjLEVBQUUsZ0JBQWdCLEVBQUUsYUFBYSxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFLdEY7OztHQUdHO0FBQ0gsTUFBTSxPQUFPLGVBQWU7SUFtQjFCLFlBQW9CLElBQXFCO1FBQXJCLFNBQUksR0FBSixJQUFJLENBQWlCO1FBaEJqQyx1QkFBa0IsR0FBRyxLQUFLLENBQUM7UUFpQmpDLElBQUksQ0FBQyxJQUFJLEVBQUU7WUFDVCxNQUFNLElBQUksS0FBSyxDQUFDLG9HQUFvRyxDQUFDLENBQUM7U0FDdkg7UUFDRCxJQUFJLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUM7UUFDdEIsSUFBSSxDQUFDLFdBQVcsR0FBRyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsVUFBVSxFQUFFLElBQUksRUFBRSxDQUFlLENBQUM7UUFDaEUsSUFBSSxDQUFDLGFBQWEsR0FBRyxJQUFJLEtBQUssQ0FBQyxZQUFZLEVBQUUsQ0FBQztRQUM5QyxJQUFJLENBQUMsaUJBQWlCLEdBQUcsSUFBSSxtQkFBbUIsRUFBRSxDQUFDO1FBQ25ELElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQztRQUNaLElBQUksQ0FBQyxhQUFhLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsaUJBQWlCLEVBQUUsR0FBRyxFQUFFLENBQUMsSUFBSSxDQUFDLGtCQUFrQixHQUFHLElBQUksQ0FBQyxDQUFDO0lBQ2xHLENBQUM7SUFFRCxtQ0FBbUM7SUFDbkMsSUFBSSxTQUFTO1FBQ1gsT0FBTyxJQUFJLENBQUMsSUFBSSxJQUFJLElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDO0lBQ3ZDLENBQUM7SUFFRCwrQkFBK0I7SUFDL0IsSUFBSSxZQUFZO1FBQ2QsT0FBTyxJQUFJLENBQUMsU0FBUyxJQUFJLElBQUksQ0FBQyxTQUFTLENBQUMsb0JBQW9CLElBQUksRUFBRSxDQUFDO0lBQ3JFLENBQUM7SUFFRCxpQ0FBaUM7SUFDakMsSUFBSSxnQkFBZ0I7UUFDbEIsT0FBTyxFQUFFLFNBQVMsRUFBRSxJQUFJLENBQUMsVUFBVSxFQUFFLFVBQVUsRUFBRSxJQUFJLENBQUMsV0FBVyxFQUFFLENBQUM7SUFDdEUsQ0FBQztJQUVELElBQUksWUFBWTtRQUNkLE9BQU8sSUFBSSxDQUFDLFlBQVksQ0FBQyxNQUFNLElBQUksRUFBRSxDQUFDO0lBQ3hDLENBQUM7SUFFRCxJQUFJLFlBQVk7UUFDZCxPQUFPLElBQUksQ0FBQyxhQUFhLENBQUM7SUFDNUIsQ0FBQztJQUVELElBQUksaUJBQWlCO1FBQ25CLE9BQU8sSUFBSSxDQUFDLElBQUksQ0FBQyxVQUFVLEVBQUUsQ0FBQyxjQUFjLENBQUM7SUFDL0MsQ0FBQztJQUVELElBQUksaUJBQWlCO1FBQ25CLE9BQU8sSUFBSSxDQUFDLGtCQUFrQixDQUFDO0lBQ2pDLENBQUM7SUFFRCwrRkFBK0Y7SUFDL0YsSUFBSSxTQUFTO1FBQ1gsT0FBTyxDQUFDLElBQUksQ0FBQyxZQUFZLElBQUksSUFBSSxDQUFDLFlBQVksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxTQUFTLElBQUksSUFBSSxDQUFDLFNBQVMsQ0FBQyxTQUFTLENBQUMsQ0FBQztJQUM1RyxDQUFDO0lBRUQsSUFBSTtRQUNGLElBQUksQ0FBQyxJQUFJLENBQUMsWUFBWSxJQUFJLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxTQUFTLElBQUksQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLFNBQVMsQ0FBQyxLQUFLLElBQUksQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLFVBQVUsSUFBSSxDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsVUFBVSxDQUFDLEtBQUssRUFBRTtZQUNwSyxNQUFNLElBQUksS0FBSyxDQUFDLDZQQUE2UCxDQUFDLENBQUM7U0FDaFI7UUFDRCxJQUFJLENBQUMsY0FBYyxHQUFHLElBQUksQ0FBQyxZQUFZLElBQUksSUFBSSxDQUFDLFlBQVksQ0FBQyxTQUFTLElBQUksSUFBSSxDQUFDLFlBQVksQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDO1FBQzVHLElBQUksQ0FBQyxlQUFlLEdBQUcsSUFBSSxDQUFDLFlBQVksSUFBSSxJQUFJLENBQUMsWUFBWSxDQUFDLFVBQVUsSUFBSSxJQUFJLENBQUMsWUFBWSxDQUFDLFVBQVUsQ0FBQyxLQUFLLENBQUM7UUFDL0csSUFBSSxDQUFDLFVBQVUsR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDLFdBQVcsQ0FBQyxDQUFDO1FBQ2hELElBQUksQ0FBQyxXQUFXLEdBQUcsSUFBSSxDQUFDLFdBQVcsQ0FBQyxZQUFZLENBQUMsQ0FBQztRQUVsRCxNQUFNLFlBQVksR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQztRQUN6QyxJQUFJLFlBQVksSUFBSSxPQUFPLFlBQVksQ0FBQyxXQUFXLEtBQUssVUFBVSxFQUFFO1lBQ2xFLFlBQVksQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDO1lBQzFDLFlBQVksQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxDQUFDO1NBQzVDO1FBRUQsSUFBSSxDQUFDLFVBQVUsQ0FBQyxTQUFTLEdBQUcsSUFBSSxDQUFDLGFBQWEsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDMUQsSUFBSSxDQUFDLFdBQVcsQ0FBQyxTQUFTLEdBQUcsSUFBSSxDQUFDLGFBQWEsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7UUFFM0QsZ0ZBQWdGO1FBQ2hGLElBQUksSUFBSSxDQUFDLGlCQUFpQixFQUFFO1lBQzFCLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFVBQVUsRUFBRSxVQUFVLEVBQUUsQ0FBQyxLQUFpQyxFQUFFLEVBQUUsQ0FBQyxJQUFJLENBQUMsY0FBYyxDQUFDLEtBQUssRUFBRSxXQUFXLENBQUMsQ0FBQyxDQUFDO1lBQ3pJLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFdBQVcsRUFBRSxVQUFVLEVBQUUsQ0FBQyxLQUFpQyxFQUFFLEVBQUUsQ0FBQyxJQUFJLENBQUMsY0FBYyxDQUFDLEtBQUssRUFBRSxZQUFZLENBQUMsQ0FBQyxDQUFDO1NBQzVJO1FBRUQsVUFBVSxDQUFDLEdBQUcsRUFBRSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsTUFBTSxFQUFFLEVBQUUsRUFBRSxDQUFDLENBQUM7SUFDakQsQ0FBQztJQUVELGNBQWMsQ0FBQyxLQUFpQyxFQUFFLFFBQW9DO1FBQ3BGLHFFQUFxRTtRQUNyRSxNQUFNLGdCQUFnQixHQUFHLEtBQUssQ0FBQyxhQUFhLElBQUksS0FBSyxDQUFDLGFBQWEsQ0FBQyxTQUFTLElBQUksRUFBRSxDQUFDO1FBQ3BGLElBQUksZ0JBQWdCLENBQUMsT0FBTyxDQUFDLGFBQWEsQ0FBQyxLQUFLLENBQUMsQ0FBQyxJQUFJLElBQUksQ0FBQyxjQUFjLEtBQUssZ0JBQWdCLEVBQUU7WUFDOUYsSUFBSSxRQUFRLEtBQUssWUFBWSxJQUFJLENBQUMsUUFBUSxLQUFLLFdBQVcsSUFBSSxJQUFJLENBQUMsY0FBYyxLQUFLLGVBQWUsQ0FBQyxFQUFFO2dCQUN0RyxJQUFJLENBQUMsSUFBSSxFQUFFLENBQUM7YUFDYjtTQUNGO1FBQ0QsTUFBTSxJQUFJLEdBQUcsQ0FBQyxRQUFRLEtBQUssV0FBVyxDQUFDLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDO1FBQzNELElBQUksQ0FBQyxjQUFjLEdBQUcsR0FBRyxLQUFLLElBQUksS0FBSyxDQUFDLElBQUksSUFBSSxJQUFJLEVBQUUsQ0FBQztJQUN6RCxDQUFDO0lBRUQsYUFBYSxDQUFDLEtBQW1CO1FBQy9CLElBQUksQ0FBQyxrQkFBa0IsR0FBRyxLQUFLLENBQUM7UUFDaEMsSUFBSSxLQUFLLENBQUMsT0FBTyxLQUFLLE9BQU8sQ0FBQyxJQUFJLElBQUksS0FBSyxDQUFDLE9BQU8sS0FBSyxPQUFPLENBQUMsS0FBSyxJQUFJLEtBQUssQ0FBQyxPQUFPLEtBQUssT0FBTyxDQUFDLEdBQUcsRUFBRTtZQUN0RyxLQUFLLENBQUMsd0JBQXdCLEVBQUUsQ0FBQztTQUNsQztJQUNILENBQUM7SUFFRCxPQUFPO1FBQ0wsbUNBQW1DO1FBQ25DLElBQUksQ0FBQyxhQUFhLENBQUMsY0FBYyxFQUFFLENBQUM7UUFDcEMsSUFBSSxDQUFDLGlCQUFpQixDQUFDLFNBQVMsRUFBRSxDQUFDO0lBQ3JDLENBQUM7SUFFRCxXQUFXLENBQUMsUUFBb0M7UUFDOUMsTUFBTSxnQkFBZ0IsR0FBRyxJQUFJLENBQUMsWUFBWSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBQ3JELE1BQU0sUUFBUSxHQUFHLElBQUksQ0FBQyxTQUFTLElBQUksSUFBSSxDQUFDLFNBQVMsQ0FBQyxFQUFFLENBQUM7UUFDckQsTUFBTSxVQUFVLEdBQUcsSUFBSSxDQUFDLFdBQVcsQ0FBQyxxQkFBcUIsSUFBSSxJQUFJLENBQUM7UUFDbEUsTUFBTSxNQUFNLEdBQUcsSUFBSSxDQUFDLElBQUksSUFBSSxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksSUFBSSxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLENBQUM7UUFFOUUsSUFBSSxTQUFTLEdBQVcsZ0JBQWdCLENBQUMsSUFBSSxJQUFJLE1BQU0sQ0FBQztRQUN4RCxJQUFJLFNBQVMsS0FBSyxPQUFPLElBQUksU0FBUyxLQUFLLFNBQVMsRUFBRTtZQUNwRCxTQUFTLEdBQUcsUUFBUSxDQUFDO1NBQ3RCO1FBRUQsTUFBTSxLQUFLLEdBQUcsUUFBUSxDQUFDLGFBQWEsQ0FBQyxPQUFPLENBQXFCLENBQUM7UUFDbEUsS0FBSyxDQUFDLEVBQUUsR0FBRyxRQUFRLE1BQU0sSUFBSSxRQUFRLEVBQUUsQ0FBQztRQUN4QyxLQUFLLENBQUMsU0FBUyxHQUFHLDJCQUEyQixRQUFRLElBQUksUUFBUSxDQUFDLE9BQU8sQ0FBQyxTQUFTLEVBQUUsRUFBRSxDQUFDLEVBQUUsQ0FBQztRQUMzRixJQUFJLFNBQVMsS0FBSyxVQUFVLEVBQUU7WUFDNUIsZ0ZBQWdGO1lBQ2hGLEtBQUssQ0FBQyxRQUFRLEdBQUcsSUFBSSxDQUFDO1lBQ3RCLFNBQVMsR0FBRyxNQUFNLENBQUM7U0FDcEI7UUFDRCxLQUFLLENBQUMsSUFBSSxHQUFHLFNBQVMsSUFBSSxNQUFNLENBQUM7UUFDakMsS0FBSyxDQUFDLFlBQVksQ0FBQyxNQUFNLEVBQUUsY0FBYyxDQUFDLENBQUM7UUFDM0MsS0FBSyxDQUFDLFlBQVksR0FBRyxLQUFLLENBQUM7UUFDM0IsS0FBSyxDQUFDLFdBQVcsR0FBRyxnQkFBZ0IsQ0FBQyxXQUFXLElBQUksRUFBRSxDQUFDO1FBQ3ZELEtBQUssQ0FBQyxLQUFLLEdBQUcsZ0JBQWdCLENBQUMsS0FBSyxJQUFJLEVBQUUsQ0FBQztRQUMzQyxJQUFJLFNBQVMsS0FBSyxRQUFRLEVBQUU7WUFDMUIsS0FBSyxDQUFDLElBQUksR0FBRyxJQUFJLENBQUMsb0JBQW9CLENBQUMsUUFBUSxDQUFDLENBQUM7U0FDbEQ7UUFDRCxPQUFPLEtBQUssQ0FBQztJQUNmLENBQUM7SUFFRCxLQUFLO1FBQ0gsOEdBQThHO0lBQ2hILENBQUM7SUFFRCxTQUFTO1FBQ1AsTUFBTSxHQUFHLEdBQUcsRUFBRSxDQUFDO1FBQ2YsTUFBTSxjQUFjLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQyxLQUFLLENBQUM7UUFDN0MsTUFBTSxlQUFlLEdBQUcsSUFBSSxDQUFDLFdBQVcsQ0FBQyxLQUFLLENBQUM7UUFDL0MsTUFBTSxxQkFBcUIsR0FBRyxDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsU0FBUyxJQUFJLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxTQUFTLENBQUMsSUFBSSxLQUFLLE9BQU8sSUFBSSxJQUFJLENBQUMsWUFBWSxDQUFDLFNBQVMsQ0FBQyxJQUFJLEtBQUssU0FBUyxDQUFDLENBQUMsQ0FBQztRQUNoSyxNQUFNLHNCQUFzQixHQUFHLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxVQUFVLElBQUksQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLFVBQVUsQ0FBQyxJQUFJLEtBQUssT0FBTyxJQUFJLElBQUksQ0FBQyxZQUFZLENBQUMsVUFBVSxDQUFDLElBQUksS0FBSyxTQUFTLENBQUMsQ0FBQyxDQUFDO1FBQ3BLLE1BQU0sZUFBZSxHQUFHLENBQUMsY0FBYyxLQUFLLEVBQUUsSUFBSSxxQkFBcUIsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLGNBQWMsSUFBSSxFQUFFLENBQUMsQ0FBQztRQUMzSCxNQUFNLGdCQUFnQixHQUFHLENBQUMsZUFBZSxLQUFLLEVBQUUsSUFBSSxzQkFBc0IsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLGVBQWUsSUFBSSxFQUFFLENBQUMsQ0FBQztRQUNoSSxZQUFZLENBQUMsR0FBRyxFQUFFLElBQUksQ0FBQyxjQUFjLEVBQUUsZUFBZSxDQUFDLENBQUM7UUFDeEQsWUFBWSxDQUFDLEdBQUcsRUFBRSxJQUFJLENBQUMsZUFBZSxFQUFFLGdCQUFnQixDQUFDLENBQUM7UUFFMUQsT0FBTyxHQUFHLENBQUM7SUFDYixDQUFDO0lBRUQsU0FBUyxDQUFDLE1BQThCO1FBQ3RDLElBQUksS0FBSyxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsSUFBSSxNQUFNLENBQUMsTUFBTSxLQUFLLENBQUMsRUFBRTtZQUNoRCxJQUFJLENBQUMsVUFBVSxDQUFDLEtBQUssR0FBRyxHQUFHLE1BQU0sQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDO1lBQ3ZDLElBQUksQ0FBQyxXQUFXLENBQUMsS0FBSyxHQUFHLEdBQUcsTUFBTSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUM7U0FDekM7SUFDSCxDQUFDO0lBRUQsVUFBVSxDQUFDLElBQVMsRUFBRSxLQUFVO1FBQzlCLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxJQUFJLEVBQUUsS0FBSyxFQUFFLFdBQVcsQ0FBQyxDQUFDO1FBQ3BELElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxJQUFJLEVBQUUsS0FBSyxFQUFFLFlBQVksQ0FBQyxDQUFDO0lBQ3ZELENBQUM7SUFFRCxvQkFBb0IsQ0FBQyxJQUFTLEVBQUUsS0FBVSxFQUFFLFFBQW9DO1FBQzlFLE1BQU0sU0FBUyxHQUFHLFFBQVEsS0FBSyxXQUFXLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxjQUFjLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxlQUFlLENBQUM7UUFDeEYsSUFBSSxTQUFTLEtBQUssU0FBUyxFQUFFO1lBQzNCLE1BQU0sZUFBZSxHQUFHLFNBQVMsSUFBSSxTQUFTLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLHdEQUF3RDtZQUV6SCxJQUFJLGNBQWMsR0FBRyxTQUFTLENBQUM7WUFDL0IsSUFBSSxlQUFlLEVBQUU7Z0JBQ25CLE1BQU0saUJBQWlCLEdBQUcsU0FBUyxDQUFDLEtBQUssQ0FBQyxRQUFRLENBQUMsQ0FBQztnQkFDcEQsY0FBYyxHQUFHLENBQUMsaUJBQWlCLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsaUJBQWlCLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLGlCQUFpQixDQUFXLENBQUM7YUFDdEc7WUFFRCxpRkFBaUY7WUFDakYsTUFBTSxVQUFVLEdBQUcsZUFBZSxDQUFDLENBQUMsQ0FBQyxxQkFBcUIsQ0FBQyxLQUFLLEVBQUUsY0FBYyxDQUFDLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxTQUFTLENBQUMsQ0FBQztZQUNyRyxNQUFNLFVBQVUsR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLEVBQUUsUUFBUSxFQUFFLFVBQVUsRUFBRSxVQUFVLEVBQUUsQ0FBQyxDQUFDO1lBRXZFLDRDQUE0QztZQUM1QyxJQUFJLGVBQWUsRUFBRTtnQkFDbkIsTUFBTSxtQkFBbUIsR0FBRyxxQkFBcUIsQ0FBQyxLQUFLLEVBQUUsY0FBYyxDQUFDLENBQUM7Z0JBQ3pFLE1BQU0sUUFBUSxHQUFHLENBQUMsVUFBVSxJQUFJLFVBQVUsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsbUJBQW1CLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQztnQkFDN0UsWUFBWSxDQUFDLElBQUksRUFBRSxTQUFTLEVBQUUsUUFBUSxDQUFDLENBQUM7YUFDekM7aUJBQU0sSUFBSSxTQUFTLEVBQUU7Z0JBQ3BCLElBQUksQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDLFVBQVUsSUFBSSxVQUFVLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDO2FBQzVFO1NBQ0Y7SUFDSCxDQUFDO0lBRUQsY0FBYztRQUNaLE1BQU0sWUFBWSxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUMsS0FBSyxDQUFDO1FBQzNDLE1BQU0sYUFBYSxHQUFHLElBQUksQ0FBQyxXQUFXLENBQUMsS0FBSyxDQUFDO1FBQzdDLE1BQU0sZ0JBQWdCLEdBQUcsSUFBSSxDQUFDLFlBQVksSUFBSSxJQUFJLENBQUMsWUFBWSxDQUFDLFNBQVMsQ0FBQztRQUMxRSxNQUFNLGlCQUFpQixHQUFHLElBQUksQ0FBQyxZQUFZLElBQUksSUFBSSxDQUFDLFlBQVksQ0FBQyxVQUFVLENBQUM7UUFDNUUsTUFBTSxZQUFZLEdBQUcsSUFBSSxDQUFDLGtCQUFrQixJQUFJLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxPQUFPLENBQUM7UUFDaEYsSUFBSSxDQUFDLGdCQUFnQixJQUFJLGdCQUFnQixDQUFDLG9CQUFvQixJQUFJLGlCQUFpQixJQUFJLGlCQUFpQixDQUFDLG9CQUFvQixDQUFDLElBQUksWUFBWSxLQUFLLE9BQU8sQ0FBQyxLQUFLLEVBQUU7WUFDaEssT0FBTyxJQUFJLENBQUM7U0FDYjtRQUNELE1BQU0sVUFBVSxHQUFHLENBQUMsQ0FBQyxDQUFDLFlBQVksS0FBSyxFQUFFLElBQUksQ0FBQyxJQUFJLENBQUMsaUJBQWlCLEtBQUssSUFBSSxJQUFJLElBQUksQ0FBQyxpQkFBaUIsS0FBSyxTQUFTLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxZQUFZLEtBQUssSUFBSSxDQUFDLGlCQUFpQixDQUFDLENBQUM7UUFDdEssTUFBTSxXQUFXLEdBQUcsQ0FBQyxDQUFDLENBQUMsYUFBYSxLQUFLLEVBQUUsSUFBSSxDQUFDLElBQUksQ0FBQyxrQkFBa0IsS0FBSyxJQUFJLElBQUksSUFBSSxDQUFDLGtCQUFrQixLQUFLLFNBQVMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLGFBQWEsS0FBSyxJQUFJLENBQUMsa0JBQWtCLENBQUMsQ0FBQztRQUM1SyxPQUFPLFVBQVUsSUFBSSxXQUFXLENBQUM7SUFDbkMsQ0FBQztJQUVELFNBQVMsQ0FBQyxJQUFTO1FBQ2pCLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxJQUFJLEVBQUUsV0FBVyxDQUFDLENBQUM7UUFDNUMsSUFBSSxDQUFDLG1CQUFtQixDQUFDLElBQUksRUFBRSxZQUFZLENBQUMsQ0FBQztRQUM3QyxJQUFJLENBQUMsVUFBVSxDQUFDLE1BQU0sRUFBRSxDQUFDO0lBQzNCLENBQUM7SUFFRCxtQkFBbUIsQ0FBQyxJQUFTLEVBQUUsUUFBb0M7UUFDakUsd0RBQXdEO1FBQ3hELE1BQU0sU0FBUyxHQUFHLENBQUMsUUFBUSxLQUFLLFdBQVcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsY0FBYyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsZUFBZSxDQUFDO1FBQzFGLE1BQU0scUJBQXFCLEdBQUcsQ0FBQyxRQUFRLEtBQUssV0FBVyxDQUFDLENBQUMsQ0FBQyxDQUFDLG1CQUFtQixDQUFDLENBQUMsQ0FBQyxvQkFBb0IsQ0FBQztRQUN0RyxNQUFNLGdCQUFnQixHQUFHLENBQUMsUUFBUSxLQUFLLFdBQVcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxZQUFZLENBQUMsQ0FBQyxDQUFDLGFBQWEsQ0FBQztRQUVuRixJQUFJLElBQUksSUFBSSxTQUFTLEtBQUssU0FBUyxFQUFFO1lBQ25DLE1BQU0sZUFBZSxHQUFHLFNBQVMsSUFBSSxTQUFTLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQztZQUNoRSxNQUFNLFNBQVMsR0FBRyxDQUFDLGVBQWUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxxQkFBcUIsQ0FBQyxJQUFJLEVBQUUsU0FBUyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLGNBQWMsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQztZQUN2SSxJQUFJLENBQUMscUJBQXFCLENBQUMsR0FBRyxTQUFTLENBQUM7WUFDeEMsSUFBSSxJQUFJLENBQUMsWUFBWSxDQUFDLFFBQVEsQ0FBQyxDQUFDLElBQUksS0FBSyxPQUFPLEVBQUU7Z0JBQ2hELE1BQU0sYUFBYSxHQUFHLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxRQUFRLENBQUMsQ0FBQztnQkFDdEQsSUFBSSxhQUFhLEtBQUssSUFBSSxJQUFJLENBQUMsSUFBSSxDQUFDLHFCQUFxQixDQUFDLElBQUksSUFBSSxDQUFDLHFCQUFxQixDQUFDLEtBQUssQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLElBQUksQ0FBQyxxQkFBcUIsQ0FBQyxDQUFDLENBQUMsT0FBTyxFQUFFO29CQUMxSSxJQUFJLENBQUMscUJBQXFCLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLHFCQUFxQixDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsYUFBYSxDQUFDLENBQUM7aUJBQ3JGO2FBQ0Y7WUFDRCxJQUFJLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxFQUFFO2dCQUMxQixNQUFNLGFBQWEsR0FBRyxJQUFJLENBQUMscUJBQXFCLENBQUMsQ0FBQztnQkFDbEQsSUFBSSxDQUFDLGdCQUFnQixDQUFDLENBQUMsS0FBSyxHQUFHLEdBQUcsYUFBYSxFQUFFLENBQUM7YUFDbkQ7U0FDRjtJQUNILENBQUM7SUFFRCxJQUFJO1FBQ0YsTUFBTSxVQUFVLEdBQUcsSUFBSSxDQUFDLFFBQVEsRUFBRSxDQUFDO1FBQ25DLE1BQU0sT0FBTyxHQUFHLENBQUMsVUFBVSxJQUFJLFVBQVUsQ0FBQyxLQUFLLENBQUMsSUFBSSxLQUFLLENBQUM7UUFFMUQsSUFBSSxDQUFDLElBQUksQ0FBQyxrQkFBa0IsRUFBRTtZQUM1QixJQUFJLElBQUksQ0FBQyxpQkFBaUIsSUFBSSxPQUFPLEVBQUU7Z0JBQ3JDLElBQUksQ0FBQyxJQUFJLENBQUMsYUFBYSxFQUFFLENBQUMsaUJBQWlCLEVBQUUsQ0FBQzthQUMvQztpQkFBTTtnQkFDTCxJQUFJLENBQUMsSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFDO2FBQzNCO1lBQ0QsSUFBSSxDQUFDLGtCQUFrQixHQUFHLElBQUksQ0FBQztTQUNoQztJQUNILENBQUM7SUFFRCxjQUFjO1FBQ1osTUFBTSxHQUFHLEdBQUcsRUFBRSxDQUFDO1FBQ2YsTUFBTSxTQUFTLEdBQUcsSUFBSSxDQUFDLHdCQUF3QixDQUFDLFdBQVcsQ0FBQyxDQUFDO1FBQzdELE1BQU0sVUFBVSxHQUFHLElBQUksQ0FBQyx3QkFBd0IsQ0FBQyxZQUFZLENBQUMsQ0FBQztRQUUvRCxZQUFZLENBQUMsR0FBRyxFQUFFLElBQUksQ0FBQyxjQUFjLEVBQUUsU0FBUyxDQUFDLENBQUM7UUFDbEQsWUFBWSxDQUFDLEdBQUcsRUFBRSxJQUFJLENBQUMsZUFBZSxFQUFFLFVBQVUsQ0FBQyxDQUFDO1FBRXBELE9BQU8sR0FBRyxDQUFDO0lBQ2IsQ0FBQztJQUVELHdCQUF3QixDQUFDLFFBQW9DO1FBQzNELE1BQU0sUUFBUSxHQUFHLFFBQVEsS0FBSyxXQUFXLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLEtBQUssQ0FBQztRQUMzRixJQUFJLFFBQVEsS0FBSyxFQUFFLElBQUksS0FBSyxDQUFDLENBQUMsUUFBUSxDQUFDLEVBQUU7WUFDdkMsT0FBTyxRQUFRLENBQUM7U0FDakI7UUFFRCxJQUFJLEdBQUcsR0FBRyxVQUFVLENBQUMsUUFBUSxDQUFDLENBQUM7UUFDL0IsTUFBTSxTQUFTLEdBQUcsSUFBSSxDQUFDLGdCQUFnQixDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBQ2xELElBQUksU0FBUyxLQUFLLElBQUksSUFBSSxDQUFDLEdBQUcsSUFBSSxHQUFHLEtBQUssQ0FBQyxDQUFDLElBQUksR0FBRyxDQUFDLE9BQU8sRUFBRTtZQUMzRCxHQUFHLEdBQUcsVUFBVSxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQztTQUMxQztRQUVELE9BQU8sR0FBRyxDQUFDO0lBQ2IsQ0FBQztJQUVELGdCQUFnQixDQUFDLFFBQW9DO1FBQ25ELE1BQU0sb0JBQW9CLEdBQUcsQ0FBQyxDQUFDLENBQUMsNEJBQTRCO1FBRTVELHFEQUFxRDtRQUNyRCxNQUFNLFlBQVksR0FBRyxRQUFRLEtBQUssV0FBVyxDQUFDLENBQUMsQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDLFlBQVksQ0FBQztRQUMzRSxNQUFNLFVBQVUsR0FBRyxJQUFJLENBQUMsWUFBWSxDQUFDLFlBQVksQ0FBQyxDQUFDO1FBQ25ELE1BQU0sR0FBRyxHQUF1QixVQUFVLElBQUksVUFBVSxDQUFDLE9BQU8sQ0FBQztRQUVqRSxJQUFJLEdBQUcsS0FBSyxTQUFTLEVBQUU7WUFDckIsT0FBTyxvQkFBb0IsQ0FBQztTQUM3QjtRQUNELE9BQU8sR0FBRyxDQUFDO0lBQ2IsQ0FBQztJQUVELG9CQUFvQixDQUFDLFFBQW9DO1FBQ3ZELE1BQU0sUUFBUSxHQUFHLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUNqRCxJQUFJLFVBQVUsR0FBRyxFQUFFLENBQUM7UUFDcEIsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLFFBQVEsRUFBRSxDQUFDLEVBQUUsRUFBRTtZQUNqQyxVQUFVLElBQUksR0FBRyxDQUFDO1NBQ25CO1FBRUQsSUFBSSxRQUFRLEdBQUcsQ0FBQyxFQUFFO1lBQ2hCLE9BQU8sS0FBSyxVQUFVLEdBQUcsQ0FBQztTQUMzQjtRQUNELE9BQU8sR0FBRyxDQUFDO0lBQ2IsQ0FBQztJQUVELFFBQVEsQ0FBQyxlQUEyRTtRQUNsRixJQUFJLGVBQWUsRUFBRTtZQUNuQixNQUFNLGFBQWEsR0FBRyxJQUFJLENBQUMsa0JBQWtCLENBQUMsZUFBZSxDQUFDLFFBQVEsRUFBRSxlQUFlLENBQUMsVUFBVSxDQUFDLENBQUM7WUFDcEcsSUFBSSxDQUFDLGFBQWEsQ0FBQyxLQUFLLEVBQUU7Z0JBQ3hCLGVBQWUsQ0FBQyxRQUFRLEtBQUssV0FBVyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLE1BQU0sRUFBRSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLE1BQU0sRUFBRSxDQUFDO2dCQUNoRyxPQUFPLGFBQWEsQ0FBQzthQUN0QjtTQUNGO2FBQU07WUFDTCxNQUFNLGNBQWMsR0FBRyxJQUFJLENBQUMsa0JBQWtCLENBQUMsV0FBVyxDQUFDLENBQUM7WUFDNUQsTUFBTSxlQUFlLEdBQUcsSUFBSSxDQUFDLGtCQUFrQixDQUFDLFlBQVksQ0FBQyxDQUFDO1lBRTlELElBQUksQ0FBQyxjQUFjLENBQUMsS0FBSyxFQUFFO2dCQUN6QixJQUFJLENBQUMsVUFBVSxDQUFDLE1BQU0sRUFBRSxDQUFDO2dCQUN6QixPQUFPLGNBQWMsQ0FBQzthQUN2QjtZQUNELElBQUksQ0FBQyxlQUFlLENBQUMsS0FBSyxFQUFFO2dCQUMxQixJQUFJLENBQUMsV0FBVyxDQUFDLE1BQU0sRUFBRSxDQUFDO2dCQUMxQixPQUFPLGVBQWUsQ0FBQzthQUN4QjtTQUNGO1FBQ0QsT0FBTyxFQUFFLEtBQUssRUFBRSxJQUFJLEVBQUUsR0FBRyxFQUFFLEVBQUUsRUFBRSxDQUFDO0lBQ2xDLENBQUM7SUFFRCxrQkFBa0IsQ0FBQyxRQUFvQyxFQUFFLFVBQWdCO1FBQ3ZFLE1BQU0sb0JBQW9CLEdBQUcsSUFBSSxDQUFDLFlBQVksQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUN6RCxJQUFJLFVBQVUsR0FBUSxFQUFFLENBQUM7UUFDekIsSUFBSSxVQUFVLEVBQUU7WUFDZCxVQUFVLEdBQUcsVUFBVSxDQUFDO1NBQ3pCO2FBQU07WUFDTCxNQUFNLEtBQUssR0FBRyxRQUFRLEtBQUssV0FBVyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDO1lBQzVFLFVBQVUsR0FBRyxLQUFLLElBQUksS0FBSyxDQUFDLEtBQUssQ0FBQztTQUNuQztRQUVELG9HQUFvRztRQUNwRyxNQUFNLGVBQWUsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDO1FBQ3ZDLFVBQVUsR0FBRyxPQUFPLGVBQWUsS0FBSyxVQUFVLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxTQUFTLEVBQUUsQ0FBQyxDQUFDLENBQUMsVUFBVSxDQUFDO1FBQ25GLE1BQU0sb0JBQW9CLEdBQUc7WUFDM0IsVUFBVSxFQUFFLElBQUksQ0FBQyxJQUFJO1lBQ3JCLFlBQVksRUFBRSxvQkFBb0IsQ0FBQyxZQUFZO1lBQy9DLFFBQVEsRUFBRSxvQkFBb0IsQ0FBQyxRQUFRO1lBQ3ZDLFNBQVMsRUFBRSxPQUFPLGVBQWUsS0FBSyxVQUFVLENBQUMsQ0FBQyxDQUFDLGVBQWUsQ0FBQyxDQUFDLENBQUMsb0JBQW9CLENBQUMsU0FBUztTQUNwRyxDQUFDO1FBRUYsUUFBUSxvQkFBb0IsQ0FBQyxJQUFJLEVBQUU7WUFDakMsS0FBSyxPQUFPO2dCQUNWLE9BQU8sY0FBYyxDQUFDLFVBQVUsb0JBQzNCLG9CQUFvQixJQUN2QixPQUFPLEVBQUUsSUFBSSxDQUFDLGdCQUFnQixDQUFDLFFBQVEsQ0FBQyxFQUN4QyxRQUFRLEVBQUUsb0JBQW9CLENBQUMsUUFBUSxFQUN2QyxRQUFRLEVBQUUsb0JBQW9CLENBQUMsUUFBUSxFQUN2Qyx1QkFBdUIsRUFBRSxvQkFBb0IsQ0FBQyx1QkFBdUIsSUFDckUsQ0FBQztZQUNMLEtBQUssU0FBUztnQkFDWixPQUFPLGdCQUFnQixDQUFDLFVBQVUsb0JBQzdCLG9CQUFvQixJQUN2QixRQUFRLEVBQUUsb0JBQW9CLENBQUMsUUFBUSxFQUN2QyxRQUFRLEVBQUUsb0JBQW9CLENBQUMsUUFBUSxFQUN2Qyx1QkFBdUIsRUFBRSxvQkFBb0IsQ0FBQyx1QkFBdUIsSUFDckUsQ0FBQztZQUNMLEtBQUssTUFBTSxDQUFDO1lBQ1osS0FBSyxVQUFVLENBQUM7WUFDaEI7Z0JBQ0UsT0FBTyxhQUFhLENBQUMsVUFBVSxFQUFFLG9CQUFvQixDQUFDLENBQUM7U0FDMUQ7SUFDSCxDQUFDO0NBQ0YiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xyXG4gIERPTUV2ZW50LFxyXG4gIENvbHVtbixcclxuICBDb2x1bW5FZGl0b3IsXHJcbiAgQ29sdW1uRWRpdG9yRHVhbElucHV0LFxyXG4gIEVkaXRvcixcclxuICBFZGl0b3JBcmd1bWVudHMsXHJcbiAgRWRpdG9yVmFsaWRhdG9yLFxyXG4gIEVkaXRvclZhbGlkYXRvck91dHB1dCxcclxuICBHcmlkT3B0aW9uLFxyXG4gIEtleUNvZGUsXHJcbiAgU2xpY2tFdmVudEhhbmRsZXIsXHJcbn0gZnJvbSAnLi4vbW9kZWxzL2luZGV4JztcclxuaW1wb3J0IHsgQmluZGluZ0V2ZW50U2VydmljZSB9IGZyb20gJy4uL3NlcnZpY2VzL2JpbmRpbmdFdmVudC5zZXJ2aWNlJztcclxuaW1wb3J0IHsgZ2V0RGVzY2VuZGFudFByb3BlcnR5LCBzZXREZWVwVmFsdWUgfSBmcm9tICcuLi9zZXJ2aWNlcy91dGlsaXRpZXMnO1xyXG5pbXBvcnQgeyBmbG9hdFZhbGlkYXRvciwgaW50ZWdlclZhbGlkYXRvciwgdGV4dFZhbGlkYXRvciB9IGZyb20gJy4uL2VkaXRvclZhbGlkYXRvcnMnO1xyXG5cclxuLy8gdXNpbmcgZXh0ZXJuYWwgbm9uLXR5cGVkIGpzIGxpYnJhcmllc1xyXG5kZWNsYXJlIGNvbnN0IFNsaWNrOiBhbnk7XHJcblxyXG4vKlxyXG4gKiBBbiBleGFtcGxlIG9mIGEgJ2RldGFjaGVkJyBlZGl0b3IuXHJcbiAqIEtleURvd24gZXZlbnRzIGFyZSBhbHNvIGhhbmRsZWQgdG8gcHJvdmlkZSBoYW5kbGluZyBmb3IgVGFiLCBTaGlmdC1UYWIsIEVzYyBhbmQgQ3RybC1FbnRlci5cclxuICovXHJcbmV4cG9ydCBjbGFzcyBEdWFsSW5wdXRFZGl0b3IgaW1wbGVtZW50cyBFZGl0b3Ige1xyXG4gIHByaXZhdGUgX2JpbmRFdmVudFNlcnZpY2U6IEJpbmRpbmdFdmVudFNlcnZpY2U7XHJcbiAgcHJpdmF0ZSBfZXZlbnRIYW5kbGVyOiBTbGlja0V2ZW50SGFuZGxlcjtcclxuICBwcml2YXRlIF9pc1ZhbHVlU2F2ZUNhbGxlZCA9IGZhbHNlO1xyXG4gIHByaXZhdGUgX2xhc3RFdmVudFR5cGU6IHN0cmluZyB8IHVuZGVmaW5lZDtcclxuICBwcml2YXRlIF9sYXN0SW5wdXRLZXlFdmVudDogSlF1ZXJ5LkV2ZW50O1xyXG4gIHByaXZhdGUgX2xlZnRJbnB1dDogSFRNTElucHV0RWxlbWVudDtcclxuICBwcml2YXRlIF9yaWdodElucHV0OiBIVE1MSW5wdXRFbGVtZW50O1xyXG4gIHByaXZhdGUgX2xlZnRGaWVsZE5hbWU6IHN0cmluZztcclxuICBwcml2YXRlIF9yaWdodEZpZWxkTmFtZTogc3RyaW5nO1xyXG4gIG9yaWdpbmFsTGVmdFZhbHVlOiBzdHJpbmcgfCBudW1iZXI7XHJcbiAgb3JpZ2luYWxSaWdodFZhbHVlOiBzdHJpbmcgfCBudW1iZXI7XHJcblxyXG4gIC8qKiBTbGlja0dyaWQgR3JpZCBvYmplY3QgKi9cclxuICBncmlkOiBhbnk7XHJcblxyXG4gIC8qKiBHcmlkIG9wdGlvbnMgKi9cclxuICBncmlkT3B0aW9uczogR3JpZE9wdGlvbjtcclxuXHJcbiAgY29uc3RydWN0b3IocHJpdmF0ZSBhcmdzOiBFZGl0b3JBcmd1bWVudHMpIHtcclxuICAgIGlmICghYXJncykge1xyXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ1tBbmd1bGFyLVNsaWNrZ3JpZF0gU29tZXRoaW5nIGlzIHdyb25nIHdpdGggdGhpcyBncmlkLCBhbiBFZGl0b3IgbXVzdCBhbHdheXMgaGF2ZSB2YWxpZCBhcmd1bWVudHMuJyk7XHJcbiAgICB9XHJcbiAgICB0aGlzLmdyaWQgPSBhcmdzLmdyaWQ7XHJcbiAgICB0aGlzLmdyaWRPcHRpb25zID0gKHRoaXMuZ3JpZC5nZXRPcHRpb25zKCkgfHwge30pIGFzIEdyaWRPcHRpb247XHJcbiAgICB0aGlzLl9ldmVudEhhbmRsZXIgPSBuZXcgU2xpY2suRXZlbnRIYW5kbGVyKCk7XHJcbiAgICB0aGlzLl9iaW5kRXZlbnRTZXJ2aWNlID0gbmV3IEJpbmRpbmdFdmVudFNlcnZpY2UoKTtcclxuICAgIHRoaXMuaW5pdCgpO1xyXG4gICAgdGhpcy5fZXZlbnRIYW5kbGVyLnN1YnNjcmliZSh0aGlzLmdyaWQub25WYWxpZGF0aW9uRXJyb3IsICgpID0+IHRoaXMuX2lzVmFsdWVTYXZlQ2FsbGVkID0gdHJ1ZSk7XHJcbiAgfVxyXG5cclxuICAvKiogR2V0IENvbHVtbiBEZWZpbml0aW9uIG9iamVjdCAqL1xyXG4gIGdldCBjb2x1bW5EZWYoKTogQ29sdW1uIHwgdW5kZWZpbmVkIHtcclxuICAgIHJldHVybiB0aGlzLmFyZ3MgJiYgdGhpcy5hcmdzLmNvbHVtbjtcclxuICB9XHJcblxyXG4gIC8qKiBHZXQgQ29sdW1uIEVkaXRvciBvYmplY3QgKi9cclxuICBnZXQgY29sdW1uRWRpdG9yKCk6IENvbHVtbkVkaXRvciB7XHJcbiAgICByZXR1cm4gdGhpcy5jb2x1bW5EZWYgJiYgdGhpcy5jb2x1bW5EZWYuaW50ZXJuYWxDb2x1bW5FZGl0b3IgfHwge307XHJcbiAgfVxyXG5cclxuICAvKiogR2V0IHRoZSBFZGl0b3IgRE9NIEVsZW1lbnQgKi9cclxuICBnZXQgZWRpdG9yRG9tRWxlbWVudCgpOiB7IGxlZnRJbnB1dDogSFRNTElucHV0RWxlbWVudCwgcmlnaHRJbnB1dDogSFRNTElucHV0RWxlbWVudCB9IHtcclxuICAgIHJldHVybiB7IGxlZnRJbnB1dDogdGhpcy5fbGVmdElucHV0LCByaWdodElucHV0OiB0aGlzLl9yaWdodElucHV0IH07XHJcbiAgfVxyXG5cclxuICBnZXQgZWRpdG9yUGFyYW1zKCk6IENvbHVtbkVkaXRvckR1YWxJbnB1dCB7XHJcbiAgICByZXR1cm4gdGhpcy5jb2x1bW5FZGl0b3IucGFyYW1zIHx8IHt9O1xyXG4gIH1cclxuXHJcbiAgZ2V0IGV2ZW50SGFuZGxlcigpOiBTbGlja0V2ZW50SGFuZGxlciB7XHJcbiAgICByZXR1cm4gdGhpcy5fZXZlbnRIYW5kbGVyO1xyXG4gIH1cclxuXHJcbiAgZ2V0IGhhc0F1dG9Db21taXRFZGl0KCkge1xyXG4gICAgcmV0dXJuIHRoaXMuZ3JpZC5nZXRPcHRpb25zKCkuYXV0b0NvbW1pdEVkaXQ7XHJcbiAgfVxyXG5cclxuICBnZXQgaXNWYWx1ZVNhdmVDYWxsZWQoKTogYm9vbGVhbiB7XHJcbiAgICByZXR1cm4gdGhpcy5faXNWYWx1ZVNhdmVDYWxsZWQ7XHJcbiAgfVxyXG5cclxuICAvKiogR2V0IHRoZSBTaGFyZWQgVmFsaWRhdG9yIGZ1bmN0aW9uLCBjYW4gYmUgcGFzc2VkIGluIEVkaXRvciBwcm9wZXJ0eSBvciBDb2x1bW4gRGVmaW5pdGlvbiAqL1xyXG4gIGdldCB2YWxpZGF0b3IoKTogRWRpdG9yVmFsaWRhdG9yIHwgdW5kZWZpbmVkIHtcclxuICAgIHJldHVybiAodGhpcy5jb2x1bW5FZGl0b3IgJiYgdGhpcy5jb2x1bW5FZGl0b3IudmFsaWRhdG9yKSB8fCAodGhpcy5jb2x1bW5EZWYgJiYgdGhpcy5jb2x1bW5EZWYudmFsaWRhdG9yKTtcclxuICB9XHJcblxyXG4gIGluaXQoKSB7XHJcbiAgICBpZiAoIXRoaXMuZWRpdG9yUGFyYW1zIHx8ICF0aGlzLmVkaXRvclBhcmFtcy5sZWZ0SW5wdXQgfHwgIXRoaXMuZWRpdG9yUGFyYW1zLmxlZnRJbnB1dC5maWVsZCB8fCAhdGhpcy5lZGl0b3JQYXJhbXMucmlnaHRJbnB1dCB8fCAhdGhpcy5lZGl0b3JQYXJhbXMucmlnaHRJbnB1dC5maWVsZCkge1xyXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYFtBbmd1bGFyLVNsaWNrZ3JpZF0gUGxlYXNlIG1ha2Ugc3VyZSB0aGF0IHlvdXIgQ29tYm8gSW5wdXQgRWRpdG9yIGhhcyBwYXJhbXMgZGVmaW5lZCB3aXRoIFwibGVmdElucHV0XCIgYW5kIFwicmlnaHRJbnB1dFwiIChleGFtcGxlOiB7IGVkaXRvcjogeyBtb2RlbDogRWRpdG9ycy5jb21ib0lucHV0LCBwYXJhbXM6IHsgbGVmdElucHV0OiB7IGZpZWxkOiAnZmlyc3ROYW1lJyB9LCB7IHJpZ2h0U2lkZTogeyBmaWVsZDogJ2xhc3ROYW1lJyB9IH19fWApO1xyXG4gICAgfVxyXG4gICAgdGhpcy5fbGVmdEZpZWxkTmFtZSA9IHRoaXMuZWRpdG9yUGFyYW1zICYmIHRoaXMuZWRpdG9yUGFyYW1zLmxlZnRJbnB1dCAmJiB0aGlzLmVkaXRvclBhcmFtcy5sZWZ0SW5wdXQuZmllbGQ7XHJcbiAgICB0aGlzLl9yaWdodEZpZWxkTmFtZSA9IHRoaXMuZWRpdG9yUGFyYW1zICYmIHRoaXMuZWRpdG9yUGFyYW1zLnJpZ2h0SW5wdXQgJiYgdGhpcy5lZGl0b3JQYXJhbXMucmlnaHRJbnB1dC5maWVsZDtcclxuICAgIHRoaXMuX2xlZnRJbnB1dCA9IHRoaXMuY3JlYXRlSW5wdXQoJ2xlZnRJbnB1dCcpO1xyXG4gICAgdGhpcy5fcmlnaHRJbnB1dCA9IHRoaXMuY3JlYXRlSW5wdXQoJ3JpZ2h0SW5wdXQnKTtcclxuXHJcbiAgICBjb25zdCBjb250YWluZXJFbG0gPSB0aGlzLmFyZ3MuY29udGFpbmVyO1xyXG4gICAgaWYgKGNvbnRhaW5lckVsbSAmJiB0eXBlb2YgY29udGFpbmVyRWxtLmFwcGVuZENoaWxkID09PSAnZnVuY3Rpb24nKSB7XHJcbiAgICAgIGNvbnRhaW5lckVsbS5hcHBlbmRDaGlsZCh0aGlzLl9sZWZ0SW5wdXQpO1xyXG4gICAgICBjb250YWluZXJFbG0uYXBwZW5kQ2hpbGQodGhpcy5fcmlnaHRJbnB1dCk7XHJcbiAgICB9XHJcblxyXG4gICAgdGhpcy5fbGVmdElucHV0Lm9ua2V5ZG93biA9IHRoaXMuaGFuZGxlS2V5RG93bi5iaW5kKHRoaXMpO1xyXG4gICAgdGhpcy5fcmlnaHRJbnB1dC5vbmtleWRvd24gPSB0aGlzLmhhbmRsZUtleURvd24uYmluZCh0aGlzKTtcclxuXHJcbiAgICAvLyB0aGUgbGliIGRvZXMgbm90IGdldCB0aGUgZm9jdXMgb3V0IGV2ZW50IGZvciBzb21lIHJlYXNvbiwgc28gcmVnaXN0ZXIgaXQgaGVyZVxyXG4gICAgaWYgKHRoaXMuaGFzQXV0b0NvbW1pdEVkaXQpIHtcclxuICAgICAgdGhpcy5fYmluZEV2ZW50U2VydmljZS5iaW5kKHRoaXMuX2xlZnRJbnB1dCwgJ2ZvY3Vzb3V0JywgKGV2ZW50OiBET01FdmVudDxIVE1MSW5wdXRFbGVtZW50PikgPT4gdGhpcy5oYW5kbGVGb2N1c091dChldmVudCwgJ2xlZnRJbnB1dCcpKTtcclxuICAgICAgdGhpcy5fYmluZEV2ZW50U2VydmljZS5iaW5kKHRoaXMuX3JpZ2h0SW5wdXQsICdmb2N1c291dCcsIChldmVudDogRE9NRXZlbnQ8SFRNTElucHV0RWxlbWVudD4pID0+IHRoaXMuaGFuZGxlRm9jdXNPdXQoZXZlbnQsICdyaWdodElucHV0JykpO1xyXG4gICAgfVxyXG5cclxuICAgIHNldFRpbWVvdXQoKCkgPT4gdGhpcy5fbGVmdElucHV0LnNlbGVjdCgpLCA1MCk7XHJcbiAgfVxyXG5cclxuICBoYW5kbGVGb2N1c091dChldmVudDogRE9NRXZlbnQ8SFRNTElucHV0RWxlbWVudD4sIHBvc2l0aW9uOiAnbGVmdElucHV0JyB8ICdyaWdodElucHV0Jykge1xyXG4gICAgLy8gd2hlbiBjbGlja2luZyBvdXRzaWRlIHRoZSBlZGl0YWJsZSBjZWxsIE9SIHdoZW4gZm9jdXNpbmcgb3V0IG9mIGl0XHJcbiAgICBjb25zdCB0YXJnZXRDbGFzc05hbWVzID0gZXZlbnQucmVsYXRlZFRhcmdldCAmJiBldmVudC5yZWxhdGVkVGFyZ2V0LmNsYXNzTmFtZSB8fCAnJztcclxuICAgIGlmICh0YXJnZXRDbGFzc05hbWVzLmluZGV4T2YoJ2R1YWwtZWRpdG9yJykgPT09IC0xICYmIHRoaXMuX2xhc3RFdmVudFR5cGUgIT09ICdmb2N1c291dC1yaWdodCcpIHtcclxuICAgICAgaWYgKHBvc2l0aW9uID09PSAncmlnaHRJbnB1dCcgfHwgKHBvc2l0aW9uID09PSAnbGVmdElucHV0JyAmJiB0aGlzLl9sYXN0RXZlbnRUeXBlICE9PSAnZm9jdXNvdXQtbGVmdCcpKSB7XHJcbiAgICAgICAgdGhpcy5zYXZlKCk7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICAgIGNvbnN0IHNpZGUgPSAocG9zaXRpb24gPT09ICdsZWZ0SW5wdXQnKSA/ICdsZWZ0JyA6ICdyaWdodCc7XHJcbiAgICB0aGlzLl9sYXN0RXZlbnRUeXBlID0gYCR7ZXZlbnQgJiYgZXZlbnQudHlwZX0tJHtzaWRlfWA7XHJcbiAgfVxyXG5cclxuICBoYW5kbGVLZXlEb3duKGV2ZW50OiBKUXVlcnkuRXZlbnQpIHtcclxuICAgIHRoaXMuX2xhc3RJbnB1dEtleUV2ZW50ID0gZXZlbnQ7XHJcbiAgICBpZiAoZXZlbnQua2V5Q29kZSA9PT0gS2V5Q29kZS5MRUZUIHx8IGV2ZW50LmtleUNvZGUgPT09IEtleUNvZGUuUklHSFQgfHwgZXZlbnQua2V5Q29kZSA9PT0gS2V5Q29kZS5UQUIpIHtcclxuICAgICAgZXZlbnQuc3RvcEltbWVkaWF0ZVByb3BhZ2F0aW9uKCk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBkZXN0cm95KCkge1xyXG4gICAgLy8gdW5zdWJzY3JpYmUgYWxsIFNsaWNrR3JpZCBldmVudHNcclxuICAgIHRoaXMuX2V2ZW50SGFuZGxlci51bnN1YnNjcmliZUFsbCgpO1xyXG4gICAgdGhpcy5fYmluZEV2ZW50U2VydmljZS51bmJpbmRBbGwoKTtcclxuICB9XHJcblxyXG4gIGNyZWF0ZUlucHV0KHBvc2l0aW9uOiAnbGVmdElucHV0JyB8ICdyaWdodElucHV0Jyk6IEhUTUxJbnB1dEVsZW1lbnQge1xyXG4gICAgY29uc3QgZWRpdG9yU2lkZVBhcmFtcyA9IHRoaXMuZWRpdG9yUGFyYW1zW3Bvc2l0aW9uXTtcclxuICAgIGNvbnN0IGNvbHVtbklkID0gdGhpcy5jb2x1bW5EZWYgJiYgdGhpcy5jb2x1bW5EZWYuaWQ7XHJcbiAgICBjb25zdCBpZFByb3BOYW1lID0gdGhpcy5ncmlkT3B0aW9ucy5kYXRhc2V0SWRQcm9wZXJ0eU5hbWUgfHwgJ2lkJztcclxuICAgIGNvbnN0IGl0ZW1JZCA9IHRoaXMuYXJncyAmJiB0aGlzLmFyZ3MuaXRlbSAmJiB0aGlzLmFyZ3MuaXRlbVtpZFByb3BOYW1lXSB8fCAwO1xyXG5cclxuICAgIGxldCBmaWVsZFR5cGU6IHN0cmluZyA9IGVkaXRvclNpZGVQYXJhbXMudHlwZSB8fCAndGV4dCc7XHJcbiAgICBpZiAoZmllbGRUeXBlID09PSAnZmxvYXQnIHx8IGZpZWxkVHlwZSA9PT0gJ2ludGVnZXInKSB7XHJcbiAgICAgIGZpZWxkVHlwZSA9ICdudW1iZXInO1xyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IGlucHV0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnaW5wdXQnKSBhcyBIVE1MSW5wdXRFbGVtZW50O1xyXG4gICAgaW5wdXQuaWQgPSBgaXRlbS0ke2l0ZW1JZH0tJHtwb3NpdGlvbn1gO1xyXG4gICAgaW5wdXQuY2xhc3NOYW1lID0gYGR1YWwtZWRpdG9yLXRleHQgZWRpdG9yLSR7Y29sdW1uSWR9ICR7cG9zaXRpb24ucmVwbGFjZSgvaW5wdXQvZ2ksICcnKX1gO1xyXG4gICAgaWYgKGZpZWxkVHlwZSA9PT0gJ3JlYWRvbmx5Jykge1xyXG4gICAgICAvLyB3aGVuIHRoZSBjdXN0b20gdHlwZSBpcyBkZWZpbmVkIGFzIHJlYWRvbmx5LCB3ZSdsbCBtYWtlIGEgcmVhZG9ubHkgdGV4dCBpbnB1dFxyXG4gICAgICBpbnB1dC5yZWFkT25seSA9IHRydWU7XHJcbiAgICAgIGZpZWxkVHlwZSA9ICd0ZXh0JztcclxuICAgIH1cclxuICAgIGlucHV0LnR5cGUgPSBmaWVsZFR5cGUgfHwgJ3RleHQnO1xyXG4gICAgaW5wdXQuc2V0QXR0cmlidXRlKCdyb2xlJywgJ3ByZXNlbnRhdGlvbicpO1xyXG4gICAgaW5wdXQuYXV0b2NvbXBsZXRlID0gJ29mZic7XHJcbiAgICBpbnB1dC5wbGFjZWhvbGRlciA9IGVkaXRvclNpZGVQYXJhbXMucGxhY2Vob2xkZXIgfHwgJyc7XHJcbiAgICBpbnB1dC50aXRsZSA9IGVkaXRvclNpZGVQYXJhbXMudGl0bGUgfHwgJyc7XHJcbiAgICBpZiAoZmllbGRUeXBlID09PSAnbnVtYmVyJykge1xyXG4gICAgICBpbnB1dC5zdGVwID0gdGhpcy5nZXRJbnB1dERlY2ltYWxTdGVwcyhwb3NpdGlvbik7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gaW5wdXQ7XHJcbiAgfVxyXG5cclxuICBmb2N1cygpIHtcclxuICAgIC8vIGRvIG5vdGhpbmcgc2luY2Ugd2UgaGF2ZSAyIGlucHV0cyBhbmQgd2UgbWlnaHQgZm9jdXMgb24gbGVmdC9yaWdodCBkZXBlbmRpbmcgb24gd2hpY2ggaXMgaW52YWxpZCBhbmQvb3IgbmV3XHJcbiAgfVxyXG5cclxuICBnZXRWYWx1ZXMoKTogeyBbZmllbGROYW1lOiBzdHJpbmddOiBzdHJpbmcgfCBudW1iZXIgfSB7XHJcbiAgICBjb25zdCBvYmogPSB7fTtcclxuICAgIGNvbnN0IGxlZnRJbnB1dFZhbHVlID0gdGhpcy5fbGVmdElucHV0LnZhbHVlO1xyXG4gICAgY29uc3QgcmlnaHRJbnB1dFZhbHVlID0gdGhpcy5fcmlnaHRJbnB1dC52YWx1ZTtcclxuICAgIGNvbnN0IGlzTGVmdElucHV0VHlwZU51bWJlciA9ICh0aGlzLmVkaXRvclBhcmFtcy5sZWZ0SW5wdXQgJiYgKHRoaXMuZWRpdG9yUGFyYW1zLmxlZnRJbnB1dC50eXBlID09PSAnZmxvYXQnIHx8IHRoaXMuZWRpdG9yUGFyYW1zLmxlZnRJbnB1dC50eXBlID09PSAnaW50ZWdlcicpKTtcclxuICAgIGNvbnN0IGlzUmlnaHRJbnB1dFR5cGVOdW1iZXIgPSAodGhpcy5lZGl0b3JQYXJhbXMucmlnaHRJbnB1dCAmJiAodGhpcy5lZGl0b3JQYXJhbXMucmlnaHRJbnB1dC50eXBlID09PSAnZmxvYXQnIHx8IHRoaXMuZWRpdG9yUGFyYW1zLnJpZ2h0SW5wdXQudHlwZSA9PT0gJ2ludGVnZXInKSk7XHJcbiAgICBjb25zdCByZXN1bHRMZWZ0VmFsdWUgPSAobGVmdElucHV0VmFsdWUgIT09ICcnICYmIGlzTGVmdElucHV0VHlwZU51bWJlcikgPyArdGhpcy5fbGVmdElucHV0LnZhbHVlIDogKGxlZnRJbnB1dFZhbHVlIHx8ICcnKTtcclxuICAgIGNvbnN0IHJlc3VsdFJpZ2h0VmFsdWUgPSAocmlnaHRJbnB1dFZhbHVlICE9PSAnJyAmJiBpc1JpZ2h0SW5wdXRUeXBlTnVtYmVyKSA/ICt0aGlzLl9yaWdodElucHV0LnZhbHVlIDogKHJpZ2h0SW5wdXRWYWx1ZSB8fCAnJyk7XHJcbiAgICBzZXREZWVwVmFsdWUob2JqLCB0aGlzLl9sZWZ0RmllbGROYW1lLCByZXN1bHRMZWZ0VmFsdWUpO1xyXG4gICAgc2V0RGVlcFZhbHVlKG9iaiwgdGhpcy5fcmlnaHRGaWVsZE5hbWUsIHJlc3VsdFJpZ2h0VmFsdWUpO1xyXG5cclxuICAgIHJldHVybiBvYmo7XHJcbiAgfVxyXG5cclxuICBzZXRWYWx1ZXModmFsdWVzOiBBcnJheTxudW1iZXIgfCBzdHJpbmc+KSB7XHJcbiAgICBpZiAoQXJyYXkuaXNBcnJheSh2YWx1ZXMpICYmIHZhbHVlcy5sZW5ndGggPT09IDIpIHtcclxuICAgICAgdGhpcy5fbGVmdElucHV0LnZhbHVlID0gYCR7dmFsdWVzWzBdfWA7XHJcbiAgICAgIHRoaXMuX3JpZ2h0SW5wdXQudmFsdWUgPSBgJHt2YWx1ZXNbMV19YDtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIGFwcGx5VmFsdWUoaXRlbTogYW55LCBzdGF0ZTogYW55KSB7XHJcbiAgICB0aGlzLmFwcGx5VmFsdWVCeVBvc2l0aW9uKGl0ZW0sIHN0YXRlLCAnbGVmdElucHV0Jyk7XHJcbiAgICB0aGlzLmFwcGx5VmFsdWVCeVBvc2l0aW9uKGl0ZW0sIHN0YXRlLCAncmlnaHRJbnB1dCcpO1xyXG4gIH1cclxuXHJcbiAgYXBwbHlWYWx1ZUJ5UG9zaXRpb24oaXRlbTogYW55LCBzdGF0ZTogYW55LCBwb3NpdGlvbjogJ2xlZnRJbnB1dCcgfCAncmlnaHRJbnB1dCcpIHtcclxuICAgIGNvbnN0IGZpZWxkTmFtZSA9IHBvc2l0aW9uID09PSAnbGVmdElucHV0JyA/IHRoaXMuX2xlZnRGaWVsZE5hbWUgOiB0aGlzLl9yaWdodEZpZWxkTmFtZTtcclxuICAgIGlmIChmaWVsZE5hbWUgIT09IHVuZGVmaW5lZCkge1xyXG4gICAgICBjb25zdCBpc0NvbXBsZXhPYmplY3QgPSBmaWVsZE5hbWUgJiYgZmllbGROYW1lLmluZGV4T2YoJy4nKSA+IDA7IC8vIGlzIHRoZSBmaWVsZCBhIGNvbXBsZXggb2JqZWN0LCBcImFkZHJlc3Muc3RyZWV0TnVtYmVyXCJcclxuXHJcbiAgICAgIGxldCBmaWVsZE5hbWVUb1VzZSA9IGZpZWxkTmFtZTtcclxuICAgICAgaWYgKGlzQ29tcGxleE9iamVjdCkge1xyXG4gICAgICAgIGNvbnN0IGNvbXBsZXhGaWVsZE5hbWVzID0gZmllbGROYW1lLnNwbGl0KC9cXC4oLiopLyk7XHJcbiAgICAgICAgZmllbGROYW1lVG9Vc2UgPSAoY29tcGxleEZpZWxkTmFtZXMubGVuZ3RoID4gMSA/IGNvbXBsZXhGaWVsZE5hbWVzWzFdIDogY29tcGxleEZpZWxkTmFtZXMpIGFzIHN0cmluZztcclxuICAgICAgfVxyXG5cclxuICAgICAgLy8gdmFsaWRhdGUgdGhlIHZhbHVlIGJlZm9yZSBhcHBseWluZyBpdCAoaWYgbm90IHZhbGlkIHdlJ2xsIHNldCBhbiBlbXB0eSBzdHJpbmcpXHJcbiAgICAgIGNvbnN0IHN0YXRlVmFsdWUgPSBpc0NvbXBsZXhPYmplY3QgPyBnZXREZXNjZW5kYW50UHJvcGVydHkoc3RhdGUsIGZpZWxkTmFtZVRvVXNlKSA6IHN0YXRlW2ZpZWxkTmFtZV07XHJcbiAgICAgIGNvbnN0IHZhbGlkYXRpb24gPSB0aGlzLnZhbGlkYXRlKHsgcG9zaXRpb24sIGlucHV0VmFsdWU6IHN0YXRlVmFsdWUgfSk7XHJcblxyXG4gICAgICAvLyBzZXQgdGhlIG5ldyB2YWx1ZSB0byB0aGUgaXRlbSBkYXRhY29udGV4dFxyXG4gICAgICBpZiAoaXNDb21wbGV4T2JqZWN0KSB7XHJcbiAgICAgICAgY29uc3QgbmV3VmFsdWVGcm9tQ29tcGxleCA9IGdldERlc2NlbmRhbnRQcm9wZXJ0eShzdGF0ZSwgZmllbGROYW1lVG9Vc2UpO1xyXG4gICAgICAgIGNvbnN0IG5ld1ZhbHVlID0gKHZhbGlkYXRpb24gJiYgdmFsaWRhdGlvbi52YWxpZCkgPyBuZXdWYWx1ZUZyb21Db21wbGV4IDogJyc7XHJcbiAgICAgICAgc2V0RGVlcFZhbHVlKGl0ZW0sIGZpZWxkTmFtZSwgbmV3VmFsdWUpO1xyXG4gICAgICB9IGVsc2UgaWYgKGZpZWxkTmFtZSkge1xyXG4gICAgICAgIGl0ZW1bZmllbGROYW1lXSA9ICh2YWxpZGF0aW9uICYmIHZhbGlkYXRpb24udmFsaWQpID8gc3RhdGVbZmllbGROYW1lXSA6ICcnO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBpc1ZhbHVlQ2hhbmdlZCgpOiBib29sZWFuIHtcclxuICAgIGNvbnN0IGxlZnRFbG1WYWx1ZSA9IHRoaXMuX2xlZnRJbnB1dC52YWx1ZTtcclxuICAgIGNvbnN0IHJpZ2h0RWxtVmFsdWUgPSB0aGlzLl9yaWdodElucHV0LnZhbHVlO1xyXG4gICAgY29uc3QgbGVmdEVkaXRvclBhcmFtcyA9IHRoaXMuZWRpdG9yUGFyYW1zICYmIHRoaXMuZWRpdG9yUGFyYW1zLmxlZnRJbnB1dDtcclxuICAgIGNvbnN0IHJpZ2h0RWRpdG9yUGFyYW1zID0gdGhpcy5lZGl0b3JQYXJhbXMgJiYgdGhpcy5lZGl0b3JQYXJhbXMucmlnaHRJbnB1dDtcclxuICAgIGNvbnN0IGxhc3RLZXlFdmVudCA9IHRoaXMuX2xhc3RJbnB1dEtleUV2ZW50ICYmIHRoaXMuX2xhc3RJbnB1dEtleUV2ZW50LmtleUNvZGU7XHJcbiAgICBpZiAoKGxlZnRFZGl0b3JQYXJhbXMgJiYgbGVmdEVkaXRvclBhcmFtcy5hbHdheXNTYXZlT25FbnRlcktleSB8fCByaWdodEVkaXRvclBhcmFtcyAmJiByaWdodEVkaXRvclBhcmFtcy5hbHdheXNTYXZlT25FbnRlcktleSkgJiYgbGFzdEtleUV2ZW50ID09PSBLZXlDb2RlLkVOVEVSKSB7XHJcbiAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgfVxyXG4gICAgY29uc3QgbGVmdFJlc3VsdCA9ICghKGxlZnRFbG1WYWx1ZSA9PT0gJycgJiYgKHRoaXMub3JpZ2luYWxMZWZ0VmFsdWUgPT09IG51bGwgfHwgdGhpcy5vcmlnaW5hbExlZnRWYWx1ZSA9PT0gdW5kZWZpbmVkKSkpICYmIChsZWZ0RWxtVmFsdWUgIT09IHRoaXMub3JpZ2luYWxMZWZ0VmFsdWUpO1xyXG4gICAgY29uc3QgcmlnaHRSZXN1bHQgPSAoIShyaWdodEVsbVZhbHVlID09PSAnJyAmJiAodGhpcy5vcmlnaW5hbFJpZ2h0VmFsdWUgPT09IG51bGwgfHwgdGhpcy5vcmlnaW5hbFJpZ2h0VmFsdWUgPT09IHVuZGVmaW5lZCkpKSAmJiAocmlnaHRFbG1WYWx1ZSAhPT0gdGhpcy5vcmlnaW5hbFJpZ2h0VmFsdWUpO1xyXG4gICAgcmV0dXJuIGxlZnRSZXN1bHQgfHwgcmlnaHRSZXN1bHQ7XHJcbiAgfVxyXG5cclxuICBsb2FkVmFsdWUoaXRlbTogYW55KSB7XHJcbiAgICB0aGlzLmxvYWRWYWx1ZUJ5UG9zaXRpb24oaXRlbSwgJ2xlZnRJbnB1dCcpO1xyXG4gICAgdGhpcy5sb2FkVmFsdWVCeVBvc2l0aW9uKGl0ZW0sICdyaWdodElucHV0Jyk7XHJcbiAgICB0aGlzLl9sZWZ0SW5wdXQuc2VsZWN0KCk7XHJcbiAgfVxyXG5cclxuICBsb2FkVmFsdWVCeVBvc2l0aW9uKGl0ZW06IGFueSwgcG9zaXRpb246ICdsZWZ0SW5wdXQnIHwgJ3JpZ2h0SW5wdXQnKSB7XHJcbiAgICAvLyBpcyB0aGUgZmllbGQgYSBjb21wbGV4IG9iamVjdCwgXCJhZGRyZXNzLnN0cmVldE51bWJlclwiXHJcbiAgICBjb25zdCBmaWVsZE5hbWUgPSAocG9zaXRpb24gPT09ICdsZWZ0SW5wdXQnKSA/IHRoaXMuX2xlZnRGaWVsZE5hbWUgOiB0aGlzLl9yaWdodEZpZWxkTmFtZTtcclxuICAgIGNvbnN0IG9yaWdpbmFsVmFsdWVQb3NpdGlvbiA9IChwb3NpdGlvbiA9PT0gJ2xlZnRJbnB1dCcpID8gJ29yaWdpbmFsTGVmdFZhbHVlJyA6ICdvcmlnaW5hbFJpZ2h0VmFsdWUnO1xyXG4gICAgY29uc3QgaW5wdXRWYXJQb3NpdGlvbiA9IChwb3NpdGlvbiA9PT0gJ2xlZnRJbnB1dCcpID8gJ19sZWZ0SW5wdXQnIDogJ19yaWdodElucHV0JztcclxuXHJcbiAgICBpZiAoaXRlbSAmJiBmaWVsZE5hbWUgIT09IHVuZGVmaW5lZCkge1xyXG4gICAgICBjb25zdCBpc0NvbXBsZXhPYmplY3QgPSBmaWVsZE5hbWUgJiYgZmllbGROYW1lLmluZGV4T2YoJy4nKSA+IDA7XHJcbiAgICAgIGNvbnN0IGl0ZW1WYWx1ZSA9IChpc0NvbXBsZXhPYmplY3QpID8gZ2V0RGVzY2VuZGFudFByb3BlcnR5KGl0ZW0sIGZpZWxkTmFtZSkgOiAoaXRlbS5oYXNPd25Qcm9wZXJ0eShmaWVsZE5hbWUpID8gaXRlbVtmaWVsZE5hbWVdIDogJycpO1xyXG4gICAgICB0aGlzW29yaWdpbmFsVmFsdWVQb3NpdGlvbl0gPSBpdGVtVmFsdWU7XHJcbiAgICAgIGlmICh0aGlzLmVkaXRvclBhcmFtc1twb3NpdGlvbl0udHlwZSA9PT0gJ2Zsb2F0Jykge1xyXG4gICAgICAgIGNvbnN0IGRlY2ltYWxQbGFjZXMgPSB0aGlzLmdldERlY2ltYWxQbGFjZXMocG9zaXRpb24pO1xyXG4gICAgICAgIGlmIChkZWNpbWFsUGxhY2VzICE9PSBudWxsICYmICh0aGlzW29yaWdpbmFsVmFsdWVQb3NpdGlvbl0gfHwgdGhpc1tvcmlnaW5hbFZhbHVlUG9zaXRpb25dID09PSAwKSAmJiAoK3RoaXNbb3JpZ2luYWxWYWx1ZVBvc2l0aW9uXSkudG9GaXhlZCkge1xyXG4gICAgICAgICAgdGhpc1tvcmlnaW5hbFZhbHVlUG9zaXRpb25dID0gKCt0aGlzW29yaWdpbmFsVmFsdWVQb3NpdGlvbl0pLnRvRml4ZWQoZGVjaW1hbFBsYWNlcyk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICAgIGlmICh0aGlzW2lucHV0VmFyUG9zaXRpb25dKSB7XHJcbiAgICAgICAgY29uc3Qgb3JpZ2luYWxWYWx1ZSA9IHRoaXNbb3JpZ2luYWxWYWx1ZVBvc2l0aW9uXTtcclxuICAgICAgICB0aGlzW2lucHV0VmFyUG9zaXRpb25dLnZhbHVlID0gYCR7b3JpZ2luYWxWYWx1ZX1gO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBzYXZlKCkge1xyXG4gICAgY29uc3QgdmFsaWRhdGlvbiA9IHRoaXMudmFsaWRhdGUoKTtcclxuICAgIGNvbnN0IGlzVmFsaWQgPSAodmFsaWRhdGlvbiAmJiB2YWxpZGF0aW9uLnZhbGlkKSB8fCBmYWxzZTtcclxuXHJcbiAgICBpZiAoIXRoaXMuX2lzVmFsdWVTYXZlQ2FsbGVkKSB7XHJcbiAgICAgIGlmICh0aGlzLmhhc0F1dG9Db21taXRFZGl0ICYmIGlzVmFsaWQpIHtcclxuICAgICAgICB0aGlzLmdyaWQuZ2V0RWRpdG9yTG9jaygpLmNvbW1pdEN1cnJlbnRFZGl0KCk7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgdGhpcy5hcmdzLmNvbW1pdENoYW5nZXMoKTtcclxuICAgICAgfVxyXG4gICAgICB0aGlzLl9pc1ZhbHVlU2F2ZUNhbGxlZCA9IHRydWU7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBzZXJpYWxpemVWYWx1ZSgpIHtcclxuICAgIGNvbnN0IG9iaiA9IHt9O1xyXG4gICAgY29uc3QgbGVmdFZhbHVlID0gdGhpcy5zZXJpYWxpemVWYWx1ZUJ5UG9zaXRpb24oJ2xlZnRJbnB1dCcpO1xyXG4gICAgY29uc3QgcmlnaHRWYWx1ZSA9IHRoaXMuc2VyaWFsaXplVmFsdWVCeVBvc2l0aW9uKCdyaWdodElucHV0Jyk7XHJcblxyXG4gICAgc2V0RGVlcFZhbHVlKG9iaiwgdGhpcy5fbGVmdEZpZWxkTmFtZSwgbGVmdFZhbHVlKTtcclxuICAgIHNldERlZXBWYWx1ZShvYmosIHRoaXMuX3JpZ2h0RmllbGROYW1lLCByaWdodFZhbHVlKTtcclxuXHJcbiAgICByZXR1cm4gb2JqO1xyXG4gIH1cclxuXHJcbiAgc2VyaWFsaXplVmFsdWVCeVBvc2l0aW9uKHBvc2l0aW9uOiAnbGVmdElucHV0JyB8ICdyaWdodElucHV0Jykge1xyXG4gICAgY29uc3QgZWxtVmFsdWUgPSBwb3NpdGlvbiA9PT0gJ2xlZnRJbnB1dCcgPyB0aGlzLl9sZWZ0SW5wdXQudmFsdWUgOiB0aGlzLl9yaWdodElucHV0LnZhbHVlO1xyXG4gICAgaWYgKGVsbVZhbHVlID09PSAnJyB8fCBpc05hTigrZWxtVmFsdWUpKSB7XHJcbiAgICAgIHJldHVybiBlbG1WYWx1ZTtcclxuICAgIH1cclxuXHJcbiAgICBsZXQgcnRuID0gcGFyc2VGbG9hdChlbG1WYWx1ZSk7XHJcbiAgICBjb25zdCBkZWNQbGFjZXMgPSB0aGlzLmdldERlY2ltYWxQbGFjZXMocG9zaXRpb24pO1xyXG4gICAgaWYgKGRlY1BsYWNlcyAhPT0gbnVsbCAmJiAocnRuIHx8IHJ0biA9PT0gMCkgJiYgcnRuLnRvRml4ZWQpIHtcclxuICAgICAgcnRuID0gcGFyc2VGbG9hdChydG4udG9GaXhlZChkZWNQbGFjZXMpKTtcclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4gcnRuO1xyXG4gIH1cclxuXHJcbiAgZ2V0RGVjaW1hbFBsYWNlcyhwb3NpdGlvbjogJ2xlZnRJbnB1dCcgfCAncmlnaHRJbnB1dCcpOiBudW1iZXIge1xyXG4gICAgY29uc3QgZGVmYXVsdERlY2ltYWxQbGFjZXMgPSAwOyAvLyBUT0RPIG1vdmUgaW50byBhIGNvbnN0YW50XHJcblxyXG4gICAgLy8gcmV0dXJucyB0aGUgbnVtYmVyIG9mIGZpeGVkIGRlY2ltYWwgcGxhY2VzIG9yIG51bGxcclxuICAgIGNvbnN0IHBvc2l0aW9uU2lkZSA9IHBvc2l0aW9uID09PSAnbGVmdElucHV0JyA/ICdsZWZ0SW5wdXQnIDogJ3JpZ2h0SW5wdXQnO1xyXG4gICAgY29uc3Qgc2lkZVBhcmFtcyA9IHRoaXMuZWRpdG9yUGFyYW1zW3Bvc2l0aW9uU2lkZV07XHJcbiAgICBjb25zdCBydG46IG51bWJlciB8IHVuZGVmaW5lZCA9IHNpZGVQYXJhbXMgJiYgc2lkZVBhcmFtcy5kZWNpbWFsO1xyXG5cclxuICAgIGlmIChydG4gPT09IHVuZGVmaW5lZCkge1xyXG4gICAgICByZXR1cm4gZGVmYXVsdERlY2ltYWxQbGFjZXM7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gcnRuO1xyXG4gIH1cclxuXHJcbiAgZ2V0SW5wdXREZWNpbWFsU3RlcHMocG9zaXRpb246ICdsZWZ0SW5wdXQnIHwgJ3JpZ2h0SW5wdXQnKTogc3RyaW5nIHtcclxuICAgIGNvbnN0IGRlY2ltYWxzID0gdGhpcy5nZXREZWNpbWFsUGxhY2VzKHBvc2l0aW9uKTtcclxuICAgIGxldCB6ZXJvU3RyaW5nID0gJyc7XHJcbiAgICBmb3IgKGxldCBpID0gMTsgaSA8IGRlY2ltYWxzOyBpKyspIHtcclxuICAgICAgemVyb1N0cmluZyArPSAnMCc7XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKGRlY2ltYWxzID4gMCkge1xyXG4gICAgICByZXR1cm4gYDAuJHt6ZXJvU3RyaW5nfTFgO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuICcxJztcclxuICB9XHJcblxyXG4gIHZhbGlkYXRlKGlucHV0VmFsaWRhdGlvbj86IHsgcG9zaXRpb246ICdsZWZ0SW5wdXQnIHwgJ3JpZ2h0SW5wdXQnLCBpbnB1dFZhbHVlOiBhbnkgfSk6IEVkaXRvclZhbGlkYXRvck91dHB1dCB7XHJcbiAgICBpZiAoaW5wdXRWYWxpZGF0aW9uKSB7XHJcbiAgICAgIGNvbnN0IHBvc1ZhbGlkYXRpb24gPSB0aGlzLnZhbGlkYXRlQnlQb3NpdGlvbihpbnB1dFZhbGlkYXRpb24ucG9zaXRpb24sIGlucHV0VmFsaWRhdGlvbi5pbnB1dFZhbHVlKTtcclxuICAgICAgaWYgKCFwb3NWYWxpZGF0aW9uLnZhbGlkKSB7XHJcbiAgICAgICAgaW5wdXRWYWxpZGF0aW9uLnBvc2l0aW9uID09PSAnbGVmdElucHV0JyA/IHRoaXMuX2xlZnRJbnB1dC5zZWxlY3QoKSA6IHRoaXMuX3JpZ2h0SW5wdXQuc2VsZWN0KCk7XHJcbiAgICAgICAgcmV0dXJuIHBvc1ZhbGlkYXRpb247XHJcbiAgICAgIH1cclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIGNvbnN0IGxlZnRWYWxpZGF0aW9uID0gdGhpcy52YWxpZGF0ZUJ5UG9zaXRpb24oJ2xlZnRJbnB1dCcpO1xyXG4gICAgICBjb25zdCByaWdodFZhbGlkYXRpb24gPSB0aGlzLnZhbGlkYXRlQnlQb3NpdGlvbigncmlnaHRJbnB1dCcpO1xyXG5cclxuICAgICAgaWYgKCFsZWZ0VmFsaWRhdGlvbi52YWxpZCkge1xyXG4gICAgICAgIHRoaXMuX2xlZnRJbnB1dC5zZWxlY3QoKTtcclxuICAgICAgICByZXR1cm4gbGVmdFZhbGlkYXRpb247XHJcbiAgICAgIH1cclxuICAgICAgaWYgKCFyaWdodFZhbGlkYXRpb24udmFsaWQpIHtcclxuICAgICAgICB0aGlzLl9yaWdodElucHV0LnNlbGVjdCgpO1xyXG4gICAgICAgIHJldHVybiByaWdodFZhbGlkYXRpb247XHJcbiAgICAgIH1cclxuICAgIH1cclxuICAgIHJldHVybiB7IHZhbGlkOiB0cnVlLCBtc2c6ICcnIH07XHJcbiAgfVxyXG5cclxuICB2YWxpZGF0ZUJ5UG9zaXRpb24ocG9zaXRpb246ICdsZWZ0SW5wdXQnIHwgJ3JpZ2h0SW5wdXQnLCBpbnB1dFZhbHVlPzogYW55KTogRWRpdG9yVmFsaWRhdG9yT3V0cHV0IHtcclxuICAgIGNvbnN0IHBvc2l0aW9uRWRpdG9yUGFyYW1zID0gdGhpcy5lZGl0b3JQYXJhbXNbcG9zaXRpb25dO1xyXG4gICAgbGV0IGN1cnJlbnRWYWw6IGFueSA9ICcnO1xyXG4gICAgaWYgKGlucHV0VmFsdWUpIHtcclxuICAgICAgY3VycmVudFZhbCA9IGlucHV0VmFsdWU7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICBjb25zdCBpbnB1dCA9IHBvc2l0aW9uID09PSAnbGVmdElucHV0JyA/IHRoaXMuX2xlZnRJbnB1dCA6IHRoaXMuX3JpZ2h0SW5wdXQ7XHJcbiAgICAgIGN1cnJlbnRWYWwgPSBpbnB1dCAmJiBpbnB1dC52YWx1ZTtcclxuICAgIH1cclxuXHJcbiAgICAvLyB0aGVyZSBhcmUgMiB3YXlzIG9mIHBhc3NpbmcgYSBWYWxpZGF0b3IsIDEtaW5kZXBlbmRlbnQgdmFsaWRhdG9yIG9uIGVhY2ggc2lkZSwgMi1zaGFyZWQgdmFsaWRhdG9yXHJcbiAgICBjb25zdCBjb21tb25WYWxpZGF0b3IgPSB0aGlzLnZhbGlkYXRvcjtcclxuICAgIGN1cnJlbnRWYWwgPSB0eXBlb2YgY29tbW9uVmFsaWRhdG9yID09PSAnZnVuY3Rpb24nID8gdGhpcy5nZXRWYWx1ZXMoKSA6IGN1cnJlbnRWYWw7XHJcbiAgICBjb25zdCBiYXNlVmFsaWRhdG9yT3B0aW9ucyA9IHtcclxuICAgICAgZWRpdG9yQXJnczogdGhpcy5hcmdzLFxyXG4gICAgICBlcnJvck1lc3NhZ2U6IHBvc2l0aW9uRWRpdG9yUGFyYW1zLmVycm9yTWVzc2FnZSxcclxuICAgICAgcmVxdWlyZWQ6IHBvc2l0aW9uRWRpdG9yUGFyYW1zLnJlcXVpcmVkLFxyXG4gICAgICB2YWxpZGF0b3I6IHR5cGVvZiBjb21tb25WYWxpZGF0b3IgPT09ICdmdW5jdGlvbicgPyBjb21tb25WYWxpZGF0b3IgOiBwb3NpdGlvbkVkaXRvclBhcmFtcy52YWxpZGF0b3IsXHJcbiAgICB9O1xyXG5cclxuICAgIHN3aXRjaCAocG9zaXRpb25FZGl0b3JQYXJhbXMudHlwZSkge1xyXG4gICAgICBjYXNlICdmbG9hdCc6XHJcbiAgICAgICAgcmV0dXJuIGZsb2F0VmFsaWRhdG9yKGN1cnJlbnRWYWwsIHtcclxuICAgICAgICAgIC4uLmJhc2VWYWxpZGF0b3JPcHRpb25zLFxyXG4gICAgICAgICAgZGVjaW1hbDogdGhpcy5nZXREZWNpbWFsUGxhY2VzKHBvc2l0aW9uKSxcclxuICAgICAgICAgIG1pblZhbHVlOiBwb3NpdGlvbkVkaXRvclBhcmFtcy5taW5WYWx1ZSxcclxuICAgICAgICAgIG1heFZhbHVlOiBwb3NpdGlvbkVkaXRvclBhcmFtcy5tYXhWYWx1ZSxcclxuICAgICAgICAgIG9wZXJhdG9yQ29uZGl0aW9uYWxUeXBlOiBwb3NpdGlvbkVkaXRvclBhcmFtcy5vcGVyYXRvckNvbmRpdGlvbmFsVHlwZSxcclxuICAgICAgICB9KTtcclxuICAgICAgY2FzZSAnaW50ZWdlcic6XHJcbiAgICAgICAgcmV0dXJuIGludGVnZXJWYWxpZGF0b3IoY3VycmVudFZhbCwge1xyXG4gICAgICAgICAgLi4uYmFzZVZhbGlkYXRvck9wdGlvbnMsXHJcbiAgICAgICAgICBtaW5WYWx1ZTogcG9zaXRpb25FZGl0b3JQYXJhbXMubWluVmFsdWUsXHJcbiAgICAgICAgICBtYXhWYWx1ZTogcG9zaXRpb25FZGl0b3JQYXJhbXMubWF4VmFsdWUsXHJcbiAgICAgICAgICBvcGVyYXRvckNvbmRpdGlvbmFsVHlwZTogcG9zaXRpb25FZGl0b3JQYXJhbXMub3BlcmF0b3JDb25kaXRpb25hbFR5cGUsXHJcbiAgICAgICAgfSk7XHJcbiAgICAgIGNhc2UgJ3RleHQnOlxyXG4gICAgICBjYXNlICdwYXNzd29yZCc6XHJcbiAgICAgIGRlZmF1bHQ6XHJcbiAgICAgICAgcmV0dXJuIHRleHRWYWxpZGF0b3IoY3VycmVudFZhbCwgYmFzZVZhbGlkYXRvck9wdGlvbnMpO1xyXG4gICAgfVxyXG4gIH1cclxufVxyXG4iXX0=