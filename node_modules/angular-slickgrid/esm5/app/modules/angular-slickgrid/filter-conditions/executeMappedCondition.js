import { booleanFilterCondition } from './booleanFilterCondition';
import { collectionSearchFilterCondition } from './collectionSearchFilterCondition';
import { numberFilterCondition } from './numberFilterCondition';
import { objectFilterCondition } from './objectFilterCondition';
import { stringFilterCondition } from './stringFilterCondition';
import { FieldType, OperatorType } from '../models/index';
import { mapMomentDateFormatWithFieldType } from './../services/utilities';
import { testFilterCondition } from './filterUtilities';
import * as moment_ from 'moment-mini';
var moment = moment_; // patch to fix rollup "moment has no default export" issue, document here https://github.com/rollup/rollup/issues/670
export var executeMappedCondition = function (options) {
    // when using a multi-select ('IN' operator) we will not use the field type but instead go directly with a collection search
    var operator = options && options.operator && options.operator.toUpperCase();
    if (operator === 'IN' || operator === 'NIN' || operator === 'IN_CONTAINS' || operator === 'NIN_CONTAINS') {
        return collectionSearchFilterCondition(options);
    }
    // execute the mapped type, or default to String condition check
    switch (options.fieldType) {
        case FieldType.boolean:
            return booleanFilterCondition(options);
        case FieldType.date:
        case FieldType.dateIso:
        case FieldType.dateUtc:
        case FieldType.dateTime:
        case FieldType.dateTimeIso:
        case FieldType.dateTimeIsoAmPm:
        case FieldType.dateTimeIsoAM_PM:
        case FieldType.dateTimeShortIso:
        case FieldType.dateEuro:
        case FieldType.dateEuroShort:
        case FieldType.dateTimeShortEuro:
        case FieldType.dateTimeEuro:
        case FieldType.dateTimeEuroAmPm:
        case FieldType.dateTimeEuroAM_PM:
        case FieldType.dateTimeEuroShort:
        case FieldType.dateTimeEuroShortAmPm:
        case FieldType.dateTimeEuroShortAM_PM:
        case FieldType.dateUs:
        case FieldType.dateUsShort:
        case FieldType.dateTimeShortUs:
        case FieldType.dateTimeUs:
        case FieldType.dateTimeUsAmPm:
        case FieldType.dateTimeUsAM_PM:
        case FieldType.dateTimeUsShort:
        case FieldType.dateTimeUsShortAmPm:
        case FieldType.dateTimeUsShortAM_PM:
            return executeAssociatedDateCondition(options);
        case FieldType.integer:
        case FieldType.float:
        case FieldType.number:
            return numberFilterCondition(options);
        case FieldType.object:
            return objectFilterCondition(options);
        case FieldType.string:
        case FieldType.text:
        case FieldType.password:
        case FieldType.readonly:
        default:
            return stringFilterCondition(options);
    }
};
/**
 * Execute Date filter condition and use correct date format depending on it's field type (or filterSearchType when that is provided)
 * @param options
 */
function executeAssociatedDateCondition(options) {
    var filterSearchType = options && (options.filterSearchType || options.fieldType) || FieldType.dateIso;
    var FORMAT = mapMomentDateFormatWithFieldType(filterSearchType);
    var searchTerms = Array.isArray(options.searchTerms) && options.searchTerms || [];
    var isRangeSearch = false;
    var dateSearch1;
    var dateSearch2;
    // return when cell value is not a valid date
    if (searchTerms.length === 0 || searchTerms[0] === '' || searchTerms[0] === null || !moment(options.cellValue, FORMAT, true).isValid()) {
        return false;
    }
    // cell value in moment format
    var dateCell = moment(options.cellValue, FORMAT, true);
    if (searchTerms.length === 2 || (typeof searchTerms[0] === 'string' && searchTerms[0].indexOf('..') > 0)) {
        isRangeSearch = true;
        var searchValues = (searchTerms.length === 2) ? searchTerms : searchTerms[0].split('..');
        var searchValue1 = (Array.isArray(searchValues) && searchValues[0] || '');
        var searchValue2 = (Array.isArray(searchValues) && searchValues[1] || '');
        var searchTerm1 = moment(searchValue1, FORMAT, true);
        var searchTerm2 = moment(searchValue2, FORMAT, true);
        // return if any of the 2 values are invalid dates
        if (!moment(searchTerm1, FORMAT, true).isValid() || !moment(searchTerm2, FORMAT, true).isValid()) {
            return false;
        }
        dateSearch1 = moment(searchTerm1, FORMAT, true);
        dateSearch2 = moment(searchTerm2, FORMAT, true);
    }
    else {
        // return if the search term is an invalid date
        if (!moment(searchTerms[0], FORMAT, true).isValid()) {
            return false;
        }
        dateSearch1 = moment(searchTerms[0], FORMAT, true);
    }
    // when comparing with Dates only (without time), we need to disregard the time portion, we can do so by setting our time to start at midnight
    // ref, see https://stackoverflow.com/a/19699447/1212166
    var dateCellTimestamp = FORMAT.toLowerCase().includes('h') ? parseInt(dateCell.format('X'), 10) : parseInt(dateCell.clone().startOf('day').format('X'), 10);
    // run the filter condition with date in Unix Timestamp format
    if (isRangeSearch) {
        var isInclusive = options.operator && options.operator === OperatorType.rangeInclusive;
        var resultCondition1 = testFilterCondition((isInclusive ? '>=' : '>'), dateCellTimestamp, parseInt(dateSearch1.format('X'), 10));
        var resultCondition2 = testFilterCondition((isInclusive ? '<=' : '<'), dateCellTimestamp, parseInt(dateSearch2.format('X'), 10));
        return (resultCondition1 && resultCondition2);
    }
    var dateSearchTimestamp1 = FORMAT.toLowerCase().includes('h') ? parseInt(dateSearch1.format('X'), 10) : parseInt(dateSearch1.clone().startOf('day').format('X'), 10);
    return testFilterCondition(options.operator || '==', dateCellTimestamp, dateSearchTimestamp1);
}
;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZXhlY3V0ZU1hcHBlZENvbmRpdGlvbi5qcyIsInNvdXJjZVJvb3QiOiJuZzovL2FuZ3VsYXItc2xpY2tncmlkLyIsInNvdXJjZXMiOlsiYXBwL21vZHVsZXMvYW5ndWxhci1zbGlja2dyaWQvZmlsdGVyLWNvbmRpdGlvbnMvZXhlY3V0ZU1hcHBlZENvbmRpdGlvbi50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsc0JBQXNCLEVBQUUsTUFBTSwwQkFBMEIsQ0FBQztBQUNsRSxPQUFPLEVBQUUsK0JBQStCLEVBQUUsTUFBTSxtQ0FBbUMsQ0FBQztBQUNwRixPQUFPLEVBQUUscUJBQXFCLEVBQUUsTUFBTSx5QkFBeUIsQ0FBQztBQUNoRSxPQUFPLEVBQUUscUJBQXFCLEVBQUUsTUFBTSx5QkFBeUIsQ0FBQztBQUNoRSxPQUFPLEVBQUUscUJBQXFCLEVBQUUsTUFBTSx5QkFBeUIsQ0FBQztBQUVoRSxPQUFPLEVBQUUsU0FBUyxFQUEwQyxZQUFZLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUNsRyxPQUFPLEVBQUUsZ0NBQWdDLEVBQUUsTUFBTSx5QkFBeUIsQ0FBQztBQUMzRSxPQUFPLEVBQUUsbUJBQW1CLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUN4RCxPQUFPLEtBQUssT0FBTyxNQUFNLGFBQWEsQ0FBQztBQUV2QyxJQUFNLE1BQU0sR0FBRyxPQUFPLENBQUMsQ0FBQyxzSEFBc0g7QUFFOUksTUFBTSxDQUFDLElBQU0sc0JBQXNCLEdBQW9CLFVBQUMsT0FBOEI7SUFDcEYsNEhBQTRIO0lBQzVILElBQU0sUUFBUSxHQUFHLE9BQU8sSUFBSSxPQUFPLENBQUMsUUFBUSxJQUFJLE9BQU8sQ0FBQyxRQUFRLENBQUMsV0FBVyxFQUFFLENBQUM7SUFDL0UsSUFBSSxRQUFRLEtBQUssSUFBSSxJQUFJLFFBQVEsS0FBSyxLQUFLLElBQUksUUFBUSxLQUFLLGFBQWEsSUFBSSxRQUFRLEtBQUssY0FBYyxFQUFFO1FBQ3hHLE9BQU8sK0JBQStCLENB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QVksQ0FBQyxjQUFjLENBQUM7UUFDekYsSUFBTSxnQkFBZ0IsR0FBRyxtQkFBbUIsQ0FBQyxDQUFDLFdBQVcsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsRUFBRSxpQkFBaUIsRUFBRSxRQUFRLENBQUMsV0FBVyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDO1FBQ25JLElBQU0sZ0JBQWdCLEdBQUcsbUJBQW1CLENBQUMsQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLEVBQUUsaUJBQWlCLEVBQUUsUUFBUSxDQUFDLFdBQVcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQztRQUNuSSxPQUFPLENBQUMsZ0JBQWdCLElBQUksZ0JBQWdCLENBQUMsQ0FBQztLQUMvQztJQUVELElBQU0sb0JBQW9CLEdBQUcsTUFBTSxDQUFDLFdBQVcsRUFBRSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDLFdBQVcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxXQUFXLENBQUMsS0FBSyxFQUFFLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQztJQUN2SyxPQUFPLG1CQUFtQixDQUFDLE9BQU8sQ0FBQyxRQUFRLElBQUksSUFBSSxFQUFFLGlCQUFpQixFQUFFLG9CQUFvQixDQUFDLENBQUM7QUFDaEcsQ0FBQztBQUFBLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBib29sZWFuRmlsdGVyQ29uZGl0aW9uIH0gZnJvbSAnLi9ib29sZWFuRmlsdGVyQ29uZGl0aW9uJztcclxuaW1wb3J0IHsgY29sbGVjdGlvblNlYXJjaEZpbHRlckNvbmRpdGlvbiB9IGZyb20gJy4vY29sbGVjdGlvblNlYXJjaEZpbHRlckNvbmRpdGlvbic7XHJcbmltcG9ydCB7IG51bWJlckZpbHRlckNvbmRpdGlvbiB9IGZyb20gJy4vbnVtYmVyRmlsdGVyQ29uZGl0aW9uJztcclxuaW1wb3J0IHsgb2JqZWN0RmlsdGVyQ29uZGl0aW9uIH0gZnJvbSAnLi9vYmplY3RGaWx0ZXJDb25kaXRpb24nO1xyXG5pbXBvcnQgeyBzdHJpbmdGaWx0ZXJDb25kaXRpb24gfSBmcm9tICcuL3N0cmluZ0ZpbHRlckNvbmRpdGlvbic7XHJcblxyXG5pbXBvcnQgeyBGaWVsZFR5cGUsIEZpbHRlckNvbmRpdGlvbiwgRmlsdGVyQ29uZGl0aW9uT3B0aW9uLCBPcGVyYXRvclR5cGUgfSBmcm9tICcuLi9tb2RlbHMvaW5kZXgnO1xyXG5pbXBvcnQgeyBtYXBNb21lbnREYXRlRm9ybWF0V2l0aEZpZWxkVHlwZSB9IGZyb20gJy4vLi4vc2VydmljZXMvdXRpbGl0aWVzJztcclxuaW1wb3J0IHsgdGVzdEZpbHRlckNvbmRpdGlvbiB9IGZyb20gJy4vZmlsdGVyVXRpbGl0aWVzJztcclxuaW1wb3J0ICogYXMgbW9tZW50XyBmcm9tICdtb21lbnQtbWluaSc7XHJcblxyXG5jb25zdCBtb21lbnQgPSBtb21lbnRfOyAvLyBwYXRjaCB0byBmaXggcm9sbHVwIFwibW9tZW50IGhhcyBubyBkZWZhdWx0IGV4cG9ydFwiIGlzc3VlLCBkb2N1bWVudCBoZXJlIGh0dHBzOi8vZ2l0aHViLmNvbS9yb2xsdXAvcm9sbHVwL2lzc3Vlcy82NzBcclxuXHJcbmV4cG9ydCBjb25zdCBleGVjdXRlTWFwcGVkQ29uZGl0aW9uOiBGaWx0ZXJDb25kaXRpb24gPSAob3B0aW9uczogRmlsdGVyQ29uZGl0aW9uT3B0aW9uKSA9PiB7XHJcbiAgLy8gd2hlbiB1c2luZyBhIG11bHRpLXNlbGVjdCAoJ0lOJyBvcGVyYXRvcikgd2Ugd2lsbCBub3QgdXNlIHRoZSBmaWVsZCB0eXBlIGJ1dCBpbnN0ZWFkIGdvIGRpcmVjdGx5IHdpdGggYSBjb2xsZWN0aW9uIHNlYXJjaFxyXG4gIGNvbnN0IG9wZXJhdG9yID0gb3B0aW9ucyAmJiBvcHRpb25zLm9wZXJhdG9yICYmIG9wdGlvbnMub3BlcmF0b3IudG9VcHBlckNhc2UoKTtcclxuICBpZiAob3BlcmF0b3IgPT09ICdJTicgfHwgb3BlcmF0b3IgPT09ICdOSU4nIHx8IG9wZXJhdG9yID09PSAnSU5fQ09OVEFJTlMnIHx8IG9wZXJhdG9yID09PSAnTklOX0NPTlRBSU5TJykge1xyXG4gICAgcmV0dXJuIGNvbGxlY3Rpb25TZWFyY2hGaWx0ZXJDb25kaXRpb24ob3B0aW9ucyk7XHJcbiAgfVxyXG5cclxuICAvLyBleGVjdXRlIHRoZSBtYXBwZWQgdHlwZSwgb3IgZGVmYXVsdCB0byBTdHJpbmcgY29uZGl0aW9uIGNoZWNrXHJcbiAgc3dpdGNoIChvcHRpb25zLmZpZWxkVHlwZSkge1xyXG4gICAgY2FzZSBGaWVsZFR5cGUuYm9vbGVhbjpcclxuICAgICAgcmV0dXJuIGJvb2xlYW5GaWx0ZXJDb25kaXRpb24ob3B0aW9ucyk7XHJcbiAgICBjYXNlIEZpZWxkVHlwZS5kYXRlOlxyXG4gICAgY2FzZSBGaWVsZFR5cGUuZGF0ZUlzbzpcclxuICAgIGNhc2UgRmllbGRUeXBlLmRhdGVVdGM6XHJcbiAgICBjYXNlIEZpZWxkVHlwZS5kYXRlVGltZTpcclxuICAgIGNhc2UgRmllbGRUeXBlLmRhdGVUaW1lSXNvOlxyXG4gICAgY2FzZSBGaWVsZFR5cGUuZGF0ZVRpbWVJc29BbVBtOlxyXG4gICAgY2FzZSBGaWVsZFR5cGUuZGF0ZVRpbWVJc29BTV9QTTpcclxuICAgIGNhc2UgRmllbGRUeXBlLmRhdGVUaW1lU2hvcnRJc286XHJcbiAgICBjYXNlIEZpZWxkVHlwZS5kYXRlRXVybzpcclxuICAgIGNhc2UgRmllbGRUeXBlLmRhdGVFdXJvU2hvcnQ6XHJcbiAgICBjYXNlIEZpZWxkVHlwZS5kYXRlVGltZVNob3J0RXVybzpcclxuICAgIGNhc2UgRmllbGRUeXBlLmRhdGVUaW1lRXVybzpcclxuICAgIGNhc2UgRmllbGRUeXBlLmRhdGVUaW1lRXVyb0FtUG06XHJcbiAgICBjYXNlIEZpZWxkVHlwZS5kYXRlVGltZUV1cm9BTV9QTTpcclxuICAgIGNhc2UgRmllbGRUeXBlLmRhdGVUaW1lRXVyb1Nob3J0OlxyXG4gICAgY2FzZSBGaWVsZFR5cGUuZGF0ZVRpbWVFdXJvU2hvcnRBbVBtOlxyXG4gICAgY2FzZSBGaWVsZFR5cGUuZGF0ZVRpbWVFdXJvU2hvcnRBTV9QTTpcclxuICAgIGNhc2UgRmllbGRUeXBlLmRhdGVVczpcclxuICAgIGNhc2UgRmllbGRUeXBlLmRhdGVVc1Nob3J0OlxyXG4gICAgY2FzZSBGaWVsZFR5cGUuZGF0ZVRpbWVTaG9ydFVzOlxyXG4gICAgY2FzZSBGaWVsZFR5cGUuZGF0ZVRpbWVVczpcclxuICAgIGNhc2UgRmllbGRUeXBlLmRhdGVUaW1lVXNBbVBtOlxyXG4gICAgY2FzZSBGaWVsZFR5cGUuZGF0ZVRpbWVVc0FNX1BNOlxyXG4gICAgY2FzZSBGaWVsZFR5cGUuZGF0ZVRpbWVVc1Nob3J0OlxyXG4gICAgY2FzZSBGaWVsZFR5cGUuZGF0ZVRpbWVVc1Nob3J0QW1QbTpcclxuICAgIGNhc2UgRmllbGRUeXBlLmRhdGVUaW1lVXNTaG9ydEFNX1BNOlxyXG4gICAgICByZXR1cm4gZXhlY3V0ZUFzc29jaWF0ZWREYXRlQ29uZGl0aW9uKG9wdGlvbnMpO1xyXG4gICAgY2FzZSBGaWVsZFR5cGUuaW50ZWdlcjpcclxuICAgIGNhc2UgRmllbGRUeXBlLmZsb2F0OlxyXG4gICAgY2FzZSBGaWVsZFR5cGUubnVtYmVyOlxyXG4gICAgICByZXR1cm4gbnVtYmVyRmlsdGVyQ29uZGl0aW9uKG9wdGlvbnMpO1xyXG4gICAgY2FzZSBGaWVsZFR5cGUub2JqZWN0OlxyXG4gICAgICByZXR1cm4gb2JqZWN0RmlsdGVyQ29uZGl0aW9uKG9wdGlvbnMpO1xyXG4gICAgY2FzZSBGaWVsZFR5cGUuc3RyaW5nOlxyXG4gICAgY2FzZSBGaWVsZFR5cGUudGV4dDpcclxuICAgIGNhc2UgRmllbGRUeXBlLnBhc3N3b3JkOlxyXG4gICAgY2FzZSBGaWVsZFR5cGUucmVhZG9ubHk6XHJcbiAgICBkZWZhdWx0OlxyXG4gICAgICByZXR1cm4gc3RyaW5nRmlsdGVyQ29uZGl0aW9uKG9wdGlvbnMpO1xyXG4gIH1cclxufTtcclxuXHJcbi8qKlxyXG4gKiBFeGVjdXRlIERhdGUgZmlsdGVyIGNvbmRpdGlvbiBhbmQgdXNlIGNvcnJlY3QgZGF0ZSBmb3JtYXQgZGVwZW5kaW5nIG9uIGl0J3MgZmllbGQgdHlwZSAob3IgZmlsdGVyU2VhcmNoVHlwZSB3aGVuIHRoYXQgaXMgcHJvdmlkZWQpXHJcbiAqIEBwYXJhbSBvcHRpb25zXHJcbiAqL1xyXG5mdW5jdGlvbiBleGVjdXRlQXNzb2NpYXRlZERhdGVDb25kaXRpb24ob3B0aW9uczogRmlsdGVyQ29uZGl0aW9uT3B0aW9uKTogYm9vbGVhbiB7XHJcbiAgY29uc3QgZmlsdGVyU2VhcmNoVHlwZSA9IG9wdGlvbnMgJiYgKG9wdGlvbnMuZmlsdGVyU2VhcmNoVHlwZSB8fCBvcHRpb25zLmZpZWxkVHlwZSkgfHwgRmllbGRUeXBlLmRhdGVJc287XHJcbiAgY29uc3QgRk9STUFUID0gbWFwTW9tZW50RGF0ZUZvcm1hdFdpdGhGaWVsZFR5cGUoZmlsdGVyU2VhcmNoVHlwZSk7XHJcbiAgY29uc3Qgc2VhcmNoVGVybXMgPSBBcnJheS5pc0FycmF5KG9wdGlvbnMuc2VhcmNoVGVybXMpICYmIG9wdGlvbnMuc2VhcmNoVGVybXMgfHwgW107XHJcblxyXG4gIGxldCBpc1JhbmdlU2VhcmNoID0gZmFsc2U7XHJcbiAgbGV0IGRhdGVTZWFyY2gxOiBhbnk7XHJcbiAgbGV0IGRhdGVTZWFyY2gyOiBhbnk7XHJcblxyXG4gIC8vIHJldHVybiB3aGVuIGNlbGwgdmFsdWUgaXMgbm90IGEgdmFsaWQgZGF0ZVxyXG4gIGlmIChzZWFyY2hUZXJtcy5sZW5ndGggPT09IDAgfHwgc2VhcmNoVGVybXNbMF0gPT09ICcnIHx8IHNlYXJjaFRlcm1zWzBdID09PSBudWxsIHx8ICFtb21lbnQob3B0aW9ucy5jZWxsVmFsdWUsIEZPUk1BVCwgdHJ1ZSkuaXNWYWxpZCgpKSB7XHJcbiAgICByZXR1cm4gZmFsc2U7XHJcbiAgfVxyXG5cclxuICAvLyBjZWxsIHZhbHVlIGluIG1vbWVudCBmb3JtYXRcclxuICBjb25zdCBkYXRlQ2VsbCA9IG1vbWVudChvcHRpb25zLmNlbGxWYWx1ZSwgRk9STUFULCB0cnVlKTtcclxuXHJcbiAgaWYgKHNlYXJjaFRlcm1zLmxlbmd0aCA9PT0gMiB8fCAodHlwZW9mIHNlYXJjaFRlcm1zWzBdID09PSAnc3RyaW5nJyAmJiAoc2VhcmNoVGVybXNbMF0gYXMgc3RyaW5nKS5pbmRleE9mKCcuLicpID4gMCkpIHtcclxuICAgIGlzUmFuZ2VTZWFyY2ggPSB0cnVlO1xyXG4gICAgY29uc3Qgc2VhcmNoVmFsdWVzID0gKHNlYXJjaFRlcm1zLmxlbmd0aCA9PT0gMikgPyBzZWFyY2hUZXJtcyA6IChzZWFyY2hUZXJtc1swXSBhcyBzdHJpbmcpLnNwbGl0KCcuLicpO1xyXG4gICAgY29uc3Qgc2VhcmNoVmFsdWUxID0gKEFycmF5LmlzQXJyYXkoc2VhcmNoVmFsdWVzKSAmJiBzZWFyY2hWYWx1ZXNbMF0gfHwgJycpIGFzIERhdGUgfCBzdHJpbmc7XHJcbiAgICBjb25zdCBzZWFyY2hWYWx1ZTIgPSAoQXJyYXkuaXNBcnJheShzZWFyY2hWYWx1ZXMpICYmIHNlYXJjaFZhbHVlc1sxXSB8fCAnJykgYXMgRGF0ZSB8IHN0cmluZztcclxuICAgIGNvbnN0IHNlYXJjaFRlcm0xID0gbW9tZW50KHNlYXJjaFZhbHVlMSwgRk9STUFULCB0cnVlKTtcclxuICAgIGNvbnN0IHNlYXJjaFRlcm0yID0gbW9tZW50KHNlYXJjaFZhbHVlMiwgRk9STUFULCB0cnVlKTtcclxuXHJcbiAgICAvLyByZXR1cm4gaWYgYW55IG9mIHRoZSAyIHZhbHVlcyBhcmUgaW52YWxpZCBkYXRlc1xyXG4gICAgaWYgKCFtb21lbnQoc2VhcmNoVGVybTEsIEZPUk1BVCwgdHJ1ZSkuaXNWYWxpZCgpIHx8ICFtb21lbnQoc2VhcmNoVGVybTIsIEZPUk1BVCwgdHJ1ZSkuaXNWYWxpZCgpKSB7XHJcbiAgICAgIHJldHVybiBmYWxzZTtcclxuICAgIH1cclxuICAgIGRhdGVTZWFyY2gxID0gbW9tZW50KHNlYXJjaFRlcm0xLCBGT1JNQVQsIHRydWUpO1xyXG4gICAgZGF0ZVNlYXJjaDIgPSBtb21lbnQoc2VhcmNoVGVybTIsIEZPUk1BVCwgdHJ1ZSk7XHJcbiAgfSBlbHNlIHtcclxuICAgIC8vIHJldHVybiBpZiB0aGUgc2VhcmNoIHRlcm0gaXMgYW4gaW52YWxpZCBkYXRlXHJcbiAgICBpZiAoIW1vbWVudChzZWFyY2hUZXJtc1swXSBhcyBEYXRlIHwgc3RyaW5nLCBGT1JNQVQsIHRydWUpLmlzVmFsaWQoKSkge1xyXG4gICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICB9XHJcbiAgICBkYXRlU2VhcmNoMSA9IG1vbWVudChzZWFyY2hUZXJtc1swXSBhcyBEYXRlIHwgc3RyaW5nLCBGT1JNQVQsIHRydWUpO1xyXG4gIH1cclxuXHJcbiAgLy8gd2hlbiBjb21wYXJpbmcgd2l0aCBEYXRlcyBvbmx5ICh3aXRob3V0IHRpbWUpLCB3ZSBuZWVkIHRvIGRpc3JlZ2FyZCB0aGUgdGltZSBwb3J0aW9uLCB3ZSBjYW4gZG8gc28gYnkgc2V0dGluZyBvdXIgdGltZSB0byBzdGFydCBhdCBtaWRuaWdodFxyXG4gIC8vIHJlZiwgc2VlIGh0dHBzOi8vc3RhY2tvdmVyZmxvdy5jb20vYS8xOTY5OTQ0Ny8xMjEyMTY2XHJcbiAgY29uc3QgZGF0ZUNlbGxUaW1lc3RhbXAgPSBGT1JNQVQudG9Mb3dlckNhc2UoKS5pbmNsdWRlcygnaCcpID8gcGFyc2VJbnQoZGF0ZUNlbGwuZm9ybWF0KCdYJyksIDEwKSA6IHBhcnNlSW50KGRhdGVDZWxsLmNsb25lKCkuc3RhcnRPZignZGF5JykuZm9ybWF0KCdYJyksIDEwKTtcclxuXHJcbiAgLy8gcnVuIHRoZSBmaWx0ZXIgY29uZGl0aW9uIHdpdGggZGF0ZSBpbiBVbml4IFRpbWVzdGFtcCBmb3JtYXRcclxuICBpZiAoaXNSYW5nZVNlYXJjaCkge1xyXG4gICAgY29uc3QgaXNJbmNsdXNpdmUgPSBvcHRpb25zLm9wZXJhdG9yICYmIG9wdGlvbnMub3BlcmF0b3IgPT09IE9wZXJhdG9yVHlwZS5yYW5nZUluY2x1c2l2ZTtcclxuICAgIGNvbnN0IHJlc3VsdENvbmRpdGlvbjEgPSB0ZXN0RmlsdGVyQ29uZGl0aW9uKChpc0luY2x1c2l2ZSA/ICc+PScgOiAnPicpLCBkYXRlQ2VsbFRpbWVzdGFtcCwgcGFyc2VJbnQoZGF0ZVNlYXJjaDEuZm9ybWF0KCdYJyksIDEwKSk7XHJcbiAgICBjb25zdCByZXN1bHRDb25kaXRpb24yID0gdGVzdEZpbHRlckNvbmRpdGlvbigoaXNJbmNsdXNpdmUgPyAnPD0nIDogJzwnKSwgZGF0ZUNlbGxUaW1lc3RhbXAsIHBhcnNlSW50KGRhdGVTZWFyY2gyLmZvcm1hdCgnWCcpLCAxMCkpO1xyXG4gICAgcmV0dXJuIChyZXN1bHRDb25kaXRpb24xICYmIHJlc3VsdENvbmRpdGlvbjIpO1xyXG4gIH1cclxuXHJcbiAgY29uc3QgZGF0ZVNlYXJjaFRpbWVzdGFtcDEgPSBGT1JNQVQudG9Mb3dlckNhc2UoKS5pbmNsdWRlcygnaCcpID8gcGFyc2VJbnQoZGF0ZVNlYXJjaDEuZm9ybWF0KCdYJyksIDEwKSA6IHBhcnNlSW50KGRhdGVTZWFyY2gxLmNsb25lKCkuc3RhcnRPZignZGF5JykuZm9ybWF0KCdYJyksIDEwKTtcclxuICByZXR1cm4gdGVzdEZpbHRlckNvbmRpdGlvbihvcHRpb25zLm9wZXJhdG9yIHx8ICc9PScsIGRhdGVDZWxsVGltZXN0YW1wLCBkYXRlU2VhcmNoVGltZXN0YW1wMSk7XHJcbn07XHJcbiJdfQ==