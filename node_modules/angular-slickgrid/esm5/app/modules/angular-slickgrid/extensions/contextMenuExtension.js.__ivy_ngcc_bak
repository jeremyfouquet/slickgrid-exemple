import * as tslib_1 from "tslib";
import { Injectable, Optional } from '@angular/core';
import { TranslateService } from '@ngx-translate/core';
import { DelimiterType, ExtensionName, FileType, } from '../models/index';
import { ExtensionUtility } from './extensionUtility';
import { SharedService } from '../services/shared.service';
import { ExportService } from '../services/export.service';
import { ExcelExportService } from '../services/excelExport.service';
import { TreeDataService } from '../services/treeData.service';
import { exportWithFormatterWhenDefined } from '../services/export-utilities';
import { getDescendantProperty, getTranslationPrefix } from '../services/utilities';
var ContextMenuExtension = /** @class */ (function () {
    function ContextMenuExtension(excelExportService, exportService, extensionUtility, sharedService, treeDataService, translate) {
        this.excelExportService = excelExportService;
        this.exportService = exportService;
        this.extensionUtility = extensionUtility;
        this.sharedService = sharedService;
        this.treeDataService = treeDataService;
        this.translate = translate;
        this._eventHandler = new Slick.EventHandler();
    }
    Object.defineProperty(ContextMenuExtension.prototype, "eventHandler", {
        get: function () {
            return this._eventHandler;
        },
        enumerable: true,
        configurable: true
    });
    ContextMenuExtension.prototype.dispose = function () {
        // unsubscribe all SlickGrid events
        this._eventHandler.unsubscribeAll();
        if (this._addon && this._addon.destroy) {
            this._addon.destroy();
        }
        if (this.sharedService.gridOptions && this.sharedService.gridOptions.contextMenu && this.sharedService.gridOptions.contextMenu.commandItems) {
            this.sharedService.gridOptions.contextMenu = this._userOriginalContextMenu;
        }
        this.extensionUtility.nullifyFunctionNameStartingWithOn(this._contextMenuOptions);
        this._addon = null;
        this._contextMenuOptions = null;
    };
    /** Get the instance of the SlickGrid addon (control or plugin). */
    ContextMenuExtension.prototype.getAddonInstance = function () {
        return this._addon;
    };
    /**
     * Create the Action Cell Menu and expose all the available hooks that user can subscribe (onCommand, onBeforeMenuShow, ...)
     * @param grid
     * @param dataView
     * @param columnDefinitions
     */
    ContextMenuExtension.prototype.register = function () {
        var _this = this;
        if (this.sharedService.gridOptions && this.sharedService.gridOptions.enableTranslate && (!this.translate || !this.translate.instant)) {
            throw new Error('[Angular-Slickgrid] requires "ngx-translate" to be installed and configured when the grid option "enableTranslate" is enabled.');
        }
        if (this.sharedService && this.sharedService.grid && this.sharedService.gridOptions && this.sharedService.gridOptions.contextMenu) {
            this._contextMenuOptions = this.sharedService.gridOptions.contextMenu;
            // keep original user context menu, useful when switching locale to translate
            this._userOriginalContextMenu = tslib_1.__assign({}, this._contextMenuOptions);
            // dynamically import the SlickGrid plugin (addon) with RequireJS
            this.extensionUtility.loadExtensionDynamically(ExtensionName.contextMenu);
            // merge the original commands with the built-in internal commands
            var originalCommandItems = this._userOriginalContextMenu && Array.isArray(this._userOriginalContextMenu.commandItems) ? this._userOriginalContextMenu.commandItems : [];
            this._contextMenuOptions.commandItems = tslib_1.__spread(originalCommandItems, this.addMenuCustomCommands(originalCommandItems));
            this._contextMenuOptions = tslib_1.__assign({}, this._contextMenuOptions);
            this.sharedService.gridOptions.contextMenu = this._contextMenuOptions;
            // sort all menu items by their position order when defined
            this.extensionUtility.sortItems(this._contextMenuOptions.commandItems || [], 'positionOrder');
            this.extensionUtility.sortItems(this._contextMenuOptions.optionItems || [], 'positionOrder');
            this._addon = new Slick.Plugins.ContextMenu(this._contextMenuOptions);
            this.sharedService.grid.registerPlugin(this._addon);
            // translate the item keys when necessary
            if (this.sharedService.gridOptions.enableTranslate) {
                this.translateContextMenu();
            }
            // hook all events
            if (this.sharedService.grid && this._contextMenuOptions) {
                if (this._contextMenuOptions.onExtensionRegistered) {
                    this._contextMenuOptions.onExtensionRegistered(this._addon);
                }
                if (this._contextMenuOptions && typeof this._contextMenuOptions.onCommand === 'function') {
                    this._eventHandler.subscribe(this._addon.onCommand, function (event, args) {
                        _this._contextMenuOptions.onCommand(event, args);
                    });
                }
                if (this._contextMenuOptions && typeof this._contextMenuOptions.onOptionSelected === 'function') {
                    this._eventHandler.subscribe(this._addon.onOptionSelected, function (event, args) {
                        _this._contextMenuOptions.onOptionSelected(event, args);
                    });
                }
                if (this._contextMenuOptions && typeof this._contextMenuOptions.onBeforeMenuShow === 'function') {
                    this._eventHandler.subscribe(this._addon.onBeforeMenuShow, function (event, args) {
                        _this._contextMenuOptions.onBeforeMenuShow(event, args);
                    });
                }
                if (this._contextMenuOptions && typeof this._contextMenuOptions.onBeforeMenuClose === 'function') {
                    this._eventHandler.subscribe(this._addon.onBeforeMenuClose, function (event, args) {
                        _this._contextMenuOptions.onBeforeMenuClose(event, args);
                    });
                }
                if (this._contextMenuOptions && typeof this._contextMenuOptions.onAfterMenuShow === 'function') {
                    this._eventHandler.subscribe(this._addon.onAfterMenuShow, function (event, args) {
                        _this._contextMenuOptions.onAfterMenuShow(event, args);
                    });
                }
            }
            return this._addon;
        }
        return null;
    };
    /** Translate the Cell Menu titles, we need to loop through all column definition to re-translate them */
    ContextMenuExtension.prototype.translateContextMenu = function () {
        if (this.sharedService && this.sharedService.gridOptions && this.sharedService.gridOptions.contextMenu) {
            var contextMenu = this.sharedService.gridOptions.contextMenu;
            var menuOptions = {};
            if (contextMenu.commandTitleKey) {
                contextMenu.commandTitle = this.translate && this.translate.currentLang && this.translate.instant && this.translate.instant(contextMenu.commandTitleKey) || contextMenu.commandTitle;
                menuOptions.commandTitle = contextMenu.commandTitle;
            }
            if (contextMenu.optionTitleKey) {
                contextMenu.optionTitle = this.translate && this.translate.currentLang && this.translate.instant && this.translate.instant(contextMenu.optionTitleKey) || contextMenu.optionTitle;
                menuOptions.optionTitle = contextMenu.optionTitle;
            }
            var originalCommandItems = this._userOriginalContextMenu && Array.isArray(this._userOriginalContextMenu.commandItems) ? this._userOriginalContextMenu.commandItems : [];
            contextMenu.commandItems = tslib_1.__spread(originalCommandItems, this.addMenuCustomCommands(originalCommandItems));
            menuOptions.commandItems = contextMenu.commandItems; // copy it also to the menuOptions else they won't be translated when locale changes
            // translate all command/options and resort them afterward
            this.extensionUtility.translateItems(contextMenu.commandItems || [], 'titleKey', 'title');
            this.extensionUtility.translateItems(contextMenu.optionItems || [], 'titleKey', 'title');
            this.extensionUtility.sortItems(contextMenu.commandItems || [], 'positionOrder');
            this.extensionUtility.sortItems(contextMenu.optionItems || [], 'positionOrder');
            // update the title options so that it has latest translated values
            if (this._addon && this._addon.setOptions) {
                this._addon.setOptions(menuOptions);
            }
        }
    };
    // --
    // private functions
    // ------------------
    /** Create Context Menu with Custom Commands (copy cell value, export) */
    ContextMenuExtension.prototype.addMenuCustomCommands = function (originalCustomItems) {
        var _this = this;
        var menuCustomItems = [];
        var gridOptions = this.sharedService && this.sharedService.gridOptions || {};
        var contextMenu = gridOptions && gridOptions.contextMenu;
        var dataView = this.sharedService && this.sharedService.dataView;
        var translationPrefix = getTranslationPrefix(gridOptions);
        // show context menu: Copy (cell value)
        if (contextMenu && !contextMenu.hideCopyCellValueCommand) {
            var commandName_1 = 'copy';
            if (!originalCustomItems.find(function (item) { return item.hasOwnProperty('command') && item.command === commandName_1; })) {
                menuCustomItems.push({
                    iconCssClass: contextMenu.iconCopyCellValueCommand || 'fa fa-clone',
                    title: this.extensionUtility.translateWhenEnabledAndServiceExist(translationPrefix + "COPY", 'TEXT_COPY'),
                    disabled: false,
                    command: commandName_1,
                    positionOrder: 50,
                    action: function (e, args) {
                        _this.copyToClipboard(args);
                    },
                    itemUsabilityOverride: function (args) {
                        // make sure there's an item to copy before enabling this command
                        var columnDef = args && args.column;
                        var dataContext = args && args.dataContext;
                        if (typeof columnDef.queryFieldNameGetterFn === 'function') {
                            var cellValue = _this.getCellValueFromQueryFieldGetter(columnDef, dataContext);
                            if (cellValue !== '' && cellValue !== undefined) {
                                return true;
                            }
                        }
                        else if (columnDef && dataContext.hasOwnProperty(columnDef.field)) {
                            return dataContext[columnDef.field] !== '' && dataContext[columnDef.field] !== null && dataContext[columnDef.field] !== undefined;
                        }
                        return false;
                    }
                });
            }
        }
        // show context menu: Export to file
        if (gridOptions && gridOptions.enableExport && contextMenu && !contextMenu.hideExportCsvCommand) {
            var commandName_2 = 'export-csv';
            if (!originalCustomItems.find(function (item) { return item.hasOwnProperty('command') && item.command === commandName_2; })) {
                menuCustomItems.push({
                    iconCssClass: contextMenu.iconExportCsvCommand || 'fa fa-download',
                    title: this.extensionUtility.translateWhenEnabledAndServiceExist(translationPrefix + "EXPORT_TO_CSV", 'TEXT_EXPORT_TO_CSV'),
                    disabled: false,
                    command: commandName_2,
                    positionOrder: 51,
                    action: function () { return _this.exportService.exportToFile({
                        delimiter: DelimiterType.comma,
                        filename: 'export',
                        format: FileType.csv,
                        useUtf8WithBom: true,
                    }); },
                });
            }
        }
        // show context menu: Export to Excel
        if (gridOptions && gridOptions.enableExcelExport && contextMenu && !contextMenu.hideExportExcelCommand) {
            var commandName_3 = 'export-excel';
            if (!originalCustomItems.find(function (item) { return item.hasOwnProperty('command') && item.command === commandName_3; })) {
                menuCustomItems.push({
                    iconCssClass: contextMenu.iconExportExcelCommand || 'fa fa-file-excel-o text-success',
                    title: this.extensionUtility.translateWhenEnabledAndServiceExist(translationPrefix + "EXPORT_TO_EXCEL", 'TEXT_EXPORT_TO_EXCEL'),
                    disabled: false,
                    command: commandName_3,
                    positionOrder: 52,
                    action: function () { return _this.excelExportService.exportToExcel({
                        filename: 'export',
                        format: FileType.xlsx,
                    }); },
                });
            }
        }
        // show context menu: export to text file as tab delimited
        if (gridOptions && gridOptions.enableExport && contextMenu && !contextMenu.hideExportTextDelimitedCommand) {
            var commandName_4 = 'export-text-delimited';
            if (!originalCustomItems.find(function (item) { return item.hasOwnProperty('command') && item.command === commandName_4; })) {
                menuCustomItems.push({
                    iconCssClass: contextMenu.iconExportTextDelimitedCommand || 'fa fa-download',
                    title: this.extensionUtility.translateWhenEnabledAndServiceExist(translationPrefix + "EXPORT_TO_TAB_DELIMITED", 'TEXT_EXPORT_TO_TAB_DELIMITED'),
                    disabled: false,
                    command: commandName_4,
                    positionOrder: 53,
                    action: function () { return _this.exportService.exportToFile({
                        delimiter: DelimiterType.tab,
                        filename: 'export',
                        format: FileType.txt,
                        useUtf8WithBom: true,
                    }); },
                });
            }
        }
        // -- Grouping Commands
        if (gridOptions && (gridOptions.enableGrouping || gridOptions.enableDraggableGrouping || gridOptions.enableTreeData)) {
            // add a divider (separator) between the top sort commands and the other clear commands
            if (contextMenu && !contextMenu.hideCopyCellValueCommand) {
                menuCustomItems.push({ divider: true, command: '', positionOrder: 54 });
            }
            // show context menu: Clear Grouping
            if (gridOptions && !gridOptions.enableTreeData && contextMenu && !contextMenu.hideClearAllGrouping) {
                var commandName_5 = 'clear-grouping';
                if (!originalCustomItems.find(function (item) { return item.hasOwnProperty('command') && item.command === commandName_5; })) {
                    menuCustomItems.push({
                        iconCssClass: contextMenu.iconClearGroupingCommand || 'fa fa-times',
                        title: this.extensionUtility.translateWhenEnabledAndServiceExist(translationPrefix + "CLEAR_ALL_GROUPING", 'TEXT_CLEAR_ALL_GROUPING'),
                        disabled: false,
                        command: commandName_5,
                        positionOrder: 55,
                        action: function () { return dataView.setGrouping([]); },
                        itemUsabilityOverride: function () {
                            // only enable the command when there's an actually grouping in play
                            var groupingArray = dataView && dataView.getGrouping && dataView.getGrouping();
                            return Array.isArray(groupingArray) && groupingArray.length > 0;
                        }
                    });
                }
            }
            // show context menu: Collapse all Groups
            if (gridOptions && contextMenu && !contextMenu.hideCollapseAllGroups) {
                var commandName_6 = 'collapse-all-groups';
                if (!originalCustomItems.find(function (item) { return item.hasOwnProperty('command') && item.command === commandName_6; })) {
                    menuCustomItems.push({
                        iconCssClass: contextMenu.iconCollapseAllGroupsCommand || 'fa fa-compress',
                        title: this.extensionUtility.translateWhenEnabledAndServiceExist(translationPrefix + "COLLAPSE_ALL_GROUPS", 'TEXT_COLLAPSE_ALL_GROUPS'),
                        disabled: false,
                        command: commandName_6,
                        positionOrder: 56,
                        action: function () {
                            if (gridOptions.enableTreeData) {
                                _this.treeDataService.toggleTreeDataCollapse(true);
                            }
                            else {
                                dataView.collapseAllGroups();
                            }
                        },
                        itemUsabilityOverride: function () {
                            if (gridOptions.enableTreeData) {
                                return true;
                            }
                            // only enable the command when there's an actually grouping in play
                            var groupingArray = dataView && dataView.getGrouping && dataView.getGrouping();
                            return Array.isArray(groupingArray) && groupingArray.length > 0;
                        }
                    });
                }
            }
            // show context menu: Expand all Groups
            if (gridOptions && contextMenu && !contextMenu.hideExpandAllGroups) {
                var commandName_7 = 'expand-all-groups';
                if (!originalCustomItems.find(function (item) { return item.hasOwnProperty('command') && item.command === commandName_7; })) {
                    menuCustomItems.push({
                        iconCssClass: contextMenu.iconExpandAllGroupsCommand || 'fa fa-expand',
                        title: this.extensionUtility.translateWhenEnabledAndServiceExist(translationPrefix + "EXPAND_ALL_GROUPS", 'TEXT_EXPAND_ALL_GROUPS'),
                        disabled: false,
                        command: commandName_7,
                        positionOrder: 57,
                        action: function () {
                            if (gridOptions.enableTreeData) {
                                _this.treeDataService.toggleTreeDataCollapse(false);
                            }
                            else {
                                dataView.expandAllGroups();
                            }
                        },
                        itemUsabilityOverride: function () {
                            if (gridOptions.enableTreeData) {
                                return true;
                            }
                            // only enable the command when there's an actually grouping in play
                            var groupingArray = dataView && dataView.getGrouping && dataView.getGrouping();
                            return Array.isArray(groupingArray) && groupingArray.length > 0;
                        }
                    });
                }
            }
        }
        return menuCustomItems;
    };
    /**
     * First get the value, if "exportWithFormatter" is set then we'll use the formatter output
     * Then we create the DOM trick to copy a text value by creating a fake <div> that is not shown to the user
     * and from there we can call the execCommand 'copy' command and expect the value to be in clipboard
     * @param args
     */
    ContextMenuExtension.prototype.copyToClipboard = function (args) {
        try {
            if (args && args.grid && args.command) {
                // get the value, if "exportWithFormatter" is set then we'll use the formatter output
                var gridOptions = this.sharedService && this.sharedService.gridOptions || {};
                var cell = args && args.cell || 0;
                var row = args && args.row || 0;
                var columnDef = args && args.column;
                var dataContext = args && args.dataContext;
                var grid = this.sharedService && this.sharedService.grid;
                var exportOptions = gridOptions && (gridOptions.excelExportOptions || gridOptions.exportOptions);
                var textToCopy = exportWithFormatterWhenDefined(row, cell, dataContext, columnDef, grid, exportOptions);
                if (typeof columnDef.queryFieldNameGetterFn === 'function') {
                    textToCopy = this.getCellValueFromQueryFieldGetter(columnDef, dataContext);
                }
                // create fake <div> to copy into clipboard & delete it from the DOM once we're done
                var range = document.createRange();
                var tmpElem = $('<div>').css({ position: 'absolute', left: '-1000px', top: '-1000px' }).text(textToCopy);
                $('body').append(tmpElem);
                range.selectNodeContents(tmpElem.get(0));
                var selection = window.getSelection();
                if (selection && selection.addRange && selection.removeAllRanges) {
                    selection.removeAllRanges();
                    selection.addRange(range);
                    var success = document.execCommand('copy', false, textToCopy);
                    if (success) {
                        tmpElem.remove();
                    }
                }
            }
        }
        catch (e) { }
    };
    /**
     * When a queryFieldNameGetterFn is defined, then get the value from that getter callback function
     * @param columnDef
     * @param dataContext
     * @return cellValue
     */
    ContextMenuExtension.prototype.getCellValueFromQueryFieldGetter = function (columnDef, dataContext) {
        var cellValue = '';
        if (typeof columnDef.queryFieldNameGetterFn === 'function') {
            var queryFieldName = columnDef.queryFieldNameGetterFn(dataContext);
            // get the cell value from the item or when it's a dot notation then exploded the item and get the final value
            if (queryFieldName && queryFieldName.indexOf('.') >= 0) {
                cellValue = getDescendantProperty(dataContext, queryFieldName);
            }
            else {
                cellValue = dataContext[queryFieldName];
            }
        }
        return cellValue;
    };
    ContextMenuExtension.ctorParameters = function () { return [
        { type: ExcelExportService },
        { type: ExportService },
        { type: ExtensionUtility },
        { type: SharedService },
        { type: TreeDataService },
        { type: TranslateService, decorators: [{ type: Optional }] }
    ]; };
    ContextMenuExtension = tslib_1.__decorate([
        Injectable(),
        tslib_1.__param(5, Optional())
    ], ContextMenuExtension);
    return ContextMenuExtension;
}());
export { ContextMenuExtension };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29udGV4dE1lbnVFeHRlbnNpb24uanMiLCJzb3VyY2VSb290Ijoibmc6Ly9hbmd1bGFyLXNsaWNrZ3JpZC8iLCJzb3VyY2VzIjpbImFwcC9tb2R1bGVzL2FuZ3VsYXItc2xpY2tncmlkL2V4dGVuc2lvbnMvY29udGV4dE1lbnVFeHRlbnNpb24udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsUUFBUSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ3JELE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBRXZELE9BQU8sRUFHTCxhQUFhLEVBRWIsYUFBYSxFQUNiLFFBQVEsR0FNVCxNQUFNLGlCQUFpQixDQUFDO0FBQ3pCLE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBQ3RELE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSw0QkFBNEIsQ0FBQztBQUMzRCxPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0sNEJBQTRCLENBQUM7QUFDM0QsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0saUNBQWlDLENBQUM7QUFDckUsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLDhCQUE4QixDQUFDO0FBQy9ELE9BQU8sRUFBRSw4QkFBOEIsRUFBRSxNQUFNLDhCQUE4QixDQUFDO0FBQzlFLE9BQU8sRUFBRSxxQkFBcUIsRUFBRSxvQkFBb0IsRUFBRSxNQUFNLHVCQUF1QixDQUFDO0FBTXBGO0lBTUUsOEJBQ1Usa0JBQXNDLEVBQ3RDLGFBQTRCLEVBQzVCLGdCQUFrQyxFQUNsQyxhQUE0QixFQUM1QixlQUFnQyxFQUNwQixTQUEyQjtRQUx2Qyx1QkFBa0IsR0FBbEIsa0JBQWtCLENBQW9CO1FBQ3RDLGtCQUFhLEdBQWIsYUFBYSxDQUFlO1FBQzVCLHFCQUFnQixHQUFoQixnQkFBZ0IsQ0FBa0I7UUFDbEMsa0JBQWEsR0FBYixhQUFhLENBQWU7UUFDNUIsb0JBQWUsR0FBZixlQUFlLENBQWlCO1FB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T0FBTyxTQUFTLENBQUMsc0JBQXNCLEtBQUssVUFBVSxFQUFFO1lBQzFELElBQU0sY0FBYyxHQUFHLFNBQVMsQ0FBQyxzQkFBc0IsQ0FBQyxXQUFXLENBQUMsQ0FBQztZQUVyRSw4R0FBOEc7WUFDOUcsSUFBSSxjQUFjLElBQUksY0FBYyxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLEVBQUU7Z0JBQ3RELFNBQVMsR0FBRyxxQkFBcUIsQ0FBQyxXQUFXLEVBQUUsY0FBYyxDQUFDLENBQUM7YUFDaEU7aUJBQU07Z0JBQ0wsU0FBUyxHQUFHLFdBQVcsQ0FBQyxjQUFjLENBQUMsQ0FBQzthQUN6QztTQUNGO1FBRUQsT0FBTyxTQUFTLENBQUM7SUFDbkIsQ0FBQzs7Z0JBclo2QixrQkFBa0I7Z0JBQ3ZCLGFBQWE7Z0JBQ1YsZ0JBQWdCO2dCQUNuQixhQUFhO2dCQUNYLGVBQWU7Z0JBQ1QsZ0JBQWdCLHVCQUE5QyxRQUFROztJQVpBLG9CQUFvQjtRQURoQyxVQUFVLEVBQUU7UUFhUixtQkFBQSxRQUFRLEVBQUUsQ0FBQTtPQVpGLG9CQUFvQixDQTZaaEM7SUFBRCwyQkFBQztDQUFBLEFBN1pELElBNlpDO1NBN1pZLG9CQUFvQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUsIE9wdGlvbmFsIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IFRyYW5zbGF0ZVNlcnZpY2UgfSBmcm9tICdAbmd4LXRyYW5zbGF0ZS9jb3JlJztcclxuXHJcbmltcG9ydCB7XHJcbiAgQ29sdW1uLFxyXG4gIENvbnRleHRNZW51LFxyXG4gIERlbGltaXRlclR5cGUsXHJcbiAgRXh0ZW5zaW9uLFxyXG4gIEV4dGVuc2lvbk5hbWUsXHJcbiAgRmlsZVR5cGUsXHJcbiAgTWVudUNhbGxiYWNrQXJncyxcclxuICBNZW51Q29tbWFuZEl0ZW0sXHJcbiAgTWVudUNvbW1hbmRJdGVtQ2FsbGJhY2tBcmdzLFxyXG4gIE1lbnVPcHRpb25JdGVtQ2FsbGJhY2tBcmdzLFxyXG4gIFNsaWNrRXZlbnRIYW5kbGVyLFxyXG59IGZyb20gJy4uL21vZGVscy9pbmRleCc7XHJcbmltcG9ydCB7IEV4dGVuc2lvblV0aWxpdHkgfSBmcm9tICcuL2V4dGVuc2lvblV0aWxpdHknO1xyXG5pbXBvcnQgeyBTaGFyZWRTZXJ2aWNlIH0gZnJvbSAnLi4vc2VydmljZXMvc2hhcmVkLnNlcnZpY2UnO1xyXG5pbXBvcnQgeyBFeHBvcnRTZXJ2aWNlIH0gZnJvbSAnLi4vc2VydmljZXMvZXhwb3J0LnNlcnZpY2UnO1xyXG5pbXBvcnQgeyBFeGNlbEV4cG9ydFNlcnZpY2UgfSBmcm9tICcuLi9zZXJ2aWNlcy9leGNlbEV4cG9ydC5zZXJ2aWNlJztcclxuaW1wb3J0IHsgVHJlZURhdGFTZXJ2aWNlIH0gZnJvbSAnLi4vc2VydmljZXMvdHJlZURhdGEuc2VydmljZSc7XHJcbmltcG9ydCB7IGV4cG9ydFdpdGhGb3JtYXR0ZXJXaGVuRGVmaW5lZCB9IGZyb20gJy4uL3NlcnZpY2VzL2V4cG9ydC11dGlsaXRpZXMnO1xyXG5pbXBvcnQgeyBnZXREZXNjZW5kYW50UHJvcGVydHksIGdldFRyYW5zbGF0aW9uUHJlZml4IH0gZnJvbSAnLi4vc2VydmljZXMvdXRpbGl0aWVzJztcclxuXHJcbi8vIHVzaW5nIGV4dGVybmFsIG5vbi10eXBlZCBqcyBsaWJyYXJpZXNcclxuZGVjbGFyZSBjb25zdCBTbGljazogYW55O1xyXG5cclxuQEluamVjdGFibGUoKVxyXG5leHBvcnQgY2xhc3MgQ29udGV4dE1lbnVFeHRlbnNpb24gaW1wbGVtZW50cyBFeHRlbnNpb24ge1xyXG4gIHByaXZhdGUgX2FkZG9uOiBhbnk7XHJcbiAgcHJpdmF0ZSBfY29udGV4dE1lbnVPcHRpb25zOiBDb250ZXh0TWVudSB8IG51bGw7XHJcbiAgcHJpdmF0ZSBfZXZlbnRIYW5kbGVyOiBTbGlja0V2ZW50SGFuZGxlcjtcclxuICBwcml2YXRlIF91c2VyT3JpZ2luYWxDb250ZXh0TWVudTogQ29udGV4dE1lbnUgfCB1bmRlZmluZWQ7XHJcblxyXG4gIGNvbnN0cnVjdG9yKFxyXG4gICAgcHJpdmF0ZSBleGNlbEV4cG9ydFNlcnZpY2U6IEV4Y2VsRXhwb3J0U2VydmljZSxcclxuICAgIHByaXZhdGUgZXhwb3J0U2VydmljZTogRXhwb3J0U2VydmljZSxcclxuICAgIHByaXZhdGUgZXh0ZW5zaW9uVXRpbGl0eTogRXh0ZW5zaW9uVXRpbGl0eSxcclxuICAgIHByaXZhdGUgc2hhcmVkU2VydmljZTogU2hhcmVkU2VydmljZSxcclxuICAgIHByaXZhdGUgdHJlZURhdGFTZXJ2aWNlOiBUcmVlRGF0YVNlcnZpY2UsXHJcbiAgICBAT3B0aW9uYWwoKSBwcml2YXRlIHRyYW5zbGF0ZTogVHJhbnNsYXRlU2VydmljZSxcclxuICApIHtcclxuICAgIHRoaXMuX2V2ZW50SGFuZGxlciA9IG5ldyBTbGljay5FdmVudEhhbmRsZXIoKTtcclxuICB9XHJcblxyXG4gIGdldCBldmVudEhhbmRsZXIoKTogU2xpY2tFdmVudEhhbmRsZXIge1xyXG4gICAgcmV0dXJuIHRoaXMuX2V2ZW50SGFuZGxlcjtcclxuICB9XHJcblxyXG4gIGRpc3Bvc2UoKSB7XHJcbiAgICAvLyB1bnN1YnNjcmliZSBhbGwgU2xpY2tHcmlkIGV2ZW50c1xyXG4gICAgdGhpcy5fZXZlbnRIYW5kbGVyLnVuc3Vic2NyaWJlQWxsKCk7XHJcblxyXG4gICAgaWYgKHRoaXMuX2FkZG9uICYmIHRoaXMuX2FkZG9uLmRlc3Ryb3kpIHtcclxuICAgICAgdGhpcy5fYWRkb24uZGVzdHJveSgpO1xyXG4gICAgfVxyXG4gICAgaWYgKHRoaXMuc2hhcmVkU2VydmljZS5ncmlkT3B0aW9ucyAmJiB0aGlzLnNoYXJlZFNlcnZpY2UuZ3JpZE9wdGlvbnMuY29udGV4dE1lbnUgJiYgdGhpcy5zaGFyZWRTZXJ2aWNlLmdyaWRPcHRpb25zLmNvbnRleHRNZW51LmNvbW1hbmRJdGVtcykge1xyXG4gICAgICB0aGlzLnNoYXJlZFNlcnZpY2UuZ3JpZE9wdGlvbnMuY29udGV4dE1lbnUgPSB0aGlzLl91c2VyT3JpZ2luYWxDb250ZXh0TWVudTtcclxuICAgIH1cclxuICAgIHRoaXMuZXh0ZW5zaW9uVXRpbGl0eS5udWxsaWZ5RnVuY3Rpb25OYW1lU3RhcnRpbmdXaXRoT24odGhpcy5fY29udGV4dE1lbnVPcHRpb25zKTtcclxuICAgIHRoaXMuX2FkZG9uID0gbnVsbDtcclxuICAgIHRoaXMuX2NvbnRleHRNZW51T3B0aW9ucyA9IG51bGw7XHJcbiAgfVxyXG5cclxuICAvKiogR2V0IHRoZSBpbnN0YW5jZSBvZiB0aGUgU2xpY2tHcmlkIGFkZG9uIChjb250cm9sIG9yIHBsdWdpbikuICovXHJcbiAgZ2V0QWRkb25JbnN0YW5jZSgpIHtcclxuICAgIHJldHVybiB0aGlzLl9hZGRvbjtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIENyZWF0ZSB0aGUgQWN0aW9uIENlbGwgTWVudSBhbmQgZXhwb3NlIGFsbCB0aGUgYXZhaWxhYmxlIGhvb2tzIHRoYXQgdXNlciBjYW4gc3Vic2NyaWJlIChvbkNvbW1hbmQsIG9uQmVmb3JlTWVudVNob3csIC4uLilcclxuICAgKiBAcGFyYW0gZ3JpZFxyXG4gICAqIEBwYXJhbSBkYXRhVmlld1xyXG4gICAqIEBwYXJhbSBjb2x1bW5EZWZpbml0aW9uc1xyXG4gICAqL1xyXG4gIHJlZ2lzdGVyKCk6IGFueSB7XHJcbiAgICBpZiAodGhpcy5zaGFyZWRTZXJ2aWNlLmdyaWRPcHRpb25zICYmIHRoaXMuc2hhcmVkU2VydmljZS5ncmlkT3B0aW9ucy5lbmFibGVUcmFuc2xhdGUgJiYgKCF0aGlzLnRyYW5zbGF0ZSB8fCAhdGhpcy50cmFuc2xhdGUuaW5zdGFudCkpIHtcclxuICAgICAgdGhyb3cgbmV3IEVycm9yKCdbQW5ndWxhci1TbGlja2dyaWRdIHJlcXVpcmVzIFwibmd4LXRyYW5zbGF0ZVwiIHRvIGJlIGluc3RhbGxlZCBhbmQgY29uZmlndXJlZCB3aGVuIHRoZSBncmlkIG9wdGlvbiBcImVuYWJsZVRyYW5zbGF0ZVwiIGlzIGVuYWJsZWQuJyk7XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKHRoaXMuc2hhcmVkU2VydmljZSAmJiB0aGlzLnNoYXJlZFNlcnZpY2UuZ3JpZCAmJiB0aGlzLnNoYXJlZFNlcnZpY2UuZ3JpZE9wdGlvbnMgJiYgdGhpcy5zaGFyZWRTZXJ2aWNlLmdyaWRPcHRpb25zLmNvbnRleHRNZW51KSB7XHJcbiAgICAgIHRoaXMuX2NvbnRleHRNZW51T3B0aW9ucyA9IHRoaXMuc2hhcmVkU2VydmljZS5ncmlkT3B0aW9ucy5jb250ZXh0TWVudTtcclxuXHJcbiAgICAgIC8vIGtlZXAgb3JpZ2luYWwgdXNlciBjb250ZXh0IG1lbnUsIHVzZWZ1bCB3aGVuIHN3aXRjaGluZyBsb2NhbGUgdG8gdHJhbnNsYXRlXHJcbiAgICAgIHRoaXMuX3VzZXJPcmlnaW5hbENvbnRleHRNZW51ID0geyAuLi50aGlzLl9jb250ZXh0TWVudU9wdGlvbnMgfTtcclxuXHJcbiAgICAgIC8vIGR5bmFtaWNhbGx5IGltcG9ydCB0aGUgU2xpY2tHcmlkIHBsdWdpbiAoYWRkb24pIHdpdGggUmVxdWlyZUpTXHJcbiAgICAgIHRoaXMuZXh0ZW5zaW9uVXRpbGl0eS5sb2FkRXh0ZW5zaW9uRHluYW1pY2FsbHkoRXh0ZW5zaW9uTmFtZS5jb250ZXh0TWVudSk7XHJcblxyXG4gICAgICAvLyBtZXJnZSB0aGUgb3JpZ2luYWwgY29tbWFuZHMgd2l0aCB0aGUgYnVpbHQtaW4gaW50ZXJuYWwgY29tbWFuZHNcclxuICAgICAgY29uc3Qgb3JpZ2luYWxDb21tYW5kSXRlbXMgPSB0aGlzLl91c2VyT3JpZ2luYWxDb250ZXh0TWVudSAmJiBBcnJheS5pc0FycmF5KHRoaXMuX3VzZXJPcmlnaW5hbENvbnRleHRNZW51LmNvbW1hbmRJdGVtcykgPyB0aGlzLl91c2VyT3JpZ2luYWxDb250ZXh0TWVudS5jb21tYW5kSXRlbXMgOiBbXTtcclxuICAgICAgdGhpcy5fY29udGV4dE1lbnVPcHRpb25zLmNvbW1hbmRJdGVtcyA9IFsuLi5vcmlnaW5hbENvbW1hbmRJdGVtcywgLi4udGhpcy5hZGRNZW51Q3VzdG9tQ29tbWFuZHMob3JpZ2luYWxDb21tYW5kSXRlbXMpXTtcclxuICAgICAgdGhpcy5fY29udGV4dE1lbnVPcHRpb25zID0geyAuLi50aGlzLl9jb250ZXh0TWVudU9wdGlvbnMgfTtcclxuICAgICAgdGhpcy5zaGFyZWRTZXJ2aWNlLmdyaWRPcHRpb25zLmNvbnRleHRNZW51ID0gdGhpcy5fY29udGV4dE1lbnVPcHRpb25zO1xyXG5cclxuICAgICAgLy8gc29ydCBhbGwgbWVudSBpdGVtcyBieSB0aGVpciBwb3NpdGlvbiBvcmRlciB3aGVuIGRlZmluZWRcclxuICAgICAgdGhpcy5leHRlbnNpb25VdGlsaXR5LnNvcnRJdGVtcyh0aGlzLl9jb250ZXh0TWVudU9wdGlvbnMuY29tbWFuZEl0ZW1zIHx8IFtdLCAncG9zaXRpb25PcmRlcicpO1xyXG4gICAgICB0aGlzLmV4dGVuc2lvblV0aWxpdHkuc29ydEl0ZW1zKHRoaXMuX2NvbnRleHRNZW51T3B0aW9ucy5vcHRpb25JdGVtcyB8fCBbXSwgJ3Bvc2l0aW9uT3JkZXInKTtcclxuXHJcbiAgICAgIHRoaXMuX2FkZG9uID0gbmV3IFNsaWNrLlBsdWdpbnMuQ29udGV4dE1lbnUodGhpcy5fY29udGV4dE1lbnVPcHRpb25zKTtcclxuICAgICAgdGhpcy5zaGFyZWRTZXJ2aWNlLmdyaWQucmVnaXN0ZXJQbHVnaW4odGhpcy5fYWRkb24pO1xyXG5cclxuICAgICAgLy8gdHJhbnNsYXRlIHRoZSBpdGVtIGtleXMgd2hlbiBuZWNlc3NhcnlcclxuICAgICAgaWYgKHRoaXMuc2hhcmVkU2VydmljZS5ncmlkT3B0aW9ucy5lbmFibGVUcmFuc2xhdGUpIHtcclxuICAgICAgICB0aGlzLnRyYW5zbGF0ZUNvbnRleHRNZW51KCk7XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIC8vIGhvb2sgYWxsIGV2ZW50c1xyXG4gICAgICBpZiAodGhpcy5zaGFyZWRTZXJ2aWNlLmdyaWQgJiYgdGhpcy5fY29udGV4dE1lbnVPcHRpb25zKSB7XHJcbiAgICAgICAgaWYgKHRoaXMuX2NvbnRleHRNZW51T3B0aW9ucy5vbkV4dGVuc2lvblJlZ2lzdGVyZWQpIHtcclxuICAgICAgICAgIHRoaXMuX2NvbnRleHRNZW51T3B0aW9ucy5vbkV4dGVuc2lvblJlZ2lzdGVyZWQodGhpcy5fYWRkb24pO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAodGhpcy5fY29udGV4dE1lbnVPcHRpb25zICYmIHR5cGVvZiB0aGlzLl9jb250ZXh0TWVudU9wdGlvbnMub25Db21tYW5kID09PSAnZnVuY3Rpb24nKSB7XHJcbiAgICAgICAgICB0aGlzLl9ldmVudEhhbmRsZXIuc3Vic2NyaWJlKHRoaXMuX2FkZG9uLm9uQ29tbWFuZCwgKGV2ZW50OiBFdmVudCwgYXJnczogTWVudUNvbW1hbmRJdGVtQ2FsbGJhY2tBcmdzKSA9PiB7XHJcbiAgICAgICAgICAgIHRoaXMuX2NvbnRleHRNZW51T3B0aW9ucy5vbkNvbW1hbmQoZXZlbnQsIGFyZ3MpO1xyXG4gICAgICAgICAgfSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmICh0aGlzLl9jb250ZXh0TWVudU9wdGlvbnMgJiYgdHlwZW9mIHRoaXMuX2NvbnRleHRNZW51T3B0aW9ucy5vbk9wdGlvblNlbGVjdGVkID09PSAnZnVuY3Rpb24nKSB7XHJcbiAgICAgICAgICB0aGlzLl9ldmVudEhhbmRsZXIuc3Vic2NyaWJlKHRoaXMuX2FkZG9uLm9uT3B0aW9uU2VsZWN0ZWQsIChldmVudDogRXZlbnQsIGFyZ3M6IE1lbnVPcHRpb25JdGVtQ2FsbGJhY2tBcmdzKSA9PiB7XHJcbiAgICAgICAgICAgIHRoaXMuX2NvbnRleHRNZW51T3B0aW9ucy5vbk9wdGlvblNlbGVjdGVkKGV2ZW50LCBhcmdzKTtcclxuICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAodGhpcy5fY29udGV4dE1lbnVPcHRpb25zICYmIHR5cGVvZiB0aGlzLl9jb250ZXh0TWVudU9wdGlvbnMub25CZWZvcmVNZW51U2hvdyA9PT0gJ2Z1bmN0aW9uJykge1xyXG4gICAgICAgICAgdGhpcy5fZXZlbnRIYW5kbGVyLnN1YnNjcmliZSh0aGlzLl9hZGRvbi5vbkJlZm9yZU1lbnVTaG93LCAoZXZlbnQ6IEV2ZW50LCBhcmdzOiB7IGNlbGw6IG51bWJlcjsgcm93OiBudW1iZXI7IGdyaWQ6IGFueTsgfSkgPT4ge1xyXG4gICAgICAgICAgICB0aGlzLl9jb250ZXh0TWVudU9wdGlvbnMub25CZWZvcmVNZW51U2hvdyhldmVudCwgYXJncyk7XHJcbiAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKHRoaXMuX2NvbnRleHRNZW51T3B0aW9ucyAmJiB0eXBlb2YgdGhpcy5fY29udGV4dE1lbnVPcHRpb25zLm9uQmVmb3JlTWVudUNsb3NlID09PSAnZnVuY3Rpb24nKSB7XHJcbiAgICAgICAgICB0aGlzLl9ldmVudEhhbmRsZXIuc3Vic2NyaWJlKHRoaXMuX2FkZG9uLm9uQmVmb3JlTWVudUNsb3NlLCAoZXZlbnQ6IEV2ZW50LCBhcmdzOiB7IGNlbGw6IG51bWJlcjsgcm93OiBudW1iZXI7IGdyaWQ6IGFueTsgbWVudTogYW55OyB9KSA9PiB7XHJcbiAgICAgICAgICAgIHRoaXMuX2NvbnRleHRNZW51T3B0aW9ucy5vbkJlZm9yZU1lbnVDbG9zZShldmVudCwgYXJncyk7XHJcbiAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKHRoaXMuX2NvbnRleHRNZW51T3B0aW9ucyAmJiB0eXBlb2YgdGhpcy5fY29udGV4dE1lbnVPcHRpb25zLm9uQWZ0ZXJNZW51U2hvdyA9PT0gJ2Z1bmN0aW9uJykge1xyXG4gICAgICAgICAgdGhpcy5fZXZlbnRIYW5kbGVyLnN1YnNjcmliZSh0aGlzLl9hZGRvbi5vbkFmdGVyTWVudVNob3csIChldmVudDogRXZlbnQsIGFyZ3M6IHsgY2VsbDogbnVtYmVyOyByb3c6IG51bWJlcjsgZ3JpZDogYW55OyB9KSA9PiB7XHJcbiAgICAgICAgICAgIHRoaXMuX2NvbnRleHRNZW51T3B0aW9ucy5vbkFmdGVyTWVudVNob3coZXZlbnQsIGFyZ3MpO1xyXG4gICAgICAgICAgfSk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICAgIHJldHVybiB0aGlzLl9hZGRvbjtcclxuICAgIH1cclxuICAgIHJldHVybiBudWxsO1xyXG4gIH1cclxuXHJcbiAgLyoqIFRyYW5zbGF0ZSB0aGUgQ2VsbCBNZW51IHRpdGxlcywgd2UgbmVlZCB0byBsb29wIHRocm91Z2ggYWxsIGNvbHVtbiBkZWZpbml0aW9uIHRvIHJlLXRyYW5zbGF0ZSB0aGVtICovXHJcbiAgdHJhbnNsYXRlQ29udGV4dE1lbnUoKSB7XHJcbiAgICBpZiAodGhpcy5zaGFyZWRTZXJ2aWNlICYmIHRoaXMuc2hhcmVkU2VydmljZS5ncmlkT3B0aW9ucyAmJiB0aGlzLnNoYXJlZFNlcnZpY2UuZ3JpZE9wdGlvbnMuY29udGV4dE1lbnUpIHtcclxuICAgICAgY29uc3QgY29udGV4dE1lbnUgPSB0aGlzLnNoYXJlZFNlcnZpY2UuZ3JpZE9wdGlvbnMuY29udGV4dE1lbnU7XHJcbiAgICAgIGNvbnN0IG1lbnVPcHRpb25zOiBQYXJ0aWFsPENvbnRleHRNZW51PiA9IHt9O1xyXG5cclxuICAgICAgaWYgKGNvbnRleHRNZW51LmNvbW1hbmRUaXRsZUtleSkge1xyXG4gICAgICAgIGNvbnRleHRNZW51LmNvbW1hbmRUaXRsZSA9IHRoaXMudHJhbnNsYXRlICYmIHRoaXMudHJhbnNsYXRlLmN1cnJlbnRMYW5nICYmIHRoaXMudHJhbnNsYXRlLmluc3RhbnQgJiYgdGhpcy50cmFuc2xhdGUuaW5zdGFudChjb250ZXh0TWVudS5jb21tYW5kVGl0bGVLZXkpIHx8IGNvbnRleHRNZW51LmNvbW1hbmRUaXRsZTtcclxuICAgICAgICBtZW51T3B0aW9ucy5jb21tYW5kVGl0bGUgPSBjb250ZXh0TWVudS5jb21tYW5kVGl0bGU7XHJcbiAgICAgIH1cclxuICAgICAgaWYgKGNvbnRleHRNZW51Lm9wdGlvblRpdGxlS2V5KSB7XHJcbiAgICAgICAgY29udGV4dE1lbnUub3B0aW9uVGl0bGUgPSB0aGlzLnRyYW5zbGF0ZSAmJiB0aGlzLnRyYW5zbGF0ZS5jdXJyZW50TGFuZyAmJiB0aGlzLnRyYW5zbGF0ZS5pbnN0YW50ICYmIHRoaXMudHJhbnNsYXRlLmluc3RhbnQoY29udGV4dE1lbnUub3B0aW9uVGl0bGVLZXkpIHx8IGNvbnRleHRNZW51Lm9wdGlvblRpdGxlO1xyXG4gICAgICAgIG1lbnVPcHRpb25zLm9wdGlvblRpdGxlID0gY29udGV4dE1lbnUub3B0aW9uVGl0bGU7XHJcbiAgICAgIH1cclxuICAgICAgY29uc3Qgb3JpZ2luYWxDb21tYW5kSXRlbXMgPSB0aGlzLl91c2VyT3JpZ2luYWxDb250ZXh0TWVudSAmJiBBcnJheS5pc0FycmF5KHRoaXMuX3VzZXJPcmlnaW5hbENvbnRleHRNZW51LmNvbW1hbmRJdGVtcykgPyB0aGlzLl91c2VyT3JpZ2luYWxDb250ZXh0TWVudS5jb21tYW5kSXRlbXMgOiBbXTtcclxuICAgICAgY29udGV4dE1lbnUuY29tbWFuZEl0ZW1zID0gWy4uLm9yaWdpbmFsQ29tbWFuZEl0ZW1zLCAuLi50aGlzLmFkZE1lbnVDdXN0b21Db21tYW5kcyhvcmlnaW5hbENvbW1hbmRJdGVtcyldO1xyXG4gICAgICBtZW51T3B0aW9ucy5jb21tYW5kSXRlbXMgPSBjb250ZXh0TWVudS5jb21tYW5kSXRlbXM7IC8vIGNvcHkgaXQgYWxzbyB0byB0aGUgbWVudU9wdGlvbnMgZWxzZSB0aGV5IHdvbid0IGJlIHRyYW5zbGF0ZWQgd2hlbiBsb2NhbGUgY2hhbmdlc1xyXG5cclxuICAgICAgLy8gdHJhbnNsYXRlIGFsbCBjb21tYW5kL29wdGlvbnMgYW5kIHJlc29ydCB0aGVtIGFmdGVyd2FyZFxyXG4gICAgICB0aGlzLmV4dGVuc2lvblV0aWxpdHkudHJhbnNsYXRlSXRlbXMoY29udGV4dE1lbnUuY29tbWFuZEl0ZW1zIHx8IFtdLCAndGl0bGVLZXknLCAndGl0bGUnKTtcclxuICAgICAgdGhpcy5leHRlbnNpb25VdGlsaXR5LnRyYW5zbGF0ZUl0ZW1zKGNvbnRleHRNZW51Lm9wdGlvbkl0ZW1zIHx8IFtdLCAndGl0bGVLZXknLCAndGl0bGUnKTtcclxuICAgICAgdGhpcy5leHRlbnNpb25VdGlsaXR5LnNvcnRJdGVtcyhjb250ZXh0TWVudS5jb21tYW5kSXRlbXMgfHwgW10sICdwb3NpdGlvbk9yZGVyJyk7XHJcbiAgICAgIHRoaXMuZXh0ZW5zaW9uVXRpbGl0eS5zb3J0SXRlbXMoY29udGV4dE1lbnUub3B0aW9uSXRlbXMgfHwgW10sICdwb3NpdGlvbk9yZGVyJyk7XHJcblxyXG4gICAgICAvLyB1cGRhdGUgdGhlIHRpdGxlIG9wdGlvbnMgc28gdGhhdCBpdCBoYXMgbGF0ZXN0IHRyYW5zbGF0ZWQgdmFsdWVzXHJcbiAgICAgIGlmICh0aGlzLl9hZGRvbiAmJiB0aGlzLl9hZGRvbi5zZXRPcHRpb25zKSB7XHJcbiAgICAgICAgdGhpcy5fYWRkb24uc2V0T3B0aW9ucyhtZW51T3B0aW9ucyk7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8vIC0tXHJcbiAgLy8gcHJpdmF0ZSBmdW5jdGlvbnNcclxuICAvLyAtLS0tLS0tLS0tLS0tLS0tLS1cclxuXHJcbiAgLyoqIENyZWF0ZSBDb250ZXh0IE1lbnUgd2l0aCBDdXN0b20gQ29tbWFuZHMgKGNvcHkgY2VsbCB2YWx1ZSwgZXhwb3J0KSAqL1xyXG4gIHByaXZhdGUgYWRkTWVudUN1c3RvbUNvbW1hbmRzKG9yaWdpbmFsQ3VzdG9tSXRlbXM6IEFycmF5PE1lbnVDb21tYW5kSXRlbSB8ICdkaXZpZGVyJz4pIHtcclxuICAgIGNvbnN0IG1lbnVDdXN0b21JdGVtczogQXJyYXk8TWVudUNvbW1hbmRJdGVtIHwgJ2RpdmlkZXInPiA9IFtdO1xyXG4gICAgY29uc3QgZ3JpZE9wdGlvbnMgPSB0aGlzLnNoYXJlZFNlcnZpY2UgJiYgdGhpcy5zaGFyZWRTZXJ2aWNlLmdyaWRPcHRpb25zIHx8IHt9O1xyXG4gICAgY29uc3QgY29udGV4dE1lbnUgPSBncmlkT3B0aW9ucyAmJiBncmlkT3B0aW9ucy5jb250ZXh0TWVudTtcclxuICAgIGNvbnN0IGRhdGFWaWV3ID0gdGhpcy5zaGFyZWRTZXJ2aWNlICYmIHRoaXMuc2hhcmVkU2VydmljZS5kYXRhVmlldztcclxuICAgIGNvbnN0IHRyYW5zbGF0aW9uUHJlZml4ID0gZ2V0VHJhbnNsYXRpb25QcmVmaXgoZ3JpZE9wdGlvbnMpO1xyXG5cclxuICAgIC8vIHNob3cgY29udGV4dCBtZW51OiBDb3B5IChjZWxsIHZhbHVlKVxyXG4gICAgaWYgKGNvbnRleHRNZW51ICYmICFjb250ZXh0TWVudS5oaWRlQ29weUNlbGxWYWx1ZUNvbW1hbmQpIHtcclxuICAgICAgY29uc3QgY29tbWFuZE5hbWUgPSAnY29weSc7XHJcbiAgICAgIGlmICghb3JpZ2luYWxDdXN0b21JdGVtcy5maW5kKChpdGVtOiBNZW51Q29tbWFuZEl0ZW0pID0+IGl0ZW0uaGFzT3duUHJvcGVydHkoJ2NvbW1hbmQnKSAmJiBpdGVtLmNvbW1hbmQgPT09IGNvbW1hbmROYW1lKSkge1xyXG4gICAgICAgIG1lbnVDdXN0b21JdGVtcy5wdXNoKFxyXG4gICAgICAgICAge1xyXG4gICAgICAgICAgICBpY29uQ3NzQ2xhc3M6IGNvbnRleHRNZW51Lmljb25Db3B5Q2VsbFZhbHVlQ29tbWFuZCB8fCAnZmEgZmEtY2xvbmUnLFxyXG4gICAgICAgICAgICB0aXRsZTogdGhpcy5leHRlbnNpb25VdGlsaXR5LnRyYW5zbGF0ZVdoZW5FbmFibGVkQW5kU2VydmljZUV4aXN0KGAke3RyYW5zbGF0aW9uUHJlZml4fUNPUFlgLCAnVEVYVF9DT1BZJyksXHJcbiAgICAgICAgICAgIGRpc2FibGVkOiBmYWxzZSxcclxuICAgICAgICAgICAgY29tbWFuZDogY29tbWFuZE5hbWUsXHJcbiAgICAgICAgICAgIHBvc2l0aW9uT3JkZXI6IDUwLFxyXG4gICAgICAgICAgICBhY3Rpb246IChlOiBFdmVudCwgYXJnczogTWVudUNvbW1hbmRJdGVtQ2FsbGJhY2tBcmdzKSA9PiB7XHJcbiAgICAgICAgICAgICAgdGhpcy5jb3B5VG9DbGlwYm9hcmQoYXJncyk7XHJcbiAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgIGl0ZW1Vc2FiaWxpdHlPdmVycmlkZTogKGFyZ3M6IE1lbnVDYWxsYmFja0FyZ3MpID0+IHtcclxuICAgICAgICAgICAgICAvLyBtYWtlIHN1cmUgdGhlcmUncyBhbiBpdGVtIHRvIGNvcHkgYmVmb3JlIGVuYWJsaW5nIHRoaXMgY29tbWFuZFxyXG4gICAgICAgICAgICAgIGNvbnN0IGNvbHVtbkRlZiA9IGFyZ3MgJiYgYXJncy5jb2x1bW4gYXMgQ29sdW1uO1xyXG4gICAgICAgICAgICAgIGNvbnN0IGRhdGFDb250ZXh0ID0gYXJncyAmJiBhcmdzLmRhdGFDb250ZXh0O1xyXG4gICAgICAgICAgICAgIGlmICh0eXBlb2YgY29sdW1uRGVmLnF1ZXJ5RmllbGROYW1lR2V0dGVyRm4gPT09ICdmdW5jdGlvbicpIHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGNlbGxWYWx1ZSA9IHRoaXMuZ2V0Q2VsbFZhbHVlRnJvbVF1ZXJ5RmllbGRHZXR0ZXIoY29sdW1uRGVmLCBkYXRhQ29udGV4dCk7XHJcbiAgICAgICAgICAgICAgICBpZiAoY2VsbFZhbHVlICE9PSAnJyAmJiBjZWxsVmFsdWUgIT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICB9IGVsc2UgaWYgKGNvbHVtbkRlZiAmJiBkYXRhQ29udGV4dC5oYXNPd25Qcm9wZXJ0eShjb2x1bW5EZWYuZmllbGQpKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gZGF0YUNvbnRleHRbY29sdW1uRGVmLmZpZWxkXSAhPT0gJycgJiYgZGF0YUNvbnRleHRbY29sdW1uRGVmLmZpZWxkXSAhPT0gbnVsbCAmJiBkYXRhQ29udGV4dFtjb2x1bW5EZWYuZmllbGRdICE9PSB1bmRlZmluZWQ7XHJcbiAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgfVxyXG4gICAgICAgICk7XHJcbiAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICAvLyBzaG93IGNvbnRleHQgbWVudTogRXhwb3J0IHRvIGZpbGVcclxuICAgIGlmIChncmlkT3B0aW9ucyAmJiBncmlkT3B0aW9ucy5lbmFibGVFeHBvcnQgJiYgY29udGV4dE1lbnUgJiYgIWNvbnRleHRNZW51LmhpZGVFeHBvcnRDc3ZDb21tYW5kKSB7XHJcbiAgICAgIGNvbnN0IGNvbW1hbmROYW1lID0gJ2V4cG9ydC1jc3YnO1xyXG4gICAgICBpZiAoIW9yaWdpbmFsQ3VzdG9tSXRlbXMuZmluZCgoaXRlbTogTWVudUNvbW1hbmRJdGVtKSA9PiBpdGVtLmhhc093blByb3BlcnR5KCdjb21tYW5kJykgJiYgaXRlbS5jb21tYW5kID09PSBjb21tYW5kTmFtZSkpIHtcclxuICAgICAgICBtZW51Q3VzdG9tSXRlbXMucHVzaChcclxuICAgICAgICAgIHtcclxuICAgICAgICAgICAgaWNvbkNzc0NsYXNzOiBjb250ZXh0TWVudS5pY29uRXhwb3J0Q3N2Q29tbWFuZCB8fCAnZmEgZmEtZG93bmxvYWQnLFxyXG4gICAgICAgICAgICB0aXRsZTogdGhpcy5leHRlbnNpb25VdGlsaXR5LnRyYW5zbGF0ZVdoZW5FbmFibGVkQW5kU2VydmljZUV4aXN0KGAke3RyYW5zbGF0aW9uUHJlZml4fUVYUE9SVF9UT19DU1ZgLCAnVEVYVF9FWFBPUlRfVE9fQ1NWJyksXHJcbiAgICAgICAgICAgIGRpc2FibGVkOiBmYWxzZSxcclxuICAgICAgICAgICAgY29tbWFuZDogY29tbWFuZE5hbWUsXHJcbiAgICAgICAgICAgIHBvc2l0aW9uT3JkZXI6IDUxLFxyXG4gICAgICAgICAgICBhY3Rpb246ICgpID0+IHRoaXMuZXhwb3J0U2VydmljZS5leHBvcnRUb0ZpbGUoe1xyXG4gICAgICAgICAgICAgIGRlbGltaXRlcjogRGVsaW1pdGVyVHlwZS5jb21tYSxcclxuICAgICAgICAgICAgICBmaWxlbmFtZTogJ2V4cG9ydCcsXHJcbiAgICAgICAgICAgICAgZm9ybWF0OiBGaWxlVHlwZS5jc3YsXHJcbiAgICAgICAgICAgICAgdXNlVXRmOFdpdGhCb206IHRydWUsXHJcbiAgICAgICAgICAgIH0pLFxyXG4gICAgICAgICAgfVxyXG4gICAgICAgICk7XHJcbiAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICAvLyBzaG93IGNvbnRleHQgbWVudTogRXhwb3J0IHRvIEV4Y2VsXHJcbiAgICBpZiAoZ3JpZE9wdGlvbnMgJiYgZ3JpZE9wdGlvbnMuZW5hYmxlRXhjZWxFeHBvcnQgJiYgY29udGV4dE1lbnUgJiYgIWNvbnRleHRNZW51LmhpZGVFeHBvcnRFeGNlbENvbW1hbmQpIHtcclxuICAgICAgY29uc3QgY29tbWFuZE5hbWUgPSAnZXhwb3J0LWV4Y2VsJztcclxuICAgICAgaWYgKCFvcmlnaW5hbEN1c3RvbUl0ZW1zLmZpbmQoKGl0ZW06IE1lbnVDb21tYW5kSXRlbSkgPT4gaXRlbS5oYXNPd25Qcm9wZXJ0eSgnY29tbWFuZCcpICYmIGl0ZW0uY29tbWFuZCA9PT0gY29tbWFuZE5hbWUpKSB7XHJcbiAgICAgICAgbWVudUN1c3RvbUl0ZW1zLnB1c2goXHJcbiAgICAgICAgICB7XHJcbiAgICAgICAgICAgIGljb25Dc3NDbGFzczogY29udGV4dE1lbnUuaWNvbkV4cG9ydEV4Y2VsQ29tbWFuZCB8fCAnZmEgZmEtZmlsZS1leGNlbC1vIHRleHQtc3VjY2VzcycsXHJcbiAgICAgICAgICAgIHRpdGxlOiB0aGlzLmV4dGVuc2lvblV0aWxpdHkudHJhbnNsYXRlV2hlbkVuYWJsZWRBbmRTZXJ2aWNlRXhpc3QoYCR7dHJhbnNsYXRpb25QcmVmaXh9RVhQT1JUX1RPX0VYQ0VMYCwgJ1RFWFRfRVhQT1JUX1RPX0VYQ0VMJyksXHJcbiAgICAgICAgICAgIGRpc2FibGVkOiBmYWxzZSxcclxuICAgICAgICAgICAgY29tbWFuZDogY29tbWFuZE5hbWUsXHJcbiAgICAgICAgICAgIHBvc2l0aW9uT3JkZXI6IDUyLFxyXG4gICAgICAgICAgICBhY3Rpb246ICgpID0+IHRoaXMuZXhjZWxFeHBvcnRTZXJ2aWNlLmV4cG9ydFRvRXhjZWwoe1xyXG4gICAgICAgICAgICAgIGZpbGVuYW1lOiAnZXhwb3J0JyxcclxuICAgICAgICAgICAgICBmb3JtYXQ6IEZpbGVUeXBlLnhsc3gsXHJcbiAgICAgICAgICAgIH0pLFxyXG4gICAgICAgICAgfVxyXG4gICAgICAgICk7XHJcbiAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICAvLyBzaG93IGNvbnRleHQgbWVudTogZXhwb3J0IHRvIHRleHQgZmlsZSBhcyB0YWIgZGVsaW1pdGVkXHJcbiAgICBpZiAoZ3JpZE9wdGlvbnMgJiYgZ3JpZE9wdGlvbnMuZW5hYmxlRXhwb3J0ICYmIGNvbnRleHRNZW51ICYmICFjb250ZXh0TWVudS5oaWRlRXhwb3J0VGV4dERlbGltaXRlZENvbW1hbmQpIHtcclxuICAgICAgY29uc3QgY29tbWFuZE5hbWUgPSAnZXhwb3J0LXRleHQtZGVsaW1pdGVkJztcclxuICAgICAgaWYgKCFvcmlnaW5hbEN1c3RvbUl0ZW1zLmZpbmQoKGl0ZW06IE1lbnVDb21tYW5kSXRlbSkgPT4gaXRlbS5oYXNPd25Qcm9wZXJ0eSgnY29tbWFuZCcpICYmIGl0ZW0uY29tbWFuZCA9PT0gY29tbWFuZE5hbWUpKSB7XHJcbiAgICAgICAgbWVudUN1c3RvbUl0ZW1zLnB1c2goXHJcbiAgICAgICAgICB7XHJcbiAgICAgICAgICAgIGljb25Dc3NDbGFzczogY29udGV4dE1lbnUuaWNvbkV4cG9ydFRleHREZWxpbWl0ZWRDb21tYW5kIHx8ICdmYSBmYS1kb3dubG9hZCcsXHJcbiAgICAgICAgICAgIHRpdGxlOiB0aGlzLmV4dGVuc2lvblV0aWxpdHkudHJhbnNsYXRlV2hlbkVuYWJsZWRBbmRTZXJ2aWNlRXhpc3QoYCR7dHJhbnNsYXRpb25QcmVmaXh9RVhQT1JUX1RPX1RBQl9ERUxJTUlURURgLCAnVEVYVF9FWFBPUlRfVE9fVEFCX0RFTElNSVRFRCcpLFxyXG4gICAgICAgICAgICBkaXNhYmxlZDogZmFsc2UsXHJcbiAgICAgICAgICAgIGNvbW1hbmQ6IGNvbW1hbmROYW1lLFxyXG4gICAgICAgICAgICBwb3NpdGlvbk9yZGVyOiA1MyxcclxuICAgICAgICAgICAgYWN0aW9uOiAoKSA9PiB0aGlzLmV4cG9ydFNlcnZpY2UuZXhwb3J0VG9GaWxlKHtcclxuICAgICAgICAgICAgICBkZWxpbWl0ZXI6IERlbGltaXRlclR5cGUudGFiLFxyXG4gICAgICAgICAgICAgIGZpbGVuYW1lOiAnZXhwb3J0JyxcclxuICAgICAgICAgICAgICBmb3JtYXQ6IEZpbGVUeXBlLnR4dCxcclxuICAgICAgICAgICAgICB1c2VVdGY4V2l0aEJvbTogdHJ1ZSxcclxuICAgICAgICAgICAgfSksXHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgKTtcclxuICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIC8vIC0tIEdyb3VwaW5nIENvbW1hbmRzXHJcbiAgICBpZiAoZ3JpZE9wdGlvbnMgJiYgKGdyaWRPcHRpb25zLmVuYWJsZUdyb3VwaW5nIHx8IGdyaWRPcHRpb25zLmVuYWJsZURyYWdnYWJsZUdyb3VwaW5nIHx8IGdyaWRPcHRpb25zLmVuYWJsZVRyZWVEYXRhKSkge1xyXG4gICAgICAvLyBhZGQgYSBkaXZpZGVyIChzZXBhcmF0b3IpIGJldHdlZW4gdGhlIHRvcCBzb3J0IGNvbW1hbmRzIGFuZCB0aGUgb3RoZXIgY2xlYXIgY29tbWFuZHNcclxuICAgICAgaWYgKGNvbnRleHRNZW51ICYmICFjb250ZXh0TWVudS5oaWRlQ29weUNlbGxWYWx1ZUNvbW1hbmQpIHtcclxuICAgICAgICBtZW51Q3VzdG9tSXRlbXMucHVzaCh7IGRpdmlkZXI6IHRydWUsIGNvbW1hbmQ6ICcnLCBwb3NpdGlvbk9yZGVyOiA1NCB9KTtcclxuICAgICAgfVxyXG5cclxuICAgICAgLy8gc2hvdyBjb250ZXh0IG1lbnU6IENsZWFyIEdyb3VwaW5nXHJcbiAgICAgIGlmIChncmlkT3B0aW9ucyAmJiAhZ3JpZE9wdGlvbnMuZW5hYmxlVHJlZURhdGEgJiYgY29udGV4dE1lbnUgJiYgIWNvbnRleHRNZW51LmhpZGVDbGVhckFsbEdyb3VwaW5nKSB7XHJcbiAgICAgICAgY29uc3QgY29tbWFuZE5hbWUgPSAnY2xlYXItZ3JvdXBpbmcnO1xyXG4gICAgICAgIGlmICghb3JpZ2luYWxDdXN0b21JdGVtcy5maW5kKChpdGVtOiBNZW51Q29tbWFuZEl0ZW0pID0+IGl0ZW0uaGFzT3duUHJvcGVydHkoJ2NvbW1hbmQnKSAmJiBpdGVtLmNvbW1hbmQgPT09IGNvbW1hbmROYW1lKSkge1xyXG4gICAgICAgICAgbWVudUN1c3RvbUl0ZW1zLnB1c2goXHJcbiAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICBpY29uQ3NzQ2xhc3M6IGNvbnRleHRNZW51Lmljb25DbGVhckdyb3VwaW5nQ29tbWFuZCB8fCAnZmEgZmEtdGltZXMnLFxyXG4gICAgICAgICAgICAgIHRpdGxlOiB0aGlzLmV4dGVuc2lvblV0aWxpdHkudHJhbnNsYXRlV2hlbkVuYWJsZWRBbmRTZXJ2aWNlRXhpc3QoYCR7dHJhbnNsYXRpb25QcmVmaXh9Q0xFQVJfQUxMX0dST1VQSU5HYCwgJ1RFWFRfQ0xFQVJfQUxMX0dST1VQSU5HJyksXHJcbiAgICAgICAgICAgICAgZGlzYWJsZWQ6IGZhbHNlLFxyXG4gICAgICAgICAgICAgIGNvbW1hbmQ6IGNvbW1hbmROYW1lLFxyXG4gICAgICAgICAgICAgIHBvc2l0aW9uT3JkZXI6IDU1LFxyXG4gICAgICAgICAgICAgIGFjdGlvbjogKCkgPT4gZGF0YVZpZXcuc2V0R3JvdXBpbmcoW10pLFxyXG4gICAgICAgICAgICAgIGl0ZW1Vc2FiaWxpdHlPdmVycmlkZTogKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgLy8gb25seSBlbmFibGUgdGhlIGNvbW1hbmQgd2hlbiB0aGVyZSdzIGFuIGFjdHVhbGx5IGdyb3VwaW5nIGluIHBsYXlcclxuICAgICAgICAgICAgICAgIGNvbnN0IGdyb3VwaW5nQXJyYXkgPSBkYXRhVmlldyAmJiBkYXRhVmlldy5nZXRHcm91cGluZyAmJiBkYXRhVmlldy5nZXRHcm91cGluZygpO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIEFycmF5LmlzQXJyYXkoZ3JvdXBpbmdBcnJheSkgJiYgZ3JvdXBpbmdBcnJheS5sZW5ndGggPiAwO1xyXG4gICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgKTtcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIC8vIHNob3cgY29udGV4dCBtZW51OiBDb2xsYXBzZSBhbGwgR3JvdXBzXHJcbiAgICAgIGlmIChncmlkT3B0aW9ucyAmJiBjb250ZXh0TWVudSAmJiAhY29udGV4dE1lbnUuaGlkZUNvbGxhcHNlQWxsR3JvdXBzKSB7XHJcbiAgICAgICAgY29uc3QgY29tbWFuZE5hbWUgPSAnY29sbGFwc2UtYWxsLWdyb3Vwcyc7XHJcbiAgICAgICAgaWYgKCFvcmlnaW5hbEN1c3RvbUl0ZW1zLmZpbmQoKGl0ZW06IE1lbnVDb21tYW5kSXRlbSkgPT4gaXRlbS5oYXNPd25Qcm9wZXJ0eSgnY29tbWFuZCcpICYmIGl0ZW0uY29tbWFuZCA9PT0gY29tbWFuZE5hbWUpKSB7XHJcbiAgICAgICAgICBtZW51Q3VzdG9tSXRlbXMucHVzaChcclxuICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgIGljb25Dc3NDbGFzczogY29udGV4dE1lbnUuaWNvbkNvbGxhcHNlQWxsR3JvdXBzQ29tbWFuZCB8fCAnZmEgZmEtY29tcHJlc3MnLFxyXG4gICAgICAgICAgICAgIHRpdGxlOiB0aGlzLmV4dGVuc2lvblV0aWxpdHkudHJhbnNsYXRlV2hlbkVuYWJsZWRBbmRTZXJ2aWNlRXhpc3QoYCR7dHJhbnNsYXRpb25QcmVmaXh9Q09MTEFQU0VfQUxMX0dST1VQU2AsICdURVhUX0NPTExBUFNFX0FMTF9HUk9VUFMnKSxcclxuICAgICAgICAgICAgICBkaXNhYmxlZDogZmFsc2UsXHJcbiAgICAgICAgICAgICAgY29tbWFuZDogY29tbWFuZE5hbWUsXHJcbiAgICAgICAgICAgICAgcG9zaXRpb25PcmRlcjogNTYsXHJcbiAgICAgICAgICAgICAgYWN0aW9uOiAoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBpZiAoZ3JpZE9wdGlvbnMuZW5hYmxlVHJlZURhdGEpIHtcclxuICAgICAgICAgICAgICAgICAgdGhpcy50cmVlRGF0YVNlcnZpY2UudG9nZ2xlVHJlZURhdGFDb2xsYXBzZSh0cnVlKTtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgIGRhdGFWaWV3LmNvbGxhcHNlQWxsR3JvdXBzKCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICBpdGVtVXNhYmlsaXR5T3ZlcnJpZGU6ICgpID0+IHtcclxuICAgICAgICAgICAgICAgIGlmIChncmlkT3B0aW9ucy5lbmFibGVUcmVlRGF0YSkge1xyXG4gICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIC8vIG9ubHkgZW5hYmxlIHRoZSBjb21tYW5kIHdoZW4gdGhlcmUncyBhbiBhY3R1YWxseSBncm91cGluZyBpbiBwbGF5XHJcbiAgICAgICAgICAgICAgICBjb25zdCBncm91cGluZ0FycmF5ID0gZGF0YVZpZXcgJiYgZGF0YVZpZXcuZ2V0R3JvdXBpbmcgJiYgZGF0YVZpZXcuZ2V0R3JvdXBpbmcoKTtcclxuICAgICAgICAgICAgICAgIHJldHVybiBBcnJheS5pc0FycmF5KGdyb3VwaW5nQXJyYXkpICYmIGdyb3VwaW5nQXJyYXkubGVuZ3RoID4gMDtcclxuICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcblxyXG4gICAgICAvLyBzaG93IGNvbnRleHQgbWVudTogRXhwYW5kIGFsbCBHcm91cHNcclxuICAgICAgaWYgKGdyaWRPcHRpb25zICYmIGNvbnRleHRNZW51ICYmICFjb250ZXh0TWVudS5oaWRlRXhwYW5kQWxsR3JvdXBzKSB7XHJcbiAgICAgICAgY29uc3QgY29tbWFuZE5hbWUgPSAnZXhwYW5kLWFsbC1ncm91cHMnO1xyXG4gICAgICAgIGlmICghb3JpZ2luYWxDdXN0b21JdGVtcy5maW5kKChpdGVtOiBNZW51Q29tbWFuZEl0ZW0pID0+IGl0ZW0uaGFzT3duUHJvcGVydHkoJ2NvbW1hbmQnKSAmJiBpdGVtLmNvbW1hbmQgPT09IGNvbW1hbmROYW1lKSkge1xyXG4gICAgICAgICAgbWVudUN1c3RvbUl0ZW1zLnB1c2goXHJcbiAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICBpY29uQ3NzQ2xhc3M6IGNvbnRleHRNZW51Lmljb25FeHBhbmRBbGxHcm91cHNDb21tYW5kIHx8ICdmYSBmYS1leHBhbmQnLFxyXG4gICAgICAgICAgICAgIHRpdGxlOiB0aGlzLmV4dGVuc2lvblV0aWxpdHkudHJhbnNsYXRlV2hlbkVuYWJsZWRBbmRTZXJ2aWNlRXhpc3QoYCR7dHJhbnNsYXRpb25QcmVmaXh9RVhQQU5EX0FMTF9HUk9VUFNgLCAnVEVYVF9FWFBBTkRfQUxMX0dST1VQUycpLFxyXG4gICAgICAgICAgICAgIGRpc2FibGVkOiBmYWxzZSxcclxuICAgICAgICAgICAgICBjb21tYW5kOiBjb21tYW5kTmFtZSxcclxuICAgICAgICAgICAgICBwb3NpdGlvbk9yZGVyOiA1NyxcclxuICAgICAgICAgICAgICBhY3Rpb246ICgpID0+IHtcclxuICAgICAgICAgICAgICAgIGlmIChncmlkT3B0aW9ucy5lbmFibGVUcmVlRGF0YSkge1xyXG4gICAgICAgICAgICAgICAgICB0aGlzLnRyZWVEYXRhU2VydmljZS50b2dnbGVUcmVlRGF0YUNvbGxhcHNlKGZhbHNlKTtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgIGRhdGFWaWV3LmV4cGFuZEFsbEdyb3VwcygpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgaXRlbVVzYWJpbGl0eU92ZXJyaWRlOiAoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBpZiAoZ3JpZE9wdGlvbnMuZW5hYmxlVHJlZURhdGEpIHtcclxuICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAvLyBvbmx5IGVuYWJsZSB0aGUgY29tbWFuZCB3aGVuIHRoZXJlJ3MgYW4gYWN0dWFsbHkgZ3JvdXBpbmcgaW4gcGxheVxyXG4gICAgICAgICAgICAgICAgY29uc3QgZ3JvdXBpbmdBcnJheSA9IGRhdGFWaWV3ICYmIGRhdGFWaWV3LmdldEdyb3VwaW5nICYmIGRhdGFWaWV3LmdldEdyb3VwaW5nKCk7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gQXJyYXkuaXNBcnJheShncm91cGluZ0FycmF5KSAmJiBncm91cGluZ0FycmF5Lmxlbmd0aCA+IDA7XHJcbiAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICApO1xyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHJldHVybiBtZW51Q3VzdG9tSXRlbXM7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBGaXJzdCBnZXQgdGhlIHZhbHVlLCBpZiBcImV4cG9ydFdpdGhGb3JtYXR0ZXJcIiBpcyBzZXQgdGhlbiB3ZSdsbCB1c2UgdGhlIGZvcm1hdHRlciBvdXRwdXRcclxuICAgKiBUaGVuIHdlIGNyZWF0ZSB0aGUgRE9NIHRyaWNrIHRvIGNvcHkgYSB0ZXh0IHZhbHVlIGJ5IGNyZWF0aW5nIGEgZmFrZSA8ZGl2PiB0aGF0IGlzIG5vdCBzaG93biB0byB0aGUgdXNlclxyXG4gICAqIGFuZCBmcm9tIHRoZXJlIHdlIGNhbiBjYWxsIHRoZSBleGVjQ29tbWFuZCAnY29weScgY29tbWFuZCBhbmQgZXhwZWN0IHRoZSB2YWx1ZSB0byBiZSBpbiBjbGlwYm9hcmRcclxuICAgKiBAcGFyYW0gYXJnc1xyXG4gICAqL1xyXG4gIHByaXZhdGUgY29weVRvQ2xpcGJvYXJkKGFyZ3M6IE1lbnVDb21tYW5kSXRlbUNhbGxiYWNrQXJncykge1xyXG4gICAgdHJ5IHtcclxuICAgICAgaWYgKGFyZ3MgJiYgYXJncy5ncmlkICYmIGFyZ3MuY29tbWFuZCkge1xyXG4gICAgICAgIC8vIGdldCB0aGUgdmFsdWUsIGlmIFwiZXhwb3J0V2l0aEZvcm1hdHRlclwiIGlzIHNldCB0aGVuIHdlJ2xsIHVzZSB0aGUgZm9ybWF0dGVyIG91dHB1dFxyXG4gICAgICAgIGNvbnN0IGdyaWRPcHRpb25zID0gdGhpcy5zaGFyZWRTZXJ2aWNlICYmIHRoaXMuc2hhcmVkU2VydmljZS5ncmlkT3B0aW9ucyB8fCB7fTtcclxuICAgICAgICBjb25zdCBjZWxsID0gYXJncyAmJiBhcmdzLmNlbGwgfHwgMDtcclxuICAgICAgICBjb25zdCByb3cgPSBhcmdzICYmIGFyZ3Mucm93IHx8IDA7XHJcbiAgICAgICAgY29uc3QgY29sdW1uRGVmID0gYXJncyAmJiBhcmdzLmNvbHVtbjtcclxuICAgICAgICBjb25zdCBkYXRhQ29udGV4dCA9IGFyZ3MgJiYgYXJncy5kYXRhQ29udGV4dDtcclxuICAgICAgICBjb25zdCBncmlkID0gdGhpcy5zaGFyZWRTZXJ2aWNlICYmIHRoaXMuc2hhcmVkU2VydmljZS5ncmlkO1xyXG4gICAgICAgIGNvbnN0IGV4cG9ydE9wdGlvbnMgPSBncmlkT3B0aW9ucyAmJiAoZ3JpZE9wdGlvbnMuZXhjZWxFeHBvcnRPcHRpb25zIHx8IGdyaWRPcHRpb25zLmV4cG9ydE9wdGlvbnMpO1xyXG4gICAgICAgIGxldCB0ZXh0VG9Db3B5ID0gZXhwb3J0V2l0aEZvcm1hdHRlcldoZW5EZWZpbmVkKHJvdywgY2VsbCwgZGF0YUNvbnRleHQsIGNvbHVtbkRlZiwgZ3JpZCwgZXhwb3J0T3B0aW9ucyk7XHJcblxyXG4gICAgICAgIGlmICh0eXBlb2YgY29sdW1uRGVmLnF1ZXJ5RmllbGROYW1lR2V0dGVyRm4gPT09ICdmdW5jdGlvbicpIHtcclxuICAgICAgICAgIHRleHRUb0NvcHkgPSB0aGlzLmdldENlbGxWYWx1ZUZyb21RdWVyeUZpZWxkR2V0dGVyKGNvbHVtbkRlZiwgZGF0YUNvbnRleHQpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgLy8gY3JlYXRlIGZha2UgPGRpdj4gdG8gY29weSBpbnRvIGNsaXBib2FyZCAmIGRlbGV0ZSBpdCBmcm9tIHRoZSBET00gb25jZSB3ZSdyZSBkb25lXHJcbiAgICAgICAgY29uc3QgcmFuZ2UgPSBkb2N1bWVudC5jcmVhdGVSYW5nZSgpO1xyXG4gICAgICAgIGNvbnN0IHRtcEVsZW0gPSAkKCc8ZGl2PicpLmNzcyh7IHBvc2l0aW9uOiAnYWJzb2x1dGUnLCBsZWZ0OiAnLTEwMDBweCcsIHRvcDogJy0xMDAwcHgnIH0pLnRleHQodGV4dFRvQ29weSk7XHJcbiAgICAgICAgJCgnYm9keScpLmFwcGVuZCh0bXBFbGVtKTtcclxuICAgICAgICByYW5nZS5zZWxlY3ROb2RlQ29udGVudHModG1wRWxlbS5nZXQoMCkpO1xyXG4gICAgICAgIGNvbnN0IHNlbGVjdGlvbiA9IHdpbmRvdy5nZXRTZWxlY3Rpb24oKTtcclxuICAgICAgICBpZiAoc2VsZWN0aW9uICYmIHNlbGVjdGlvbi5hZGRSYW5nZSAmJiBzZWxlY3Rpb24ucmVtb3ZlQWxsUmFuZ2VzKSB7XHJcbiAgICAgICAgICBzZWxlY3Rpb24ucmVtb3ZlQWxsUmFuZ2VzKCk7XHJcbiAgICAgICAgICBzZWxlY3Rpb24uYWRkUmFuZ2UocmFuZ2UpO1xyXG4gICAgICAgICAgY29uc3Qgc3VjY2VzcyA9IGRvY3VtZW50LmV4ZWNDb21tYW5kKCdjb3B5JywgZmFsc2UsIHRleHRUb0NvcHkpO1xyXG4gICAgICAgICAgaWYgKHN1Y2Nlc3MpIHtcclxuICAgICAgICAgICAgdG1wRWxlbS5yZW1vdmUoKTtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgIH0gY2F0Y2ggKGUpIHsgfVxyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogV2hlbiBhIHF1ZXJ5RmllbGROYW1lR2V0dGVyRm4gaXMgZGVmaW5lZCwgdGhlbiBnZXQgdGhlIHZhbHVlIGZyb20gdGhhdCBnZXR0ZXIgY2FsbGJhY2sgZnVuY3Rpb25cclxuICAgKiBAcGFyYW0gY29sdW1uRGVmXHJcbiAgICogQHBhcmFtIGRhdGFDb250ZXh0XHJcbiAgICogQHJldHVybiBjZWxsVmFsdWVcclxuICAgKi9cclxuICBwcml2YXRlIGdldENlbGxWYWx1ZUZyb21RdWVyeUZpZWxkR2V0dGVyKGNvbHVtbkRlZjogQ29sdW1uLCBkYXRhQ29udGV4dDogYW55KTogc3RyaW5nIHtcclxuICAgIGxldCBjZWxsVmFsdWUgPSAnJztcclxuXHJcbiAgICBpZiAodHlwZW9mIGNvbHVtbkRlZi5xdWVyeUZpZWxkTmFtZUdldHRlckZuID09PSAnZnVuY3Rpb24nKSB7XHJcbiAgICAgIGNvbnN0IHF1ZXJ5RmllbGROYW1lID0gY29sdW1uRGVmLnF1ZXJ5RmllbGROYW1lR2V0dGVyRm4oZGF0YUNvbnRleHQpO1xyXG5cclxuICAgICAgLy8gZ2V0IHRoZSBjZWxsIHZhbHVlIGZyb20gdGhlIGl0ZW0gb3Igd2hlbiBpdCdzIGEgZG90IG5vdGF0aW9uIHRoZW4gZXhwbG9kZWQgdGhlIGl0ZW0gYW5kIGdldCB0aGUgZmluYWwgdmFsdWVcclxuICAgICAgaWYgKHF1ZXJ5RmllbGROYW1lICYmIHF1ZXJ5RmllbGROYW1lLmluZGV4T2YoJy4nKSA+PSAwKSB7XHJcbiAgICAgICAgY2VsbFZhbHVlID0gZ2V0RGVzY2VuZGFudFByb3BlcnR5KGRhdGFDb250ZXh0LCBxdWVyeUZpZWxkTmFtZSk7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgY2VsbFZhbHVlID0gZGF0YUNvbnRleHRbcXVlcnlGaWVsZE5hbWVdO1xyXG4gICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIGNlbGxWYWx1ZTtcclxuICB9XHJcbn1cclxuIl19