import * as tslib_1 from "tslib";
import { Injectable } from '@angular/core';
import { isObservable, Subject } from 'rxjs';
import * as isequal_ from 'lodash.isequal';
var isequal = isequal_; // patch to fix rollup to work
import { FilterService } from './filter.service';
import { GridService } from './grid.service';
import { SharedService } from './shared.service';
import { executeBackendProcessesCallback, onBackendError } from './backend-utilities';
import { unsubscribeAllObservables } from './utilities';
var PaginationService = /** @class */ (function () {
    /** Constructor */
    function PaginationService(filterService, gridService, sharedService) {
        this.filterService = filterService;
        this.gridService = gridService;
        this.sharedService = sharedService;
        this._initialized = false;
        this._isLocalGrid = true;
        this._dataFrom = 1;
        this._dataTo = 1;
        this._pageCount = 1;
        this._pageNumber = 1;
        this._totalItems = 0;
        this._eventHandler = new Slick.EventHandler();
        this._subscriptions = [];
        this.onPaginationChanged = new Subject();
        this.onPaginationVisibilityChanged = new Subject();
    }
    Object.defineProperty(PaginationService.prototype, "paginationOptions", {
        get: function () {
            return this._paginationOptions;
        },
        set: function (paginationOptions) {
            this._paginationOptions = paginationOptions;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(PaginationService.prototype, "availablePageSizes", {
        get: function () {
            return this._availablePageSizes;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(PaginationService.prototype, "dataFrom", {
        get: function () {
            return this._dataFrom;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(PaginationService.prototype, "dataTo", {
        get: function () {
            return this._dataTo;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(PaginationService.prototype, "itemsPerPage", {
        get: function () {
            return this._itemsPerPage;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(PaginationService.prototype, "pageCount", {
        get: function () {
            return this._pageCount;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(PaginationService.prototype, "pageNumber", {
        get: function () {
            return this._pageNumber;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(PaginationService.prototype, "totalItems", {
        get: function () {
            return this._totalItems;
        },
        set: function (totalItems) {
            this._totalItems = totalItems;
            if (this._initialized) {
                this.refreshPagination();
            }
        },
        enumerable: true,
        configurable: true
    });
    PaginationService.prototype.init = function (grid, dataView, paginationOptions, backendServiceApi) {
        var _this = this;
        this._availablePageSizes = paginationOptions.pageSizes;
        this.dataView = dataView;
        this.grid = grid;
        this._backendServiceApi = backendServiceApi;
        this._paginationOptions = paginationOptions;
        this._isLocalGrid = !backendServiceApi;
        this._pageNumber = paginationOptions.pageNumber || 1;
        if (backendServiceApi && (!backendServiceApi.service || !backendServiceApi.process)) {
            throw new Error("BackendServiceApi requires the following 2 properties \"process\" and \"service\" to be defined.");
        }
        if (this._isLocalGrid && this.dataView) {
            this._eventHandler.subscribe(this.dataView.onPagingInfoChanged, function (e, pagingInfo) {
                if (_this._totalItems !== pagingInfo.totalRows) {
                    _this.updateTotalItems(pagingInfo.totalRows);
                }
            });
            dataView.setRefreshHints({ isFilterUnchanged: true });
            dataView.setPagingOptions({ pageSize: this.paginationOptions.pageSize, pageNum: (this._pageNumber - 1) }); // dataView page starts at 0 instead of 1
        }
        // Subscribe to Filter Clear & Changed and go back to page 1 when that happen
        this._subscriptions.push(this.filterService.onFilterChanged.subscribe(function () { return _this.resetPagination(); }));
        this._subscriptions.push(this.filterService.onFilterCleared.subscribe(function () { return _this.resetPagination(); }));
        // Subscribe to any dataview row count changed so that when Adding/Deleting item(s) through the DataView
        // that would trigger a refresh of the pagination numbers
        if (this.dataView) {
            this._subscriptions.push(this.gridService.onItemAdded.subscribe(function (items) { return _this.processOnItemAddedOrRemoved(items, true); }));
            this._subscriptions.push(this.gridService.onItemDeleted.subscribe(function (items) { return _this.processOnItemAddedOrRemoved(items, false); }));
        }
        this.refreshPagination(false, false);
        this._initialized = true;
    };
    PaginationService.prototype.dispose = function () {
        this._initialized = false;
        // unsubscribe all SlickGrid events
        this._eventHandler.unsubscribeAll();
        // also unsubscribe all Angular Subscriptions
        this._subscriptions = unsubscribeAllObservables(this._subscriptions);
    };
    PaginationService.prototype.getCurrentPageNumber = function () {
        return this._pageNumber;
    };
    PaginationService.prototype.getCurrentPagination = function () {
        return {
            pageNumber: this._pageNumber,
            pageSize: this._itemsPerPage,
            pageSizes: this._availablePageSizes,
        };
    };
    PaginationService.prototype.getFullPagination = function () {
        return {
            pageCount: this._pageCount,
            pageNumber: this._pageNumber,
            pageSize: this._itemsPerPage,
            pageSizes: this._availablePageSizes,
            totalItems: this._totalItems,
            dataFrom: this._dataFrom,
            dataTo: this._dataTo,
        };
    };
    PaginationService.prototype.getCurrentItemPerPage = function () {
        return this._itemsPerPage;
    };
    PaginationService.prototype.changeItemPerPage = function (itemsPerPage, event) {
        this._pageNumber = 1;
        this._pageCount = Math.ceil(this._totalItems / itemsPerPage);
        this._itemsPerPage = itemsPerPage;
        return this.processOnPageChanged(this._pageNumber, event);
    };
    PaginationService.prototype.goToFirstPage = function (event) {
        this._pageNumber = 1;
        return this.processOnPageChanged(this._pageNumber, event);
    };
    PaginationService.prototype.goToLastPage = function (event) {
        this._pageNumber = this._pageCount || 1;
        return this.processOnPageChanged(this._pageNumber, event);
    };
    PaginationService.prototype.goToNextPage = function (event) {
        if (this._pageNumber < this._pageCount) {
            this._pageNumber++;
            return this.processOnPageChanged(this._pageNumber, event);
        }
        else {
            return new Promise(function (resolve) { return resolve(false); });
        }
    };
    PaginationService.prototype.goToPageNumber = function (pageNumber, event) {
        var previousPageNumber = this._pageNumber;
        if (pageNumber < 1) {
            this._pageNumber = 1;
        }
        else if (pageNumber > this._pageCount) {
            this._pageNumber = this._pageCount;
        }
        else {
            this._pageNumber = pageNumber;
        }
        if (this._pageNumber !== previousPageNumber) {
            return this.processOnPageChanged(this._pageNumber, event);
        }
        else {
            return new Promise(function (resolve) { return resolve(false); });
        }
    };
    PaginationService.prototype.goToPreviousPage = function (event) {
        if (this._pageNumber > 1) {
            this._pageNumber--;
            return this.processOnPageChanged(this._pageNumber, event);
        }
        else {
            return new Promise(function (resolve) { return resolve(false); });
        }
    };
    PaginationService.prototype.refreshPagination = function (isPageNumberReset, triggerChangedEvent) {
        if (isPageNumberReset === void 0) { isPageNumberReset = false; }
        if (triggerChangedEvent === void 0) { triggerChangedEvent = true; }
        var previousPagination = tslib_1.__assign({}, this.getCurrentPagination());
        if (this._paginationOptions) {
            var pagination = this._paginationOptions;
            // set the number of items per page if not already set
            if (!this._itemsPerPage) {
                if (this._isLocalGrid) {
                    this._itemsPerPage = pagination.pageSize;
                }
                else {
                    this._itemsPerPage = +((this._backendServiceApi && this._backendServiceApi.options && this._backendServiceApi.options.paginationOptions && this._backendServiceApi.options.paginationOptions.first) ? this._backendServiceApi.options.paginationOptions.first : pagination.pageSize);
                }
            }
            // if totalItems changed, we should always go back to the first page and recalculation the From-To indexes
            if (isPageNumberReset || this._totalItems !== pagination.totalItems) {
                if (isPageNumberReset) {
                    this._pageNumber = 1;
                    this.paginationOptions.pageNumber = 1;
                }
                else if (!this._initialized && pagination.pageNumber && pagination.pageNumber > 1) {
                    this._pageNumber = pagination.pageNumber || 1;
                }
                // when page number is set to 1 then also reset the "offset" of backend service
                if (this._pageNumber === 1 && this._backendServiceApi) {
                    this._backendServiceApi.service.resetPaginationOptions();
                }
            }
            // calculate and refresh the multiple properties of the pagination UI
            this._availablePageSizes = pagination.pageSizes;
            if (!this._totalItems && pagination.totalItems) {
                this._totalItems = pagination.totalItems;
            }
            this.recalculateFromToIndexes();
        }
        this._pageCount = Math.ceil(this._totalItems / this._itemsPerPage);
        var currentPagination = this.getCurrentPagination();
        this.sharedService.currentPagination = currentPagination;
        if (triggerChangedEvent && !isequal(previousPagination, currentPagination)) {
            this.onPaginationChanged.next(currentPagination);
        }
    };
    PaginationService.prototype.processOnPageChanged = function (pageNumber, event) {
        var _this = this;
        return new Promise(function (resolve, reject) {
            _this.recalculateFromToIndexes();
            if (_this._isLocalGrid && _this.dataView) {
                _this.dataView.setPagingOptions({ pageSize: _this._itemsPerPage, pageNum: (pageNumber - 1) }); // dataView page starts at 0 instead of 1
                _this.onPaginationChanged.next(_this.getFullPagination());
            }
            else {
                var itemsPerPage = +_this._itemsPerPage;
                // keep start time & end timestamps & return it after process execution
                var startTime_1 = new Date();
                // run any pre-process, if defined, for example a spinner
                if (_this._backendServiceApi.preProcess) {
                    _this._backendServiceApi.preProcess();
                }
                var query = _this._backendServiceApi.service.processOnPaginationChanged(event, { newPage: pageNumber, pageSize: itemsPerPage });
                // the processes can be Promises or an Observables (like HttpClient)
                var process_1 = _this._backendServiceApi.process(query);
                if (process_1 instanceof Promise) {
                    process_1
                        .then(function (processResult) {
                        resolve(executeBackendProcessesCallback(startTime_1, processResult, _this._backendServiceApi, _this._totalItems));
                    })
                        .catch(function (error) {
                        onBackendError(error, _this._backendServiceApi);
                        reject(process_1);
                    });
                }
                else if (isObservable(process_1)) {
                    _this._subscriptions.push(process_1.subscribe(function (processResult) {
                        resolve(executeBackendProcessesCallback(startTime_1, processResult, _this._backendServiceApi, _this._totalItems));
                    }, function (error) {
                        onBackendError(error, _this._backendServiceApi);
                        reject(process_1);
                    }));
                }
                _this.onPaginationChanged.next(_this.getFullPagination());
            }
        });
    };
    PaginationService.prototype.recalculateFromToIndexes = function () {
        if (this._totalItems === 0) {
            this._dataFrom = 0;
            this._dataTo = 1;
            this._pageNumber = 0;
        }
        else {
            this._dataFrom = this._pageNumber > 1 ? ((this._pageNumber * this._itemsPerPage) - this._itemsPerPage + 1) : 1;
            this._dataTo = (this._totalItems < this._itemsPerPage) ? this._totalItems : ((this._pageNumber || 1) * this._itemsPerPage);
            if (this._dataTo > this._totalItems) {
                this._dataTo = this._totalItems;
            }
        }
        this._pageNumber = (this._totalItems > 0 && this._pageNumber === 0) ? 1 : this._pageNumber;
        // do a final check on the From/To and make sure they are not over or below min/max acceptable values
        if (this._dataTo > this._totalItems) {
            this._dataTo = this._totalItems;
        }
        else if (this._totalItems < this._itemsPerPage) {
            this._dataTo = this._totalItems;
        }
    };
    /** Reset the Pagination to first page and recalculate necessary numbers */
    PaginationService.prototype.resetPagination = function (triggerChangedEvent) {
        if (triggerChangedEvent === void 0) { triggerChangedEvent = true; }
        if (this._isLocalGrid) {
            // on a local grid we also need to reset the DataView paging to 1st page
            this.dataView.setPagingOptions({ pageSize: this._itemsPerPage, pageNum: 0 });
        }
        this.refreshPagination(true, triggerChangedEvent);
    };
    /**
     * Toggle the Pagination (show/hide), it will use the visible if defined else it will automatically inverse when called without argument
     *
     * IMPORTANT NOTE:
     * The Pagination must be created on initial page load, then only after can you toggle it.
     * Basically this method WILL NOT WORK to show the Pagination if it was not there from the start.
     */
    PaginationService.prototype.togglePaginationVisibility = function (visible) {
        if (this.grid && this.sharedService && this.sharedService.gridOptions) {
            var isVisible = visible !== undefined ? visible : !this.sharedService.gridOptions.enablePagination;
            this.sharedService.gridOptions.enablePagination = isVisible;
            this.onPaginationVisibilityChanged.next({ visible: isVisible });
            // make sure to reset the Pagination and go back to first page to avoid any issues with Pagination being offset
            if (isVisible) {
                this.goToFirstPage();
            }
            // when using a local grid, we can reset the DataView pagination by changing its page size
            // page size of 0 would show all, hence cancel the pagination
            if (this._isLocalGrid) {
                var pageSize = visible ? this._itemsPerPage : 0;
                this.dataView.setPagingOptions({ pageSize: pageSize, pageNum: 0 });
            }
        }
    };
    // --
    // private functions
    // --------------------
    PaginationService.prototype.updateTotalItems = function (totalItems, triggerChangedEvent) {
        if (triggerChangedEvent === void 0) { triggerChangedEvent = false; }
        this._totalItems = totalItems;
        if (this._paginationOptions) {
            this._paginationOptions.totalItems = totalItems;
            this.refreshPagination(false, triggerChangedEvent);
        }
    };
    /**
     * When item is added or removed, we will refresh the numbers on the pagination however we won't trigger a backend change
     * This will have a side effect though, which is that the "To" count won't be matching the "items per page" count,
     * that is a necessary side effect to avoid triggering a backend query just to refresh the paging,
     * basically we assume that this offset is fine for the time being,
     * until user does an action which will refresh the data hence the pagination which will then become normal again
     */
    PaginationService.prototype.processOnItemAddedOrRemoved = function (items, isItemAdded) {
        if (isItemAdded === void 0) { isItemAdded = true; }
        if (items !== null) {
            var previousDataTo = this._dataTo;
            var itemCount = Array.isArray(items) ? items.length : 1;
            var itemCountWithDirection = isItemAdded ? +itemCount : -itemCount;
            // refresh the total count in the pagination and in the UI
            this._totalItems += itemCountWithDirection;
            this.recalculateFromToIndexes();
            // finally refresh the "To" count and we know it might be different than the "items per page" count
            // but this is necessary since we don't want an actual backend refresh
            this._dataTo = previousDataTo + itemCountWithDirection;
            this.onPaginationChanged.next(this.getFullPagination());
        }
    };
    PaginationService.ctorParameters = function () { return [
        { type: FilterService },
        { type: GridService },
        { type: SharedService }
    ]; };
    PaginationService = tslib_1.__decorate([
        Injectable()
    ], PaginationService);
    return PaginationService;
}());
export { PaginationService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGFnaW5hdGlvbi5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vYW5ndWxhci1zbGlja2dyaWQvIiwic291cmNlcyI6WyJhcHAvbW9kdWxlcy9hbmd1bGFyLXNsaWNrZ3JpZC9zZXJ2aWNlcy9wYWdpbmF0aW9uLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDM0MsT0FBTyxFQUFnQixZQUFZLEVBQUUsT0FBTyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQzNELE9BQU8sS0FBSyxRQUFRLE1BQU0sZ0JBQWdCLENBQUM7QUFDM0MsSUFBTSxPQUFPLEdBQUcsUUFBUSxDQUFDLENBQUMsOEJBQThCO0FBR3hELE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSxrQkFBa0IsQ0FBQztBQUNqRCxPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDN0MsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLGtCQUFrQixDQUFDO0FBQ2pELE9BQU8sRUFBRSwrQkFBK0IsRUFBRSxjQUFjLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUN0RixPQUFPLEVBQUUseUJBQXlCLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFNeEQ7SUFvQkUsa0JBQWtCO0lBQ2xCLDJCQUFvQixhQUE0QixFQUFVLFdBQXdCLEVBQVUsYUFBNEI7UUFBcEcsa0JBQWEsR0FBYixhQUFhLENBQWU7UUFBVSxnQkFBVyxHQUFYLFdBQVcsQ0FBYTtRQUFVLGtCQUFhLEdBQWIsYUFBYSxDQUFlO1FBcEJoSCxpQkFBWSxHQUFHLEtBQUssQ0FBQztRQUNyQixpQkFBWSxHQUFHLElBQUksQ0FBQztRQUVwQixjQUFTLEdBQUcsQ0FBQyxDQUFDO1FBQ2QsWUFBTyxHQUFHLENBQUMsQ0FBQztRQUVaLGVBQVUsR0FBRyxDQUFDLENBQUM7UUFDZixnQkFBVyxHQUFHLENBQUMsQ0FBQztRQUNoQixnQkFBVyxHQUFHLENBQUMs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QU0sY0FBYyxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUM7WUFDcEMsSUFBTSxTQUFTLEdBQUcsS0FBSyxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQzFELElBQU0sc0JBQXNCLEdBQUcsV0FBVyxDQUFDLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUM7WUFFckUsMERBQTBEO1lBQzFELElBQUksQ0FBQyxXQUFXLElBQUksc0JBQXNCLENBQUM7WUFDM0MsSUFBSSxDQUFDLHdCQUF3QixFQUFFLENBQUM7WUFFaEMsbUdBQW1HO1lBQ25HLHNFQUFzRTtZQUN0RSxJQUFJLENBQUMsT0FBTyxHQUFHLGNBQWMsR0FBRyxzQkFBc0IsQ0FBQztZQUN2RCxJQUFJLENBQUMsbUJBQW1CLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxpQkFBaUIsRUFBRSxDQUFDLENBQUM7U0FDekQ7SUFDSCxDQUFDOztnQkF4V2tDLGFBQWE7Z0JBQXVCLFdBQVc7Z0JBQXlCLGFBQWE7O0lBckI3RyxpQkFBaUI7UUFEN0IsVUFBVSxFQUFFO09BQ0EsaUJBQWlCLENBOFg3QjtJQUFELHdCQUFDO0NBQUEsQUE5WEQsSUE4WEM7U0E5WFksaUJBQWlCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBTdWJzY3JpcHRpb24sIGlzT2JzZXJ2YWJsZSwgU3ViamVjdCB9IGZyb20gJ3J4anMnO1xyXG5pbXBvcnQgKiBhcyBpc2VxdWFsXyBmcm9tICdsb2Rhc2guaXNlcXVhbCc7XHJcbmNvbnN0IGlzZXF1YWwgPSBpc2VxdWFsXzsgLy8gcGF0Y2ggdG8gZml4IHJvbGx1cCB0byB3b3JrXHJcblxyXG5pbXBvcnQgeyBCYWNrZW5kU2VydmljZUFwaSwgQ3VycmVudFBhZ2luYXRpb24sIEdyYXBocWxSZXN1bHQsIEdyYXBocWxQYWdpbmF0ZWRSZXN1bHQsIEdyaWRPcHRpb24sIFBhZ2luYXRpb24sIFNlcnZpY2VQYWdpbmF0aW9uIH0gZnJvbSAnLi4vbW9kZWxzJztcclxuaW1wb3J0IHsgRmlsdGVyU2VydmljZSB9IGZyb20gJy4vZmlsdGVyLnNlcnZpY2UnO1xyXG5pbXBvcnQgeyBHcmlkU2VydmljZSB9IGZyb20gJy4vZ3JpZC5zZXJ2aWNlJztcclxuaW1wb3J0IHsgU2hhcmVkU2VydmljZSB9IGZyb20gJy4vc2hhcmVkLnNlcnZpY2UnO1xyXG5pbXBvcnQgeyBleGVjdXRlQmFja2VuZFByb2Nlc3Nlc0NhbGxiYWNrLCBvbkJhY2tlbmRFcnJvciB9IGZyb20gJy4vYmFja2VuZC11dGlsaXRpZXMnO1xyXG5pbXBvcnQgeyB1bnN1YnNjcmliZUFsbE9ic2VydmFibGVzIH0gZnJvbSAnLi91dGlsaXRpZXMnO1xyXG5cclxuLy8gdXNpbmcgZXh0ZXJuYWwgbm9uLXR5cGVkIGpzIGxpYnJhcmllc1xyXG5kZWNsYXJlIGNvbnN0IFNsaWNrOiBhbnk7XHJcblxyXG5ASW5qZWN0YWJsZSgpXHJcbmV4cG9ydCBjbGFzcyBQYWdpbmF0aW9uU2VydmljZSB7XHJcbiAgcHJpdmF0ZSBfaW5pdGlhbGl6ZWQgPSBmYWxzZTtcclxuICBwcml2YXRlIF9pc0xvY2FsR3JpZCA9IHRydWU7XHJcbiAgcHJpdmF0ZSBfYmFja2VuZFNlcnZpY2VBcGk6IEJhY2tlbmRTZXJ2aWNlQXBpO1xyXG4gIHByaXZhdGUgX2RhdGFGcm9tID0gMTtcclxuICBwcml2YXRlIF9kYXRhVG8gPSAxO1xyXG4gIHByaXZhdGUgX2l0ZW1zUGVyUGFnZTogbnVtYmVyO1xyXG4gIHByaXZhdGUgX3BhZ2VDb3VudCA9IDE7XHJcbiAgcHJpdmF0ZSBfcGFnZU51bWJlciA9IDE7XHJcbiAgcHJpdmF0ZSBfdG90YWxJdGVtcyA9IDA7XHJcbiAgcHJpdmF0ZSBfYXZhaWxhYmxlUGFnZVNpemVzOiBudW1iZXJbXTtcclxuICBwcml2YXRlIF9ldmVudEhhbmRsZXIgPSBuZXcgU2xpY2suRXZlbnRIYW5kbGVyKCk7XHJcbiAgcHJpdmF0ZSBfcGFnaW5hdGlvbk9wdGlvbnM6IFBhZ2luYXRpb247XHJcbiAgcHJpdmF0ZSBfc3Vic2NyaXB0aW9uczogU3Vic2NyaXB0aW9uW10gPSBbXTtcclxuICBvblBhZ2luYXRpb25DaGFuZ2VkID0gbmV3IFN1YmplY3Q8U2VydmljZVBhZ2luYXRpb24+KCk7XHJcbiAgb25QYWdpbmF0aW9uVmlzaWJpbGl0eUNoYW5nZWQgPSBuZXcgU3ViamVjdDx7IHZpc2libGU6IGJvb2xlYW4gfT4oKTtcclxuXHJcbiAgZGF0YVZpZXc6IGFueTtcclxuICBncmlkOiBhbnk7XHJcblxyXG4gIC8qKiBDb25zdHJ1Y3RvciAqL1xyXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgZmlsdGVyU2VydmljZTogRmlsdGVyU2VydmljZSwgcHJpdmF0ZSBncmlkU2VydmljZTogR3JpZFNlcnZpY2UsIHByaXZhdGUgc2hhcmVkU2VydmljZTogU2hhcmVkU2VydmljZSkgeyB9XHJcblxyXG4gIGdldCBwYWdpbmF0aW9uT3B0aW9ucygpOiBQYWdpbmF0aW9uIHtcclxuICAgIHJldHVybiB0aGlzLl9wYWdpbmF0aW9uT3B0aW9ucztcclxuICB9XHJcbiAgc2V0IHBhZ2luYXRpb25PcHRpb25zKHBhZ2luYXRpb25PcHRpb25zOiBQYWdpbmF0aW9uKSB7XHJcbiAgICB0aGlzLl9wYWdpbmF0aW9uT3B0aW9ucyA9IHBhZ2luYXRpb25PcHRpb25zO1xyXG4gIH1cclxuXHJcbiAgZ2V0IGF2YWlsYWJsZVBhZ2VTaXplcygpOiBudW1iZXJbXSB7XHJcbiAgICByZXR1cm4gdGhpcy5fYXZhaWxhYmxlUGFnZVNpemVzO1xyXG4gIH1cclxuXHJcbiAgZ2V0IGRhdGFGcm9tKCk6IG51bWJlciB7XHJcbiAgICByZXR1cm4gdGhpcy5fZGF0YUZyb207XHJcbiAgfVxyXG5cclxuICBnZXQgZGF0YVRvKCk6IG51bWJlciB7XHJcbiAgICByZXR1cm4gdGhpcy5fZGF0YVRvO1xyXG4gIH1cclxuXHJcbiAgZ2V0IGl0ZW1zUGVyUGFnZSgpOiBudW1iZXIge1xyXG4gICAgcmV0dXJuIHRoaXMuX2l0ZW1zUGVyUGFnZTtcclxuICB9XHJcblxyXG4gIGdldCBwYWdlQ291bnQoKTogbnVtYmVyIHtcclxuICAgIHJldHVybiB0aGlzLl9wYWdlQ291bnQ7XHJcbiAgfVxyXG5cclxuICBnZXQgcGFnZU51bWJlcigpOiBudW1iZXIge1xyXG4gICAgcmV0dXJuIHRoaXMuX3BhZ2VOdW1iZXI7XHJcbiAgfVxyXG5cclxuICBzZXQgdG90YWxJdGVtcyh0b3RhbEl0ZW1zOiBudW1iZXIpIHtcclxuICAgIHRoaXMuX3RvdGFsSXRlbXMgPSB0b3RhbEl0ZW1zO1xyXG4gICAgaWYgKHRoaXMuX2luaXRpYWxpemVkKSB7XHJcbiAgICAgIHRoaXMucmVmcmVzaFBhZ2luYXRpb24oKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIGdldCB0b3RhbEl0ZW1zKCk6IG51bWJlciB7XHJcbiAgICByZXR1cm4gdGhpcy5fdG90YWxJdGVtcztcclxuICB9XHJcblxyXG4gIGluaXQoZ3JpZDogYW55LCBkYXRhVmlldzogYW55LCBwYWdpbmF0aW9uT3B0aW9uczogUGFnaW5hdGlvbiwgYmFja2VuZFNlcnZpY2VBcGk/OiBCYWNrZW5kU2VydmljZUFwaSkge1xyXG4gICAgdGhpcy5fYXZhaWxhYmxlUGFnZVNpemVzID0gcGFnaW5hdGlvbk9wdGlvbnMucGFnZVNpemVzO1xyXG4gICAgdGhpcy5kYXRhVmlldyA9IGRhdGFWaWV3O1xyXG4gICAgdGhpcy5ncmlkID0gZ3JpZDtcclxuICAgIHRoaXMuX2JhY2tlbmRTZXJ2aWNlQXBpID0gYmFja2VuZFNlcnZpY2VBcGk7XHJcbiAgICB0aGlzLl9wYWdpbmF0aW9uT3B0aW9ucyA9IHBhZ2luYXRpb25PcHRpb25zO1xyXG4gICAgdGhpcy5faXNMb2NhbEdyaWQgPSAhYmFja2VuZFNlcnZpY2VBcGk7XHJcbiAgICB0aGlzLl9wYWdlTnVtYmVyID0gcGFnaW5hdGlvbk9wdGlvbnMucGFnZU51bWJlciB8fCAxO1xyXG5cclxuICAgIGlmIChiYWNrZW5kU2VydmljZUFwaSAmJiAoIWJhY2tlbmRTZXJ2aWNlQXBpLnNlcnZpY2UgfHwgIWJhY2tlbmRTZXJ2aWNlQXBpLnByb2Nlc3MpKSB7XHJcbiAgICAgIHRocm93IG5ldyBFcnJvcihgQmFja2VuZFNlcnZpY2VBcGkgcmVxdWlyZXMgdGhlIGZvbGxvd2luZyAyIHByb3BlcnRpZXMgXCJwcm9jZXNzXCIgYW5kIFwic2VydmljZVwiIHRvIGJlIGRlZmluZWQuYCk7XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKHRoaXMuX2lzTG9jYWxHcmlkICYmIHRoaXMuZGF0YVZpZXcpIHtcclxuICAgICAgdGhpcy5fZXZlbnRIYW5kbGVyLnN1YnNjcmliZSh0aGlzLmRhdGFWaWV3Lm9uUGFnaW5nSW5mb0NoYW5nZWQsIChlLCBwYWdpbmdJbmZvKSA9PiB7XHJcbiAgICAgICAgaWYgKHRoaXMuX3RvdGFsSXRlbXMgIT09IHBhZ2luZ0luZm8udG90YWxSb3dzKSB7XHJcbiAgICAgICAgICB0aGlzLnVwZGF0ZVRvdGFsSXRlbXMocGFnaW5nSW5mby50b3RhbFJvd3MpO1xyXG4gICAgICAgIH1cclxuICAgICAgfSk7XHJcbiAgICAgIGRhdGFWaWV3LnNldFJlZnJlc2hIaW50cyh7IGlzRmlsdGVyVW5jaGFuZ2VkOiB0cnVlIH0pO1xyXG4gICAgICBkYXRhVmlldy5zZXRQYWdpbmdPcHRpb25zKHsgcGFnZVNpemU6IHRoaXMucGFnaW5hdGlvbk9wdGlvbnMucGFnZVNpemUsIHBhZ2VOdW06ICh0aGlzLl9wYWdlTnVtYmVyIC0gMSkgfSk7IC8vIGRhdGFWaWV3IHBhZ2Ugc3RhcnRzIGF0IDAgaW5zdGVhZCBvZiAxXHJcbiAgICB9XHJcblxyXG4gICAgLy8gU3Vic2NyaWJlIHRvIEZpbHRlciBDbGVhciAmIENoYW5nZWQgYW5kIGdvIGJhY2sgdG8gcGFnZSAxIHdoZW4gdGhhdCBoYXBwZW5cclxuICAgIHRoaXMuX3N1YnNjcmlwdGlvbnMucHVzaCh0aGlzLmZpbHRlclNlcnZpY2Uub25GaWx0ZXJDaGFuZ2VkLnN1YnNjcmliZSgoKSA9PiB0aGlzLnJlc2V0UGFnaW5hdGlvbigpKSk7XHJcbiAgICB0aGlzLl9zdWJzY3JpcHRpb25zLnB1c2godGhpcy5maWx0ZXJTZXJ2aWNlLm9uRmlsdGVyQ2xlYXJlZC5zdWJzY3JpYmUoKCkgPT4gdGhpcy5yZXNldFBhZ2luYXRpb24oKSkpO1xyXG5cclxuICAgIC8vIFN1YnNjcmliZSB0byBhbnkgZGF0YXZpZXcgcm93IGNvdW50IGNoYW5nZWQgc28gdGhhdCB3aGVuIEFkZGluZy9EZWxldGluZyBpdGVtKHMpIHRocm91Z2ggdGhlIERhdGFWaWV3XHJcbiAgICAvLyB0aGF0IHdvdWxkIHRyaWdnZXIgYSByZWZyZXNoIG9mIHRoZSBwYWdpbmF0aW9uIG51bWJlcnNcclxuICAgIGlmICh0aGlzLmRhdGFWaWV3KSB7XHJcbiAgICAgIHRoaXMuX3N1YnNjcmlwdGlvbnMucHVzaCh0aGlzLmdyaWRTZXJ2aWNlLm9uSXRlbUFkZGVkLnN1YnNjcmliZSgoaXRlbXM6IGFueSB8IGFueVtdKSA9PiB0aGlzLnByb2Nlc3NPbkl0ZW1BZGRlZE9yUmVtb3ZlZChpdGVtcywgdHJ1ZSkpKTtcclxuICAgICAgdGhpcy5fc3Vic2NyaXB0aW9ucy5wdXNoKHRoaXMuZ3JpZFNlcnZpY2Uub25JdGVtRGVsZXRlZC5zdWJzY3JpYmUoKGl0ZW1zOiBhbnkgfCBhbnlbXSkgPT4gdGhpcy5wcm9jZXNzT25JdGVtQWRkZWRPclJlbW92ZWQoaXRlbXMsIGZhbHNlKSkpO1xyXG4gICAgfVxyXG5cclxuICAgIHRoaXMucmVmcmVzaFBhZ2luYXRpb24oZmFsc2UsIGZhbHNlKTtcclxuICAgIHRoaXMuX2luaXRpYWxpemVkID0gdHJ1ZTtcclxuICB9XHJcblxyXG4gIGRpc3Bvc2UoKSB7XHJcbiAgICB0aGlzLl9pbml0aWFsaXplZCA9IGZhbHNlO1xyXG5cclxuICAgIC8vIHVuc3Vic2NyaWJlIGFsbCBTbGlja0dyaWQgZXZlbnRzXHJcbiAgICB0aGlzLl9ldmVudEhhbmRsZXIudW5zdWJzY3JpYmVBbGwoKTtcclxuXHJcbiAgICAvLyBhbHNvIHVuc3Vic2NyaWJlIGFsbCBBbmd1bGFyIFN1YnNjcmlwdGlvbnNcclxuICAgIHRoaXMuX3N1YnNjcmlwdGlvbnMgPSB1bnN1YnNjcmliZUFsbE9ic2VydmFibGVzKHRoaXMuX3N1YnNjcmlwdGlvbnMpO1xyXG4gIH1cclxuXHJcbiAgZ2V0Q3VycmVudFBhZ2VOdW1iZXIoKTogbnVtYmVyIHtcclxuICAgIHJldHVybiB0aGlzLl9wYWdlTnVtYmVyO1xyXG4gIH1cclxuXHJcbiAgZ2V0Q3VycmVudFBhZ2luYXRpb24oKTogQ3VycmVudFBhZ2luYXRpb24gJiB7IHBhZ2VTaXplczogbnVtYmVyW10gfSB7XHJcbiAgICByZXR1cm4ge1xyXG4gICAgICBwYWdlTnVtYmVyOiB0aGlzLl9wYWdlTnVtYmVyLFxyXG4gICAgICBwYWdlU2l6ZTogdGhpcy5faXRlbXNQZXJQYWdlLFxyXG4gICAgICBwYWdlU2l6ZXM6IHRoaXMuX2F2YWlsYWJsZVBhZ2VTaXplcyxcclxuICAgIH07XHJcbiAgfVxyXG5cclxuICBnZXRGdWxsUGFnaW5hdGlvbigpOiBTZXJ2aWNlUGFnaW5hdGlvbiB7XHJcbiAgICByZXR1cm4ge1xyXG4gICAgICBwYWdlQ291bnQ6IHRoaXMuX3BhZ2VDb3VudCxcclxuICAgICAgcGFnZU51bWJlcjogdGhpcy5fcGFnZU51bWJlcixcclxuICAgICAgcGFnZVNpemU6IHRoaXMuX2l0ZW1zUGVyUGFnZSxcclxuICAgICAgcGFnZVNpemVzOiB0aGlzLl9hdmFpbGFibGVQYWdlU2l6ZXMsXHJcbiAgICAgIHRvdGFsSXRlbXM6IHRoaXMuX3RvdGFsSXRlbXMsXHJcbiAgICAgIGRhdGFGcm9tOiB0aGlzLl9kYXRhRnJvbSxcclxuICAgICAgZGF0YVRvOiB0aGlzLl9kYXRhVG8sXHJcbiAgICB9O1xyXG4gIH1cclxuXHJcbiAgZ2V0Q3VycmVudEl0ZW1QZXJQYWdlKCk6IG51bWJlciB7XHJcbiAgICByZXR1cm4gdGhpcy5faXRlbXNQZXJQYWdlO1xyXG4gIH1cclxuXHJcbiAgY2hhbmdlSXRlbVBlclBhZ2UoaXRlbXNQZXJQYWdlOiBudW1iZXIsIGV2ZW50PzogYW55KTogUHJvbWlzZTxhbnk+IHtcclxuICAgIHRoaXMuX3BhZ2VOdW1iZXIgPSAxO1xyXG4gICAgdGhpcy5fcGFnZUNvdW50ID0gTWF0aC5jZWlsKHRoaXMuX3RvdGFsSXRlbXMgLyBpdGVtc1BlclBhZ2UpO1xyXG4gICAgdGhpcy5faXRlbXNQZXJQYWdlID0gaXRlbXNQZXJQYWdlO1xyXG4gICAgcmV0dXJuIHRoaXMucHJvY2Vzc09uUGFnZUNoYW5nZWQodGhpcy5fcGFnZU51bWJlciwgZXZlbnQpO1xyXG4gIH1cclxuXHJcbiAgZ29Ub0ZpcnN0UGFnZShldmVudD86IGFueSk6IFByb21pc2U8YW55PiB7XHJcbiAgICB0aGlzLl9wYWdlTnVtYmVyID0gMTtcclxuICAgIHJldHVybiB0aGlzLnByb2Nlc3NPblBhZ2VDaGFuZ2VkKHRoaXMuX3BhZ2VOdW1iZXIsIGV2ZW50KTtcclxuICB9XHJcblxyXG4gIGdvVG9MYXN0UGFnZShldmVudD86IGFueSk6IFByb21pc2U8YW55PiB7XHJcbiAgICB0aGlzLl9wYWdlTnVtYmVyID0gdGhpcy5fcGFnZUNvdW50IHx8IDE7XHJcbiAgICByZXR1cm4gdGhpcy5wcm9jZXNzT25QYWdlQ2hhbmdlZCh0aGlzLl9wYWdlTnVtYmVyLCBldmVudCk7XHJcbiAgfVxyXG5cclxuICBnb1RvTmV4dFBhZ2UoZXZlbnQ/OiBhbnkpOiBQcm9taXNlPGFueT4ge1xyXG4gICAgaWYgKHRoaXMuX3BhZ2VOdW1iZXIgPCB0aGlzLl9wYWdlQ291bnQpIHtcclxuICAgICAgdGhpcy5fcGFnZU51bWJlcisrO1xyXG4gICAgICByZXR1cm4gdGhpcy5wcm9jZXNzT25QYWdlQ2hhbmdlZCh0aGlzLl9wYWdlTnVtYmVyLCBldmVudCk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICByZXR1cm4gbmV3IFByb21pc2UocmVzb2x2ZSA9PiByZXNvbHZlKGZhbHNlKSk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBnb1RvUGFnZU51bWJlcihwYWdlTnVtYmVyOiBudW1iZXIsIGV2ZW50PzogYW55KTogUHJvbWlzZTxhbnk+IHtcclxuICAgIGNvbnN0IHByZXZpb3VzUGFnZU51bWJlciA9IHRoaXMuX3BhZ2VOdW1iZXI7XHJcblxyXG4gICAgaWYgKHBhZ2VOdW1iZXIgPCAxKSB7XHJcbiAgICAgIHRoaXMuX3BhZ2VOdW1iZXIgPSAxO1xyXG4gICAgfSBlbHNlIGlmIChwYWdlTnVtYmVyID4gdGhpcy5fcGFnZUNvdW50KSB7XHJcbiAgICAgIHRoaXMuX3BhZ2VOdW1iZXIgPSB0aGlzLl9wYWdlQ291bnQ7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICB0aGlzLl9wYWdlTnVtYmVyID0gcGFnZU51bWJlcjtcclxuICAgIH1cclxuXHJcbiAgICBpZiAodGhpcy5fcGFnZU51bWJlciAhPT0gcHJldmlvdXNQYWdlTnVtYmVyKSB7XHJcbiAgICAgIHJldHVybiB0aGlzLnByb2Nlc3NPblBhZ2VDaGFuZ2VkKHRoaXMuX3BhZ2VOdW1iZXIsIGV2ZW50KTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHJldHVybiBuZXcgUHJvbWlzZShyZXNvbHZlID0+IHJlc29sdmUoZmFsc2UpKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIGdvVG9QcmV2aW91c1BhZ2UoZXZlbnQ/OiBhbnkpOiBQcm9taXNlPGFueT4ge1xyXG4gICAgaWYgKHRoaXMuX3BhZ2VOdW1iZXIgPiAxKSB7XHJcbiAgICAgIHRoaXMuX3BhZ2VOdW1iZXItLTtcclxuICAgICAgcmV0dXJuIHRoaXMucHJvY2Vzc09uUGFnZUNoYW5nZWQodGhpcy5fcGFnZU51bWJlciwgZXZlbnQpO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKHJlc29sdmUgPT4gcmVzb2x2ZShmYWxzZSkpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcmVmcmVzaFBhZ2luYXRpb24oaXNQYWdlTnVtYmVyUmVzZXQ6IGJvb2xlYW4gPSBmYWxzZSwgdHJpZ2dlckNoYW5nZWRFdmVudCA9IHRydWUpIHtcclxuICAgIGNvbnN0IHByZXZpb3VzUGFnaW5hdGlvbiA9IHsgLi4udGhpcy5nZXRDdXJyZW50UGFnaW5hdGlvbigpIH07XHJcblxyXG4gICAgaWYgKHRoaXMuX3BhZ2luYXRpb25PcHRpb25zKSB7XHJcbiAgICAgIGNvbnN0IHBhZ2luYXRpb24gPSB0aGlzLl9wYWdpbmF0aW9uT3B0aW9ucztcclxuXHJcbiAgICAgIC8vIHNldCB0aGUgbnVtYmVyIG9mIGl0ZW1zIHBlciBwYWdlIGlmIG5vdCBhbHJlYWR5IHNldFxyXG4gICAgICBpZiAoIXRoaXMuX2l0ZW1zUGVyUGFnZSkge1xyXG4gICAgICAgIGlmICh0aGlzLl9pc0xvY2FsR3JpZCkge1xyXG4gICAgICAgICAgdGhpcy5faXRlbXNQZXJQYWdlID0gcGFnaW5hdGlvbi5wYWdlU2l6ZTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgdGhpcy5faXRlbXNQZXJQYWdlID0gKygodGhpcy5fYmFja2VuZFNlcnZpY2VBcGkgJiYgdGhpcy5fYmFja2VuZFNlcnZpY2VBcGkub3B0aW9ucyAmJiB0aGlzLl9iYWNrZW5kU2VydmljZUFwaS5vcHRpb25zLnBhZ2luYXRpb25PcHRpb25zICYmIHRoaXMuX2JhY2tlbmRTZXJ2aWNlQXBpLm9wdGlvbnMucGFnaW5hdGlvbk9wdGlvbnMuZmlyc3QpID8gdGhpcy5fYmFja2VuZFNlcnZpY2VBcGkub3B0aW9ucy5wYWdpbmF0aW9uT3B0aW9ucy5maXJzdCA6IHBhZ2luYXRpb24ucGFnZVNpemUpO1xyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG5cclxuICAgICAgLy8gaWYgdG90YWxJdGVtcyBjaGFuZ2VkLCB3ZSBzaG91bGQgYWx3YXlzIGdvIGJhY2sgdG8gdGhlIGZpcnN0IHBhZ2UgYW5kIHJlY2FsY3VsYXRpb24gdGhlIEZyb20tVG8gaW5kZXhlc1xyXG4gICAgICBpZiAoaXNQYWdlTnVtYmVyUmVzZXQgfHwgdGhpcy5fdG90YWxJdGVtcyAhPT0gcGFnaW5hdGlvbi50b3RhbEl0ZW1zKSB7XHJcbiAgICAgICAgaWYgKGlzUGFnZU51bWJlclJlc2V0KSB7XHJcbiAgICAgICAgICB0aGlzLl9wYWdlTnVtYmVyID0gMTtcclxuICAgICAgICAgIHRoaXMucGFnaW5hdGlvbk9wdGlvbnMucGFnZU51bWJlciA9IDE7XHJcbiAgICAgICAgfSBlbHNlIGlmICghdGhpcy5faW5pdGlhbGl6ZWQgJiYgcGFnaW5hdGlvbi5wYWdlTnVtYmVyICYmIHBhZ2luYXRpb24ucGFnZU51bWJlciA+IDEpIHtcclxuICAgICAgICAgIHRoaXMuX3BhZ2VOdW1iZXIgPSBwYWdpbmF0aW9uLnBhZ2VOdW1iZXIgfHwgMTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIC8vIHdoZW4gcGFnZSBudW1iZXIgaXMgc2V0IHRvIDEgdGhlbiBhbHNvIHJlc2V0IHRoZSBcIm9mZnNldFwiIG9mIGJhY2tlbmQgc2VydmljZVxyXG4gICAgICAgIGlmICh0aGlzLl9wYWdlTnVtYmVyID09PSAxICYmIHRoaXMuX2JhY2tlbmRTZXJ2aWNlQXBpKSB7XHJcbiAgICAgICAgICB0aGlzLl9iYWNrZW5kU2VydmljZUFwaS5zZXJ2aWNlLnJlc2V0UGFnaW5hdGlvbk9wdGlvbnMoKTtcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIC8vIGNhbGN1bGF0ZSBhbmQgcmVmcmVzaCB0aGUgbXVsdGlwbGUgcHJvcGVydGllcyBvZiB0aGUgcGFnaW5hdGlvbiBVSVxyXG4gICAgICB0aGlzLl9hdmFpbGFibGVQYWdlU2l6ZXMgPSBwYWdpbmF0aW9uLnBhZ2VTaXplcztcclxuICAgICAgaWYgKCF0aGlzLl90b3RhbEl0ZW1zICYmIHBhZ2luYXRpb24udG90YWxJdGVtcykge1xyXG4gICAgICAgIHRoaXMuX3RvdGFsSXRlbXMgPSBwYWdpbmF0aW9uLnRvdGFsSXRlbXM7XHJcbiAgICAgIH1cclxuICAgICAgdGhpcy5yZWNhbGN1bGF0ZUZyb21Ub0luZGV4ZXMoKTtcclxuICAgIH1cclxuICAgIHRoaXMuX3BhZ2VDb3VudCA9IE1hdGguY2VpbCh0aGlzLl90b3RhbEl0ZW1zIC8gdGhpcy5faXRlbXNQZXJQYWdlKTtcclxuICAgIGNvbnN0IGN1cnJlbnRQYWdpbmF0aW9uID0gdGhpcy5nZXRDdXJyZW50UGFnaW5hdGlvbigpO1xyXG4gICAgdGhpcy5zaGFyZWRTZXJ2aWNlLmN1cnJlbnRQYWdpbmF0aW9uID0gY3VycmVudFBhZ2luYXRpb247XHJcblxyXG4gICAgaWYgKHRyaWdnZXJDaGFuZ2VkRXZlbnQgJiYgIWlzZXF1YWwocHJldmlvdXNQYWdpbmF0aW9uLCBjdXJyZW50UGFnaW5hdGlvbikpIHtcclxuICAgICAgdGhpcy5vblBhZ2luYXRpb25DaGFuZ2VkLm5leHQoY3VycmVudFBhZ2luYXRpb24pO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcHJvY2Vzc09uUGFnZUNoYW5nZWQocGFnZU51bWJlcjogbnVtYmVyLCBldmVudD86IEV2ZW50IHwgdW5kZWZpbmVkKTogUHJvbWlzZTxhbnk+IHtcclxuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XHJcbiAgICAgIHRoaXMucmVjYWxjdWxhdGVGcm9tVG9JbmRleGVzKCk7XHJcblxyXG4gICAgICBpZiAodGhpcy5faXNMb2NhbEdyaWQgJiYgdGhpcy5kYXRhVmlldykge1xyXG4gICAgICAgIHRoaXMuZGF0YVZpZXcuc2V0UGFnaW5nT3B0aW9ucyh7IHBhZ2VTaXplOiB0aGlzLl9pdGVtc1BlclBhZ2UsIHBhZ2VOdW06IChwYWdlTnVtYmVyIC0gMSkgfSk7IC8vIGRhdGFWaWV3IHBhZ2Ugc3RhcnRzIGF0IDAgaW5zdGVhZCBvZiAxXHJcbiAgICAgICAgdGhpcy5vblBhZ2luYXRpb25DaGFuZ2VkLm5leHQodGhpcy5nZXRGdWxsUGFnaW5hdGlvbigpKTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICBjb25zdCBpdGVtc1BlclBhZ2UgPSArdGhpcy5faXRlbXNQZXJQYWdlO1xyXG5cclxuICAgICAgICAvLyBrZWVwIHN0YXJ0IHRpbWUgJiBlbmQgdGltZXN0YW1wcyAmIHJldHVybiBpdCBhZnRlciBwcm9jZXNzIGV4ZWN1dGlvblxyXG4gICAgICAgIGNvbnN0IHN0YXJ0VGltZSA9IG5ldyBEYXRlKCk7XHJcblxyXG4gICAgICAgIC8vIHJ1biBhbnkgcHJlLXByb2Nlc3MsIGlmIGRlZmluZWQsIGZvciBleGFtcGxlIGEgc3Bpbm5lclxyXG4gICAgICAgIGlmICh0aGlzLl9iYWNrZW5kU2VydmljZUFwaS5wcmVQcm9jZXNzKSB7XHJcbiAgICAgICAgICB0aGlzLl9iYWNrZW5kU2VydmljZUFwaS5wcmVQcm9jZXNzKCk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBjb25zdCBxdWVyeSA9IHRoaXMuX2JhY2tlbmRTZXJ2aWNlQXBpLnNlcnZpY2UucHJvY2Vzc09uUGFnaW5hdGlvbkNoYW5nZWQoZXZlbnQsIHsgbmV3UGFnZTogcGFnZU51bWJlciwgcGFnZVNpemU6IGl0ZW1zUGVyUGFnZSB9KTtcclxuXHJcbiAgICAgICAgLy8gdGhlIHByb2Nlc3NlcyBjYW4gYmUgUHJvbWlzZXMgb3IgYW4gT2JzZXJ2YWJsZXMgKGxpa2UgSHR0cENsaWVudClcclxuICAgICAgICBjb25zdCBwcm9jZXNzID0gdGhpcy5fYmFja2VuZFNlcnZpY2VBcGkucHJvY2VzcyhxdWVyeSk7XHJcbiAgICAgICAgaWYgKHByb2Nlc3MgaW5zdGFuY2VvZiBQcm9taXNlKSB7XHJcbiAgICAgICAgICBwcm9jZXNzXHJcbiAgICAgICAgICAgIC50aGVuKChwcm9jZXNzUmVzdWx0OiBHcmFwaHFsUmVzdWx0IHwgR3JhcGhxbFBhZ2luYXRlZFJlc3VsdCB8IGFueSkgPT4ge1xyXG4gICAgICAgICAgICAgIHJlc29sdmUoZXhlY3V0ZUJhY2tlbmRQcm9jZXNzZXNDYWxsYmFjayhzdGFydFRpbWUsIHByb2Nlc3NSZXN1bHQsIHRoaXMuX2JhY2tlbmRTZXJ2aWNlQXBpLCB0aGlzLl90b3RhbEl0ZW1zKSk7XHJcbiAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgIC5jYXRjaCgoZXJyb3IpID0+IHtcclxuICAgICAgICAgICAgICBvbkJhY2tlbmRFcnJvcihlcnJvciwgdGhpcy5fYmFja2VuZFNlcnZpY2VBcGkpO1xyXG4gICAgICAgICAgICAgIHJlamVjdChwcm9jZXNzKTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfSBlbHNlIGlmIChpc09ic2VydmFibGUocHJvY2VzcykpIHtcclxuICAgICAgICAgIHRoaXMuX3N1YnNjcmlwdGlvbnMucHVzaChcclxuICAgICAgICAgICAgcHJvY2Vzcy5zdWJzY3JpYmUoXHJcbiAgICAgICAgICAgICAgKHByb2Nlc3NSZXN1bHQ6IEdyYXBocWxSZXN1bHQgfCBHcmFwaHFsUGFnaW5hdGVkUmVzdWx0IHwgYW55KSA9PiB7XHJcbiAgICAgICAgICAgICAgICByZXNvbHZlKGV4ZWN1dGVCYWNrZW5kUHJvY2Vzc2VzQ2FsbGJhY2soc3RhcnRUaW1lLCBwcm9jZXNzUmVzdWx0LCB0aGlzLl9iYWNrZW5kU2VydmljZUFwaSwgdGhpcy5fdG90YWxJdGVtcykpO1xyXG4gICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgKGVycm9yOiBhbnkpID0+IHtcclxuICAgICAgICAgICAgICAgIG9uQmFja2VuZEVycm9yKGVycm9yLCB0aGlzLl9iYWNrZW5kU2VydmljZUFwaSk7XHJcbiAgICAgICAgICAgICAgICByZWplY3QocHJvY2Vzcyk7XHJcbiAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICApXHJcbiAgICAgICAgICApO1xyXG4gICAgICAgIH1cclxuICAgICAgICB0aGlzLm9uUGFnaW5hdGlvbkNoYW5nZWQubmV4dCh0aGlzLmdldEZ1bGxQYWdpbmF0aW9uKCkpO1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIHJlY2FsY3VsYXRlRnJvbVRvSW5kZXhlcygpIHtcclxuICAgIGlmICh0aGlzLl90b3RhbEl0ZW1zID09PSAwKSB7XHJcbiAgICAgIHRoaXMuX2RhdGFGcm9tID0gMDtcclxuICAgICAgdGhpcy5fZGF0YVRvID0gMTtcclxuICAgICAgdGhpcy5fcGFnZU51bWJlciA9IDA7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICB0aGlzLl9kYXRhRnJvbSA9IHRoaXMuX3BhZ2VOdW1iZXIgPiAxID8gKCh0aGlzLl9wYWdlTnVtYmVyICogdGhpcy5faXRlbXNQZXJQYWdlKSAtIHRoaXMuX2l0ZW1zUGVyUGFnZSArIDEpIDogMTtcclxuICAgICAgdGhpcy5fZGF0YVRvID0gKHRoaXMuX3RvdGFsSXRlbXMgPCB0aGlzLl9pdGVtc1BlclBhZ2UpID8gdGhpcy5fdG90YWxJdGVtcyA6ICgodGhpcy5fcGFnZU51bWJlciB8fCAxKSAqIHRoaXMuX2l0ZW1zUGVyUGFnZSk7XHJcbiAgICAgIGlmICh0aGlzLl9kYXRhVG8gPiB0aGlzLl90b3RhbEl0ZW1zKSB7XHJcbiAgICAgICAgdGhpcy5fZGF0YVRvID0gdGhpcy5fdG90YWxJdGVtcztcclxuICAgICAgfVxyXG4gICAgfVxyXG4gICAgdGhpcy5fcGFnZU51bWJlciA9ICh0aGlzLl90b3RhbEl0ZW1zID4gMCAmJiB0aGlzLl9wYWdlTnVtYmVyID09PSAwKSA/IDEgOiB0aGlzLl9wYWdlTnVtYmVyO1xyXG5cclxuICAgIC8vIGRvIGEgZmluYWwgY2hlY2sgb24gdGhlIEZyb20vVG8gYW5kIG1ha2Ugc3VyZSB0aGV5IGFyZSBub3Qgb3ZlciBvciBiZWxvdyBtaW4vbWF4IGFjY2VwdGFibGUgdmFsdWVzXHJcbiAgICBpZiAodGhpcy5fZGF0YVRvID4gdGhpcy5fdG90YWxJdGVtcykge1xyXG4gICAgICB0aGlzLl9kYXRhVG8gPSB0aGlzLl90b3RhbEl0ZW1zO1xyXG4gICAgfSBlbHNlIGlmICh0aGlzLl90b3RhbEl0ZW1zIDwgdGhpcy5faXRlbXNQZXJQYWdlKSB7XHJcbiAgICAgIHRoaXMuX2RhdGFUbyA9IHRoaXMuX3RvdGFsSXRlbXM7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvKiogUmVzZXQgdGhlIFBhZ2luYXRpb24gdG8gZmlyc3QgcGFnZSBhbmQgcmVjYWxjdWxhdGUgbmVjZXNzYXJ5IG51bWJlcnMgKi9cclxuICByZXNldFBhZ2luYXRpb24odHJpZ2dlckNoYW5nZWRFdmVudCA9IHRydWUpIHtcclxuICAgIGlmICh0aGlzLl9pc0xvY2FsR3JpZCkge1xyXG4gICAgICAvLyBvbiBhIGxvY2FsIGdyaWQgd2UgYWxzbyBuZWVkIHRvIHJlc2V0IHRoZSBEYXRhVmlldyBwYWdpbmcgdG8gMXN0IHBhZ2VcclxuICAgICAgdGhpcy5kYXRhVmlldy5zZXRQYWdpbmdPcHRpb25zKHsgcGFnZVNpemU6IHRoaXMuX2l0ZW1zUGVyUGFnZSwgcGFnZU51bTogMCB9KTtcclxuICAgIH1cclxuICAgIHRoaXMucmVmcmVzaFBhZ2luYXRpb24odHJ1ZSwgdHJpZ2dlckNoYW5nZWRFdmVudCk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBUb2dnbGUgdGhlIFBhZ2luYXRpb24gKHNob3cvaGlkZSksIGl0IHdpbGwgdXNlIHRoZSB2aXNpYmxlIGlmIGRlZmluZWQgZWxzZSBpdCB3aWxsIGF1dG9tYXRpY2FsbHkgaW52ZXJzZSB3aGVuIGNhbGxlZCB3aXRob3V0IGFyZ3VtZW50XHJcbiAgICpcclxuICAgKiBJTVBPUlRBTlQgTk9URTpcclxuICAgKiBUaGUgUGFnaW5hdGlvbiBtdXN0IGJlIGNyZWF0ZWQgb24gaW5pdGlhbCBwYWdlIGxvYWQsIHRoZW4gb25seSBhZnRlciBjYW4geW91IHRvZ2dsZSBpdC5cclxuICAgKiBCYXNpY2FsbHkgdGhpcyBtZXRob2QgV0lMTCBOT1QgV09SSyB0byBzaG93IHRoZSBQYWdpbmF0aW9uIGlmIGl0IHdhcyBub3QgdGhlcmUgZnJvbSB0aGUgc3RhcnQuXHJcbiAgICovXHJcbiAgdG9nZ2xlUGFnaW5hdGlvblZpc2liaWxpdHkodmlzaWJsZT86IGJvb2xlYW4pIHtcclxuICAgIGlmICh0aGlzLmdyaWQgJiYgdGhpcy5zaGFyZWRTZXJ2aWNlICYmIHRoaXMuc2hhcmVkU2VydmljZS5ncmlkT3B0aW9ucykge1xyXG4gICAgICBjb25zdCBpc1Zpc2libGUgPSB2aXNpYmxlICE9PSB1bmRlZmluZWQgPyB2aXNpYmxlIDogIXRoaXMuc2hhcmVkU2VydmljZS5ncmlkT3B0aW9ucy5lbmFibGVQYWdpbmF0aW9uO1xyXG4gICAgICB0aGlzLnNoYXJlZFNlcnZpY2UuZ3JpZE9wdGlvbnMuZW5hYmxlUGFnaW5hdGlvbiA9IGlzVmlzaWJsZTtcclxuICAgICAgdGhpcy5vblBhZ2luYXRpb25WaXNpYmlsaXR5Q2hhbmdlZC5uZXh0KHsgdmlzaWJsZTogaXNWaXNpYmxlIH0pO1xyXG5cclxuICAgICAgLy8gbWFrZSBzdXJlIHRvIHJlc2V0IHRoZSBQYWdpbmF0aW9uIGFuZCBnbyBiYWNrIHRvIGZpcnN0IHBhZ2UgdG8gYXZvaWQgYW55IGlzc3VlcyB3aXRoIFBhZ2luYXRpb24gYmVpbmcgb2Zmc2V0XHJcbiAgICAgIGlmIChpc1Zpc2libGUpIHtcclxuICAgICAgICB0aGlzLmdvVG9GaXJzdFBhZ2UoKTtcclxuICAgICAgfVxyXG5cclxuICAgICAgLy8gd2hlbiB1c2luZyBhIGxvY2FsIGdyaWQsIHdlIGNhbiByZXNldCB0aGUgRGF0YVZpZXcgcGFnaW5hdGlvbiBieSBjaGFuZ2luZyBpdHMgcGFnZSBzaXplXHJcbiAgICAgIC8vIHBhZ2Ugc2l6ZSBvZiAwIHdvdWxkIHNob3cgYWxsLCBoZW5jZSBjYW5jZWwgdGhlIHBhZ2luYXRpb25cclxuICAgICAgaWYgKHRoaXMuX2lzTG9jYWxHcmlkKSB7XHJcbiAgICAgICAgY29uc3QgcGFnZVNpemUgPSB2aXNpYmxlID8gdGhpcy5faXRlbXNQZXJQYWdlIDogMDtcclxuICAgICAgICB0aGlzLmRhdGFWaWV3LnNldFBhZ2luZ09wdGlvbnMoeyBwYWdlU2l6ZSwgcGFnZU51bTogMCB9KTtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLy8gLS1cclxuICAvLyBwcml2YXRlIGZ1bmN0aW9uc1xyXG4gIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tXHJcblxyXG4gIHVwZGF0ZVRvdGFsSXRlbXModG90YWxJdGVtczogbnVtYmVyLCB0cmlnZ2VyQ2hhbmdlZEV2ZW50ID0gZmFsc2UpIHtcclxuICAgIHRoaXMuX3RvdGFsSXRlbXMgPSB0b3RhbEl0ZW1zO1xyXG4gICAgaWYgKHRoaXMuX3BhZ2luYXRpb25PcHRpb25zKSB7XHJcbiAgICAgIHRoaXMuX3BhZ2luYXRpb25PcHRpb25zLnRvdGFsSXRlbXMgPSB0b3RhbEl0ZW1zO1xyXG4gICAgICB0aGlzLnJlZnJlc2hQYWdpbmF0aW9uKGZhbHNlLCB0cmlnZ2VyQ2hhbmdlZEV2ZW50KTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFdoZW4gaXRlbSBpcyBhZGRlZCBvciByZW1vdmVkLCB3ZSB3aWxsIHJlZnJlc2ggdGhlIG51bWJlcnMgb24gdGhlIHBhZ2luYXRpb24gaG93ZXZlciB3ZSB3b24ndCB0cmlnZ2VyIGEgYmFja2VuZCBjaGFuZ2VcclxuICAgKiBUaGlzIHdpbGwgaGF2ZSBhIHNpZGUgZWZmZWN0IHRob3VnaCwgd2hpY2ggaXMgdGhhdCB0aGUgXCJUb1wiIGNvdW50IHdvbid0IGJlIG1hdGNoaW5nIHRoZSBcIml0ZW1zIHBlciBwYWdlXCIgY291bnQsXHJcbiAgICogdGhhdCBpcyBhIG5lY2Vzc2FyeSBzaWRlIGVmZmVjdCB0byBhdm9pZCB0cmlnZ2VyaW5nIGEgYmFja2VuZCBxdWVyeSBqdXN0IHRvIHJlZnJlc2ggdGhlIHBhZ2luZyxcclxuICAgKiBiYXNpY2FsbHkgd2UgYXNzdW1lIHRoYXQgdGhpcyBvZmZzZXQgaXMgZmluZSBmb3IgdGhlIHRpbWUgYmVpbmcsXHJcbiAgICogdW50aWwgdXNlciBkb2VzIGFuIGFjdGlvbiB3aGljaCB3aWxsIHJlZnJlc2ggdGhlIGRhdGEgaGVuY2UgdGhlIHBhZ2luYXRpb24gd2hpY2ggd2lsbCB0aGVuIGJlY29tZSBub3JtYWwgYWdhaW5cclxuICAgKi9cclxuICBwcml2YXRlIHByb2Nlc3NPbkl0ZW1BZGRlZE9yUmVtb3ZlZChpdGVtczogYW55IHwgYW55W10sIGlzSXRlbUFkZGVkID0gdHJ1ZSkge1xyXG4gICAgaWYgKGl0ZW1zICE9PSBudWxsKSB7XHJcbiAgICAgIGNvbnN0IHByZXZpb3VzRGF0YVRvID0gdGhpcy5fZGF0YVRvO1xyXG4gICAgICBjb25zdCBpdGVtQ291bnQgPSBBcnJheS5pc0FycmF5KGl0ZW1zKSA/IGl0ZW1zLmxlbmd0aCA6IDE7XHJcbiAgICAgIGNvbnN0IGl0ZW1Db3VudFdpdGhEaXJlY3Rpb24gPSBpc0l0ZW1BZGRlZCA/ICtpdGVtQ291bnQgOiAtaXRlbUNvdW50O1xyXG5cclxuICAgICAgLy8gcmVmcmVzaCB0aGUgdG90YWwgY291bnQgaW4gdGhlIHBhZ2luYXRpb24gYW5kIGluIHRoZSBVSVxyXG4gICAgICB0aGlzLl90b3RhbEl0ZW1zICs9IGl0ZW1Db3VudFdpdGhEaXJlY3Rpb247XHJcbiAgICAgIHRoaXMucmVjYWxjdWxhdGVGcm9tVG9JbmRleGVzKCk7XHJcblxyXG4gICAgICAvLyBmaW5hbGx5IHJlZnJlc2ggdGhlIFwiVG9cIiBjb3VudCBhbmQgd2Uga25vdyBpdCBtaWdodCBiZSBkaWZmZXJlbnQgdGhhbiB0aGUgXCJpdGVtcyBwZXIgcGFnZVwiIGNvdW50XHJcbiAgICAgIC8vIGJ1dCB0aGlzIGlzIG5lY2Vzc2FyeSBzaW5jZSB3ZSBkb24ndCB3YW50IGFuIGFjdHVhbCBiYWNrZW5kIHJlZnJlc2hcclxuICAgICAgdGhpcy5fZGF0YVRvID0gcHJldmlvdXNEYXRhVG8gKyBpdGVtQ291bnRXaXRoRGlyZWN0aW9uO1xyXG4gICAgICB0aGlzLm9uUGFnaW5hdGlvbkNoYW5nZWQubmV4dCh0aGlzLmdldEZ1bGxQYWdpbmF0aW9uKCkpO1xyXG4gICAgfVxyXG4gIH1cclxufVxyXG4iXX0=