import * as tslib_1 from "tslib";
import { Injectable } from '@angular/core';
import { ExtensionName } from './../models/index';
import { ExtensionUtility } from '../extensions/extensionUtility';
import { ExtensionService } from './extension.service';
import { ResizerService } from './resizer.service';
import { unsubscribeAllObservables } from './utilities';
import { SharedService } from './shared.service';
var GroupingAndColspanService = /** @class */ (function () {
    function GroupingAndColspanService(extensionUtility, extensionService, resizerService, sharedService) {
        this.extensionUtility = extensionUtility;
        this.extensionService = extensionService;
        this.resizerService = resizerService;
        this.sharedService = sharedService;
        this.subscriptions = [];
        this._eventHandler = new Slick.EventHandler();
    }
    Object.defineProperty(GroupingAndColspanService.prototype, "eventHandler", {
        /** Getter of the SlickGrid Event Handler */
        get: function () {
            return this._eventHandler;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(GroupingAndColspanService.prototype, "_gridOptions", {
        /** Getter for the Grid Options pulled through the Grid Object */
        get: function () {
            return (this._grid && this._grid.getOptions) ? this._grid.getOptions() : {};
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(GroupingAndColspanService.prototype, "_columnDefinitions", {
        /** Getter for the Column Definitions pulled through the Grid Object */
        get: function () {
            return (this._grid && this._grid.getColumns) ? this._grid.getColumns() : [];
        },
        enumerable: true,
        configurable: true
    });
    GroupingAndColspanService.prototype.init = function (grid, dataView) {
        var _this = this;
        this._grid = grid;
        if (grid && this._gridOptions) {
            // When dealing with Pre-Header Grouping colspan, we need to re-create the pre-header in multiple occasions
            // for all these events, we have to trigger a re-create
            if (this._gridOptions.createPreHeaderPanel) {
                // on all following events, call the
                this._eventHandler.subscribe(grid.onSort, function () { return _this.renderPreHeaderRowGroupingTitles(); });
                this._eventHandler.subscribe(grid.onColumnsResized, function () { return _this.renderPreHeaderRowGroupingTitles(); });
                this._eventHandler.subscribe(grid.onColumnsReordered, function () { return _this.renderPreHeaderRowGroupingTitles(); });
                this._eventHandler.subscribe(dataView.onRowCountChanged, function () { return _this.renderPreHeaderRowGroupingTitles(); });
                this.subscriptions.push(this.resizerService.onGridAfterResize.subscribe(function () { return _this.renderPreHeaderRowGroupingTitles(); }), this.sharedService.onHeaderMenuHideColumns.subscribe(function () { return _this.delayRenderPreHeaderRowGroupingTitles(0); }));
                this._eventHandler.subscribe(grid.onSetOptions, function (_e, args) {
                    // when user changes frozen columns dynamically (e.g. from header menu), we need to re-render the pre-header of the grouping titles
                    if (args && args.optionsBefore && args.optionsAfter && args.optionsBefore.frozenColumn !== args.optionsAfter.frozenColumn) {
                        _this.delayRenderPreHeaderRowGroupingTitles(0);
                    }
                });
                // for both picker (columnPicker/gridMenu) we also need to re-create after hiding/showing columns
                var columnPickerExtension = this.extensionService.getExtensionByName(ExtensionName.columnPicker);
                if (columnPickerExtension && columnPickerExtension.instance && columnPickerExtension.instance.onColumnsChanged) {
                    this._eventHandler.subscribe(columnPickerExtension.instance.onColumnsChanged, function () { return _this.renderPreHeaderRowGroupingTitles(); });
                }
                var gridMenuExtension = this.extensionService.getExtensionByName(ExtensionName.gridMenu);
                if (gridMenuExtension && gridMenuExtension.instance && gridMenuExtension.instance.onColumnsChanged && gridMenuExtension.instance.onMenuClose) {
                    this._eventHandler.subscribe(gridMenuExtension.instance.onColumnsChanged, function () { return _this.renderPreHeaderRowGroupingTitles(); });
                    this._eventHandler.subscribe(gridMenuExtension.instance.onMenuClose, function () { return _this.renderPreHeaderRowGroupingTitles(); });
                }
                // also not sure why at this point, but it seems that I need to call the 1st create in a delayed execution
                // probably some kind of timing issues and delaying it until the grid is fully ready fixes this problem
                this.delayRenderPreHeaderRowGroupingTitles(50);
            }
        }
    };
    GroupingAndColspanService.prototype.dispose = function () {
        // unsubscribe all SlickGrid events
        this._eventHandler.unsubscribeAll();
        // also unsubscribe all Angular Subscriptions
        this.subscriptions = unsubscribeAllObservables(this.subscriptions);
    };
    /** call "renderPreHeaderRowGroupingTitles()" with a setTimeout delay */
    GroupingAndColspanService.prototype.delayRenderPreHeaderRowGroupingTitles = function (delay) {
        var _this = this;
        if (delay === void 0) { delay = 0; }
        setTimeout(function () { return _this.renderPreHeaderRowGroupingTitles(); }, delay);
    };
    /** Create or Render the Pre-Header Row Grouping Titles */
    GroupingAndColspanService.prototype.renderPreHeaderRowGroupingTitles = function () {
        if (this._gridOptions && this._gridOptions.frozenColumn !== undefined && this._gridOptions.frozenColumn >= 0) {
            // Add column groups to left panel
            var $preHeaderPanel = $(this._grid.getPreHeaderPanelLeft());
            this.renderHeaderGroups($preHeaderPanel, 0, this._gridOptions.frozenColumn + 1);
            // Add column groups to right panel
            $preHeaderPanel = $(this._grid.getPreHeaderPanelRight());
            this.renderHeaderGroups($preHeaderPanel, this._gridOptions.frozenColumn + 1, this._columnDefinitions.length);
        }
        else {
            // regular grid (not a frozen grid)
            var $preHeaderPanel = $(this._grid.getPreHeaderPanel());
            this.renderHeaderGroups($preHeaderPanel, 0, this._columnDefinitions.length);
        }
    };
    GroupingAndColspanService.prototype.renderHeaderGroups = function (preHeaderPanel, start, end) {
        preHeaderPanel.empty()
            .addClass('slick-header-columns')
            .css('left', '-1000px')
            .width(this._grid.getHeadersWidth());
        preHeaderPanel.parent().addClass('slick-header');
        var headerColumnWidthDiff = this._grid.getHeaderColumnWidthDiff();
        var colDef;
        var header;
        var lastColumnGroup = '';
        var widthTotal = 0;
        var frozenHeaderWidthCalcDifferential = this._gridOptions && this._gridOptions.frozenHeaderWidthCalcDifferential || 0;
        var isFrozenGrid = (this._gridOptions && (this._gridOptions.frozenColumn !== undefined && this._gridOptions.frozenColumn >= 0));
        for (var i = start; i < end; i++) {
            colDef = this._columnDefinitions[i];
            if (colDef) {
                if (lastColumnGroup === colDef.columnGroup && i > 0) {
                    widthTotal += colDef.width || 0;
                    if (header && header.width) {
                        header.width(widthTotal - headerColumnWidthDiff - frozenHeaderWidthCalcDifferential); // remove possible frozen border
                    }
                }
                else {
                    widthTotal = colDef.width || 0;
                    header = $("<div class=\"ui-state-default slick-header-column " + (isFrozenGrid ? 'frozen' : '') + "\" />")
                        .html("<span class=\"slick-column-name\">" + (colDef.columnGroup || '') + "</span>")
                        .width(widthTotal - headerColumnWidthDiff)
                        .appendTo(preHeaderPanel);
                }
                lastColumnGroup = colDef.columnGroup || '';
            }
        }
    };
    /** Translate Column Group texts and re-render them afterward. */
    GroupingAndColspanService.prototype.translateGroupingAndColSpan = function () {
        var currentColumnDefinitions = this._grid.getColumns();
        this.extensionUtility.translateItems(currentColumnDefinitions, 'columnGroupKey', 'columnGroup');
        this._grid.setColumns(currentColumnDefinitions);
        this.renderPreHeaderRowGroupingTitles();
    };
    GroupingAndColspanService.ctorParameters = function () { return [
        { type: ExtensionUtility },
        { type: ExtensionService },
        { type: ResizerService },
        { type: SharedService }
    ]; };
    GroupingAndColspanService = tslib_1.__decorate([
        Injectable()
    ], GroupingAndColspanService);
    return GroupingAndColspanService;
}());
export { GroupingAndColspanService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ3JvdXBpbmdBbmRDb2xzcGFuLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9hbmd1bGFyLXNsaWNrZ3JpZC8iLCJzb3VyY2VzIjpbImFwcC9tb2R1bGVzL2FuZ3VsYXItc2xpY2tncmlkL3NlcnZpY2VzL2dyb3VwaW5nQW5kQ29sc3Bhbi5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBRzNDLE9BQU8sRUFBeUMsYUFBYSxFQUFFLE1BQU0sbUJBQW1CLENBQUM7QUFDekYsT0FBTyxFQUFFLGdCQUFnQixFQUFFLE1BQU0sZ0NBQWdDLENBQUM7QUFDbEUsT0FBTyxFQUFFLGdCQUFnQixFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFDdkQsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBQ25ELE9BQU8sRUFBRSx5QkFBeUIsRUFBRSxNQUFNLGFBQWEsQ0FBQztBQUN4RCxPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0sa0JBQWtCLENBQUM7QUFTakQ7SUFLRSxtQ0FBb0IsZ0JBQWtDLEVBQVUsZ0JBQWtDLEVBQVUsY0FBOEIsRUFBVSxhQUE0QjtRQUE1SixxQkFBZ0IsR0FBaEIsZ0JBQWdCLENBQWtCO1FBQVUscUJBQWdCLEdBQWhCLGdCQUFnQixDQUFrQjtRQUFVLG1CQUFjLEdBQWQsY0FBYyxDQUFnQjtRQUFVLGtCQUFhLEdBQWIsYUFBYSxDQUFlO1FBRnhLLGtCQUFhLEdBQW1CLEVBQUUsQ0FBQztRQUd6QyxJQUFJLENBQUMsYUFBYSxHQUFHLElBQUksS0FBSyxDQUFDLFlBQVksRUFBRSxDQUFDO0lBQ2hELENBQUM7SUFHRCxzQkFBSSxtREFBWTtRQURoQiw0Q0FBNEM7YUFDNUM7WUFDRSxPQUFPLElBQUksQ0FBQyxhQUFhLENBQUM7UUFDNUIsQ0FBQzs7O09BQUE7SUFHRCxzQkFBWSxtREFBWTtRQUR4QixpRUFBaUU7YUFDakU7WUFDRSxPQUFP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QUFHLENBQUMsQ0FBQyx3REFBb0QsWUFBWSxDQUFDLENBQUMsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLEVBQUUsV0FBTSxDQUFDO3lCQUMvRixJQUFJLENBQUMsd0NBQW1DLE1BQU0sQ0FBQyxXQUFXLElBQUksRUFBRSxhQUFTLENBQUM7eUJBQzFFLEtBQUssQ0FBQyxVQUFVLEdBQUcscUJBQXFCLENBQUM7eUJBQ3pDLFFBQVEsQ0FBQyxjQUFjLENBQUMsQ0FBQztpQkFDN0I7Z0JBQ0QsZUFBZSxHQUFHLE1BQU0sQ0FBQyxXQUFXLElBQUksRUFBRSxDQUFDO2FBQzVDO1NBQ0Y7SUFDSCxDQUFDO0lBR0QsaUVBQWlFO0lBQ2pFLCtEQUEyQixHQUEzQjtRQUNFLElBQU0sd0JBQXdCLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxVQUFVLEVBQUUsQ0FBQztRQUN6RCxJQUFJLENBQUMsZ0JBQWdCLENBQUMsY0FBYyxDQUFDLHdCQUF3QixFQUFFLGdCQUFnQixFQUFFLGFBQWEsQ0FBQyxDQUFDO1FBQ2hHLElBQUksQ0FBQyxLQUFLLENBQUMsVUFBVSxDQUFDLHdCQUF3QixDQUFDLENBQUM7UUFDaEQsSUFBSSxDQUFDLGdDQUFnQyxFQUFFLENBQUM7SUFDMUMsQ0FBQzs7Z0JBdklxQyxnQkFBZ0I7Z0JBQTRCLGdCQUFnQjtnQkFBMEIsY0FBYztnQkFBeUIsYUFBYTs7SUFMcksseUJBQXlCO1FBRHJDLFVBQVUsRUFBRTtPQUNBLHlCQUF5QixDQTZJckM7SUFBRCxnQ0FBQztDQUFBLEFBN0lELElBNklDO1NBN0lZLHlCQUF5QiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgU3Vic2NyaXB0aW9uIH0gZnJvbSAncnhqcyc7XHJcblxyXG5pbXBvcnQgeyBDb2x1bW4sIEdyaWRPcHRpb24sIFNsaWNrRXZlbnRIYW5kbGVyLCBFeHRlbnNpb25OYW1lIH0gZnJvbSAnLi8uLi9tb2RlbHMvaW5kZXgnO1xyXG5pbXBvcnQgeyBFeHRlbnNpb25VdGlsaXR5IH0gZnJvbSAnLi4vZXh0ZW5zaW9ucy9leHRlbnNpb25VdGlsaXR5JztcclxuaW1wb3J0IHsgRXh0ZW5zaW9uU2VydmljZSB9IGZyb20gJy4vZXh0ZW5zaW9uLnNlcnZpY2UnO1xyXG5pbXBvcnQgeyBSZXNpemVyU2VydmljZSB9IGZyb20gJy4vcmVzaXplci5zZXJ2aWNlJztcclxuaW1wb3J0IHsgdW5zdWJzY3JpYmVBbGxPYnNlcnZhYmxlcyB9IGZyb20gJy4vdXRpbGl0aWVzJztcclxuaW1wb3J0IHsgU2hhcmVkU2VydmljZSB9IGZyb20gJy4vc2hhcmVkLnNlcnZpY2UnO1xyXG5cclxuLy8gdXNpbmcgZXh0ZXJuYWwgbm9uLXR5cGVkIGpzIGxpYnJhcmllc1xyXG5kZWNsYXJlIGxldCAkOiBhbnk7XHJcblxyXG4vLyB1c2luZyBleHRlcm5hbCBub24tdHlwZWQganMgbGlicmFyaWVzXHJcbmRlY2xhcmUgY29uc3QgU2xpY2s6IGFueTtcclxuXHJcbkBJbmplY3RhYmxlKClcclxuZXhwb3J0IGNsYXNzIEdyb3VwaW5nQW5kQ29sc3BhblNlcnZpY2Uge1xyXG4gIHByaXZhdGUgX2V2ZW50SGFuZGxlcjogU2xpY2tFdmVudEhhbmRsZXI7XHJcbiAgcHJpdmF0ZSBfZ3JpZDogYW55O1xyXG4gIHByaXZhdGUgc3Vic2NyaXB0aW9uczogU3Vic2NyaXB0aW9uW10gPSBbXTtcclxuXHJcbiAgY29uc3RydWN0b3IocHJpdmF0ZSBleHRlbnNpb25VdGlsaXR5OiBFeHRlbnNpb25VdGlsaXR5LCBwcml2YXRlIGV4dGVuc2lvblNlcnZpY2U6IEV4dGVuc2lvblNlcnZpY2UsIHByaXZhdGUgcmVzaXplclNlcnZpY2U6IFJlc2l6ZXJTZXJ2aWNlLCBwcml2YXRlIHNoYXJlZFNlcnZpY2U6IFNoYXJlZFNlcnZpY2UpIHtcclxuICAgIHRoaXMuX2V2ZW50SGFuZGxlciA9IG5ldyBTbGljay5FdmVudEhhbmRsZXIoKTtcclxuICB9XHJcblxyXG4gIC8qKiBHZXR0ZXIgb2YgdGhlIFNsaWNrR3JpZCBFdmVudCBIYW5kbGVyICovXHJcbiAgZ2V0IGV2ZW50SGFuZGxlcigpOiBTbGlja0V2ZW50SGFuZGxlciB7XHJcbiAgICByZXR1cm4gdGhpcy5fZXZlbnRIYW5kbGVyO1xyXG4gIH1cclxuXHJcbiAgLyoqIEdldHRlciBmb3IgdGhlIEdyaWQgT3B0aW9ucyBwdWxsZWQgdGhyb3VnaCB0aGUgR3JpZCBPYmplY3QgKi9cclxuICBwcml2YXRlIGdldCBfZ3JpZE9wdGlvbnMoKTogR3JpZE9wdGlvbiB7XHJcbiAgICByZXR1cm4gKHRoaXMuX2dyaWQgJiYgdGhpcy5fZ3JpZC5nZXRPcHRpb25zKSA/IHRoaXMuX2dyaWQuZ2V0T3B0aW9ucygpIDoge307XHJcbiAgfVxyXG5cclxuICAvKiogR2V0dGVyIGZvciB0aGUgQ29sdW1uIERlZmluaXRpb25zIHB1bGxlZCB0aHJvdWdoIHRoZSBHcmlkIE9iamVjdCAqL1xyXG4gIHByaXZhdGUgZ2V0IF9jb2x1bW5EZWZpbml0aW9ucygpOiBDb2x1bW5bXSB7XHJcbiAgICByZXR1cm4gKHRoaXMuX2dyaWQgJiYgdGhpcy5fZ3JpZC5nZXRDb2x1bW5zKSA/IHRoaXMuX2dyaWQuZ2V0Q29sdW1ucygpIDogW107XHJcbiAgfVxyXG5cclxuICBpbml0KGdyaWQ6IGFueSwgZGF0YVZpZXc6IGFueSkge1xyXG4gICAgdGhpcy5fZ3JpZCA9IGdyaWQ7XHJcblxyXG4gICAgaWYgKGdyaWQgJiYgdGhpcy5fZ3JpZE9wdGlvbnMpIHtcclxuICAgICAgLy8gV2hlbiBkZWFsaW5nIHdpdGggUHJlLUhlYWRlciBHcm91cGluZyBjb2xzcGFuLCB3ZSBuZWVkIHRvIHJlLWNyZWF0ZSB0aGUgcHJlLWhlYWRlciBpbiBtdWx0aXBsZSBvY2Nhc2lvbnNcclxuICAgICAgLy8gZm9yIGFsbCB0aGVzZSBldmVudHMsIHdlIGhhdmUgdG8gdHJpZ2dlciBhIHJlLWNyZWF0ZVxyXG4gICAgICBpZiAodGhpcy5fZ3JpZE9wdGlvbnMuY3JlYXRlUHJlSGVhZGVyUGFuZWwpIHtcclxuICAgICAgICAvLyBvbiBhbGwgZm9sbG93aW5nIGV2ZW50cywgY2FsbCB0aGVcclxuICAgICAgICB0aGlzLl9ldmVudEhhbmRsZXIuc3Vic2NyaWJlKGdyaWQub25Tb3J0LCAoKSA9PiB0aGlzLnJlbmRlclByZUhlYWRlclJvd0dyb3VwaW5nVGl0bGVzKCkpO1xyXG4gICAgICAgIHRoaXMuX2V2ZW50SGFuZGxlci5zdWJzY3JpYmUoZ3JpZC5vbkNvbHVtbnNSZXNpemVkLCAoKSA9PiB0aGlzLnJlbmRlclByZUhlYWRlclJvd0dyb3VwaW5nVGl0bGVzKCkpO1xyXG4gICAgICAgIHRoaXMuX2V2ZW50SGFuZGxlci5zdWJzY3JpYmUoZ3JpZC5vbkNvbHVtbnNSZW9yZGVyZWQsICgpID0+IHRoaXMucmVuZGVyUHJlSGVhZGVyUm93R3JvdXBpbmdUaXRsZXMoKSk7XHJcbiAgICAgICAgdGhpcy5fZXZlbnRIYW5kbGVyLnN1YnNjcmliZShkYXRhVmlldy5vblJvd0NvdW50Q2hhbmdlZCwgKCkgPT4gdGhpcy5yZW5kZXJQcmVIZWFkZXJSb3dHcm91cGluZ1RpdGxlcygpKTtcclxuICAgICAgICB0aGlzLnN1YnNjcmlwdGlvbnMucHVzaChcclxuICAgICAgICAgIHRoaXMucmVzaXplclNlcnZpY2Uub25HcmlkQWZ0ZXJSZXNpemUuc3Vic2NyaWJlKCgpID0+IHRoaXMucmVuZGVyUHJlSGVhZGVyUm93R3JvdXBpbmdUaXRsZXMoKSksXHJcbiAgICAgICAgICB0aGlzLnNoYXJlZFNlcnZpY2Uub25IZWFkZXJNZW51SGlkZUNvbHVtbnMuc3Vic2NyaWJlKCgpID0+IHRoaXMuZGVsYXlSZW5kZXJQcmVIZWFkZXJSb3dHcm91cGluZ1RpdGxlcygwKSlcclxuICAgICAgICApO1xyXG5cclxuICAgICAgICB0aGlzLl9ldmVudEhhbmRsZXIuc3Vic2NyaWJlKGdyaWQub25TZXRPcHRpb25zLCAoX2UsIGFyZ3MpID0+IHtcclxuICAgICAgICAgIC8vIHdoZW4gdXNlciBjaGFuZ2VzIGZyb3plbiBjb2x1bW5zIGR5bmFtaWNhbGx5IChlLmcuIGZyb20gaGVhZGVyIG1lbnUpLCB3ZSBuZWVkIHRvIHJlLXJlbmRlciB0aGUgcHJlLWhlYWRlciBvZiB0aGUgZ3JvdXBpbmcgdGl0bGVzXHJcbiAgICAgICAgICBpZiAoYXJncyAmJiBhcmdzLm9wdGlvbnNCZWZvcmUgJiYgYXJncy5vcHRpb25zQWZ0ZXIgJiYgYXJncy5vcHRpb25zQmVmb3JlLmZyb3plbkNvbHVtbiAhPT0gYXJncy5vcHRpb25zQWZ0ZXIuZnJvemVuQ29sdW1uKSB7XHJcbiAgICAgICAgICAgIHRoaXMuZGVsYXlSZW5kZXJQcmVIZWFkZXJSb3dHcm91cGluZ1RpdGxlcygwKTtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgLy8gZm9yIGJvdGggcGlja2VyIChjb2x1bW5QaWNrZXIvZ3JpZE1lbnUpIHdlIGFsc28gbmVlZCB0byByZS1jcmVhdGUgYWZ0ZXIgaGlkaW5nL3Nob3dpbmcgY29sdW1uc1xyXG4gICAgICAgIGNvbnN0IGNvbHVtblBpY2tlckV4dGVuc2lvbiA9IHRoaXMuZXh0ZW5zaW9uU2VydmljZS5nZXRFeHRlbnNpb25CeU5hbWUoRXh0ZW5zaW9uTmFtZS5jb2x1bW5QaWNrZXIpO1xyXG4gICAgICAgIGlmIChjb2x1bW5QaWNrZXJFeHRlbnNpb24gJiYgY29sdW1uUGlja2VyRXh0ZW5zaW9uLmluc3RhbmNlICYmIGNvbHVtblBpY2tlckV4dGVuc2lvbi5pbnN0YW5jZS5vbkNvbHVtbnNDaGFuZ2VkKSB7XHJcbiAgICAgICAgICB0aGlzLl9ldmVudEhhbmRsZXIuc3Vic2NyaWJlKGNvbHVtblBpY2tlckV4dGVuc2lvbi5pbnN0YW5jZS5vbkNvbHVtbnNDaGFuZ2VkLCAoKSA9PiB0aGlzLnJlbmRlclByZUhlYWRlclJvd0dyb3VwaW5nVGl0bGVzKCkpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgY29uc3QgZ3JpZE1lbnVFeHRlbnNpb24gPSB0aGlzLmV4dGVuc2lvblNlcnZpY2UuZ2V0RXh0ZW5zaW9uQnlOYW1lKEV4dGVuc2lvbk5hbWUuZ3JpZE1lbnUpO1xyXG4gICAgICAgIGlmIChncmlkTWVudUV4dGVuc2lvbiAmJiBncmlkTWVudUV4dGVuc2lvbi5pbnN0YW5jZSAmJiBncmlkTWVudUV4dGVuc2lvbi5pbnN0YW5jZS5vbkNvbHVtbnNDaGFuZ2VkICYmIGdyaWRNZW51RXh0ZW5zaW9uLmluc3RhbmNlLm9uTWVudUNsb3NlKSB7XHJcbiAgICAgICAgICB0aGlzLl9ldmVudEhhbmRsZXIuc3Vic2NyaWJlKGdyaWRNZW51RXh0ZW5zaW9uLmluc3RhbmNlLm9uQ29sdW1uc0NoYW5nZWQsICgpID0+IHRoaXMucmVuZGVyUHJlSGVhZGVyUm93R3JvdXBpbmdUaXRsZXMoKSk7XHJcbiAgICAgICAgICB0aGlzLl9ldmVudEhhbmRsZXIuc3Vic2NyaWJlKGdyaWRNZW51RXh0ZW5zaW9uLmluc3RhbmNlLm9uTWVudUNsb3NlLCAoKSA9PiB0aGlzLnJlbmRlclByZUhlYWRlclJvd0dyb3VwaW5nVGl0bGVzKCkpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgLy8gYWxzbyBub3Qgc3VyZSB3aHkgYXQgdGhpcyBwb2ludCwgYnV0IGl0IHNlZW1zIHRoYXQgSSBuZWVkIHRvIGNhbGwgdGhlIDFzdCBjcmVhdGUgaW4gYSBkZWxheWVkIGV4ZWN1dGlvblxyXG4gICAgICAgIC8vIHByb2JhYmx5IHNvbWUga2luZCBvZiB0aW1pbmcgaXNzdWVzIGFuZCBkZWxheWluZyBpdCB1bnRpbCB0aGUgZ3JpZCBpcyBmdWxseSByZWFkeSBmaXhlcyB0aGlzIHByb2JsZW1cclxuICAgICAgICB0aGlzLmRlbGF5UmVuZGVyUHJlSGVhZGVyUm93R3JvdXBpbmdUaXRsZXMoNTApO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBkaXNwb3NlKCkge1xyXG4gICAgLy8gdW5zdWJzY3JpYmUgYWxsIFNsaWNrR3JpZCBldmVudHNcclxuICAgIHRoaXMuX2V2ZW50SGFuZGxlci51bnN1YnNjcmliZUFsbCgpO1xyXG5cclxuICAgIC8vIGFsc28gdW5zdWJzY3JpYmUgYWxsIEFuZ3VsYXIgU3Vic2NyaXB0aW9uc1xyXG4gICAgdGhpcy5zdWJzY3JpcHRpb25zID0gdW5zdWJzY3JpYmVBbGxPYnNlcnZhYmxlcyh0aGlzLnN1YnNjcmlwdGlvbnMpO1xyXG4gIH1cclxuXHJcbiAgLyoqIGNhbGwgXCJyZW5kZXJQcmVIZWFkZXJSb3dHcm91cGluZ1RpdGxlcygpXCIgd2l0aCBhIHNldFRpbWVvdXQgZGVsYXkgKi9cclxuICBkZWxheVJlbmRlclByZUhlYWRlclJvd0dyb3VwaW5nVGl0bGVzKGRlbGF5ID0gMCkge1xyXG4gICAgc2V0VGltZW91dCgoKSA9PiB0aGlzLnJlbmRlclByZUhlYWRlclJvd0dyb3VwaW5nVGl0bGVzKCksIGRlbGF5KTtcclxuICB9XHJcblxyXG4gIC8qKiBDcmVhdGUgb3IgUmVuZGVyIHRoZSBQcmUtSGVhZGVyIFJvdyBHcm91cGluZyBUaXRsZXMgKi9cclxuICByZW5kZXJQcmVIZWFkZXJSb3dHcm91cGluZ1RpdGxlcygpIHtcclxuICAgIGlmICh0aGlzLl9ncmlkT3B0aW9ucyAmJiB0aGlzLl9ncmlkT3B0aW9ucy5mcm96ZW5Db2x1bW4gIT09IHVuZGVmaW5lZCAmJiB0aGlzLl9ncmlkT3B0aW9ucy5mcm96ZW5Db2x1bW4gPj0gMCkge1xyXG4gICAgICAvLyBBZGQgY29sdW1uIGdyb3VwcyB0byBsZWZ0IHBhbmVsXHJcbiAgICAgIGxldCAkcHJlSGVhZGVyUGFuZWwgPSAkKHRoaXMuX2dyaWQuZ2V0UHJlSGVhZGVyUGFuZWxMZWZ0KCkpO1xyXG4gICAgICB0aGlzLnJlbmRlckhlYWRlckdyb3VwcygkcHJlSGVhZGVyUGFuZWwsIDAsIHRoaXMuX2dyaWRPcHRpb25zLmZyb3plbkNvbHVtbiArIDEpO1xyXG5cclxuICAgICAgLy8gQWRkIGNvbHVtbiBncm91cHMgdG8gcmlnaHQgcGFuZWxcclxuICAgICAgJHByZUhlYWRlclBhbmVsID0gJCh0aGlzLl9ncmlkLmdldFByZUhlYWRlclBhbmVsUmlnaHQoKSk7XHJcbiAgICAgIHRoaXMucmVuZGVySGVhZGVyR3JvdXBzKCRwcmVIZWFkZXJQYW5lbCwgdGhpcy5fZ3JpZE9wdGlvbnMuZnJvemVuQ29sdW1uICsgMSwgdGhpcy5fY29sdW1uRGVmaW5pdGlvbnMubGVuZ3RoKTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIC8vIHJlZ3VsYXIgZ3JpZCAobm90IGEgZnJvemVuIGdyaWQpXHJcbiAgICAgIGNvbnN0ICRwcmVIZWFkZXJQYW5lbCA9ICQodGhpcy5fZ3JpZC5nZXRQcmVIZWFkZXJQYW5lbCgpKTtcclxuICAgICAgdGhpcy5yZW5kZXJIZWFkZXJHcm91cHMoJHByZUhlYWRlclBhbmVsLCAwLCB0aGlzLl9jb2x1bW5EZWZpbml0aW9ucy5sZW5ndGgpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcmVuZGVySGVhZGVyR3JvdXBzKHByZUhlYWRlclBhbmVsOiBhbnksIHN0YXJ0OiBudW1iZXIsIGVuZDogbnVtYmVyKSB7XHJcbiAgICBwcmVIZWFkZXJQYW5lbC5lbXB0eSgpXHJcbiAgICAgIC5hZGRDbGFzcygnc2xpY2staGVhZGVyLWNvbHVtbnMnKVxyXG4gICAgICAuY3NzKCdsZWZ0JywgJy0xMDAwcHgnKVxyXG4gICAgICAud2lkdGgodGhpcy5fZ3JpZC5nZXRIZWFkZXJzV2lkdGgoKSk7XHJcbiAgICBwcmVIZWFkZXJQYW5lbC5wYXJlbnQoKS5hZGRDbGFzcygnc2xpY2staGVhZGVyJyk7XHJcblxyXG4gICAgY29uc3QgaGVhZGVyQ29sdW1uV2lkdGhEaWZmID0gdGhpcy5fZ3JpZC5nZXRIZWFkZXJDb2x1bW5XaWR0aERpZmYoKTtcclxuXHJcbiAgICBsZXQgY29sRGVmO1xyXG4gICAgbGV0IGhlYWRlcjtcclxuICAgIGxldCBsYXN0Q29sdW1uR3JvdXAgPSAnJztcclxuICAgIGxldCB3aWR0aFRvdGFsID0gMDtcclxuICAgIGNvbnN0IGZyb3plbkhlYWRlcldpZHRoQ2FsY0RpZmZlcmVudGlhbCA9IHRoaXMuX2dyaWRPcHRpb25zICYmIHRoaXMuX2dyaWRPcHRpb25zLmZyb3plbkhlYWRlcldpZHRoQ2FsY0RpZmZlcmVudGlhbCB8fCAwO1xyXG4gICAgY29uc3QgaXNGcm96ZW5HcmlkID0gKHRoaXMuX2dyaWRPcHRpb25zICYmICh0aGlzLl9ncmlkT3B0aW9ucy5mcm96ZW5Db2x1bW4gIT09IHVuZGVmaW5lZCAmJiB0aGlzLl9ncmlkT3B0aW9ucy5mcm96ZW5Db2x1bW4gPj0gMCkpO1xyXG5cclxuICAgIGZvciAobGV0IGkgPSBzdGFydDsgaSA8IGVuZDsgaSsrKSB7XHJcbiAgICAgIGNvbERlZiA9IHRoaXMuX2NvbHVtbkRlZmluaXRpb25zW2ldO1xyXG4gICAgICBpZiAoY29sRGVmKSB7XHJcbiAgICAgICAgaWYgKGxhc3RDb2x1bW5Hcm91cCA9PT0gY29sRGVmLmNvbHVtbkdyb3VwICYmIGkgPiAwKSB7XHJcbiAgICAgICAgICB3aWR0aFRvdGFsICs9IGNvbERlZi53aWR0aCB8fCAwO1xyXG4gICAgICAgICAgaWYgKGhlYWRlciAmJiBoZWFkZXIud2lkdGgpIHtcclxuICAgICAgICAgICAgaGVhZGVyLndpZHRoKHdpZHRoVG90YWwgLSBoZWFkZXJDb2x1bW5XaWR0aERpZmYgLSBmcm96ZW5IZWFkZXJXaWR0aENhbGNEaWZmZXJlbnRpYWwpOyAvLyByZW1vdmUgcG9zc2libGUgZnJvemVuIGJvcmRlclxyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICB3aWR0aFRvdGFsID0gY29sRGVmLndpZHRoIHx8IDA7XHJcbiAgICAgICAgICBoZWFkZXIgPSAkKGA8ZGl2IGNsYXNzPVwidWktc3RhdGUtZGVmYXVsdCBzbGljay1oZWFkZXItY29sdW1uICR7aXNGcm96ZW5HcmlkID8gJ2Zyb3plbicgOiAnJ31cIiAvPmApXHJcbiAgICAgICAgICAgIC5odG1sKGA8c3BhbiBjbGFzcz1cInNsaWNrLWNvbHVtbi1uYW1lXCI+JHtjb2xEZWYuY29sdW1uR3JvdXAgfHwgJyd9PC9zcGFuPmApXHJcbiAgICAgICAgICAgIC53aWR0aCh3aWR0aFRvdGFsIC0gaGVhZGVyQ29sdW1uV2lkdGhEaWZmKVxyXG4gICAgICAgICAgICAuYXBwZW5kVG8ocHJlSGVhZGVyUGFuZWwpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBsYXN0Q29sdW1uR3JvdXAgPSBjb2xEZWYuY29sdW1uR3JvdXAgfHwgJyc7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICB9XHJcblxyXG5cclxuICAvKiogVHJhbnNsYXRlIENvbHVtbiBHcm91cCB0ZXh0cyBhbmQgcmUtcmVuZGVyIHRoZW0gYWZ0ZXJ3YXJkLiAqL1xyXG4gIHRyYW5zbGF0ZUdyb3VwaW5nQW5kQ29sU3BhbigpIHtcclxuICAgIGNvbnN0IGN1cnJlbnRDb2x1bW5EZWZpbml0aW9ucyA9IHRoaXMuX2dyaWQuZ2V0Q29sdW1ucygpO1xyXG4gICAgdGhpcy5leHRlbnNpb25VdGlsaXR5LnRyYW5zbGF0ZUl0ZW1zKGN1cnJlbnRDb2x1bW5EZWZpbml0aW9ucywgJ2NvbHVtbkdyb3VwS2V5JywgJ2NvbHVtbkdyb3VwJyk7XHJcbiAgICB0aGlzLl9ncmlkLnNldENvbHVtbnMoY3VycmVudENvbHVtbkRlZmluaXRpb25zKTtcclxuICAgIHRoaXMucmVuZGVyUHJlSGVhZGVyUm93R3JvdXBpbmdUaXRsZXMoKTtcclxuICB9XHJcbn1cclxuIl19