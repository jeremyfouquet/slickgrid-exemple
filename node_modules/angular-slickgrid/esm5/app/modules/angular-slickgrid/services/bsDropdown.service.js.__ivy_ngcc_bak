import * as tslib_1 from "tslib";
import { Injectable } from '@angular/core';
import { AngularUtilService } from './angularUtil.service';
// Boostrap dropdown service
var BsDropDownService = /** @class */ (function () {
    function BsDropDownService(angularUtilService) {
        this.angularUtilService = angularUtilService;
    }
    Object.defineProperty(BsDropDownService.prototype, "domElement", {
        get: function () {
            return this._domElement;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(BsDropDownService.prototype, "domContainerElement", {
        get: function () {
            return this._domContainerElement;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(BsDropDownService.prototype, "gridViewport", {
        get: function () {
            return $('.slick-viewport');
        },
        enumerable: true,
        configurable: true
    });
    BsDropDownService.prototype.dispose = function () {
        if (this._domElement && this._domElement.remove) {
            this._domElement.remove();
        }
    };
    BsDropDownService.prototype.dropContainerShow = function () {
        if (this._domContainerElement && this._domContainerElement.show) {
            this._domContainerElement.show();
        }
    };
    BsDropDownService.prototype.render = function (dropdownParams) {
        var _this = this;
        return new Promise(function (resolve) {
            var component = dropdownParams.component, args = dropdownParams.args, parent = dropdownParams.parent, offsetTop = dropdownParams.offsetTop, offsetLeft = dropdownParams.offsetLeft, offsetDropupBottom = dropdownParams.offsetDropupBottom;
            var cell = args.cell;
            var row = args.row;
            _this._domContainerElement = $("#myDrop-r" + row + "-c" + cell);
            if (_this._domContainerElement) {
                // hide the dropdown we created as a formatter Component, we'll redisplay it later
                var cellPos_1 = _this._domContainerElement.offset();
                var componentOutput_1 = _this.angularUtilService.createAngularComponent(component);
                var componentInstance = componentOutput_1 && componentOutput_1.componentRef && componentOutput_1.componentRef.instance;
                if (componentInstance) {
                    var myDropId_1 = componentInstance.dropdownId || 'myDrop';
                    var dropDownToggleId_1 = componentInstance.dropDownToggleId || 'dropdownMenu1';
                    _this._domElement = $("#" + myDropId_1);
                    if (_this._domElement) {
                        // make sure to remove any previous Action dropdown elements, to avoid having multiple element of the same on top of each other
                        _this.dispose();
                        // assign the row data to the dropdown component instance
                        Object.assign(componentInstance, { parent: parent, row: args.row, dataContext: args.grid.getDataItem(args.row) });
                        // use a delay to make sure Angular ran at least a full cycle and make sure it finished rendering the Component before using it
                        setTimeout(function () {
                            // create a new dropdown element
                            _this._domElement = $(componentOutput_1.domElement);
                            var topPos = (cellPos_1 && cellPos_1.top || 0) + 30 + (offsetTop || 0);
                            var leftPos = (cellPos_1 && cellPos_1.left || 0) + (offsetLeft || 0);
                            _this._domElement.appendTo('body');
                            _this._domElement.css('position', 'absolute');
                            _this._domElement.css('top', topPos);
                            _this._domElement.css('left', leftPos);
                            $("#" + myDropId_1).addClass('open');
                            $("#" + dropDownToggleId_1).hide();
                            // check if it should drop Up or Down
                            var offset = 35;
                            var iElement = $('.dropdown-menu');
                            var iElementWrapper = iElement.parent();
                            var iElementWrapperOffset = iElementWrapper.offset() || {};
                            var iElementWrapperOffsetTop = iElementWrapperOffset.top || iElementWrapper && iElementWrapper.length > 0 && iElementWrapper[0].offsetTop;
                            var iElementHeight = iElement.height();
                            var windowHeight = window.innerHeight;
                            var shouldDropUp = (windowHeight - iElementHeight - offset) < iElementWrapperOffsetTop;
                            var menuMarginTop = '0px';
                            if (shouldDropUp) {
                                var offsetBottom = offsetDropupBottom || 0;
                                menuMarginTop = '-'.concat("" + (iElementHeight + offset + offsetBottom + 5), 'px');
                            }
                            _this._domElement.css({ 'margin-top': menuMarginTop });
                            // set dropdown margin left according to the document width
                            var parentOffset = iElementWrapperOffset.left;
                            var leftMargin = parentOffset - $(document).width();
                            _this._domElement.css({ 'margin-left': (_this._domElement.width() + leftMargin + 60) + 'px' });
                            try {
                                _this._domElement.dropdown('show'); // required for Bootstrap 4 only
                            }
                            catch (e) {
                                // Bootstrap 3 wil throw an error since that method doesn't exist, we can safely disregard it
                            }
                            _this._domElement.on('hidden.bs.dropdown', function () { return _this.dropContainerShow(); });
                            // hide dropdown menu on grid scroll
                            _this.gridViewport.on('scroll', function () { return _this.dispose(); });
                            // hide on dropdown click
                            _this._domElement.on('click', function () { return _this.dispose(); });
                            resolve(true);
                        });
                    }
                }
            }
        });
    };
    BsDropDownService.ctorParameters = function () { return [
        { type: AngularUtilService }
    ]; };
    BsDropDownService = tslib_1.__decorate([
        Injectable()
    ], BsDropDownService);
    return BsDropDownService;
}());
export { BsDropDownService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYnNEcm9wZG93bi5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vYW5ndWxhci1zbGlja2dyaWQvIiwic291cmNlcyI6WyJhcHAvbW9kdWxlcy9hbmd1bGFyLXNsaWNrZ3JpZC9zZXJ2aWNlcy9ic0Ryb3Bkb3duLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUNBLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDM0MsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0sdUJBQXVCLENBQUM7QUF5QjNELDRCQUE0QjtBQUU1QjtJQUlFLDJCQUFvQixrQkFBc0M7UUFBdEMsdUJBQWtCLEdBQWxCLGtCQUFrQixDQUFvQjtJQUFJLENBQUM7SUFFL0Qsc0JBQUkseUNBQVU7YUFBZDtZQUNFLE9BQU8sSUFBSSxDQUFDLFdBQVcsQ0FBQztRQUMxQixDQUFDOzs7T0FBQTtJQUVELHNCQUFJLGtEQUFtQjthQUF2QjtZQUNFLE9BQU8sSUFBSSxDQUFDLG9CQUFvQixDQUFDO1FBQ25DLENBQUM7OztPQUFBO0lBRUQsc0JBQUksMkNBQVk7YUFBaEI7WUFDRSxPQUFPLENBQUMsQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDO1FBQzlCLENBQUM7OztPQUFBO0lBRUQsbUNBQU8sR0FBUDtRQUNFLElBQUksSUFBSSxDQUFDLFdBQVcsSUFBSSxJQUFJLENBQUMsV0FBVyxDQUFDLE1BQU0sRUFBRTtZQUMvQyxJQUFJLENBQUMsV0FBVyxDQUFDLE1BQU0sRUFBRSxDQUFDO1NBQzNCO0lBQ0gsQ0FBQztJQUVELDZDQUFpQixHQUFqQjtRQUNFLElBQUksSUFBSSxDQUFDLG9CQUFvQixJQUFJLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxJQUFJLEVBQUU7WUFDL0QsSUFBSSxDQUFDLG9CQUFvQixDQUFDLElBQUksRUFBRSxDQUFDO1NBQ2xDO0lBQ0gsQ0FBQztJQUVELGtDQUFNLEdBQU4sVUFBTyxjQUFxQztRQUE1QyxpQkFpRkM7UUFoRkMsT0FBTyxJQUFJ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LENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsZ0NBQWdDOzZCQUNwRTs0QkFBQyxPQUFPLENBQUMsRUFBRTtnQ0FDViw2RkFBNkY7NkJBQzlGOzRCQUVELEtBQUksQ0FBQyxXQUFXLENBQUMsRUFBRSxDQUFDLG9CQUFvQixFQUFFLGNBQU0sT0FBQSxLQUFJLENBQUMsaUJBQWlCLEVBQUUsRUFBeEIsQ0FBd0IsQ0FBQyxDQUFDOzRCQUUxRSxvQ0FBb0M7NEJBQ3BDLEtBQUksQ0FBQyxZQUFZLENBQUMsRUFBRSxDQUFDLFFBQVEsRUFBRSxjQUFNLE9BQUEsS0FBSSxDQUFDLE9BQU8sRUFBRSxFQUFkLENBQWMsQ0FBQyxDQUFDOzRCQUVyRCx5QkFBeUI7NEJBQ3pCLEtBQUksQ0FBQyxXQUFXLENBQUMsRUFBRSxDQUFDLE9BQU8sRUFBRSxjQUFNLE9BQUEsS0FBSSxDQUFDLE9BQU8sRUFBRSxFQUFkLENBQWMsQ0FBQyxDQUFDOzRCQUNuRCxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUM7d0JBQ2hCLENBQUMsQ0FBQyxDQUFDO3FCQUNKO2lCQUNGO2FBQ0Y7UUFDSCxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUM7O2dCQTNHdUMsa0JBQWtCOztJQUovQyxpQkFBaUI7UUFEN0IsVUFBVSxFQUFFO09BQ0EsaUJBQWlCLENBZ0g3QjtJQUFELHdCQUFDO0NBQUEsQUFoSEQsSUFnSEM7U0FoSFksaUJBQWlCIiwic291cmNlc0NvbnRlbnQiOlsiXHJcbmltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgQW5ndWxhclV0aWxTZXJ2aWNlIH0gZnJvbSAnLi9hbmd1bGFyVXRpbC5zZXJ2aWNlJztcclxuXHJcbmludGVyZmFjZSBEcm9wRG93blNlcnZpY2VQYXJhbXMge1xyXG4gIC8qKiB0aGUgY3VzdG9tIGFjdGlvbiBmb3JtYXR0ZXIgY29tcG9uZW50IHRoYXQgY29udGFpbnMgdGhlIGRyb3Bkb3duICovXHJcbiAgY29tcG9uZW50OiBhbnk7XHJcblxyXG4gIC8qKiBoZWxwIHRvIGdldCB0aGUgZGF0YSBjb250ZXh0ICovXHJcbiAgYXJnczogYW55O1xyXG5cclxuICAvKiogcGFyZW50IGNvbnRhaW5lciAqL1xyXG4gIHBhcmVudDogYW55O1xyXG5cclxuICAvKiogT2Zmc2V0IGJvdHRvbSB3aGVuIHVzaW5nIGEgRHJvcCBVcCwgaWYgd2UgbmVlZCB0byByZXBvc2l0aW9uIHRoZSBkcm9wZG93biBjb21wb25lbnQgKi9cclxuICBvZmZzZXREcm9wdXBCb3R0b20/OiBudW1iZXI7XHJcblxyXG4gIC8qKiBPZmZzZXQgbGVmdCBpZiB3ZSBuZWVkIHRvIHJlcG9zaXRpb24gdGhlIGRyb3Bkb3duIGNvbXBvbmVudCAqL1xyXG4gIG9mZnNldExlZnQ/OiBudW1iZXI7XHJcblxyXG4gIC8qKiBPZmZzZXQgdG9wIGlmIHdlIG5lZWQgdG8gcmVwb3NpdGlvbiB0aGUgZHJvcGRvd24gY29tcG9uZW50ICovXHJcbiAgb2Zmc2V0VG9wPzogbnVtYmVyO1xyXG59XHJcblxyXG4vLyB1c2luZyBleHRlcm5hbCBub24tdHlwZWQganMgbGlicmFyaWVzXHJcbmRlY2xhcmUgY29uc3QgJDogYW55O1xyXG5cclxuLy8gQm9vc3RyYXAgZHJvcGRvd24gc2VydmljZVxyXG5ASW5qZWN0YWJsZSgpXHJcbmV4cG9ydCBjbGFzcyBCc0Ryb3BEb3duU2VydmljZSB7XHJcbiAgcHJpdmF0ZSBfZG9tQ29udGFpbmVyRWxlbWVudDogYW55O1xyXG4gIHByaXZhdGUgX2RvbUVsZW1lbnQ6IGFueTtcclxuXHJcbiAgY29uc3RydWN0b3IocHJpdmF0ZSBhbmd1bGFyVXRpbFNlcnZpY2U6IEFuZ3VsYXJVdGlsU2VydmljZSkgeyB9XHJcblxyXG4gIGdldCBkb21FbGVtZW50KCkge1xyXG4gICAgcmV0dXJuIHRoaXMuX2RvbUVsZW1lbnQ7XHJcbiAgfVxyXG5cclxuICBnZXQgZG9tQ29udGFpbmVyRWxlbWVudCgpIHtcclxuICAgIHJldHVybiB0aGlzLl9kb21Db250YWluZXJFbGVtZW50O1xyXG4gIH1cclxuXHJcbiAgZ2V0IGdyaWRWaWV3cG9ydCgpIHtcclxuICAgIHJldHVybiAkKCcuc2xpY2stdmlld3BvcnQnKTtcclxuICB9XHJcblxyXG4gIGRpc3Bvc2UoKSB7XHJcbiAgICBpZiAodGhpcy5fZG9tRWxlbWVudCAmJiB0aGlzLl9kb21FbGVtZW50LnJlbW92ZSkge1xyXG4gICAgICB0aGlzLl9kb21FbGVtZW50LnJlbW92ZSgpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgZHJvcENvbnRhaW5lclNob3coKSB7XHJcbiAgICBpZiAodGhpcy5fZG9tQ29udGFpbmVyRWxlbWVudCAmJiB0aGlzLl9kb21Db250YWluZXJFbGVtZW50LnNob3cpIHtcclxuICAgICAgdGhpcy5fZG9tQ29udGFpbmVyRWxlbWVudC5zaG93KCk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICByZW5kZXIoZHJvcGRvd25QYXJhbXM6IERyb3BEb3duU2VydmljZVBhcmFtcykge1xyXG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiB7XHJcbiAgICAgIGNvbnN0IHsgY29tcG9uZW50LCBhcmdzLCBwYXJlbnQsIG9mZnNldFRvcCwgb2Zmc2V0TGVmdCwgb2Zmc2V0RHJvcHVwQm90dG9tIH0gPSBkcm9wZG93blBhcmFtcztcclxuXHJcbiAgICAgIGNvbnN0IGNlbGwgPSBhcmdzLmNlbGw7XHJcbiAgICAgIGNvbnN0IHJvdyA9IGFyZ3Mucm93O1xyXG5cclxuICAgICAgdGhpcy5fZG9tQ29udGFpbmVyRWxlbWVudCA9ICQoYCNteURyb3AtciR7cm93fS1jJHtjZWxsfWApO1xyXG5cclxuICAgICAgaWYgKHRoaXMuX2RvbUNvbnRhaW5lckVsZW1lbnQpIHtcclxuICAgICAgICAvLyBoaWRlIHRoZSBkcm9wZG93biB3ZSBjcmVhdGVkIGFzIGEgZm9ybWF0dGVyIENvbXBvbmVudCwgd2UnbGwgcmVkaXNwbGF5IGl0IGxhdGVyXHJcbiAgICAgICAgY29uc3QgY2VsbFBvcyA9IHRoaXMuX2RvbUNvbnRhaW5lckVsZW1lbnQub2Zmc2V0KCk7XHJcblxyXG4gICAgICAgIGNvbnN0IGNvbXBvbmVudE91dHB1dCA9IHRoaXMuYW5ndWxhclV0aWxTZXJ2aWNlLmNyZWF0ZUFuZ3VsYXJDb21wb25lbnQoY29tcG9uZW50KTtcclxuICAgICAgICBjb25zdCBjb21wb25lbnRJbnN0YW5jZSA9IGNvbXBvbmVudE91dHB1dCAmJiBjb21wb25lbnRPdXRwdXQuY29tcG9uZW50UmVmICYmIGNvbXBvbmVudE91dHB1dC5jb21wb25lbnRSZWYuaW5zdGFuY2U7XHJcblxyXG4gICAgICAgIGlmIChjb21wb25lbnRJbnN0YW5jZSkge1xyXG4gICAgICAgICAgY29uc3QgbXlEcm9wSWQgPSBjb21wb25lbnRJbnN0YW5jZS5kcm9wZG93bklkIHx8ICdteURyb3AnO1xyXG4gICAgICAgICAgY29uc3QgZHJvcERvd25Ub2dnbGVJZCA9IGNvbXBvbmVudEluc3RhbmNlLmRyb3BEb3duVG9nZ2xlSWQgfHwgJ2Ryb3Bkb3duTWVudTEnO1xyXG4gICAgICAgICAgdGhpcy5fZG9tRWxlbWVudCA9ICQoYCMke215RHJvcElkfWApO1xyXG5cclxuICAgICAgICAgIGlmICh0aGlzLl9kb21FbGVtZW50KSB7XHJcbiAgICAgICAgICAgIC8vIG1ha2Ugc3VyZSB0byByZW1vdmUgYW55IHByZXZpb3VzIEFjdGlvbiBkcm9wZG93biBlbGVtZW50cywgdG8gYXZvaWQgaGF2aW5nIG11bHRpcGxlIGVsZW1lbnQgb2YgdGhlIHNhbWUgb24gdG9wIG9mIGVhY2ggb3RoZXJcclxuICAgICAgICAgICAgdGhpcy5kaXNwb3NlKCk7XHJcblxyXG4gICAgICAgICAgICAvLyBhc3NpZ24gdGhlIHJvdyBkYXRhIHRvIHRoZSBkcm9wZG93biBjb21wb25lbnQgaW5zdGFuY2VcclxuICAgICAgICAgICAgT2JqZWN0LmFzc2lnbihjb21wb25lbnRJbnN0YW5jZSwgeyBwYXJlbnQsIHJvdzogYXJncy5yb3csIGRhdGFDb250ZXh0OiBhcmdzLmdyaWQuZ2V0RGF0YUl0ZW0oYXJncy5yb3cpIH0pO1xyXG5cclxuICAgICAgICAgICAgLy8gdXNlIGEgZGVsYXkgdG8gbWFrZSBzdXJlIEFuZ3VsYXIgcmFuIGF0IGxlYXN0IGEgZnVsbCBjeWNsZSBhbmQgbWFrZSBzdXJlIGl0IGZpbmlzaGVkIHJlbmRlcmluZyB0aGUgQ29tcG9uZW50IGJlZm9yZSB1c2luZyBpdFxyXG4gICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHtcclxuICAgICAgICAgICAgICAvLyBjcmVhdGUgYSBuZXcgZHJvcGRvd24gZWxlbWVudFxyXG4gICAgICAgICAgICAgIHRoaXMuX2RvbUVsZW1lbnQgPSAkKGNvbXBvbmVudE91dHB1dC5kb21FbGVtZW50KTtcclxuICAgICAgICAgICAgICBjb25zdCB0b3BQb3MgPSAoY2VsbFBvcyAmJiBjZWxsUG9zLnRvcCB8fCAwKSArIDMwICsgKG9mZnNldFRvcCB8fCAwKTtcclxuICAgICAgICAgICAgICBjb25zdCBsZWZ0UG9zID0gKGNlbGxQb3MgJiYgY2VsbFBvcy5sZWZ0IHx8IDApICsgKG9mZnNldExlZnQgfHwgMCk7XHJcbiAgICAgICAgICAgICAgdGhpcy5fZG9tRWxlbWVudC5hcHBlbmRUbygnYm9keScpO1xyXG4gICAgICAgICAgICAgIHRoaXMuX2RvbUVsZW1lbnQuY3NzKCdwb3NpdGlvbicsICdhYnNvbHV0ZScpO1xyXG4gICAgICAgICAgICAgIHRoaXMuX2RvbUVsZW1lbnQuY3NzKCd0b3AnLCB0b3BQb3MpO1xyXG4gICAgICAgICAgICAgIHRoaXMuX2RvbUVsZW1lbnQuY3NzKCdsZWZ0JywgbGVmdFBvcyk7XHJcbiAgICAgICAgICAgICAgJChgIyR7bXlEcm9wSWR9YCkuYWRkQ2xhc3MoJ29wZW4nKTtcclxuICAgICAgICAgICAgICAkKGAjJHtkcm9wRG93blRvZ2dsZUlkfWApLmhpZGUoKTtcclxuXHJcbiAgICAgICAgICAgICAgLy8gY2hlY2sgaWYgaXQgc2hvdWxkIGRyb3AgVXAgb3IgRG93blxyXG4gICAgICAgICAgICAgIGNvbnN0IG9mZnNldCA9IDM1O1xyXG4gICAgICAgICAgICAgIGNvbnN0IGlFbGVtZW50ID0gJCgnLmRyb3Bkb3duLW1lbnUnKTtcclxuICAgICAgICAgICAgICBjb25zdCBpRWxlbWVudFdyYXBwZXIgPSBpRWxlbWVudC5wYXJlbnQoKTtcclxuICAgICAgICAgICAgICBjb25zdCBpRWxlbWVudFdyYXBwZXJPZmZzZXQgPSBpRWxlbWVudFdyYXBwZXIub2Zmc2V0KCkgfHwge307XHJcbiAgICAgICAgICAgICAgY29uc3QgaUVsZW1lbnRXcmFwcGVyT2Zmc2V0VG9wID0gaUVsZW1lbnRXcmFwcGVyT2Zmc2V0LnRvcCB8fCBpRWxlbWVudFdyYXBwZXIgJiYgaUVsZW1lbnRXcmFwcGVyLmxlbmd0aCA+IDAgJiYgaUVsZW1lbnRXcmFwcGVyWzBdLm9mZnNldFRvcDtcclxuICAgICAgICAgICAgICBjb25zdCBpRWxlbWVudEhlaWdodCA9IGlFbGVtZW50LmhlaWdodCgpO1xyXG4gICAgICAgICAgICAgIGNvbnN0IHdpbmRvd0hlaWdodCA9IHdpbmRvdy5pbm5lckhlaWdodDtcclxuICAgICAgICAgICAgICBjb25zdCBzaG91bGREcm9wVXAgPSAod2luZG93SGVpZ2h0IC0gaUVsZW1lbnRIZWlnaHQgLSBvZmZzZXQpIDwgaUVsZW1lbnRXcmFwcGVyT2Zmc2V0VG9wO1xyXG4gICAgICAgICAgICAgIGxldCBtZW51TWFyZ2luVG9wID0gJzBweCc7XHJcbiAgICAgICAgICAgICAgaWYgKHNob3VsZERyb3BVcCkge1xyXG4gICAgICAgICAgICAgICAgY29uc3Qgb2Zmc2V0Qm90dG9tID0gb2Zmc2V0RHJvcHVwQm90dG9tIHx8IDA7XHJcbiAgICAgICAgICAgICAgICBtZW51TWFyZ2luVG9wID0gJy0nLmNvbmNhdChgJHtpRWxlbWVudEhlaWdodCArIG9mZnNldCArIG9mZnNldEJvdHRvbSArIDV9YCwgJ3B4Jyk7XHJcbiAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgIHRoaXMuX2RvbUVsZW1lbnQuY3NzKHsgJ21hcmdpbi10b3AnOiBtZW51TWFyZ2luVG9wIH0pO1xyXG5cclxuICAgICAgICAgICAgICAvLyBzZXQgZHJvcGRvd24gbWFyZ2luIGxlZnQgYWNjb3JkaW5nIHRvIHRoZSBkb2N1bWVudCB3aWR0aFxyXG4gICAgICAgICAgICAgIGNvbnN0IHBhcmVudE9mZnNldCA9IGlFbGVtZW50V3JhcHBlck9mZnNldC5sZWZ0O1xyXG4gICAgICAgICAgICAgIGNvbnN0IGxlZnRNYXJnaW4gPSBwYXJlbnRPZmZzZXQgLSAkKGRvY3VtZW50KS53aWR0aCgpO1xyXG4gICAgICAgICAgICAgIHRoaXMuX2RvbUVsZW1lbnQuY3NzKHsgJ21hcmdpbi1sZWZ0JzogKHRoaXMuX2RvbUVsZW1lbnQud2lkdGgoKSArIGxlZnRNYXJnaW4gKyA2MCkgKyAncHgnIH0pO1xyXG5cclxuICAgICAgICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5fZG9tRWxlbWVudC5kcm9wZG93bignc2hvdycpOyAvLyByZXF1aXJlZCBmb3IgQm9vdHN0cmFwIDQgb25seVxyXG4gICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHtcclxuICAgICAgICAgICAgICAgIC8vIEJvb3RzdHJhcCAzIHdpbCB0aHJvdyBhbiBlcnJvciBzaW5jZSB0aGF0IG1ldGhvZCBkb2Vzbid0IGV4aXN0LCB3ZSBjYW4gc2FmZWx5IGRpc3JlZ2FyZCBpdFxyXG4gICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgdGhpcy5fZG9tRWxlbWVudC5vbignaGlkZGVuLmJzLmRyb3Bkb3duJywgKCkgPT4gdGhpcy5kcm9wQ29udGFpbmVyU2hvdygpKTtcclxuXHJcbiAgICAgICAgICAgICAgLy8gaGlkZSBkcm9wZG93biBtZW51IG9uIGdyaWQgc2Nyb2xsXHJcbiAgICAgICAgICAgICAgdGhpcy5ncmlkVmlld3BvcnQub24oJ3Njcm9sbCcsICgpID0+IHRoaXMuZGlzcG9zZSgpKTtcclxuXHJcbiAgICAgICAgICAgICAgLy8gaGlkZSBvbiBkcm9wZG93biBjbGlja1xyXG4gICAgICAgICAgICAgIHRoaXMuX2RvbUVsZW1lbnQub24oJ2NsaWNrJywgKCkgPT4gdGhpcy5kaXNwb3NlKCkpO1xyXG4gICAgICAgICAgICAgIHJlc29sdmUodHJ1ZSk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgfVxyXG59XHJcbiJdfQ==