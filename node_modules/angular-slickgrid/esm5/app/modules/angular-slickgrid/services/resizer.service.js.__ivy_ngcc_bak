import { Subject } from 'rxjs';
// global constants, height/width are in pixels
var DATAGRID_MIN_HEIGHT = 180;
var DATAGRID_MIN_WIDTH = 300;
var DATAGRID_BOTTOM_PADDING = 20;
var DATAGRID_FOOTER_HEIGHT = 20;
var DATAGRID_PAGINATION_HEIGHT = 35;
var ResizerService = /** @class */ (function () {
    function ResizerService() {
        this._resizePaused = false;
        this.onGridAfterResize = new Subject();
        this.onGridBeforeResize = new Subject();
    }
    Object.defineProperty(ResizerService.prototype, "_gridOptions", {
        /** Getter for the Grid Options pulled through the Grid Object */
        get: function () {
            return (this._grid && this._grid.getOptions) ? this._grid.getOptions() : {};
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(ResizerService.prototype, "_gridUid", {
        get: function () {
            return (this._grid && this._grid.getUID) ? this._grid.getUID() : this._gridOptions && this._gridOptions.gridId;
        },
        enumerable: true,
        configurable: true
    });
    ResizerService.prototype.init = function (grid, fixedDimensions) {
        if (!grid || !this._gridOptions) {
            throw new Error("\n      Angular-Slickgrid resizer requires a valid Grid object and Grid Options defined.\n      You can fix this by setting your gridOption to use \"enableAutoResize\" or create an instance of the ResizerService by calling bindAutoResizeDataGrid()");
        }
        this._grid = grid;
        var containerNode = grid && grid.getContainerNode && grid.getContainerNode() || '';
        this._gridDomElm = $(containerNode);
        var autoResizeOptions = this._gridOptions && this._gridOptions.autoResize || {};
        this._gridContainerElm = (autoResizeOptions && autoResizeOptions.containerId) ? $("#" + autoResizeOptions.containerId) : $("#" + this._gridOptions.gridContainerId);
        if (fixedDimensions) {
            this._fixedHeight = fixedDimensions.height;
            this._fixedWidth = fixedDimensions.width;
        }
    };
    /** Bind an auto resize trigger on the datagrid, if that is enable then it will resize itself to the available space
     * Options: we could also provide a % factor to resize on each height/width independently
     */
    ResizerService.prototype.bindAutoResizeDataGrid = function (newSizes) {
        // if we can't find the grid to resize, return without binding anything
        if (this._gridDomElm === undefined || this._gridDomElm.offset() === undefined) {
            return null;
        }
        // -- 1st resize the datagrid size at first load (we need this because the .on event is not triggered on first load)
        // -- also we add a slight delay (in ms) so that we resize after the grid render is done
        this.resizeGrid(10, newSizes);
        // -- 2nd bind a trigger on the Window DOM element, so that it happens also when resizing after first load
        // -- bind auto-resize to Window object only if it exist
        $(window).on("resize.grid." + this._gridUid, this.handleResizeGrid.bind(this, newSizes));
    };
    ResizerService.prototype.handleResizeGrid = function (newSizes, event) {
        this.onGridBeforeResize.next(event);
        if (!this._resizePaused) {
            // for some yet unknown reason, calling the resize twice removes any stuttering/flickering
            // when changing the height and makes it much smoother experience
            this.resizeGrid(0, newSizes);
            this.resizeGrid(0, newSizes);
        }
    };
    /**
     * Calculate the datagrid new height/width from the available space, also consider that a % factor might be applied to calculation
     * object gridOptions
     */
    ResizerService.prototype.calculateGridNewDimensions = function (gridOptions) {
        var autoResizeOptions = gridOptions && gridOptions.autoResize || {};
        if (!window || this._gridContainerElm === undefined || this._gridDomElm.offset() === undefined) {
            return null;
        }
        // calculate bottom padding
        // if using pagination, we need to add the pagination height to this bottom padding
        var bottomPadding = (autoResizeOptions && autoResizeOptions.bottomPadding !== undefined) ? autoResizeOptions.bottomPadding : DATAGRID_BOTTOM_PADDING;
        if (bottomPadding && gridOptions.enablePagination) {
            bottomPadding += DATAGRID_PAGINATION_HEIGHT;
        }
        // optionally show a custom footer with the data metrics (dataset length and last updated timestamp)
        if (bottomPadding && gridOptions.showCustomFooter) {
            bottomPadding += gridOptions.customFooterOptions && gridOptions.customFooterOptions.footerHeight || DATAGRID_FOOTER_HEIGHT;
        }
        var gridHeight = 0;
        var gridOffsetTop = 0;
        // which DOM element are we using to calculate the available size for the grid?
        if (autoResizeOptions.calculateAvailableSizeBy === 'container') {
            // uses the container's height to calculate grid height without any top offset
            gridHeight = this._gridContainerElm.height() || 0;
        }
        else {
            // uses the browser's window height with its top offset to calculate grid height
            gridHeight = window.innerHeight || 0;
            var coordOffsetTop = this._gridDomElm.offset();
            gridOffsetTop = (coordOffsetTop !== undefined) ? coordOffsetTop.top : 0;
        }
        var availableHeight = gridHeight - gridOffsetTop - bottomPadding;
        var availableWidth = this._gridContainerElm.width() || window.innerWidth || 0;
        var maxHeight = autoResizeOptions && autoResizeOptions.maxHeight || undefined;
        var minHeight = (autoResizeOptions && autoResizeOptions.minHeight !== undefined) ? autoResizeOptions.minHeight : DATAGRID_MIN_HEIGHT;
        var maxWidth = autoResizeOptions && autoResizeOptions.maxWidth || undefined;
        var minWidth = (autoResizeOptions && autoResizeOptions.minWidth !== undefined) ? autoResizeOptions.minWidth : DATAGRID_MIN_WIDTH;
        var newHeight = availableHeight;
        var newWidth = (autoResizeOptions && autoResizeOptions.sidePadding) ? availableWidth - autoResizeOptions.sidePadding : availableWidth;
        // optionally (when defined), make sure that grid height & width are within their thresholds
        if (newHeight < minHeight) {
            newHeight = minHeight;
        }
        if (maxHeight && newHeight > maxHeight) {
            newHeight = maxHeight;
        }
        if (newWidth < minWidth) {
            newWidth = minWidth;
        }
        if (maxWidth && newWidth > maxWidth) {
            newWidth = maxWidth;
        }
        // return the new dimensions unless a fixed height/width was defined
        return {
            height: this._fixedHeight || newHeight,
            width: this._fixedWidth || newWidth
        };
    };
    /**
     * Dispose function when element is destroyed
     */
    ResizerService.prototype.dispose = function () {
        $(window).off("resize.grid." + this._gridUid);
    };
    /**
     * Return the last resize dimensions used by the service
     * @return last dimensions
     */
    ResizerService.prototype.getLastResizeDimensions = function () {
        return this._lastDimensions;
    };
    /** Provide the possibility to pause the resizer for some time, until user decides to re-enabled it later if he wish to. */
    ResizerService.prototype.pauseResizer = function (isResizePaused) {
        this._resizePaused = isResizePaused;
    };
    /** Resize the datagrid to fit the browser height & width */
    ResizerService.prototype.resizeGrid = function (delay, newSizes) {
        var _this = this;
        if (delay === void 0) { delay = 10; }
        return new Promise(function (resolve) {
            // because of the javascript async nature, we might want to delay the resize a little bit
            delay = delay || 0;
            if (delay > 0) {
                clearTimeout(_this._timer);
                _this._timer = setTimeout(function () { return resolve(_this.resizeGridCallback(newSizes)); }, delay);
            }
            else {
                resolve(_this.resizeGridCallback(newSizes));
            }
        });
    };
    ResizerService.prototype.resizeGridCallback = function (newSizes) {
        var lastDimensions = this.resizeGridWithDimensions(newSizes);
        this.onGridAfterResize.next(lastDimensions);
        return lastDimensions;
    };
    ResizerService.prototype.resizeGridWithDimensions = function (newSizes) {
        // calculate the available sizes with minimum height defined as a constant
        var availableDimensions = this.calculateGridNewDimensions(this._gridOptions);
        var gridContainerElm = $("#" + this._gridOptions.gridContainerId) || {};
        if ((newSizes || availableDimensions) && this._gridDomElm.length > 0) {
            // get the new sizes, if new sizes are passed (not 0), we will use them else use available space
            // basically if user passes 1 of the dimension, let say he passes just the height,
            // we will use the height as a fixed height but the width will be resized by it's available space
            var newHeight = (newSizes && newSizes.height) ? newSizes.height : availableDimensions.height;
            var newWidth = (newSizes && newSizes.width) ? newSizes.width : availableDimensions.width;
            // apply these new height/width to the datagrid
            if (!this._gridOptions.autoHeight) {
                this._gridDomElm.height(newHeight);
                gridContainerElm.height(newHeight);
            }
            this._gridDomElm.width(newWidth);
            gridContainerElm.width(newWidth);
            // resize the slickgrid canvas on all browser except some IE versions
            // exclude all IE below IE11
            // IE11 wants to be a better standard (W3C) follower (finally) they even changed their appName output to also have 'Netscape'
            if (new RegExp('MSIE [6-8]').exec(navigator.userAgent) === null && this._grid && this._grid.resizeCanvas) {
                this._grid.resizeCanvas();
            }
            // also call the grid auto-size columns so that it takes available space when going bigger
            if (this._gridOptions && this._gridOptions.enableAutoSizeColumns && this._grid.autosizeColumns) {
                // make sure that the grid still exist (by looking if the Grid UID is found in the DOM tree) to avoid SlickGrid error "missing stylesheet"
                if (this._gridUid && $("." + this._gridUid).length > 0) {
                    this._grid.autosizeColumns();
                }
            }
            // keep last resized dimensions & resolve them to the Promise
            this._lastDimensions = {
                height: newHeight,
                width: newWidth
            };
            if ((this._gridOptions.enablePagination || this._gridOptions.backendServiceApi)) {
                this._lastDimensions.heightWithPagination = newHeight + DATAGRID_PAGINATION_HEIGHT;
            }
        }
        return this._lastDimensions;
    };
    return ResizerService;
}());
export { ResizerService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVzaXplci5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vYW5ndWxhci1zbGlja2dyaWQvIiwic291cmNlcyI6WyJhcHAvbW9kdWxlcy9hbmd1bGFyLXNsaWNrZ3JpZC9zZXJ2aWNlcy9yZXNpemVyLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQ0EsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUsvQiwrQ0FBK0M7QUFDL0MsSUFBTSxtQkFBbUIsR0FBRyxHQUFHLENBQUM7QUFDaEMsSUFBTSxrQkFBa0IsR0FBRyxHQUFHLENBQUM7QUFDL0IsSUFBTSx1QkFBdUIsR0FBRyxFQUFFLENBQUM7QUFDbkMsSUFBTSxzQkFBc0IsR0FBRyxFQUFFLENBQUM7QUFDbEMsSUFBTSwwQkFBMEIsR0FBRyxFQUFFLENBQUM7QUFRdEM7SUFBQTtRQVFVLGtCQUFhLEdBQUcsS0FBSyxDQUFDO1FBQzlCLHNCQUFpQixHQUFHLElBQUksT0FBTyxFQUFpQixDQUFDO1FBQ2pELHVCQUFrQixHQUFHLElBQUksT0FBTyxFQUFTLENBQUM7SUFzTjVDLENBQUM7SUFuTkMsc0JBQVksd0NBQVk7UUFEeEIsaUVBQWlFO2FBQ2pFO1lBQ0UsT0FBTyxDQUFDLElBQUksQ0FBQyxLQUFLLElBQUksSUFBSSxDQUFDLEtBQUssQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxVQUFVLEVBQUUsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDO1FBQzlFLENBQUM7OztPQUFBO0lBRUQsc0JBQVksb0NBQVE7YUFBcEI7WUFDRSxPQUFPLENBQUMsSUFBSSxDQUFDLEtBQUssSUFBSSxJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sRUFBRSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsWUFBWSxJQUFJLElBQUksQ0FBQyxZQUFZLENBQUMsTUFB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QUMsS0FBSyxJQUFJLElBQUksQ0FBQyxLQUFLLENBQUMsWUFBWSxFQUFFO2dCQUN4RyxJQUFJLENBQUMsS0FBSyxDQUFDLFlBQVksRUFBRSxDQUFDO2FBQzNCO1lBRUQsMEZBQTBGO1lBQzFGLElBQUksSUFBSSxDQUFDLFlBQVksSUFBSSxJQUFJLENBQUMsWUFBWSxDQUFDLHFCQUFxQixJQUFJLElBQUksQ0FBQyxLQUFLLENBQUMsZUFBZSxFQUFFO2dCQUM5RiwwSUFBMEk7Z0JBQzFJLElBQUksSUFBSSxDQUFDLFFBQVEsSUFBSSxDQUFDLENBQUMsTUFBSSxJQUFJLENBQUMsUUFBVSxDQUFDLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRTtvQkFDdEQsSUFBSSxDQUFDLEtBQUssQ0FBQyxlQUFlLEVBQUUsQ0FBQztpQkFDOUI7YUFDRjtZQUVELDZEQUE2RDtZQUM3RCxJQUFJLENBQUMsZUFBZSxHQUFHO2dCQUNyQixNQUFNLEVBQUUsU0FBUztnQkFDakIsS0FBSyxFQUFFLFFBQVE7YUFDaEIsQ0FBQztZQUVGLElBQUksQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLGdCQUFnQixJQUFJLElBQUksQ0FBQyxZQUFZLENBQUMsaUJBQWlCLENBQUMsRUFBRTtnQkFDL0UsSUFBSSxDQUFDLGVBQWUsQ0FBQyxvQkFBb0IsR0FBRyxTQUFTLEdBQUcsMEJBQTBCLENBQUM7YUFDcEY7U0FDRjtRQUVELE9BQU8sSUFBSSxDQUFDLGVBQWUsQ0FBQztJQUM5QixDQUFDO0lBQ0gscUJBQUM7QUFBRCxDQUFDLEFBaE9ELElBZ09DIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgR3JpZE9wdGlvbiB9IGZyb20gJy4vLi4vbW9kZWxzL2luZGV4JztcclxuaW1wb3J0IHsgU3ViamVjdCB9IGZyb20gJ3J4anMnO1xyXG5cclxuLy8gdXNpbmcgZXh0ZXJuYWwgbm9uLXR5cGVkIGpzIGxpYnJhcmllc1xyXG5kZWNsYXJlIGNvbnN0ICQ6IGFueTtcclxuXHJcbi8vIGdsb2JhbCBjb25zdGFudHMsIGhlaWdodC93aWR0aCBhcmUgaW4gcGl4ZWxzXHJcbmNvbnN0IERBVEFHUklEX01JTl9IRUlHSFQgPSAxODA7XHJcbmNvbnN0IERBVEFHUklEX01JTl9XSURUSCA9IDMwMDtcclxuY29uc3QgREFUQUdSSURfQk9UVE9NX1BBRERJTkcgPSAyMDtcclxuY29uc3QgREFUQUdSSURfRk9PVEVSX0hFSUdIVCA9IDIwO1xyXG5jb25zdCBEQVRBR1JJRF9QQUdJTkFUSU9OX0hFSUdIVCA9IDM1O1xyXG5cclxuZXhwb3J0IGludGVyZmFjZSBHcmlkRGltZW5zaW9uIHtcclxuICBoZWlnaHQ/OiBudW1iZXI7XHJcbiAgd2lkdGg/OiBudW1iZXI7XHJcbiAgaGVpZ2h0V2l0aFBhZ2luYXRpb24/OiBudW1iZXI7XHJcbn1cclxuXHJcbmV4cG9ydCBjbGFzcyBSZXNpemVyU2VydmljZSB7XHJcbiAgcHJpdmF0ZSBfZml4ZWRIZWlnaHQ6IG51bWJlciB8IG51bGw7XHJcbiAgcHJpdmF0ZSBfZml4ZWRXaWR0aDogbnVtYmVyIHwgbnVsbDtcclxuICBwcml2YXRlIF9ncmlkOiBhbnk7XHJcbiAgcHJpdmF0ZSBfZ3JpZERvbUVsbTogYW55O1xyXG4gIHByaXZhdGUgX2dyaWRDb250YWluZXJFbG06IGFueTtcclxuICBwcml2YXRlIF9sYXN0RGltZW5zaW9uczogR3JpZERpbWVuc2lvbjtcclxuICBwcml2YXRlIF90aW1lcjogYW55O1xyXG4gIHByaXZhdGUgX3Jlc2l6ZVBhdXNlZCA9IGZhbHNlO1xyXG4gIG9uR3JpZEFmdGVyUmVzaXplID0gbmV3IFN1YmplY3Q8R3JpZERpbWVuc2lvbj4oKTtcclxuICBvbkdyaWRCZWZvcmVSZXNpemUgPSBuZXcgU3ViamVjdDxFdmVudD4oKTtcclxuXHJcbiAgLyoqIEdldHRlciBmb3IgdGhlIEdyaWQgT3B0aW9ucyBwdWxsZWQgdGhyb3VnaCB0aGUgR3JpZCBPYmplY3QgKi9cclxuICBwcml2YXRlIGdldCBfZ3JpZE9wdGlvbnMoKTogR3JpZE9wdGlvbiB7XHJcbiAgICByZXR1cm4gKHRoaXMuX2dyaWQgJiYgdGhpcy5fZ3JpZC5nZXRPcHRpb25zKSA/IHRoaXMuX2dyaWQuZ2V0T3B0aW9ucygpIDoge307XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGdldCBfZ3JpZFVpZCgpOiBzdHJpbmcge1xyXG4gICAgcmV0dXJuICh0aGlzLl9ncmlkICYmIHRoaXMuX2dyaWQuZ2V0VUlEKSA/IHRoaXMuX2dyaWQuZ2V0VUlEKCkgOiB0aGlzLl9ncmlkT3B0aW9ucyAmJiB0aGlzLl9ncmlkT3B0aW9ucy5ncmlkSWQ7XHJcbiAgfVxyXG5cclxuICBpbml0KGdyaWQ6IGFueSwgZml4ZWREaW1lbnNpb25zPzogR3JpZERpbWVuc2lvbik6IHZvaWQge1xyXG4gICAgaWYgKCFncmlkIHx8ICF0aGlzLl9ncmlkT3B0aW9ucykge1xyXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYFxyXG4gICAgICBBbmd1bGFyLVNsaWNrZ3JpZCByZXNpemVyIHJlcXVpcmVzIGEgdmFsaWQgR3JpZCBvYmplY3QgYW5kIEdyaWQgT3B0aW9ucyBkZWZpbmVkLlxyXG4gICAgICBZb3UgY2FuIGZpeCB0aGlzIGJ5IHNldHRpbmcgeW91ciBncmlkT3B0aW9uIHRvIHVzZSBcImVuYWJsZUF1dG9SZXNpemVcIiBvciBjcmVhdGUgYW4gaW5zdGFuY2Ugb2YgdGhlIFJlc2l6ZXJTZXJ2aWNlIGJ5IGNhbGxpbmcgYmluZEF1dG9SZXNpemVEYXRhR3JpZCgpYCk7XHJcbiAgICB9XHJcblxyXG4gICAgdGhpcy5fZ3JpZCA9IGdyaWQ7XHJcbiAgICBjb25zdCBjb250YWluZXJOb2RlID0gZ3JpZCAmJiBncmlkLmdldENvbnRhaW5lck5vZGUgJiYgZ3JpZC5nZXRDb250YWluZXJOb2RlKCkgfHwgJyc7XHJcbiAgICB0aGlzLl9ncmlkRG9tRWxtID0gJChjb250YWluZXJOb2RlKTtcclxuICAgIGNvbnN0IGF1dG9SZXNpemVPcHRpb25zID0gdGhpcy5fZ3JpZE9wdGlvbnMgJiYgdGhpcy5fZ3JpZE9wdGlvbnMuYXV0b1Jlc2l6ZSB8fCB7fTtcclxuICAgIHRoaXMuX2dyaWRDb250YWluZXJFbG0gPSAoYXV0b1Jlc2l6ZU9wdGlvbnMgJiYgYXV0b1Jlc2l6ZU9wdGlvbnMuY29udGFpbmVySWQpID8gJChgIyR7YXV0b1Jlc2l6ZU9wdGlvbnMuY29udGFpbmVySWR9YCkgOiAkKGAjJHt0aGlzLl9ncmlkT3B0aW9ucy5ncmlkQ29udGFpbmVySWR9YCk7XHJcblxyXG4gICAgaWYgKGZpeGVkRGltZW5zaW9ucykge1xyXG4gICAgICB0aGlzLl9maXhlZEhlaWdodCA9IGZpeGVkRGltZW5zaW9ucy5oZWlnaHQ7XHJcbiAgICAgIHRoaXMuX2ZpeGVkV2lkdGggPSBmaXhlZERpbWVuc2lvbnMud2lkdGg7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvKiogQmluZCBhbiBhdXRvIHJlc2l6ZSB0cmlnZ2VyIG9uIHRoZSBkYXRhZ3JpZCwgaWYgdGhhdCBpcyBlbmFibGUgdGhlbiBpdCB3aWxsIHJlc2l6ZSBpdHNlbGYgdG8gdGhlIGF2YWlsYWJsZSBzcGFjZVxyXG4gICAqIE9wdGlvbnM6IHdlIGNvdWxkIGFsc28gcHJvdmlkZSBhICUgZmFjdG9yIHRvIHJlc2l6ZSBvbiBlYWNoIGhlaWdodC93aWR0aCBpbmRlcGVuZGVudGx5XHJcbiAgICovXHJcbiAgYmluZEF1dG9SZXNpemVEYXRhR3JpZChuZXdTaXplcz86IEdyaWREaW1lbnNpb24pIHtcclxuICAgIC8vIGlmIHdlIGNhbid0IGZpbmQgdGhlIGdyaWQgdG8gcmVzaXplLCByZXR1cm4gd2l0aG91dCBiaW5kaW5nIGFueXRoaW5nXHJcbiAgICBpZiAodGhpcy5fZ3JpZERvbUVsbSA9PT0gdW5kZWZpbmVkIHx8IHRoaXMuX2dyaWREb21FbG0ub2Zmc2V0KCkgPT09IHVuZGVmaW5lZCkge1xyXG4gICAgICByZXR1cm4gbnVsbDtcclxuICAgIH1cclxuXHJcbiAgICAvLyAtLSAxc3QgcmVzaXplIHRoZSBkYXRhZ3JpZCBzaXplIGF0IGZpcnN0IGxvYWQgKHdlIG5lZWQgdGhpcyBiZWNhdXNlIHRoZSAub24gZXZlbnQgaXMgbm90IHRyaWdnZXJlZCBvbiBmaXJzdCBsb2FkKVxyXG4gICAgLy8gLS0gYWxzbyB3ZSBhZGQgYSBzbGlnaHQgZGVsYXkgKGluIG1zKSBzbyB0aGF0IHdlIHJlc2l6ZSBhZnRlciB0aGUgZ3JpZCByZW5kZXIgaXMgZG9uZVxyXG4gICAgdGhpcy5yZXNpemVHcmlkKDEwLCBuZXdTaXplcyk7XHJcblxyXG4gICAgLy8gLS0gMm5kIGJpbmQgYSB0cmlnZ2VyIG9uIHRoZSBXaW5kb3cgRE9NIGVsZW1lbnQsIHNvIHRoYXQgaXQgaGFwcGVucyBhbHNvIHdoZW4gcmVzaXppbmcgYWZ0ZXIgZmlyc3QgbG9hZFxyXG4gICAgLy8gLS0gYmluZCBhdXRvLXJlc2l6ZSB0byBXaW5kb3cgb2JqZWN0IG9ubHkgaWYgaXQgZXhpc3RcclxuICAgICQod2luZG93KS5vbihgcmVzaXplLmdyaWQuJHt0aGlzLl9ncmlkVWlkfWAsIHRoaXMuaGFuZGxlUmVzaXplR3JpZC5iaW5kKHRoaXMsIG5ld1NpemVzKSk7XHJcbiAgfVxyXG5cclxuICBoYW5kbGVSZXNpemVHcmlkKG5ld1NpemVzOiBHcmlkRGltZW5zaW9uLCBldmVudDogRXZlbnQpIHtcclxuICAgIHRoaXMub25HcmlkQmVmb3JlUmVzaXplLm5leHQoZXZlbnQpO1xyXG4gICAgaWYgKCF0aGlzLl9yZXNpemVQYXVzZWQpIHtcclxuICAgICAgLy8gZm9yIHNvbWUgeWV0IHVua25vd24gcmVhc29uLCBjYWxsaW5nIHRoZSByZXNpemUgdHdpY2UgcmVtb3ZlcyBhbnkgc3R1dHRlcmluZy9mbGlja2VyaW5nXHJcbiAgICAgIC8vIHdoZW4gY2hhbmdpbmcgdGhlIGhlaWdodCBhbmQgbWFrZXMgaXQgbXVjaCBzbW9vdGhlciBleHBlcmllbmNlXHJcbiAgICAgIHRoaXMucmVzaXplR3JpZCgwLCBuZXdTaXplcyk7XHJcbiAgICAgIHRoaXMucmVzaXplR3JpZCgwLCBuZXdTaXplcyk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBDYWxjdWxhdGUgdGhlIGRhdGFncmlkIG5ldyBoZWlnaHQvd2lkdGggZnJvbSB0aGUgYXZhaWxhYmxlIHNwYWNlLCBhbHNvIGNvbnNpZGVyIHRoYXQgYSAlIGZhY3RvciBtaWdodCBiZSBhcHBsaWVkIHRvIGNhbGN1bGF0aW9uXHJcbiAgICogb2JqZWN0IGdyaWRPcHRpb25zXHJcbiAgICovXHJcbiAgY2FsY3VsYXRlR3JpZE5ld0RpbWVuc2lvbnMoZ3JpZE9wdGlvbnM6IEdyaWRPcHRpb24pOiBHcmlkRGltZW5zaW9uIHwgbnVsbCB7XHJcbiAgICBjb25zdCBhdXRvUmVzaXplT3B0aW9ucyA9IGdyaWRPcHRpb25zICYmIGdyaWRPcHRpb25zLmF1dG9SZXNpemUgfHwge307XHJcbiAgICBpZiAoIXdpbmRvdyB8fCB0aGlzLl9ncmlkQ29udGFpbmVyRWxtID09PSB1bmRlZmluZWQgfHwgdGhpcy5fZ3JpZERvbUVsbS5vZmZzZXQoKSA9PT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgIHJldHVybiBudWxsO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIGNhbGN1bGF0ZSBib3R0b20gcGFkZGluZ1xyXG4gICAgLy8gaWYgdXNpbmcgcGFnaW5hdGlvbiwgd2UgbmVlZCB0byBhZGQgdGhlIHBhZ2luYXRpb24gaGVpZ2h0IHRvIHRoaXMgYm90dG9tIHBhZGRpbmdcclxuICAgIGxldCBib3R0b21QYWRkaW5nID0gKGF1dG9SZXNpemVPcHRpb25zICYmIGF1dG9SZXNpemVPcHRpb25zLmJvdHRvbVBhZGRpbmcgIT09IHVuZGVmaW5lZCkgPyBhdXRvUmVzaXplT3B0aW9ucy5ib3R0b21QYWRkaW5nIDogREFUQUdSSURfQk9UVE9NX1BBRERJTkc7XHJcbiAgICBpZiAoYm90dG9tUGFkZGluZyAmJiBncmlkT3B0aW9ucy5lbmFibGVQYWdpbmF0aW9uKSB7XHJcbiAgICAgIGJvdHRvbVBhZGRpbmcgKz0gREFUQUdSSURfUEFHSU5BVElPTl9IRUlHSFQ7XHJcbiAgICB9XHJcblxyXG4gICAgLy8gb3B0aW9uYWxseSBzaG93IGEgY3VzdG9tIGZvb3RlciB3aXRoIHRoZSBkYXRhIG1ldHJpY3MgKGRhdGFzZXQgbGVuZ3RoIGFuZCBsYXN0IHVwZGF0ZWQgdGltZXN0YW1wKVxyXG4gICAgaWYgKGJvdHRvbVBhZGRpbmcgJiYgZ3JpZE9wdGlvbnMuc2hvd0N1c3RvbUZvb3Rlcikge1xyXG4gICAgICBib3R0b21QYWRkaW5nICs9IGdyaWRPcHRpb25zLmN1c3RvbUZvb3Rlck9wdGlvbnMgJiYgZ3JpZE9wdGlvbnMuY3VzdG9tRm9vdGVyT3B0aW9ucy5mb290ZXJIZWlnaHQgfHwgREFUQUdSSURfRk9PVEVSX0hFSUdIVDtcclxuICAgIH1cclxuXHJcbiAgICBsZXQgZ3JpZEhlaWdodCA9IDA7XHJcbiAgICBsZXQgZ3JpZE9mZnNldFRvcCA9IDA7XHJcblxyXG4gICAgLy8gd2hpY2ggRE9NIGVsZW1lbnQgYXJlIHdlIHVzaW5nIHRvIGNhbGN1bGF0ZSB0aGUgYXZhaWxhYmxlIHNpemUgZm9yIHRoZSBncmlkP1xyXG4gICAgaWYgKGF1dG9SZXNpemVPcHRpb25zLmNhbGN1bGF0ZUF2YWlsYWJsZVNpemVCeSA9PT0gJ2NvbnRhaW5lcicpIHtcclxuICAgICAgLy8gdXNlcyB0aGUgY29udGFpbmVyJ3MgaGVpZ2h0IHRvIGNhbGN1bGF0ZSBncmlkIGhlaWdodCB3aXRob3V0IGFueSB0b3Agb2Zmc2V0XHJcbiAgICAgIGdyaWRIZWlnaHQgPSB0aGlzLl9ncmlkQ29udGFpbmVyRWxtLmhlaWdodCgpIHx8IDA7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICAvLyB1c2VzIHRoZSBicm93c2VyJ3Mgd2luZG93IGhlaWdodCB3aXRoIGl0cyB0b3Agb2Zmc2V0IHRvIGNhbGN1bGF0ZSBncmlkIGhlaWdodFxyXG4gICAgICBncmlkSGVpZ2h0ID0gd2luZG93LmlubmVySGVpZ2h0IHx8IDA7XHJcbiAgICAgIGNvbnN0IGNvb3JkT2Zmc2V0VG9wID0gdGhpcy5fZ3JpZERvbUVsbS5vZmZzZXQoKTtcclxuICAgICAgZ3JpZE9mZnNldFRvcCA9IChjb29yZE9mZnNldFRvcCAhPT0gdW5kZWZpbmVkKSA/IGNvb3JkT2Zmc2V0VG9wLnRvcCA6IDA7XHJcbiAgICB9XHJcblxyXG4gICAgY29uc3QgYXZhaWxhYmxlSGVpZ2h0ID0gZ3JpZEhlaWdodCAtIGdyaWRPZmZzZXRUb3AgLSBib3R0b21QYWRkaW5nO1xyXG4gICAgY29uc3QgYXZhaWxhYmxlV2lkdGggPSB0aGlzLl9ncmlkQ29udGFpbmVyRWxtLndpZHRoKCkgfHwgd2luZG93LmlubmVyV2lkdGggfHwgMDtcclxuICAgIGNvbnN0IG1heEhlaWdodCA9IGF1dG9SZXNpemVPcHRpb25zICYmIGF1dG9SZXNpemVPcHRpb25zLm1heEhlaWdodCB8fCB1bmRlZmluZWQ7XHJcbiAgICBjb25zdCBtaW5IZWlnaHQgPSAoYXV0b1Jlc2l6ZU9wdGlvbnMgJiYgYXV0b1Jlc2l6ZU9wdGlvbnMubWluSGVpZ2h0ICE9PSB1bmRlZmluZWQpID8gYXV0b1Jlc2l6ZU9wdGlvbnMubWluSGVpZ2h0IDogREFUQUdSSURfTUlOX0hFSUdIVDtcclxuICAgIGNvbnN0IG1heFdpZHRoID0gYXV0b1Jlc2l6ZU9wdGlvbnMgJiYgYXV0b1Jlc2l6ZU9wdGlvbnMubWF4V2lkdGggfHwgdW5kZWZpbmVkO1xyXG4gICAgY29uc3QgbWluV2lkdGggPSAoYXV0b1Jlc2l6ZU9wdGlvbnMgJiYgYXV0b1Jlc2l6ZU9wdGlvbnMubWluV2lkdGggIT09IHVuZGVmaW5lZCkgPyBhdXRvUmVzaXplT3B0aW9ucy5taW5XaWR0aCA6IERBVEFHUklEX01JTl9XSURUSDtcclxuXHJcbiAgICBsZXQgbmV3SGVpZ2h0ID0gYXZhaWxhYmxlSGVpZ2h0O1xyXG4gICAgbGV0IG5ld1dpZHRoID0gKGF1dG9SZXNpemVPcHRpb25zICYmIGF1dG9SZXNpemVPcHRpb25zLnNpZGVQYWRkaW5nKSA/IGF2YWlsYWJsZVdpZHRoIC0gYXV0b1Jlc2l6ZU9wdGlvbnMuc2lkZVBhZGRpbmcgOiBhdmFpbGFibGVXaWR0aDtcclxuXHJcbiAgICAvLyBvcHRpb25hbGx5ICh3aGVuIGRlZmluZWQpLCBtYWtlIHN1cmUgdGhhdCBncmlkIGhlaWdodCAmIHdpZHRoIGFyZSB3aXRoaW4gdGhlaXIgdGhyZXNob2xkc1xyXG4gICAgaWYgKG5ld0hlaWdodCA8IG1pbkhlaWdodCkge1xyXG4gICAgICBuZXdIZWlnaHQgPSBtaW5IZWlnaHQ7XHJcbiAgICB9XHJcbiAgICBpZiAobWF4SGVpZ2h0ICYmIG5ld0hlaWdodCA+IG1heEhlaWdodCkge1xyXG4gICAgICBuZXdIZWlnaHQgPSBtYXhIZWlnaHQ7XHJcbiAgICB9XHJcbiAgICBpZiAobmV3V2lkdGggPCBtaW5XaWR0aCkge1xyXG4gICAgICBuZXdXaWR0aCA9IG1pbldpZHRoO1xyXG4gICAgfVxyXG4gICAgaWYgKG1heFdpZHRoICYmIG5ld1dpZHRoID4gbWF4V2lkdGgpIHtcclxuICAgICAgbmV3V2lkdGggPSBtYXhXaWR0aDtcclxuICAgIH1cclxuXHJcbiAgICAvLyByZXR1cm4gdGhlIG5ldyBkaW1lbnNpb25zIHVubGVzcyBhIGZpeGVkIGhlaWdodC93aWR0aCB3YXMgZGVmaW5lZFxyXG4gICAgcmV0dXJuIHtcclxuICAgICAgaGVpZ2h0OiB0aGlzLl9maXhlZEhlaWdodCB8fCBuZXdIZWlnaHQsXHJcbiAgICAgIHdpZHRoOiB0aGlzLl9maXhlZFdpZHRoIHx8IG5ld1dpZHRoXHJcbiAgICB9O1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogRGlzcG9zZSBmdW5jdGlvbiB3aGVuIGVsZW1lbnQgaXMgZGVzdHJveWVkXHJcbiAgICovXHJcbiAgZGlzcG9zZSgpIHtcclxuICAgICQod2luZG93KS5vZmYoYHJlc2l6ZS5ncmlkLiR7dGhpcy5fZ3JpZFVpZH1gKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFJldHVybiB0aGUgbGFzdCByZXNpemUgZGltZW5zaW9ucyB1c2VkIGJ5IHRoZSBzZXJ2aWNlXHJcbiAgICogQHJldHVybiBsYXN0IGRpbWVuc2lvbnNcclxuICAgKi9cclxuICBnZXRMYXN0UmVzaXplRGltZW5zaW9ucygpOiBHcmlkRGltZW5zaW9uIHtcclxuICAgIHJldHVybiB0aGlzLl9sYXN0RGltZW5zaW9ucztcclxuICB9XHJcblxyXG4gIC8qKiBQcm92aWRlIHRoZSBwb3NzaWJpbGl0eSB0byBwYXVzZSB0aGUgcmVzaXplciBmb3Igc29tZSB0aW1lLCB1bnRpbCB1c2VyIGRlY2lkZXMgdG8gcmUtZW5hYmxlZCBpdCBsYXRlciBpZiBoZSB3aXNoIHRvLiAqL1xyXG4gIHBhdXNlUmVzaXplcihpc1Jlc2l6ZVBhdXNlZDogYm9vbGVhbikge1xyXG4gICAgdGhpcy5fcmVzaXplUGF1c2VkID0gaXNSZXNpemVQYXVzZWQ7XHJcbiAgfVxyXG5cclxuICAvKiogUmVzaXplIHRoZSBkYXRhZ3JpZCB0byBmaXQgdGhlIGJyb3dzZXIgaGVpZ2h0ICYgd2lkdGggKi9cclxuICByZXNpemVHcmlkKGRlbGF5ID0gMTAsIG5ld1NpemVzPzogR3JpZERpbWVuc2lvbik6IFByb21pc2U8R3JpZERpbWVuc2lvbj4ge1xyXG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiB7XHJcbiAgICAgIC8vIGJlY2F1c2Ugb2YgdGhlIGphdmFzY3JpcHQgYXN5bmMgbmF0dXJlLCB3ZSBtaWdodCB3YW50IHRvIGRlbGF5IHRoZSByZXNpemUgYSBsaXR0bGUgYml0XHJcbiAgICAgIGRlbGF5ID0gZGVsYXkgfHwgMDtcclxuXHJcbiAgICAgIGlmIChkZWxheSA+IDApIHtcclxuICAgICAgICBjbGVhclRpbWVvdXQodGhpcy5fdGltZXIpO1xyXG4gICAgICAgIHRoaXMuX3RpbWVyID0gc2V0VGltZW91dCgoKSA9PiByZXNvbHZlKHRoaXMucmVzaXplR3JpZENhbGxiYWNrKG5ld1NpemVzKSksIGRlbGF5KTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICByZXNvbHZlKHRoaXMucmVzaXplR3JpZENhbGxiYWNrKG5ld1NpemVzKSk7XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgcmVzaXplR3JpZENhbGxiYWNrKG5ld1NpemVzOiBHcmlkRGltZW5zaW9uKSB7XHJcbiAgICBjb25zdCBsYXN0RGltZW5zaW9ucyA9IHRoaXMucmVzaXplR3JpZFdpdGhEaW1lbnNpb25zKG5ld1NpemVzKTtcclxuICAgIHRoaXMub25HcmlkQWZ0ZXJSZXNpemUubmV4dChsYXN0RGltZW5zaW9ucyk7XHJcbiAgICByZXR1cm4gbGFzdERpbWVuc2lvbnM7XHJcbiAgfVxyXG5cclxuICByZXNpemVHcmlkV2l0aERpbWVuc2lvbnMobmV3U2l6ZXM/OiBHcmlkRGltZW5zaW9uKTogR3JpZERpbWVuc2lvbiB7XHJcbiAgICAvLyBjYWxjdWxhdGUgdGhlIGF2YWlsYWJsZSBzaXplcyB3aXRoIG1pbmltdW0gaGVpZ2h0IGRlZmluZWQgYXMgYSBjb25zdGFudFxyXG4gICAgY29uc3QgYXZhaWxhYmxlRGltZW5zaW9ucyA9IHRoaXMuY2FsY3VsYXRlR3JpZE5ld0RpbWVuc2lvbnModGhpcy5fZ3JpZE9wdGlvbnMpO1xyXG4gICAgY29uc3QgZ3JpZENvbnRhaW5lckVsbSA9ICQoYCMke3RoaXMuX2dyaWRPcHRpb25zLmdyaWRDb250YWluZXJJZH1gKSB8fCB7fTtcclxuXHJcbiAgICBpZiAoKG5ld1NpemVzIHx8IGF2YWlsYWJsZURpbWVuc2lvbnMpICYmIHRoaXMuX2dyaWREb21FbG0ubGVuZ3RoID4gMCkge1xyXG4gICAgICAvLyBnZXQgdGhlIG5ldyBzaXplcywgaWYgbmV3IHNpemVzIGFyZSBwYXNzZWQgKG5vdCAwKSwgd2Ugd2lsbCB1c2UgdGhlbSBlbHNlIHVzZSBhdmFpbGFibGUgc3BhY2VcclxuICAgICAgLy8gYmFzaWNhbGx5IGlmIHVzZXIgcGFzc2VzIDEgb2YgdGhlIGRpbWVuc2lvbiwgbGV0IHNheSBoZSBwYXNzZXMganVzdCB0aGUgaGVpZ2h0LFxyXG4gICAgICAvLyB3ZSB3aWxsIHVzZSB0aGUgaGVpZ2h0IGFzIGEgZml4ZWQgaGVpZ2h0IGJ1dCB0aGUgd2lkdGggd2lsbCBiZSByZXNpemVkIGJ5IGl0J3MgYXZhaWxhYmxlIHNwYWNlXHJcbiAgICAgIGNvbnN0IG5ld0hlaWdodCA9IChuZXdTaXplcyAmJiBuZXdTaXplcy5oZWlnaHQpID8gbmV3U2l6ZXMuaGVpZ2h0IDogYXZhaWxhYmxlRGltZW5zaW9ucy5oZWlnaHQ7XHJcbiAgICAgIGNvbnN0IG5ld1dpZHRoID0gKG5ld1NpemVzICYmIG5ld1NpemVzLndpZHRoKSA/IG5ld1NpemVzLndpZHRoIDogYXZhaWxhYmxlRGltZW5zaW9ucy53aWR0aDtcclxuXHJcbiAgICAgIC8vIGFwcGx5IHRoZXNlIG5ldyBoZWlnaHQvd2lkdGggdG8gdGhlIGRhdGFncmlkXHJcbiAgICAgIGlmICghdGhpcy5fZ3JpZE9wdGlvbnMuYXV0b0hlaWdodCkge1xyXG4gICAgICAgIHRoaXMuX2dyaWREb21FbG0uaGVpZ2h0KG5ld0hlaWdodCk7XHJcbiAgICAgICAgZ3JpZENvbnRhaW5lckVsbS5oZWlnaHQobmV3SGVpZ2h0KTtcclxuICAgICAgfVxyXG4gICAgICB0aGlzLl9ncmlkRG9tRWxtLndpZHRoKG5ld1dpZHRoKTtcclxuICAgICAgZ3JpZENvbnRhaW5lckVsbS53aWR0aChuZXdXaWR0aCk7XHJcblxyXG4gICAgICAvLyByZXNpemUgdGhlIHNsaWNrZ3JpZCBjYW52YXMgb24gYWxsIGJyb3dzZXIgZXhjZXB0IHNvbWUgSUUgdmVyc2lvbnNcclxuICAgICAgLy8gZXhjbHVkZSBhbGwgSUUgYmVsb3cgSUUxMVxyXG4gICAgICAvLyBJRTExIHdhbnRzIHRvIGJlIGEgYmV0dGVyIHN0YW5kYXJkIChXM0MpIGZvbGxvd2VyIChmaW5hbGx5KSB0aGV5IGV2ZW4gY2hhbmdlZCB0aGVpciBhcHBOYW1lIG91dHB1dCB0byBhbHNvIGhhdmUgJ05ldHNjYXBlJ1xyXG4gICAgICBpZiAobmV3IFJlZ0V4cCgnTVNJRSBbNi04XScpLmV4ZWMobmF2aWdhdG9yLnVzZXJBZ2VudCkgPT09IG51bGwgJiYgdGhpcy5fZ3JpZCAmJiB0aGlzLl9ncmlkLnJlc2l6ZUNhbnZhcykge1xyXG4gICAgICAgIHRoaXMuX2dyaWQucmVzaXplQ2FudmFzKCk7XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIC8vIGFsc28gY2FsbCB0aGUgZ3JpZCBhdXRvLXNpemUgY29sdW1ucyBzbyB0aGF0IGl0IHRha2VzIGF2YWlsYWJsZSBzcGFjZSB3aGVuIGdvaW5nIGJpZ2dlclxyXG4gICAgICBpZiAodGhpcy5fZ3JpZE9wdGlvbnMgJiYgdGhpcy5fZ3JpZE9wdGlvbnMuZW5hYmxlQXV0b1NpemVDb2x1bW5zICYmIHRoaXMuX2dyaWQuYXV0b3NpemVDb2x1bW5zKSB7XHJcbiAgICAgICAgLy8gbWFrZSBzdXJlIHRoYXQgdGhlIGdyaWQgc3RpbGwgZXhpc3QgKGJ5IGxvb2tpbmcgaWYgdGhlIEdyaWQgVUlEIGlzIGZvdW5kIGluIHRoZSBET00gdHJlZSkgdG8gYXZvaWQgU2xpY2tHcmlkIGVycm9yIFwibWlzc2luZyBzdHlsZXNoZWV0XCJcclxuICAgICAgICBpZiAodGhpcy5fZ3JpZFVpZCAmJiAkKGAuJHt0aGlzLl9ncmlkVWlkfWApLmxlbmd0aCA+IDApIHtcclxuICAgICAgICAgIHRoaXMuX2dyaWQuYXV0b3NpemVDb2x1bW5zKCk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcblxyXG4gICAgICAvLyBrZWVwIGxhc3QgcmVzaXplZCBkaW1lbnNpb25zICYgcmVzb2x2ZSB0aGVtIHRvIHRoZSBQcm9taXNlXHJcbiAgICAgIHRoaXMuX2xhc3REaW1lbnNpb25zID0ge1xyXG4gICAgICAgIGhlaWdodDogbmV3SGVpZ2h0LFxyXG4gICAgICAgIHdpZHRoOiBuZXdXaWR0aFxyXG4gICAgICB9O1xyXG5cclxuICAgICAgaWYgKCh0aGlzLl9ncmlkT3B0aW9ucy5lbmFibGVQYWdpbmF0aW9uIHx8IHRoaXMuX2dyaWRPcHRpb25zLmJhY2tlbmRTZXJ2aWNlQXBpKSkge1xyXG4gICAgICAgIHRoaXMuX2xhc3REaW1lbnNpb25zLmhlaWdodFdpdGhQYWdpbmF0aW9uID0gbmV3SGVpZ2h0ICsgREFUQUdSSURfUEFHSU5BVElPTl9IRUlHSFQ7XHJcbiAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4gdGhpcy5fbGFzdERpbWVuc2lvbnM7XHJcbiAgfVxyXG59XHJcbiJdfQ==