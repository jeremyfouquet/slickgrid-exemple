import * as tslib_1 from "tslib";
import { TranslateService } from '@ngx-translate/core';
import * as moment_ from 'moment-mini';
import * as _flatpickr from 'flatpickr';
var flatpickr = _flatpickr; // patch for rollup
var moment = moment_; // patch to fix rollup "moment has no default export" issue, document here https://github.com/rollup/rollup/issues/670
import { Constants } from './../constants';
import { destroyObjectDomElementProps, getDescendantProperty, mapFlatpickrDateFormatWithFieldType, mapMomentDateFormatWithFieldType, setDeepValue } from './../services/utilities';
import { FieldType, } from './../models/index';
require('flatpickr');
/*
 * An example of a date picker editor using Flatpickr
 * https://chmln.github.io/flatpickr
 */
var DateEditor = /** @class */ (function () {
    function DateEditor(args) {
        this.args = args;
        if (!args) {
            throw new Error('[Angular-SlickGrid] Something is wrong with this grid, an Editor must always have valid arguments.');
        }
        this.grid = args.grid;
        this.gridOptions = (args.grid && args.grid.getOptions() || {});
        var options = this.gridOptions || this.args.column.params || {};
        if (options && options.i18n instanceof TranslateService) {
            this._translate = options.i18n;
        }
        this.init();
    }
    Object.defineProperty(DateEditor.prototype, "columnDef", {
        /** Get Column Definition object */
        get: function () {
            return this.args && this.args.column;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(DateEditor.prototype, "columnEditor", {
        /** Get Column Editor object */
        get: function () {
            return this.columnDef && this.columnDef.internalColumnEditor || {};
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(DateEditor.prototype, "editorDomElement", {
        /** Get the Editor DOM Element */
        get: function () {
            return this._$input;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(DateEditor.prototype, "editorOptions", {
        /** Get Flatpickr options passed to the editor by the user */
        get: function () {
            return this.columnEditor.editorOptions || {};
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(DateEditor.prototype, "hasAutoCommitEdit", {
        get: function () {
            return this.grid.getOptions().autoCommitEdit;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(DateEditor.prototype, "pickerOptions", {
        get: function () {
            return this._pickerMergedOptions;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(DateEditor.prototype, "validator", {
        /** Get the Validator function, can be passed in Editor property or Column Definition */
        get: function () {
            return this.columnEditor.validator || this.columnDef.validator;
        },
        enumerable: true,
        configurable: true
    });
    DateEditor.prototype.init = function () {
        var _this = this;
        if (this.args && this.columnDef) {
            var columnId = this.columnDef && this.columnDef.id;
            var placeholder = this.columnEditor && this.columnEditor.placeholder || '';
            var title = this.columnEditor && this.columnEditor.title || '';
            this.defaultDate = (this.args.item) ? this.args.item[this.columnDef.field] : null;
            var inputFormat = mapFlatpickrDateFormatWithFieldType(this.columnEditor.type || this.columnDef.type || FieldType.dateUtc);
            var outputFormat = mapFlatpickrDateFormatWithFieldType(this.columnDef.outputType || this.columnEditor.type || this.columnDef.type || FieldType.dateUtc);
            var currentLocale = this._translate && this._translate.currentLang || this.gridOptions.locale || 'en';
            if (currentLocale && currentLocale.length > 2) {
                currentLocale = currentLocale.substring(0, 2);
            }
            var pickerOptions = {
                defaultDate: this.defaultDate,
                altInput: true,
                altFormat: outputFormat,
                dateFormat: inputFormat,
                closeOnSelect: true,
                wrap: true,
                locale: (currentLocale !== 'en') ? this.loadFlatpickrLocale(currentLocale) : 'en',
                onChange: function () { return _this.save(); },
                errorHandler: function () {
                    // do nothing, Flatpickr is a little too sensitive and will throw an error when provided date is lower than minDate so just disregard the error completely
                }
            };
            // merge options with optional user's custom options
            this._pickerMergedOptions = tslib_1.__assign({}, pickerOptions, this.editorOptions);
            var inputCssClasses = ".editor-text.editor-" + columnId + ".form-control";
            if (this._pickerMergedOptions.altInput) {
                this._pickerMergedOptions.altInputClass = 'flatpickr-alt-input form-control';
            }
            this._$editorInputElm = $("<div class=\"flatpickr input-group\"></div>");
            var closeButtonElm = $("<span class=\"input-group-btn\" data-clear>\n          <button class=\"btn btn-default icon-close\" type=\"button\"></button>\n        </span>");
            this._$input = $("<input type=\"text\" data-input data-defaultDate=\"" + this.defaultDate + "\" class=\"" + inputCssClasses.replace(/\./g, ' ') + "\" placeholder=\"" + placeholder + "\" title=\"" + title + "\" />");
            this._$input.appendTo(this._$editorInputElm);
            // show clear date button (unless user specifically doesn't want it)
            var isCloseButtonHidden = this.columnEditor && this.columnEditor.params && this.columnEditor.params.hideClearButton || false;
            if (!isCloseButtonHidden) {
                closeButtonElm.appendTo(this._$editorInputElm);
            }
            this._$editorInputElm.appendTo(this.args.container);
            this.flatInstance = (flatpickr && this._$editorInputElm[0] && typeof this._$editorInputElm[0].flatpickr === 'function') ? this._$editorInputElm[0].flatpickr(this._pickerMergedOptions) : flatpickr(this._$editorInputElm, this._pickerMergedOptions);
            // when we're using an alternate input to display data, we'll consider this input as the one to do the focus later on
            // else just use the top one
            this._$inputWithData = (this._pickerMergedOptions && this._pickerMergedOptions.altInput) ? $(inputCssClasses + ".flatpickr-alt-input") : this._$input;
            setTimeout(function () {
                _this.show();
                _this.focus();
            }, 50);
        }
    };
    DateEditor.prototype.destroy = function () {
        var _this = this;
        this.hide();
        if (this.flatInstance && typeof this.flatInstance.destroy === 'function') {
            this.flatInstance.destroy();
            if (this.flatInstance.element) {
                setTimeout(function () { return destroyObjectDomElementProps(_this.flatInstance); });
            }
            this.flatInstance = null;
        }
        if (this._$editorInputElm) {
            this._$editorInputElm.remove();
            this._$editorInputElm = null;
        }
        if (this._$inputWithData) {
            this._$inputWithData.remove();
            this._$inputWithData = null;
        }
        this._$input.remove();
    };
    DateEditor.prototype.focus = function () {
        this._$input.focus();
        if (this._$inputWithData && typeof this._$inputWithData.focus === 'function') {
            this._$inputWithData.focus().select();
        }
    };
    DateEditor.prototype.hide = function () {
        if (this.flatInstance && typeof this.flatInstance.close === 'function') {
            this.flatInstance.close();
        }
    };
    DateEditor.prototype.show = function () {
        if (this.flatInstance && typeof this.flatInstance.open === 'function' && this.flatInstance._input) {
            this.flatInstance.open();
        }
    };
    DateEditor.prototype.getValue = function () {
        return this._$input.val();
    };
    DateEditor.prototype.setValue = function (val) {
        this.flatInstance.setDate(val);
    };
    DateEditor.prototype.applyValue = function (item, state) {
        var fieldName = this.columnDef && this.columnDef.field;
        if (fieldName !== undefined) {
            var outputTypeFormat = mapMomentDateFormatWithFieldType((this.columnDef && (this.columnDef.outputType || this.columnEditor.type || this.columnDef.type)) || FieldType.dateUtc);
            var saveTypeFormat = mapMomentDateFormatWithFieldType((this.columnDef && (this.columnDef.saveOutputType || this.columnDef.outputType || this.columnEditor.type || this.columnDef.type)) || FieldType.dateUtc);
            var isComplexObject = fieldName && fieldName.indexOf('.') > 0; // is the field a complex object, "address.streetNumber"
            // validate the value before applying it (if not valid we'll set an empty string)
            var validation = this.validate(state);
            var newValue = (state && validation && validation.valid) ? moment(state, outputTypeFormat).format(saveTypeFormat) : '';
            // set the new value to the item datacontext
            if (isComplexObject) {
                setDeepValue(item, fieldName, newValue);
            }
            else {
                item[fieldName] = newValue;
            }
        }
    };
    DateEditor.prototype.isValueChanged = function () {
        var elmValue = this._$input.val();
        var inputFormat = mapMomentDateFormatWithFieldType(this.columnEditor.type || (this.columnDef && this.columnDef.type) || FieldType.dateIso);
        var outputTypeFormat = mapMomentDateFormatWithFieldType((this.columnDef && (this.columnDef.outputType || this.columnEditor.type || this.columnDef.type)) || FieldType.dateUtc);
        var elmDateStr = elmValue ? moment(elmValue, inputFormat, false).format(outputTypeFormat) : '';
        var orgDateStr = this._originalDate ? moment(this._originalDate, inputFormat, false).format(outputTypeFormat) : '';
        if (elmDateStr === 'Invalid date' || orgDateStr === 'Invalid date') {
            return false;
        }
        var isChanged = (!(elmDateStr === '' && orgDateStr === '')) && (elmDateStr !== orgDateStr);
        return isChanged;
    };
    DateEditor.prototype.loadValue = function (item) {
        var fieldName = this.columnDef && this.columnDef.field;
        if (item && fieldName !== undefined) {
            // is the field a complex object, "address.streetNumber"
            var isComplexObject = fieldName && fieldName.indexOf('.') > 0;
            var value = (isComplexObject) ? getDescendantProperty(item, fieldName) : item[fieldName];
            this._originalDate = value;
            this.flatInstance.setDate(value);
        }
    };
    DateEditor.prototype.save = function () {
        var validation = this.validate();
        var isValid = (validation && validation.valid) || false;
        if (this.hasAutoCommitEdit && isValid) {
            // do not use args.commitChanges() as this sets the focus to the next row.
            // also the select list will stay shown when clicking off the grid
            this.grid.getEditorLock().commitCurrentEdit();
        }
        else {
            this.args.commitChanges();
        }
    };
    DateEditor.prototype.serializeValue = function () {
        var domValue = this._$input.val();
        if (!domValue) {
            return '';
        }
        var inputFormat = mapMomentDateFormatWithFieldType(this.columnEditor.type || (this.columnDef && this.columnDef.type) || FieldType.dateIso);
        var outputTypeFormat = mapMomentDateFormatWithFieldType((this.columnDef && (this.columnDef.outputType || this.columnEditor.type || this.columnDef.type)) || FieldType.dateIso);
        var value = moment(domValue, inputFormat, false).format(outputTypeFormat);
        return value;
    };
    DateEditor.prototype.validate = function (inputValue) {
        var isRequired = this.columnEditor.required;
        var elmValue = (inputValue !== undefined) ? inputValue : this._$input && this._$input.val && this._$input.val();
        var errorMsg = this.columnEditor.errorMessage;
        if (this.validator) {
            return this.validator(elmValue, this.args);
        }
        // by default the editor is almost always valid (except when it's required but not provided)
        if (isRequired && elmValue === '') {
            return {
                valid: false,
                msg: errorMsg || Constants.VALIDATION_REQUIRED_FIELD
            };
        }
        return {
            valid: true,
            msg: null
        };
    };
    //
    // private functions
    // ------------------
    /** Load a different set of locales for Flatpickr to be localized */
    DateEditor.prototype.loadFlatpickrLocale = function (language) {
        var locales = 'en';
        if (language !== 'en') {
            // change locale if needed, Flatpickr reference: https://chmln.github.io/flatpickr/localization/
            var localeDefault = require("flatpickr/dist/l10n/" + language + ".js").default;
            locales = (localeDefault && localeDefault[language]) ? localeDefault[language] : 'en';
        }
        return locales;
    };
    return DateEditor;
}());
export { DateEditor };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGF0ZUVkaXRvci5qcyIsInNvdXJjZVJvb3QiOiJuZzovL2FuZ3VsYXItc2xpY2tncmlkLyIsInNvdXJjZXMiOlsiYXBwL21vZHVsZXMvYW5ndWxhci1zbGlja2dyaWQvZWRpdG9ycy9kYXRlRWRpdG9yLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUN2RCxPQUFPLEtBQUssT0FBTyxNQUFNLGFBQWEsQ0FBQztBQUV2QyxPQUFPLEtBQUssVUFBVSxNQUFNLFdBQVcsQ0FBQztBQUV4QyxJQUFNLFNBQVMsR0FBZ0IsVUFBaUIsQ0FBQyxDQUFDLG1CQUFtQjtBQUNyRSxJQUFNLE1BQU0sR0FBRyxPQUFPLENBQUMsQ0FBQyxzSEFBc0g7QUFFOUksT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQzNDLE9BQU8sRUFBRSw0QkFBNEIsRUFBRSxxQkFBcUIsRUFBRSxtQ0FBbUMsRUFBRSxnQ0FBZ0MsRUFBRSxZQUFZLEVBQUUsTUFBTSx5QkFBeUIsQ0FBQztBQUNuTCxPQUFPLEVBT0wsU0FBUyxHQUdWLE1BQU0sbUJBQW1CLENBQUM7QUFHM0IsT0FBTyxDQUFDLFdBQVcsQ0FBQyxDQUFDO0FBS3JCOzs7R0FHRztBQUNIO0lBb0JFLG9CQUFvQixJQUFxQjtRQUFyQixTQUFJLEdBQUosSUFBSSxDQUFpQjtRQUN2QyxJQUFJLENBQUMsSUFBSSxFQUFFO1lBQ1QsTUFBTSxJQUFJLEtBQUssQ0FBQyxvR0FBb0csQ0FBQyxDQUFDO1NBQ3ZIO1FBQ0QsSUFBSSxDQUFDLElBQUksR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDO1FBQ3RCLElBQUksQ0FBQyxXQUFXLEdBQUcsQ0FBQyxJQUFJLENBQUMsSUFBSSxJQUFJLElBQUksQ0FBQyxJQUFJLENBQUMsVUFBVSxFQUFFLElBQUksRUFBRSxDQUFlLENBQUM7UUFDN0UsSUFBTSxPQUFPLEdBQUcsSUFBSSxDQUFDLFdBQVcsSUFB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LFVBQTRCLFFBQWdCO1FBQzFDLElBQUksT0FBTyxHQUFHLElBQUksQ0FBQztRQUVuQixJQUFJLFFBQVEsS0FBSyxJQUFJLEVBQUU7WUFDckIsZ0dBQWdHO1lBQ2hHLElBQU0sYUFBYSxHQUFRLE9BQU8sQ0FBQyx5QkFBdUIsUUFBUSxRQUFLLENBQUMsQ0FBQyxPQUFPLENBQUM7WUFDakYsT0FBTyxHQUFHLENBQUMsYUFBYSxJQUFJLGFBQWEsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxhQUFhLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQztTQUN2RjtRQUNELE9BQU8sT0FBTyxDQUFDO0lBQ2pCLENBQUM7SUFDSCxpQkFBQztBQUFELENBQUMsQUEvUkQsSUErUkMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBUcmFuc2xhdGVTZXJ2aWNlIH0gZnJvbSAnQG5neC10cmFuc2xhdGUvY29yZSc7XHJcbmltcG9ydCAqIGFzIG1vbWVudF8gZnJvbSAnbW9tZW50LW1pbmknO1xyXG5pbXBvcnQgeyBCYXNlT3B0aW9ucyBhcyBGbGF0cGlja3JCYXNlT3B0aW9ucyB9IGZyb20gJ2ZsYXRwaWNrci9kaXN0L3R5cGVzL29wdGlvbnMnO1xyXG5pbXBvcnQgKiBhcyBfZmxhdHBpY2tyIGZyb20gJ2ZsYXRwaWNrcic7XHJcbmltcG9ydCB7IEZsYXRwaWNrckZuIH0gZnJvbSAnZmxhdHBpY2tyL2Rpc3QvdHlwZXMvaW5zdGFuY2UnO1xyXG5jb25zdCBmbGF0cGlja3I6IEZsYXRwaWNrckZuID0gX2ZsYXRwaWNrciBhcyBhbnk7IC8vIHBhdGNoIGZvciByb2xsdXBcclxuY29uc3QgbW9tZW50ID0gbW9tZW50XzsgLy8gcGF0Y2ggdG8gZml4IHJvbGx1cCBcIm1vbWVudCBoYXMgbm8gZGVmYXVsdCBleHBvcnRcIiBpc3N1ZSwgZG9jdW1lbnQgaGVyZSBodHRwczovL2dpdGh1Yi5jb20vcm9sbHVwL3JvbGx1cC9pc3N1ZXMvNjcwXHJcblxyXG5pbXBvcnQgeyBDb25zdGFudHMgfSBmcm9tICcuLy4uL2NvbnN0YW50cyc7XHJcbmltcG9ydCB7IGRlc3Ryb3lPYmplY3REb21FbGVtZW50UHJvcHMsIGdldERlc2NlbmRhbnRQcm9wZXJ0eSwgbWFwRmxhdHBpY2tyRGF0ZUZvcm1hdFdpdGhGaWVsZFR5cGUsIG1hcE1vbWVudERhdGVGb3JtYXRXaXRoRmllbGRUeXBlLCBzZXREZWVwVmFsdWUgfSBmcm9tICcuLy4uL3NlcnZpY2VzL3V0aWxpdGllcyc7XHJcbmltcG9ydCB7XHJcbiAgQ29sdW1uLFxyXG4gIENvbHVtbkVkaXRvcixcclxuICBFZGl0b3IsXHJcbiAgRWRpdG9yQXJndW1lbnRzLFxyXG4gIEVkaXRvclZhbGlkYXRvcixcclxuICBFZGl0b3JWYWxpZGF0b3JPdXRwdXQsXHJcbiAgRmllbGRUeXBlLFxyXG4gIEZsYXRwaWNrck9wdGlvbixcclxuICBHcmlkT3B0aW9uLFxyXG59IGZyb20gJy4vLi4vbW9kZWxzL2luZGV4JztcclxuXHJcbmRlY2xhcmUgZnVuY3Rpb24gcmVxdWlyZShuYW1lOiBzdHJpbmcpO1xyXG5yZXF1aXJlKCdmbGF0cGlja3InKTtcclxuXHJcbi8vIHVzaW5nIGV4dGVybmFsIG5vbi10eXBlZCBqcyBsaWJyYXJpZXNcclxuZGVjbGFyZSBjb25zdCAkOiBhbnk7XHJcblxyXG4vKlxyXG4gKiBBbiBleGFtcGxlIG9mIGEgZGF0ZSBwaWNrZXIgZWRpdG9yIHVzaW5nIEZsYXRwaWNrclxyXG4gKiBodHRwczovL2NobWxuLmdpdGh1Yi5pby9mbGF0cGlja3JcclxuICovXHJcbmV4cG9ydCBjbGFzcyBEYXRlRWRpdG9yIGltcGxlbWVudHMgRWRpdG9yIHtcclxuICBwcml2YXRlIF8kaW5wdXRXaXRoRGF0YTogYW55O1xyXG4gIHByaXZhdGUgXyRpbnB1dDogYW55O1xyXG4gIHByaXZhdGUgXyRlZGl0b3JJbnB1dEVsbTogYW55O1xyXG4gIHByaXZhdGUgX29yaWdpbmFsRGF0ZTogc3RyaW5nO1xyXG4gIHByaXZhdGUgX3BpY2tlck1lcmdlZE9wdGlvbnM6IEZsYXRwaWNrck9wdGlvbjtcclxuXHJcbiAgLyoqIFRoZSB0cmFuc2xhdGUgbGlicmFyeSAqL1xyXG4gIHByaXZhdGUgX3RyYW5zbGF0ZTogVHJhbnNsYXRlU2VydmljZTtcclxuXHJcbiAgZmxhdEluc3RhbmNlOiBhbnk7XHJcbiAgZGVmYXVsdERhdGU6IHN0cmluZztcclxuICBvcmlnaW5hbERhdGU6IHN0cmluZztcclxuXHJcbiAgLyoqIFNsaWNrR3JpZCBHcmlkIG9iamVjdCAqL1xyXG4gIGdyaWQ6IGFueTtcclxuXHJcbiAgLyoqIEdyaWQgb3B0aW9ucyAqL1xyXG4gIGdyaWRPcHRpb25zOiBHcmlkT3B0aW9uO1xyXG5cclxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIGFyZ3M6IEVkaXRvckFyZ3VtZW50cykge1xyXG4gICAgaWYgKCFhcmdzKSB7XHJcbiAgICAgIHRocm93IG5ldyBFcnJvcignW0FuZ3VsYXItU2xpY2tHcmlkXSBTb21ldGhpbmcgaXMgd3Jvbmcgd2l0aCB0aGlzIGdyaWQsIGFuIEVkaXRvciBtdXN0IGFsd2F5cyBoYXZlIHZhbGlkIGFyZ3VtZW50cy4nKTtcclxuICAgIH1cclxuICAgIHRoaXMuZ3JpZCA9IGFyZ3MuZ3JpZDtcclxuICAgIHRoaXMuZ3JpZE9wdGlvbnMgPSAoYXJncy5ncmlkICYmIGFyZ3MuZ3JpZC5nZXRPcHRpb25zKCkgfHwge30pIGFzIEdyaWRPcHRpb247XHJcbiAgICBjb25zdCBvcHRpb25zID0gdGhpcy5ncmlkT3B0aW9ucyB8fCB0aGlzLmFyZ3MuY29sdW1uLnBhcmFtcyB8fCB7fTtcclxuICAgIGlmIChvcHRpb25zICYmIG9wdGlvbnMuaTE4biBpbnN0YW5jZW9mIFRyYW5zbGF0ZVNlcnZpY2UpIHtcclxuICAgICAgdGhpcy5fdHJhbnNsYXRlID0gb3B0aW9ucy5pMThuO1xyXG4gICAgfVxyXG5cclxuICAgIHRoaXMuaW5pdCgpO1xyXG4gIH1cclxuXHJcbiAgLyoqIEdldCBDb2x1bW4gRGVmaW5pdGlvbiBvYmplY3QgKi9cclxuICBnZXQgY29sdW1uRGVmKCk6IENvbHVtbiB8IHVuZGVmaW5lZCB7XHJcbiAgICByZXR1cm4gdGhpcy5hcmdzICYmIHRoaXMuYXJncy5jb2x1bW47XHJcbiAgfVxyXG5cclxuICAvKiogR2V0IENvbHVtbiBFZGl0b3Igb2JqZWN0ICovXHJcbiAgZ2V0IGNvbHVtbkVkaXRvcigpOiBDb2x1bW5FZGl0b3Ige1xyXG4gICAgcmV0dXJuIHRoaXMuY29sdW1uRGVmICYmIHRoaXMuY29sdW1uRGVmLmludGVybmFsQ29sdW1uRWRpdG9yIHx8IHt9O1xyXG4gIH1cclxuXHJcbiAgLyoqIEdldCB0aGUgRWRpdG9yIERPTSBFbGVtZW50ICovXHJcbiAgZ2V0IGVkaXRvckRvbUVsZW1lbnQoKTogYW55IHtcclxuICAgIHJldHVybiB0aGlzLl8kaW5wdXQ7XHJcbiAgfVxyXG5cclxuICAvKiogR2V0IEZsYXRwaWNrciBvcHRpb25zIHBhc3NlZCB0byB0aGUgZWRpdG9yIGJ5IHRoZSB1c2VyICovXHJcbiAgZ2V0IGVkaXRvck9wdGlvbnMoKTogRmxhdHBpY2tyT3B0aW9uIHtcclxuICAgIHJldHVybiB0aGlzLmNvbHVtbkVkaXRvci5lZGl0b3JPcHRpb25zIHx8IHt9O1xyXG4gIH1cclxuXHJcbiAgZ2V0IGhhc0F1dG9Db21taXRFZGl0KCkge1xyXG4gICAgcmV0dXJuIHRoaXMuZ3JpZC5nZXRPcHRpb25zKCkuYXV0b0NvbW1pdEVkaXQ7XHJcbiAgfVxyXG5cclxuICBnZXQgcGlja2VyT3B0aW9ucygpOiBGbGF0cGlja3JPcHRpb24ge1xyXG4gICAgcmV0dXJuIHRoaXMuX3BpY2tlck1lcmdlZE9wdGlvbnM7XHJcbiAgfVxyXG5cclxuICAvKiogR2V0IHRoZSBWYWxpZGF0b3IgZnVuY3Rpb24sIGNhbiBiZSBwYXNzZWQgaW4gRWRpdG9yIHByb3BlcnR5IG9yIENvbHVtbiBEZWZpbml0aW9uICovXHJcbiAgZ2V0IHZhbGlkYXRvcigpOiBFZGl0b3JWYWxpZGF0b3Ige1xyXG4gICAgcmV0dXJuIHRoaXMuY29sdW1uRWRpdG9yLnZhbGlkYXRvciB8fCB0aGlzLmNvbHVtbkRlZi52YWxpZGF0b3I7XHJcbiAgfVxyXG5cclxuICBpbml0KCk6IHZvaWQge1xyXG4gICAgaWYgKHRoaXMuYXJncyAmJiB0aGlzLmNvbHVtbkRlZikge1xyXG4gICAgICBjb25zdCBjb2x1bW5JZCA9IHRoaXMuY29sdW1uRGVmICYmIHRoaXMuY29sdW1uRGVmLmlkO1xyXG4gICAgICBjb25zdCBwbGFjZWhvbGRlciA9IHRoaXMuY29sdW1uRWRpdG9yICYmIHRoaXMuY29sdW1uRWRpdG9yLnBsYWNlaG9sZGVyIHx8ICcnO1xyXG4gICAgICBjb25zdCB0aXRsZSA9IHRoaXMuY29sdW1uRWRpdG9yICYmIHRoaXMuY29sdW1uRWRpdG9yLnRpdGxlIHx8ICcnO1xyXG4gICAgICB0aGlzLmRlZmF1bHREYXRlID0gKHRoaXMuYXJncy5pdGVtKSA/IHRoaXMuYXJncy5pdGVtW3RoaXMuY29sdW1uRGVmLmZpZWxkXSA6IG51bGw7XHJcbiAgICAgIGNvbnN0IGlucHV0Rm9ybWF0ID0gbWFwRmxhdHBpY2tyRGF0ZUZvcm1hdFdpdGhGaWVsZFR5cGUodGhpcy5jb2x1bW5FZGl0b3IudHlwZSB8fCB0aGlzLmNvbHVtbkRlZi50eXBlIHx8IEZpZWxkVHlwZS5kYXRlVXRjKTtcclxuICAgICAgY29uc3Qgb3V0cHV0Rm9ybWF0ID0gbWFwRmxhdHBpY2tyRGF0ZUZvcm1hdFdpdGhGaWVsZFR5cGUodGhpcy5jb2x1bW5EZWYub3V0cHV0VHlwZSB8fCB0aGlzLmNvbHVtbkVkaXRvci50eXBlIHx8IHRoaXMuY29sdW1uRGVmLnR5cGUgfHwgRmllbGRUeXBlLmRhdGVVdGMpO1xyXG4gICAgICBsZXQgY3VycmVudExvY2FsZSA9IHRoaXMuX3RyYW5zbGF0ZSAmJiB0aGlzLl90cmFuc2xhdGUuY3VycmVudExhbmcgfHwgdGhpcy5ncmlkT3B0aW9ucy5sb2NhbGUgfHwgJ2VuJztcclxuICAgICAgaWYgKGN1cnJlbnRMb2NhbGUgJiYgY3VycmVudExvY2FsZS5sZW5ndGggPiAyKSB7XHJcbiAgICAgICAgY3VycmVudExvY2FsZSA9IGN1cnJlbnRMb2NhbGUuc3Vic3RyaW5nKDAsIDIpO1xyXG4gICAgICB9XHJcblxyXG4gICAgICBjb25zdCBwaWNrZXJPcHRpb25zOiBGbGF0cGlja3JPcHRpb24gPSB7XHJcbiAgICAgICAgZGVmYXVsdERhdGU6IHRoaXMuZGVmYXVsdERhdGUgYXMgc3RyaW5nLFxyXG4gICAgICAgIGFsdElucHV0OiB0cnVlLFxyXG4gICAgICAgIGFsdEZvcm1hdDogb3V0cHV0Rm9ybWF0LFxyXG4gICAgICAgIGRhdGVGb3JtYXQ6IGlucHV0Rm9ybWF0LFxyXG4gICAgICAgIGNsb3NlT25TZWxlY3Q6IHRydWUsXHJcbiAgICAgICAgd3JhcDogdHJ1ZSxcclxuICAgICAgICBsb2NhbGU6IChjdXJyZW50TG9jYWxlICE9PSAnZW4nKSA/IHRoaXMubG9hZEZsYXRwaWNrckxvY2FsZShjdXJyZW50TG9jYWxlKSA6ICdlbicsXHJcbiAgICAgICAgb25DaGFuZ2U6ICgpID0+IHRoaXMuc2F2ZSgpLFxyXG4gICAgICAgIGVycm9ySGFuZGxlcjogKCkgPT4ge1xyXG4gICAgICAgICAgLy8gZG8gbm90aGluZywgRmxhdHBpY2tyIGlzIGEgbGl0dGxlIHRvbyBzZW5zaXRpdmUgYW5kIHdpbGwgdGhyb3cgYW4gZXJyb3Igd2hlbiBwcm92aWRlZCBkYXRlIGlzIGxvd2VyIHRoYW4gbWluRGF0ZSBzbyBqdXN0IGRpc3JlZ2FyZCB0aGUgZXJyb3IgY29tcGxldGVseVxyXG4gICAgICAgIH1cclxuICAgICAgfTtcclxuXHJcbiAgICAgIC8vIG1lcmdlIG9wdGlvbnMgd2l0aCBvcHRpb25hbCB1c2VyJ3MgY3VzdG9tIG9wdGlvbnNcclxuICAgICAgdGhpcy5fcGlja2VyTWVyZ2VkT3B0aW9ucyA9IHsgLi4ucGlja2VyT3B0aW9ucywgLi4uKHRoaXMuZWRpdG9yT3B0aW9ucyBhcyBGbGF0cGlja3JPcHRpb24pIH07XHJcbiAgICAgIGNvbnN0IGlucHV0Q3NzQ2xhc3NlcyA9IGAuZWRpdG9yLXRleHQuZWRpdG9yLSR7Y29sdW1uSWR9LmZvcm0tY29udHJvbGA7XHJcbiAgICAgIGlmICh0aGlzLl9waWNrZXJNZXJnZWRPcHRpb25zLmFsdElucHV0KSB7XHJcbiAgICAgICAgdGhpcy5fcGlja2VyTWVyZ2VkT3B0aW9ucy5hbHRJbnB1dENsYXNzID0gJ2ZsYXRwaWNrci1hbHQtaW5wdXQgZm9ybS1jb250cm9sJztcclxuICAgICAgfVxyXG5cclxuICAgICAgdGhpcy5fJGVkaXRvcklucHV0RWxtID0gJChgPGRpdiBjbGFzcz1cImZsYXRwaWNrciBpbnB1dC1ncm91cFwiPjwvZGl2PmApO1xyXG4gICAgICBjb25zdCBjbG9zZUJ1dHRvbkVsbSA9ICQoYDxzcGFuIGNsYXNzPVwiaW5wdXQtZ3JvdXAtYnRuXCIgZGF0YS1jbGVhcj5cclxuICAgICAgICAgIDxidXR0b24gY2xhc3M9XCJidG4gYnRuLWRlZmF1bHQgaWNvbi1jbG9zZVwiIHR5cGU9XCJidXR0b25cIj48L2J1dHRvbj5cclxuICAgICAgICA8L3NwYW4+YCk7XHJcbiAgICAgIHRoaXMuXyRpbnB1dCA9ICQoYDxpbnB1dCB0eXBlPVwidGV4dFwiIGRhdGEtaW5wdXQgZGF0YS1kZWZhdWx0RGF0ZT1cIiR7dGhpcy5kZWZhdWx0RGF0ZX1cIiBjbGFzcz1cIiR7aW5wdXRDc3NDbGFzc2VzLnJlcGxhY2UoL1xcLi9nLCAnICcpfVwiIHBsYWNlaG9sZGVyPVwiJHtwbGFjZWhvbGRlcn1cIiB0aXRsZT1cIiR7dGl0bGV9XCIgLz5gKTtcclxuICAgICAgdGhpcy5fJGlucHV0LmFwcGVuZFRvKHRoaXMuXyRlZGl0b3JJbnB1dEVsbSk7XHJcblxyXG4gICAgICAvLyBzaG93IGNsZWFyIGRhdGUgYnV0dG9uICh1bmxlc3MgdXNlciBzcGVjaWZpY2FsbHkgZG9lc24ndCB3YW50IGl0KVxyXG4gICAgICBjb25zdCBpc0Nsb3NlQnV0dG9uSGlkZGVuID0gdGhpcy5jb2x1bW5FZGl0b3IgJiYgdGhpcy5jb2x1bW5FZGl0b3IucGFyYW1zICYmIHRoaXMuY29sdW1uRWRpdG9yLnBhcmFtcy5oaWRlQ2xlYXJCdXR0b24gfHwgZmFsc2U7XHJcbiAgICAgIGlmICghaXNDbG9zZUJ1dHRvbkhpZGRlbikge1xyXG4gICAgICAgIGNsb3NlQnV0dG9uRWxtLmFwcGVuZFRvKHRoaXMuXyRlZGl0b3JJbnB1dEVsbSk7XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIHRoaXMuXyRlZGl0b3JJbnB1dEVsbS5hcHBlbmRUbyh0aGlzLmFyZ3MuY29udGFpbmVyKTtcclxuICAgICAgdGhpcy5mbGF0SW5zdGFuY2UgPSAoZmxhdHBpY2tyICYmIHRoaXMuXyRlZGl0b3JJbnB1dEVsbVswXSAmJiB0eXBlb2YgdGhpcy5fJGVkaXRvcklucHV0RWxtWzBdLmZsYXRwaWNrciA9PT0gJ2Z1bmN0aW9uJykgPyB0aGlzLl8kZWRpdG9ySW5wdXRFbG1bMF0uZmxhdHBpY2tyKHRoaXMuX3BpY2tlck1lcmdlZE9wdGlvbnMpIDogZmxhdHBpY2tyKHRoaXMuXyRlZGl0b3JJbnB1dEVsbSwgdGhpcy5fcGlja2VyTWVyZ2VkT3B0aW9ucyBhcyB1bmtub3duIGFzIFBhcnRpYWw8RmxhdHBpY2tyQmFzZU9wdGlvbnM+KTtcclxuXHJcbiAgICAgIC8vIHdoZW4gd2UncmUgdXNpbmcgYW4gYWx0ZXJuYXRlIGlucHV0IHRvIGRpc3BsYXkgZGF0YSwgd2UnbGwgY29uc2lkZXIgdGhpcyBpbnB1dCBhcyB0aGUgb25lIHRvIGRvIHRoZSBmb2N1cyBsYXRlciBvblxyXG4gICAgICAvLyBlbHNlIGp1c3QgdXNlIHRoZSB0b3Agb25lXHJcbiAgICAgIHRoaXMuXyRpbnB1dFdpdGhEYXRhID0gKHRoaXMuX3BpY2tlck1lcmdlZE9wdGlvbnMgJiYgdGhpcy5fcGlja2VyTWVyZ2VkT3B0aW9ucy5hbHRJbnB1dCkgPyAkKGAke2lucHV0Q3NzQ2xhc3Nlc30uZmxhdHBpY2tyLWFsdC1pbnB1dGApIDogdGhpcy5fJGlucHV0O1xyXG5cclxuICAgICAgc2V0VGltZW91dCgoKSA9PiB7XHJcbiAgICAgICAgdGhpcy5zaG93KCk7XHJcbiAgICAgICAgdGhpcy5mb2N1cygpO1xyXG4gICAgICB9LCA1MCk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBkZXN0cm95KCkge1xyXG4gICAgdGhpcy5oaWRlKCk7XHJcbiAgICBpZiAodGhpcy5mbGF0SW5zdGFuY2UgJiYgdHlwZW9mIHRoaXMuZmxhdEluc3RhbmNlLmRlc3Ryb3kgPT09ICdmdW5jdGlvbicpIHtcclxuICAgICAgdGhpcy5mbGF0SW5zdGFuY2UuZGVzdHJveSgpO1xyXG4gICAgICBpZiAodGhpcy5mbGF0SW5zdGFuY2UuZWxlbWVudCkge1xyXG4gICAgICAgIHNldFRpbWVvdXQoKCkgPT4gZGVzdHJveU9iamVjdERvbUVsZW1lbnRQcm9wcyh0aGlzLmZsYXRJbnN0YW5jZSkpO1xyXG4gICAgICB9XHJcbiAgICAgIHRoaXMuZmxhdEluc3RhbmNlID0gbnVsbDtcclxuICAgIH1cclxuICAgIGlmICh0aGlzLl8kZWRpdG9ySW5wdXRFbG0pIHtcclxuICAgICAgdGhpcy5fJGVkaXRvcklucHV0RWxtLnJlbW92ZSgpO1xyXG4gICAgICB0aGlzLl8kZWRpdG9ySW5wdXRFbG0gPSBudWxsO1xyXG4gICAgfVxyXG4gICAgaWYgKHRoaXMuXyRpbnB1dFdpdGhEYXRhKSB7XHJcbiAgICAgIHRoaXMuXyRpbnB1dFdpdGhEYXRhLnJlbW92ZSgpO1xyXG4gICAgICB0aGlzLl8kaW5wdXRXaXRoRGF0YSA9IG51bGw7XHJcbiAgICB9XHJcbiAgICB0aGlzLl8kaW5wdXQucmVtb3ZlKCk7XHJcbiAgfVxyXG5cclxuICBmb2N1cygpIHtcclxuICAgIHRoaXMuXyRpbnB1dC5mb2N1cygpO1xyXG4gICAgaWYgKHRoaXMuXyRpbnB1dFdpdGhEYXRhICYmIHR5cGVvZiB0aGlzLl8kaW5wdXRXaXRoRGF0YS5mb2N1cyA9PT0gJ2Z1bmN0aW9uJykge1xyXG4gICAgICB0aGlzLl8kaW5wdXRXaXRoRGF0YS5mb2N1cygpLnNlbGVjdCgpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgaGlkZSgpIHtcclxuICAgIGlmICh0aGlzLmZsYXRJbnN0YW5jZSAmJiB0eXBlb2YgdGhpcy5mbGF0SW5zdGFuY2UuY2xvc2UgPT09ICdmdW5jdGlvbicpIHtcclxuICAgICAgdGhpcy5mbGF0SW5zdGFuY2UuY2xvc2UoKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHNob3coKSB7XHJcbiAgICBpZiAodGhpcy5mbGF0SW5zdGFuY2UgJiYgdHlwZW9mIHRoaXMuZmxhdEluc3RhbmNlLm9wZW4gPT09ICdmdW5jdGlvbicgJiYgdGhpcy5mbGF0SW5zdGFuY2UuX2lucHV0KSB7XHJcbiAgICAgIHRoaXMuZmxhdEluc3RhbmNlLm9wZW4oKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIGdldFZhbHVlKCk6IHN0cmluZyB7XHJcbiAgICByZXR1cm4gdGhpcy5fJGlucHV0LnZhbCgpO1xyXG4gIH1cclxuXHJcbiAgc2V0VmFsdWUodmFsOiBzdHJpbmcpIHtcclxuICAgIHRoaXMuZmxhdEluc3RhbmNlLnNldERhdGUodmFsKTtcclxuICB9XHJcblxyXG4gIGFwcGx5VmFsdWUoaXRlbTogYW55LCBzdGF0ZTogYW55KSB7XHJcbiAgICBjb25zdCBmaWVsZE5hbWUgPSB0aGlzLmNvbHVtbkRlZiAmJiB0aGlzLmNvbHVtbkRlZi5maWVsZDtcclxuICAgIGlmIChmaWVsZE5hbWUgIT09IHVuZGVmaW5lZCkge1xyXG4gICAgICBjb25zdCBvdXRwdXRUeXBlRm9ybWF0ID0gbWFwTW9tZW50RGF0ZUZvcm1hdFdpdGhGaWVsZFR5cGUoKHRoaXMuY29sdW1uRGVmICYmICh0aGlzLmNvbHVtbkRlZi5vdXRwdXRUeXBlIHx8IHRoaXMuY29sdW1uRWRpdG9yLnR5cGUgfHwgdGhpcy5jb2x1bW5EZWYudHlwZSkpIHx8IEZpZWxkVHlwZS5kYXRlVXRjKTtcclxuICAgICAgY29uc3Qgc2F2ZVR5cGVGb3JtYXQgPSBtYXBNb21lbnREYXRlRm9ybWF0V2l0aEZpZWxkVHlwZSgodGhpcy5jb2x1bW5EZWYgJiYgKHRoaXMuY29sdW1uRGVmLnNhdmVPdXRwdXRUeXBlIHx8IHRoaXMuY29sdW1uRGVmLm91dHB1dFR5cGUgfHwgdGhpcy5jb2x1bW5FZGl0b3IudHlwZSB8fCB0aGlzLmNvbHVtbkRlZi50eXBlKSkgfHwgRmllbGRUeXBlLmRhdGVVdGMpO1xyXG4gICAgICBjb25zdCBpc0NvbXBsZXhPYmplY3QgPSBmaWVsZE5hbWUgJiYgZmllbGROYW1lLmluZGV4T2YoJy4nKSA+IDA7IC8vIGlzIHRoZSBmaWVsZCBhIGNvbXBsZXggb2JqZWN0LCBcImFkZHJlc3Muc3RyZWV0TnVtYmVyXCJcclxuXHJcbiAgICAgIC8vIHZhbGlkYXRlIHRoZSB2YWx1ZSBiZWZvcmUgYXBwbHlpbmcgaXQgKGlmIG5vdCB2YWxpZCB3ZSdsbCBzZXQgYW4gZW1wdHkgc3RyaW5nKVxyXG4gICAgICBjb25zdCB2YWxpZGF0aW9uID0gdGhpcy52YWxpZGF0ZShzdGF0ZSk7XHJcbiAgICAgIGNvbnN0IG5ld1ZhbHVlID0gKHN0YXRlICYmIHZhbGlkYXRpb24gJiYgdmFsaWRhdGlvbi52YWxpZCkgPyBtb21lbnQoc3RhdGUsIG91dHB1dFR5cGVGb3JtYXQpLmZvcm1hdChzYXZlVHlwZUZvcm1hdCkgOiAnJztcclxuXHJcbiAgICAgIC8vIHNldCB0aGUgbmV3IHZhbHVlIHRvIHRoZSBpdGVtIGRhdGFjb250ZXh0XHJcbiAgICAgIGlmIChpc0NvbXBsZXhPYmplY3QpIHtcclxuICAgICAgICBzZXREZWVwVmFsdWUoaXRlbSwgZmllbGROYW1lLCBuZXdWYWx1ZSk7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgaXRlbVtmaWVsZE5hbWVdID0gbmV3VmFsdWU7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICB9XHJcblxyXG4gIGlzVmFsdWVDaGFuZ2VkKCk6IGJvb2xlYW4ge1xyXG4gICAgY29uc3QgZWxtVmFsdWUgPSB0aGlzLl8kaW5wdXQudmFsKCk7XHJcbiAgICBjb25zdCBpbnB1dEZvcm1hdCA9IG1hcE1vbWVudERhdGVGb3JtYXRXaXRoRmllbGRUeXBlKHRoaXMuY29sdW1uRWRpdG9yLnR5cGUgfHwgKHRoaXMuY29sdW1uRGVmICYmIHRoaXMuY29sdW1uRGVmLnR5cGUpIHx8IEZpZWxkVHlwZS5kYXRlSXNvKTtcclxuICAgIGNvbnN0IG91dHB1dFR5cGVGb3JtYXQgPSBtYXBNb21lbnREYXRlRm9ybWF0V2l0aEZpZWxkVHlwZSgodGhpcy5jb2x1bW5EZWYgJiYgKHRoaXMuY29sdW1uRGVmLm91dHB1dFR5cGUgfHwgdGhpcy5jb2x1bW5FZGl0b3IudHlwZSB8fCB0aGlzLmNvbHVtbkRlZi50eXBlKSkgfHwgRmllbGRUeXBlLmRhdGVVdGMpO1xyXG4gICAgY29uc3QgZWxtRGF0ZVN0ciA9IGVsbVZhbHVlID8gbW9tZW50KGVsbVZhbHVlLCBpbnB1dEZvcm1hdCwgZmFsc2UpLmZvcm1hdChvdXRwdXRUeXBlRm9ybWF0KSA6ICcnO1xyXG4gICAgY29uc3Qgb3JnRGF0ZVN0ciA9IHRoaXMuX29yaWdpbmFsRGF0ZSA/IG1vbWVudCh0aGlzLl9vcmlnaW5hbERhdGUsIGlucHV0Rm9ybWF0LCBmYWxzZSkuZm9ybWF0KG91dHB1dFR5cGVGb3JtYXQpIDogJyc7XHJcbiAgICBpZiAoZWxtRGF0ZVN0ciA9PT0gJ0ludmFsaWQgZGF0ZScgfHwgb3JnRGF0ZVN0ciA9PT0gJ0ludmFsaWQgZGF0ZScpIHtcclxuICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IGlzQ2hhbmdlZCA9ICghKGVsbURhdGVTdHIgPT09ICcnICYmIG9yZ0RhdGVTdHIgPT09ICcnKSkgJiYgKGVsbURhdGVTdHIgIT09IG9yZ0RhdGVTdHIpO1xyXG4gICAgcmV0dXJuIGlzQ2hhbmdlZDtcclxuICB9XHJcblxyXG4gIGxvYWRWYWx1ZShpdGVtOiBhbnkpIHtcclxuICAgIGNvbnN0IGZpZWxkTmFtZSA9IHRoaXMuY29sdW1uRGVmICYmIHRoaXMuY29sdW1uRGVmLmZpZWxkO1xyXG5cclxuICAgIGlmIChpdGVtICYmIGZpZWxkTmFtZSAhPT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgIC8vIGlzIHRoZSBmaWVsZCBhIGNvbXBsZXggb2JqZWN0LCBcImFkZHJlc3Muc3RyZWV0TnVtYmVyXCJcclxuICAgICAgY29uc3QgaXNDb21wbGV4T2JqZWN0ID0gZmllbGROYW1lICYmIGZpZWxkTmFtZS5pbmRleE9mKCcuJykgPiAwO1xyXG4gICAgICBjb25zdCB2YWx1ZSA9IChpc0NvbXBsZXhPYmplY3QpID8gZ2V0RGVzY2VuZGFudFByb3BlcnR5KGl0ZW0sIGZpZWxkTmFtZSkgOiBpdGVtW2ZpZWxkTmFtZV07XHJcblxyXG4gICAgICB0aGlzLl9vcmlnaW5hbERhdGUgPSB2YWx1ZTtcclxuICAgICAgdGhpcy5mbGF0SW5zdGFuY2Uuc2V0RGF0ZSh2YWx1ZSk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBzYXZlKCkge1xyXG4gICAgY29uc3QgdmFsaWRhdGlvbiA9IHRoaXMudmFsaWRhdGUoKTtcclxuICAgIGNvbnN0IGlzVmFsaWQgPSAodmFsaWRhdGlvbiAmJiB2YWxpZGF0aW9uLnZhbGlkKSB8fCBmYWxzZTtcclxuXHJcbiAgICBpZiAodGhpcy5oYXNBdXRvQ29tbWl0RWRpdCAmJiBpc1ZhbGlkKSB7XHJcbiAgICAgIC8vIGRvIG5vdCB1c2UgYXJncy5jb21taXRDaGFuZ2VzKCkgYXMgdGhpcyBzZXRzIHRoZSBmb2N1cyB0byB0aGUgbmV4dCByb3cuXHJcbiAgICAgIC8vIGFsc28gdGhlIHNlbGVjdCBsaXN0IHdpbGwgc3RheSBzaG93biB3aGVuIGNsaWNraW5nIG9mZiB0aGUgZ3JpZFxyXG4gICAgICB0aGlzLmdyaWQuZ2V0RWRpdG9yTG9jaygpLmNvbW1pdEN1cnJlbnRFZGl0KCk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICB0aGlzLmFyZ3MuY29tbWl0Q2hhbmdlcygpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgc2VyaWFsaXplVmFsdWUoKSB7XHJcbiAgICBjb25zdCBkb21WYWx1ZTogc3RyaW5nID0gdGhpcy5fJGlucHV0LnZhbCgpO1xyXG5cclxuICAgIGlmICghZG9tVmFsdWUpIHtcclxuICAgICAgcmV0dXJuICcnO1xyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IGlucHV0Rm9ybWF0ID0gbWFwTW9tZW50RGF0ZUZvcm1hdFdpdGhGaWVsZFR5cGUodGhpcy5jb2x1bW5FZGl0b3IudHlwZSB8fCAodGhpcy5jb2x1bW5EZWYgJiYgdGhpcy5jb2x1bW5EZWYudHlwZSkgfHwgRmllbGRUeXBlLmRhdGVJc28pO1xyXG4gICAgY29uc3Qgb3V0cHV0VHlwZUZvcm1hdCA9IG1hcE1vbWVudERhdGVGb3JtYXRXaXRoRmllbGRUeXBlKCh0aGlzLmNvbHVtbkRlZiAmJiAodGhpcy5jb2x1bW5EZWYub3V0cHV0VHlwZSB8fCB0aGlzLmNvbHVtbkVkaXRvci50eXBlIHx8IHRoaXMuY29sdW1uRGVmLnR5cGUpKSB8fCBGaWVsZFR5cGUuZGF0ZUlzbyk7XHJcbiAgICBjb25zdCB2YWx1ZSA9IG1vbWVudChkb21WYWx1ZSwgaW5wdXRGb3JtYXQsIGZhbHNlKS5mb3JtYXQob3V0cHV0VHlwZUZvcm1hdCk7XHJcblxyXG4gICAgcmV0dXJuIHZhbHVlO1xyXG4gIH1cclxuXHJcbiAgdmFsaWRhdGUoaW5wdXRWYWx1ZT86IGFueSk6IEVkaXRvclZhbGlkYXRvck91dHB1dCB7XHJcbiAgICBjb25zdCBpc1JlcXVpcmVkID0gdGhpcy5jb2x1bW5FZGl0b3IucmVxdWlyZWQ7XHJcbiAgICBjb25zdCBlbG1WYWx1ZSA9IChpbnB1dFZhbHVlICE9PSB1bmRlZmluZWQpID8gaW5wdXRWYWx1ZSA6IHRoaXMuXyRpbnB1dCAmJiB0aGlzLl8kaW5wdXQudmFsICYmIHRoaXMuXyRpbnB1dC52YWwoKTtcclxuICAgIGNvbnN0IGVycm9yTXNnID0gdGhpcy5jb2x1bW5FZGl0b3IuZXJyb3JNZXNzYWdlO1xyXG5cclxuICAgIGlmICh0aGlzLnZhbGlkYXRvcikge1xyXG4gICAgICByZXR1cm4gdGhpcy52YWxpZGF0b3IoZWxtVmFsdWUsIHRoaXMuYXJncyk7XHJcbiAgICB9XHJcblxyXG4gICAgLy8gYnkgZGVmYXVsdCB0aGUgZWRpdG9yIGlzIGFsbW9zdCBhbHdheXMgdmFsaWQgKGV4Y2VwdCB3aGVuIGl0J3MgcmVxdWlyZWQgYnV0IG5vdCBwcm92aWRlZClcclxuICAgIGlmIChpc1JlcXVpcmVkICYmIGVsbVZhbHVlID09PSAnJykge1xyXG4gICAgICByZXR1cm4ge1xyXG4gICAgICAgIHZhbGlkOiBmYWxzZSxcclxuICAgICAgICBtc2c6IGVycm9yTXNnIHx8IENvbnN0YW50cy5WQUxJREFUSU9OX1JFUVVJUkVEX0ZJRUxEXHJcbiAgICAgIH07XHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIHtcclxuICAgICAgdmFsaWQ6IHRydWUsXHJcbiAgICAgIG1zZzogbnVsbFxyXG4gICAgfTtcclxuICB9XHJcblxyXG4gIC8vXHJcbiAgLy8gcHJpdmF0ZSBmdW5jdGlvbnNcclxuICAvLyAtLS0tLS0tLS0tLS0tLS0tLS1cclxuXHJcbiAgLyoqIExvYWQgYSBkaWZmZXJlbnQgc2V0IG9mIGxvY2FsZXMgZm9yIEZsYXRwaWNrciB0byBiZSBsb2NhbGl6ZWQgKi9cclxuICBwcml2YXRlIGxvYWRGbGF0cGlja3JMb2NhbGUobGFuZ3VhZ2U6IHN0cmluZykge1xyXG4gICAgbGV0IGxvY2FsZXMgPSAnZW4nO1xyXG5cclxuICAgIGlmIChsYW5ndWFnZSAhPT0gJ2VuJykge1xyXG4gICAgICAvLyBjaGFuZ2UgbG9jYWxlIGlmIG5lZWRlZCwgRmxhdHBpY2tyIHJlZmVyZW5jZTogaHR0cHM6Ly9jaG1sbi5naXRodWIuaW8vZmxhdHBpY2tyL2xvY2FsaXphdGlvbi9cclxuICAgICAgY29uc3QgbG9jYWxlRGVmYXVsdDogYW55ID0gcmVxdWlyZShgZmxhdHBpY2tyL2Rpc3QvbDEwbi8ke2xhbmd1YWdlfS5qc2ApLmRlZmF1bHQ7XHJcbiAgICAgIGxvY2FsZXMgPSAobG9jYWxlRGVmYXVsdCAmJiBsb2NhbGVEZWZhdWx0W2xhbmd1YWdlXSkgPyBsb2NhbGVEZWZhdWx0W2xhbmd1YWdlXSA6ICdlbic7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gbG9jYWxlcztcclxuICB9XHJcbn1cclxuIl19