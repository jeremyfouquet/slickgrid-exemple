import { TranslateService } from '@ngx-translate/core';
import { Constants } from './../constants';
import { KeyCode, } from './../models/index';
import { getDescendantProperty, getHtmlElementOffset, getTranslationPrefix, setDeepValue } from '../services/utilities';
import { textValidator } from '../editorValidators/textValidator';
var DEFAULT_MAX_LENGTH = 500;
/*
 * An example of a 'detached' editor.
 * The UI is added onto document BODY and .position(), .show() and .hide() are implemented.
 * KeyDown events are also handled to provide handling for Tab, Shift-Tab, Esc and Ctrl-Enter.
 */
var LongTextEditor = /** @class */ (function () {
    function LongTextEditor(args) {
        this.args = args;
        if (!args) {
            throw new Error('[Angular-SlickGrid] Something is wrong with this grid, an Editor must always have valid arguments.');
        }
        this.grid = args.grid;
        this.gridOptions = args.grid && args.grid.getOptions();
        var options = this.gridOptions || this.args.column.params || {};
        if (options && options.i18n instanceof TranslateService) {
            this._translate = options.i18n;
        }
        // get locales provided by user in forRoot or else use default English locales via the Constants
        this._locales = this.gridOptions && this.gridOptions.locales || Constants.locales;
        this.init();
    }
    Object.defineProperty(LongTextEditor.prototype, "columnDef", {
        /** Get Column Definition object */
        get: function () {
            return this.args && this.args.column;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(LongTextEditor.prototype, "columnEditor", {
        /** Get Column Editor object */
        get: function () {
            return this.columnDef && this.columnDef.internalColumnEditor || {};
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(LongTextEditor.prototype, "editorDomElement", {
        /** Get the Editor DOM Element */
        get: function () {
            return this._$textarea;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(LongTextEditor.prototype, "hasAutoCommitEdit", {
        get: function () {
            return this.grid.getOptions().autoCommitEdit;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(LongTextEditor.prototype, "validator", {
        /** Get the Validator function, can be passed in Editor property or Column Definition */
        get: function () {
            return (this.columnEditor && this.columnEditor.validator) || (this.columnDef && this.columnDef.validator);
        },
        enumerable: true,
        configurable: true
    });
    LongTextEditor.prototype.init = function () {
        var _this = this;
        var cancelText = '';
        var saveText = '';
        if (this._translate && this._translate.instant && this._translate.currentLang) {
            var translationPrefix = getTranslationPrefix(this.gridOptions);
            cancelText = this._translate.instant(translationPrefix + "CANCEL");
            saveText = this._translate.instant(translationPrefix + "SAVE");
        }
        else {
            cancelText = this._locales && this._locales.TEXT_CANCEL;
            saveText = this._locales && this._locales.TEXT_SAVE;
        }
        var columnId = this.columnDef && this.columnDef.id;
        var placeholder = this.columnEditor && this.columnEditor.placeholder || '';
        var title = this.columnEditor && this.columnEditor.title || '';
        var maxLength = this.columnEditor && this.columnEditor.maxLength || DEFAULT_MAX_LENGTH;
        var textAreaRows = this.columnEditor && this.columnEditor.params && this.columnEditor.params.textAreaRows || 6;
        var $container = $('body');
        this._$wrapper = $("<div class=\"slick-large-editor-text editor-" + columnId + "\" />").appendTo($container);
        this._$textarea = $("<textarea hidefocus rows=\"" + textAreaRows + "\" placeholder=\"" + placeholder + "\" title=\"" + title + "\">").appendTo(this._$wrapper);
        var editorFooterElm = $("<div class=\"editor-footer\"/>");
        var countContainerElm = $("<span class=\"counter\"/>");
        this._$currentLengthElm = $("<span class=\"text-length\">0</span>");
        var textMaxLengthElm = $("<span>/</span><span class=\"max-length\">" + maxLength + "</span>");
        this._$currentLengthElm.appendTo(countContainerElm);
        textMaxLengthElm.appendTo(countContainerElm);
        var cancelBtnElm = $("<button class=\"btn btn-cancel btn-default btn-xs\">" + cancelText + "</button>");
        var saveBtnElm = $("<button class=\"btn btn-save btn-primary btn-xs\">" + saveText + "</button>");
        countContainerElm.appendTo(editorFooterElm);
        cancelBtnElm.appendTo(editorFooterElm);
        saveBtnElm.appendTo(editorFooterElm);
        editorFooterElm.appendTo(this._$wrapper);
        this._$wrapper.find('.btn-save').on('click', function () { return _this.save(); });
        this._$wrapper.find('.btn-cancel').on('click', function () { return _this.cancel(); });
        this._$textarea.on('keydown', this.handleKeyDown.bind(this));
        this._$textarea.on('input', this.handleOnInputChange.bind(this));
        this.position(this.args && this.args.position);
        this._$textarea.focus().select();
    };
    LongTextEditor.prototype.cancel = function () {
        var value = this.defaultValue || '';
        this._$textarea.val(value);
        this._$currentLengthElm.text(value.length);
        if (this.args && this.args.cancelChanges) {
            this.args.cancelChanges();
        }
    };
    LongTextEditor.prototype.hide = function () {
        this._$wrapper.hide();
    };
    LongTextEditor.prototype.show = function () {
        this._$wrapper.show();
    };
    LongTextEditor.prototype.destroy = function () {
        if (this._$textarea) {
            this._$textarea.off('keydown');
            this._$textarea.off('input');
        }
        if (this._$wrapper) {
            this._$wrapper.find('.btn-save').off('click');
            this._$wrapper.find('.btn-cancel').off('click');
            this._$wrapper.remove();
        }
        this._$wrapper = null;
    };
    LongTextEditor.prototype.focus = function () {
        this._$textarea.focus();
    };
    LongTextEditor.prototype.getValue = function () {
        return this._$textarea.val();
    };
    LongTextEditor.prototype.setValue = function (val) {
        this._$textarea.val(val);
        this._$currentLengthElm.text(val.length);
    };
    LongTextEditor.prototype.applyValue = function (item, state) {
        var fieldName = this.columnDef && this.columnDef.field;
        var isComplexObject = fieldName && fieldName.indexOf('.') > 0; // is the field a complex object, "address.streetNumber"
        // validate the value before applying it (if not valid we'll set an empty string)
        var validation = this.validate(state);
        var newValue = (validation && validation.valid) ? state : '';
        // set the new value to the item datacontext
        if (isComplexObject) {
            setDeepValue(item, fieldName, newValue);
        }
        else {
            item[fieldName] = newValue;
        }
    };
    LongTextEditor.prototype.isValueChanged = function () {
        var elmValue = this._$textarea.val();
        return (!(elmValue === '' && (this.defaultValue === null || this.defaultValue === undefined))) && (elmValue !== this.defaultValue);
    };
    LongTextEditor.prototype.loadValue = function (item) {
        var fieldName = this.columnDef && this.columnDef.field;
        if (item && fieldName !== undefined) {
            // is the field a complex object, "address.streetNumber"
            var isComplexObject = fieldName && fieldName.indexOf('.') > 0;
            var value = (isComplexObject) ? getDescendantProperty(item, fieldName) : item[fieldName];
            this.defaultValue = value || '';
            this._$textarea.val(this.defaultValue);
            this._$currentLengthElm.text(this.defaultValue.length);
            this._$textarea[0].defaultValue = this.defaultValue;
            this._$textarea.select();
        }
    };
    LongTextEditor.prototype.position = function (parentPosition) {
        var containerOffset = getHtmlElementOffset(this.args.container);
        this._$wrapper
            .css('top', (containerOffset.top || parentPosition.top || 0))
            .css('left', (containerOffset.left || parentPosition.left || 0));
    };
    LongTextEditor.prototype.save = function () {
        var validation = this.validate();
        var isValid = (validation && validation.valid) || false;
        if (this.hasAutoCommitEdit && isValid) {
            // do not use args.commitChanges() as this sets the focus to the next row.
            // also the select list will stay shown when clicking off the grid
            this.grid.getEditorLock().commitCurrentEdit();
        }
        else {
            this.args.commitChanges();
        }
    };
    LongTextEditor.prototype.serializeValue = function () {
        return this._$textarea.val();
    };
    LongTextEditor.prototype.validate = function (inputValue) {
        var elmValue = (inputValue !== undefined) ? inputValue : this._$textarea && this._$textarea.val && this._$textarea.val();
        return textValidator(elmValue, {
            editorArgs: this.args,
            errorMessage: this.columnEditor.errorMessage,
            minLength: this.columnEditor.minLength,
            maxLength: this.columnEditor.maxLength,
            operatorConditionalType: this.columnEditor.operatorConditionalType,
            required: this.columnEditor.required,
            validator: this.validator,
        });
    };
    // --
    // private functions
    // ------------------
    LongTextEditor.prototype.handleKeyDown = function (event) {
        var keyCode = event.keyCode || event.code;
        if (keyCode === KeyCode.ENTER && event.ctrlKey) {
            this.save();
        }
        else if (keyCode === KeyCode.ESCAPE) {
            event.preventDefault();
            this.cancel();
        }
        else if (keyCode === KeyCode.TAB && event.shiftKey) {
            event.preventDefault();
            if (this.args && this.grid) {
                this.grid.navigatePrev();
            }
        }
        else if (keyCode === KeyCode.TAB) {
            event.preventDefault();
            if (this.args && this.grid) {
                this.grid.navigateNext();
            }
        }
    };
    /** On every input change event, we'll update the current text length counter */
    LongTextEditor.prototype.handleOnInputChange = function (event) {
        var textLength = event.target.value.length;
        this._$currentLengthElm.text(textLength);
    };
    return LongTextEditor;
}());
export { LongTextEditor };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibG9uZ1RleHRFZGl0b3IuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9hbmd1bGFyLXNsaWNrZ3JpZC8iLCJzb3VyY2VzIjpbImFwcC9tb2R1bGVzL2FuZ3VsYXItc2xpY2tncmlkL2VkaXRvcnMvbG9uZ1RleHRFZGl0b3IudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLGdCQUFnQixFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFDdkQsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQzNDLE9BQU8sRUFTTCxPQUFPLEdBRVIsTUFBTSxtQkFBbUIsQ0FBQztBQUMzQixPQUFPLEVBQUUscUJBQXFCLEVBQUUsb0JBQW9CLEVBQUUsb0JBQW9CLEVBQUUsWUFBWSxFQUFFLE1BQU0sdUJBQXVCLENBQUM7QUFDeEgsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLG1DQUFtQyxDQUFDO0FBSWxFLElBQU0sa0JBQWtCLEdBQUcsR0FBRyxDQUFDO0FBRS9COzs7O0dBSUc7QUFDSDtJQWdCRSx3QkFBb0IsSUFBcUI7UUFBckIsU0FBSSxHQUFKLElBQUksQ0FBaUI7UUFDdkMsSUFBSSxDQUFDLElBQUksRUFBRTtZQUNULE1BQU0sSUFBSSxLQUFLLENBQUMsb0dBQW9HLENBQUMsQ0FBQztTQUN2SDtRQUNELElBQUksQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQztRQUN0QixJQUFJLENBQUMsV0FBVyxHQUFHLElBQUksQ0FBQyxJQUFJLElBQUksSUFBSSxDQUFDLElBQUksQ0FBQyxVQUFVLEVBQWdCLENBQUM7UUFDckUsSUFBTSxPQUFPLEdBQUcsSUFBSSxDQUFDLFdBQVcsSUFBSSxJQUFJLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxNQUFNLElBQUksRUFBRSxDQUFDO1FBQ2xFLElBQUksT0FBTyxJQUFJLE9BQU8sQ0FBQyxJQUFJLFlBQVksZ0JBQWdCLEVBQUU7WUFDdkQsSUFBSSxDQUFDLFVBQVUsR0FBRyxPQUFPLENBQUMsSUFBSSxDQUFDO1NBQ2hDO1FBQ0QsZ0dBQWdHO1FBQ2hHLElBQUksQ0FBQyxRQUFRLEdBQUcsSUFBSSxDQUFDLFdBQVcsSUFBSSxJQUFJLENBQUMsV0FBVyxDQUFDLE9BQU8sSUFBSSxTQUFTLENBQUMsT0FBTyxDQUFDO1FBRWxGLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQztJQUNkLENBQUM7SUFHRCxzQkFBSSxxQ0FBUztRQURiLG1DQUFtQzthQUNuQztZQUNFLE9BQU8sSUFBSSxDQUFDLElBQUksSUFBSSxJQUFJLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQztRQUN2QyxDQUFDOzs7T0FBQTtJQUdELHNCQUFJLHdDQUFZO1FBRGhCLCtCQUErQjthQUMvQjtZQUNFLE9BQU8sSUFBSSxDQUFDLFNBQVMsSUFBSSxJQUFJLENBQUMsU0FBUyxDQUFDLG9CQUFvQixJQUFJLEVBQUUsQ0FBQztRQUNyRSxDQUFDOzs7T0FBQTtJQUdELHNCQUFJLDRDQUFnQjtRQURwQixpQ0FBaUM7YUFDakM7WUFDRSxPQUFPLElBQUksQ0FBQyxVQUFVLENBQUM7UUFDekIsQ0FBQzs7O09BQUE7SUFFRCxzQkFBSSw2Q0FBaUI7YUFBckI7WUFDRSxPQUFPLElBQUksQ0FBQyxJQUFJLENBQUMsVUFBVSxFQUFFLENBQUMsY0FBYyxDQUFDO1FBQy9DLENBQUM7OztPQUFBO0lBR0Qsc0JBQUkscUNBQVM7UUFEYix3RkFBd0Y7YUFDeEY7WUFDRSxPQUFPLENBQUMsSUFBSSxDQUFDLFlBQVksSUFBSSxJQUFJLENBQUMsWUFBWSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsSUFBSSxJQUFJLENBQUMsU0FBUyxDQUFDLFNBQVMsQ0FBQyxDQUFDO1FBQzVHLENBQUM7OztPQUFBO0lBRUQsNkJBQUksR0FBSjtRQUFBLGlCQTRDQztRQTNDQyxJQUFJLFVBQVUsR0FBRyxFQUFFLENBQUM7UUFDcEIsSUFBSSxRQUFRLEdBQUcsRUFBRSxDQUFDO1FBRWxCLElBQUksSUFBSSxDQUFDLFVBQVUsSUFBSSxJQUFJLENBQUMsVUFBVSxDQUFDLE9BQU8sSUFBSSxJQUFJLENBQUMsVUFBVSxDQUFDLFdBQVcsRUFBRTtZQUM3RSxJQUFNLGlCQUFpQixHQUFHLG9CQUFvQixDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQztZQUNqRSxVQUFVLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQyxPQUFPLENBQUksaUJBQWlCLFdBQVEsQ0FBQyxDQUFDO1lBQ25FLFFBQVEsR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDLE9BQU8sQ0FBSSxpQkFBaUIsU0FBTSxDQUFDLENBQUM7U0FDaEU7YUFBTTtZQUNMLFVBQVUsR0FBRyxJQUFJLENBQUMsUUFBUSxJQUFJLElBQUksQ0FBQyxRQUFRLENBQUMsV0FBVyxDQUFDO1lBQ3hELFFBQVEsR0FBRyxJQUFJLENBQUMsUUFBUSxJQUFJLElBQUksQ0FBQyxRQUFRLENBQUMsU0FBUyxDQUFDO1NBQ3JEO1FBRUQsSUFBTSxRQUFRLEdBQUcsSUFBSSxDQUFDLFNBQVMsSUFBSSxJQUFJLENBQUMsU0FBUyxDQUFDLEVBQUUsQ0FBQztRQUNyRCxJQUFNLFdBQVcsR0FBRyxJQUFJLENBQUMsWUFBWSxJQUFJLElBQUksQ0FBQyxZQUFZLENBQUMsV0FBVyxJQUFJLEVBQUUsQ0FBQztRQUM3RSxJQUFNLEtBQUssR0FBRyxJQUFJLENBQUMsWUFBWSxJQUFJLElBQUksQ0FBQyxZQUFZLENBQUMsS0FBSyxJQUFJLEVBQUUsQ0FBQztRQUNqRSxJQUFNLFNBQVMsR0FBRyxJQUFJLENBQUMsWUFBWSxJQUFJLElBQUksQ0FBQyxZQUFZLENBQUMsU0FBUyxJQUFJLGtCQUFrQixDQUFDO1FBQ3pGLElBQU0sWUFBWSxHQUFHLElBQUksQ0FBQyxZQUFZLElBQUksSUFBSSxDQUFDLFlBQVksQ0FBQyxNQUFNLElBQUksSUFBSSxDQUFDLFlBQVksQ0FBQyxNQUFNLENBQUMsWUFBWSxJQUFJLENBQUMsQ0FBQztRQUVqSCxJQUFNLFVBQVUsR0FBRyxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUM7UUFDN0IsSUFBSSxDQUFDLFNBQVMsR0FBRyxDQUFDLENBQUMsaURBQThDLFFBQVEsVUFBTSxDQUFDLENBQUMsUUFBUSxDQUFDLFVBQVUsQ0FBQyxDQUFDO1FBQ3RHLElBQUksQ0FBQyxVQUFVLEdBQUcsQ0FBQyxDQUFDLGdDQUE2QixZQUFZLHlCQUFrQixXQUFXLG1CQUFZLEtBQUssUUFBSSxDQUFDLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQztRQUUxSSxJQUFNLGVBQWUsR0FBRyxDQUFDLENBQUMsZ0NBQThCLENBQUMsQ0FBQztRQUMxRCxJQUFNLGlCQUFpQixHQUFHLENBQUMsQ0FBQywyQkFBeUIsQ0FBQyxDQUFDO1FBQ3ZELElBQUksQ0FBQyxrQkFBa0IsR0FBRyxDQUFDLENBQUMsc0NBQW9DLENBQUMsQ0FBQztRQUNsRSxJQUFNLGdCQUFnQixHQUFHLENBQUMsQ0FBQyw4Q0FBMEMsU0FBUyxZQUFTLENBQUMsQ0FBQztRQUN6RixJQUFJLENBQUMsa0JBQWtCLENBQUMsUUFBUSxDQUFDLGlCQUFpQixDQUFDLENBQUM7UUFDcEQsZ0JBQWdCLENBQUMsUUFBUSxDQUFDLGlCQUFpQixDQUFDLENBQUM7UUFFN0MsSUFBTSxZQUFZLEdBQUcsQ0FBQyxDQUFDLHlEQUFxRCxVQUFVLGNBQVcsQ0FBQyxDQUFDO1FBQ25HLElBQU0sVUFBVSxHQUFHLENBQUMsQ0FBQyx1REFBbUQsUUFBUSxjQUFXLENBQUMsQ0FBQztRQUM3RixpQkFBaUIsQ0FBQyxRQUFRLENBQUMsZUFBZSxDQUFDLENBQUM7UUFDNUMsWUFBWSxDQUFDLFFBQVEsQ0FBQyxlQUFlLENBQUMsQ0FBQztRQUN2QyxVQUFVLENBQUMsUUFBUSxDQUFDLGVBQWUsQ0FBQyxDQUFDO1FBQ3JDLGVBQWUsQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDO1FBRXpDLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxPQUFPLEVBQUUsY0FBTSxPQUFBLEtBQUksQ0FBQyxJQUFJLEVBQUUsRUFBWCxDQUFXLENBQUMsQ0FBQztRQUNoRSxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsQ0FBQyxFQUFFLENBQUMsT0FBTyxFQUFFLGNBQU0sT0FBQSxLQUFJLENBQUMsTUFBTSxFQUFFLEVBQWIsQ0FBYSxDQUFDLENBQUM7UUFDcEUsSUFBSSxDQUFDLFVBQVUsQ0FBQyxFQUFFLENBQUMsU0FBUyxFQUFFLElBQUksQ0FBQyxhQUFhLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7UUFDN0QsSUFBSSxDQUFDLFVBQVUsQ0FBQyxFQUFFLENBQUMsT0FBTyxFQUFFLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQztRQUVqRSxJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxJQUFJLElBQUksSUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUMvQyxJQUFJLENBQUMsVUFBVSxDQUFDLEtBQUssRUFBRSxDQUFDLE1BQU0sRUFBRSxDQUFDO0lBQ25DLENBQUM7SUFFRCwrQkFBTSxHQUFOO1FBQ0UsSUFBTSxLQUFLLEdBQUcsSUFBSSxDQUFDLFlBQVksSUFBSSxFQUFFLENBQUM7UUFDdEMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDM0IsSUFBSSxDQUFDLGtCQUFrQixDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLENBQUM7UUFDM0MsSUFBSSxJQUFJLENBQUMsSUFBSSxJQUFJLElBQUksQ0FBQyxJQUFJLENBQUMsYUFBYSxFQUFFO1lBQ3hDLElBQUksQ0FBQyxJQUFJLENBQUMsYUFBYSxFQUFFLENBQUM7U0FDM0I7SUFDSCxDQUFDO0lBRUQsNkJBQUksR0FBSjtRQUNFLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxFQUFFLENBQUM7SUFDeEIsQ0FBQztJQUVELDZCQUFJLEdBQUo7UUFDRSxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksRUFBRSxDQUFDO0lBQ3hCLENBQUM7SUFFRCxnQ0FBTyxHQUFQO1FBQ0UsSUFBSSxJQUFJLENBQUMsVUFBVSxFQUFFO1lBQ25CLElBQUksQ0FBQyxVQUFVLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBQyxDQUFDO1lBQy9CLElBQUksQ0FBQyxVQUFVLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxDQUFDO1NBQzlCO1FBQ0QsSUFBSSxJQUFJLENBQUMsU0FBUyxFQUFFO1lBQ2xCLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsQ0FBQztZQUM5QyxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLENBQUM7WUFDaEQsSUFBSSxDQUFDLFNBQVMsQ0FBQyxNQUFNLEVBQUUsQ0FBQztTQUN6QjtRQUNELElBQUksQ0FBQyxTQUFTLEdBQUcsSUFBSSxDQUFDO0lBQ3hCLENBQUM7SUFFRCw4QkFBSyxHQUFMO1FBQ0UsSUFBSSxDQUFDLFVBQVUsQ0FBQyxLQUFLLEVBQUUsQ0FBQztJQUMxQixDQUFDO0lBRUQsaUNBQVEsR0FBUjtRQUNFLE9BQU8sSUFBSSxDQUFDLFVBQVUsQ0FBQyxHQUFHLEVBQUUsQ0FBQztJQUMvQixDQUFDO0lBRUQsaUNBQVEsR0FBUixVQUFTLEdBQVc7UUFDbEIsSUFBSSxDQUFDLFVBQVUsQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDekIsSUFBSSxDQUFDLGtCQUFrQixDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLENBQUM7SUFDM0MsQ0FBQztJQUVELG1DQUFVLEdBQVYsVUFBVyxJQUFTLEVBQUUsS0FBVTtRQUM5QixJQUFNLFNBQVMsR0FBRyxJQUFJLENBQUMsU0FBUyxJQUFJLElBQUksQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDO1FBQ3pELElBQU0sZUFBZSxHQUFHLFNBQVMsSUFBSSxTQUFTLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLHdEQUF3RDtRQUV6SCxpRkFBaUY7UUFDakYsSUFBTSxVQUFVLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUN4QyxJQUFNLFFBQVEsR0FBRyxDQUFDLFVBQVUsSUFBSSxVQUFVLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDO1FBRS9ELDRDQUE0QztRQUM1QyxJQUFJLGVBQWUsRUFBRTtZQUNuQixZQUFZLENBQUMsSUFBSSxFQUFFLFNBQVMsRUFBRSxRQUFRLENBQUMsQ0FBQztTQUN6QzthQUFNO1lBQ0wsSUFBSSxDQUFDLFNBQVMsQ0FBQyxHQUFHLFFBQVEsQ0FBQztTQUM1QjtJQUNILENBQUM7SUFFRCx1Q0FBYyxHQUFkO1FBQ0UsSUFBTSxRQUFRLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQyxHQUFHLEVBQUUsQ0FBQztRQUN2QyxPQUFPLENBQUMsQ0FBQyxDQUFDLFFBQVEsS0FBSyxFQUFFLElBQUksQ0FBQyxJQUFJLENBQUMsWUFBWSxLQUFLLElBQUksSUFBSSxJQUFJLENBQUMsWUFBWSxLQUFLLFNBQVMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLFFBQVEsS0FBSyxJQUFJLENBQUMsWUFBWSxDQUFDLENBQUM7SUFDckksQ0FBQztJQUVELGtDQUFTLEdBQVQsVUFBVSxJQUFTO1FBQ2pCLElBQU0sU0FBUyxHQUFHLElBQUksQ0FBQyxTQUFTLElBQUksSUFBSSxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUM7UUFFekQsSUFBSSxJQUFJLElBQUksU0FBUyxLQUFLLFNBQVMsRUFBRTtZQUNuQyx3REFBd0Q7WUFDeEQsSUFBTSxlQUFlLEdBQUcsU0FBUyxJQUFJLFNBQVMsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1lBQ2hFLElBQU0sS0FBSyxHQUFHLENBQUMsZUFBZSxDQUFDLENBQUMsQ0FBQyxDQUFDLHFCQUFxQixDQUFDLElBQUksRUFBRSxTQUFTLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDO1lBRTNGLElBQUksQ0FBQyxZQUFZLEdBQUcsS0FBSyxJQUFJLEVBQUUsQ0FBQztZQUNoQyxJQUFJLENBQUMsVUFBVSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLENBQUM7WUFDdkMsSUFBSSxDQUFDLGtCQUFrQixDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLE1BQU0sQ0FBQyxDQUFDO1lBQ3ZELElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLENBQUMsWUFBWSxHQUFHLElBQUksQ0FBQyxZQUFZLENBQUM7WUFDcEQsSUFBSSxDQUFDLFVBQVUsQ0FBQyxNQUFNLEVBQUUsQ0FBQztTQUMxQjtJQUNILENBQUM7SUFFRCxpQ0FBUSxHQUFSLFVBQVMsY0FBbUM7UUFDMUMsSUFBTSxlQUFlLEdBQUcsb0JBQW9CLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQztRQUVsRSxJQUFJLENBQUMsU0FBUzthQUNYLEdBQUcsQ0FBQyxLQUFLLEVBQUUsQ0FBQyxlQUFlLENBQUMsR0FBRyxJQUFJLGNBQWMsQ0FBQyxHQUFHLElBQUksQ0FBQyxDQUFDLENBQUM7YUFDNUQsR0FBRyxDQUFDLE1BQU0sRUFBRSxDQUFDLGVBQWUsQ0FBQyxJQUFJLElBQUksY0FBYyxDQUFDLElBQUksSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQ3JFLENBQUM7SUFFRCw2QkFBSSxHQUFKO1FBQ0UsSUFBTSxVQUFVLEdBQUcsSUFBSSxDQUFDLFFBQVEsRUFBRSxDQUFDO1FBQ25DLElBQU0sT0FBTyxHQUFHLENBQUMsVUFBVSxJQUFJLFVBQVUsQ0FBQyxLQUFLLENBQUMsSUFBSSxLQUFLLENBQUM7UUFFMUQsSUFBSSxJQUFJLENBQUMsaUJBQWlCLElBQUksT0FBTyxFQUFFO1lBQ3JDLDBFQUEwRTtZQUMxRSxrRUFBa0U7WUFDbEUsSUFBSSxDQUFDLElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQyxpQkFBaUIsRUFBRSxDQUFDO1NBQy9DO2FBQU07WUFDTCxJQUFJLENBQUMsSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFDO1NBQzNCO0lBQ0gsQ0FBQztJQUVELHVDQUFjLEdBQWQ7UUFDRSxPQUFPLElBQUksQ0FBQyxVQUFVLENBQUMsR0FBRyxFQUFFLENBQUM7SUFDL0IsQ0FBQztJQUVELGlDQUFRLEdBQVIsVUFBUyxVQUFnQjtRQUN2QixJQUFNLFFBQVEsR0FBRyxDQUFDLFVBQVUsS0FBSyxTQUFTLENBQUMsQ0FBQyxDQUFDLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsVUFBVSxJQUFJLElBQUksQ0FBQyxVQUFVLENBQUMsR0FBRyxJQUFJLElBQUksQ0FBQyxVQUFVLENBQUMsR0FBRyxFQUFFLENBQUM7UUFDM0gsT0FBTyxhQUFhLENBQUMsUUFBUSxFQUFFO1lBQzdCLFVBQVUsRUFBRSxJQUFJLENBQUMsSUFBSTtZQUNyQixZQUFZLEVBQUUsSUFBSSxDQUFDLFlBQVksQ0FBQyxZQUFZO1lBQzVDLFNBQVMsRUFBRSxJQUFJLENBQUMsWUFBWSxDQUFDLFNBQVM7WUFDdEMsU0FBUyxFQUFFLElBQUksQ0FBQyxZQUFZLENBQUMsU0FBUztZQUN0Qyx1QkFBdUIsRUFBRSxJQUFJLENBQUMsWUFBWSxDQUFDLHVCQUF1QjtZQUNsRSxRQUFRLEVBQUUsSUFBSSxDQUFDLFlBQVksQ0FBQyxRQUFRO1lBQ3BDLFNBQVMsRUFBRSxJQUFJLENBQUMsU0FBUztTQUMxQixDQUFDLENBQUM7SUFDTCxDQUFDO0lBRUQsS0FBSztJQUNMLG9CQUFvQjtJQUNwQixxQkFBcUI7SUFFYixzQ0FBYSxHQUFyQixVQUFzQixLQUFvQjtRQUN4QyxJQUFNLE9BQU8sR0FBRyxLQUFLLENBQUMsT0FBTyxJQUFJLEtBQUssQ0FBQyxJQUFJLENBQUM7UUFDNUMsSUFBSSxPQUFPLEtBQUssT0FBTyxDQUFDLEtBQUssSUFBSSxLQUFLLENBQUMsT0FBTyxFQUFFO1lBQzlDLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQztTQUNiO2FBQU0sSUFBSSxPQUFPLEtBQUssT0FBTyxDQUFDLE1BQU0sRUFBRTtZQUNyQyxLQUFLLENBQUMsY0FBYyxFQUFFLENBQUM7WUFDdkIsSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDO1NBQ2Y7YUFBTSxJQUFJLE9BQU8sS0FBSyxPQUFPLENBQUMsR0FBRyxJQUFJLEtBQUssQ0FBQyxRQUFRLEVBQUU7WUFDcEQsS0FBSyxDQUFDLGNBQWMsRUFBRSxDQUFDO1lBQ3ZCLElBQUksSUFBSSxDQUFDLElBQUksSUFBSSxJQUFJLENBQUMsSUFBSSxFQUFFO2dCQUMxQixJQUFJLENBQUMsSUFBSSxDQUFDLFlBQVksRUFBRSxDQUFDO2FBQzFCO1NBQ0Y7YUFBTSxJQUFJLE9BQU8sS0FBSyxPQUFPLENBQUMsR0FBRyxFQUFFO1lBQ2xDLEtBQUssQ0FBQyxjQUFjLEVBQUUsQ0FBQztZQUN2QixJQUFJLElBQUksQ0FBQyxJQUFJLElBQUksSUFBSSxDQUFDLElBQUksRUFBRTtnQkFDMUIsSUFBSSxDQUFDLElBQUksQ0FBQyxZQUFZLEVBQUUsQ0FBQzthQUMxQjtTQUNGO0lBQ0gsQ0FBQztJQUVELGdGQUFnRjtJQUN4RSw0Q0FBbUIsR0FBM0IsVUFBNEIsS0FBc0Q7UUFDaEYsSUFBTSxVQUFVLEdBQUcsS0FBSyxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDO1FBQzdDLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUM7SUFDM0MsQ0FBQztJQUNILHFCQUFDO0FBQUQsQ0FBQyxBQXpQRCxJQXlQQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFRyYW5zbGF0ZVNlcnZpY2UgfSBmcm9tICdAbmd4LXRyYW5zbGF0ZS9jb3JlJztcclxuaW1wb3J0IHsgQ29uc3RhbnRzIH0gZnJvbSAnLi8uLi9jb25zdGFudHMnO1xyXG5pbXBvcnQge1xyXG4gIENvbHVtbixcclxuICBDb2x1bW5FZGl0b3IsXHJcbiAgRWRpdG9yLFxyXG4gIEVkaXRvckFyZ3VtZW50cyxcclxuICBFZGl0b3JWYWxpZGF0b3IsXHJcbiAgRWRpdG9yVmFsaWRhdG9yT3V0cHV0LFxyXG4gIEdyaWRPcHRpb24sXHJcbiAgSHRtbEVsZW1lbnRQb3NpdGlvbixcclxuICBLZXlDb2RlLFxyXG4gIExvY2FsZSxcclxufSBmcm9tICcuLy4uL21vZGVscy9pbmRleCc7XHJcbmltcG9ydCB7IGdldERlc2NlbmRhbnRQcm9wZXJ0eSwgZ2V0SHRtbEVsZW1lbnRPZmZzZXQsIGdldFRyYW5zbGF0aW9uUHJlZml4LCBzZXREZWVwVmFsdWUgfSBmcm9tICcuLi9zZXJ2aWNlcy91dGlsaXRpZXMnO1xyXG5pbXBvcnQgeyB0ZXh0VmFsaWRhdG9yIH0gZnJvbSAnLi4vZWRpdG9yVmFsaWRhdG9ycy90ZXh0VmFsaWRhdG9yJztcclxuXHJcbi8vIHVzaW5nIGV4dGVybmFsIG5vbi10eXBlZCBqcyBsaWJyYXJpZXNcclxuZGVjbGFyZSBjb25zdCAkOiBhbnk7XHJcbmNvbnN0IERFRkFVTFRfTUFYX0xFTkdUSCA9IDUwMDtcclxuXHJcbi8qXHJcbiAqIEFuIGV4YW1wbGUgb2YgYSAnZGV0YWNoZWQnIGVkaXRvci5cclxuICogVGhlIFVJIGlzIGFkZGVkIG9udG8gZG9jdW1lbnQgQk9EWSBhbmQgLnBvc2l0aW9uKCksIC5zaG93KCkgYW5kIC5oaWRlKCkgYXJlIGltcGxlbWVudGVkLlxyXG4gKiBLZXlEb3duIGV2ZW50cyBhcmUgYWxzbyBoYW5kbGVkIHRvIHByb3ZpZGUgaGFuZGxpbmcgZm9yIFRhYiwgU2hpZnQtVGFiLCBFc2MgYW5kIEN0cmwtRW50ZXIuXHJcbiAqL1xyXG5leHBvcnQgY2xhc3MgTG9uZ1RleHRFZGl0b3IgaW1wbGVtZW50cyBFZGl0b3Ige1xyXG4gIHByaXZhdGUgX2xvY2FsZXM6IExvY2FsZTtcclxuICBwcml2YXRlIF8kdGV4dGFyZWE6IGFueTtcclxuICBwcml2YXRlIF8kY3VycmVudExlbmd0aEVsbTogYW55O1xyXG4gIHByaXZhdGUgXyR3cmFwcGVyOiBhbnk7XHJcbiAgZGVmYXVsdFZhbHVlOiBhbnk7XHJcblxyXG4gIC8qKiBTbGlja0dyaWQgR3JpZCBvYmplY3QgKi9cclxuICBncmlkOiBhbnk7XHJcblxyXG4gIC8qKiBHcmlkIG9wdGlvbnMgKi9cclxuICBncmlkT3B0aW9uczogR3JpZE9wdGlvbjtcclxuXHJcbiAgLyoqIFRoZSB0cmFuc2xhdGUgbGlicmFyeSAqL1xyXG4gIHByaXZhdGUgX3RyYW5zbGF0ZTogVHJhbnNsYXRlU2VydmljZTtcclxuXHJcbiAgY29uc3RydWN0b3IocHJpdmF0ZSBhcmdzOiBFZGl0b3JBcmd1bWVudHMpIHtcclxuICAgIGlmICghYXJncykge1xyXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ1tBbmd1bGFyLVNsaWNrR3JpZF0gU29tZXRoaW5nIGlzIHdyb25nIHdpdGggdGhpcyBncmlkLCBhbiBFZGl0b3IgbXVzdCBhbHdheXMgaGF2ZSB2YWxpZCBhcmd1bWVudHMuJyk7XHJcbiAgICB9XHJcbiAgICB0aGlzLmdyaWQgPSBhcmdzLmdyaWQ7XHJcbiAgICB0aGlzLmdyaWRPcHRpb25zID0gYXJncy5ncmlkICYmIGFyZ3MuZ3JpZC5nZXRPcHRpb25zKCkgYXMgR3JpZE9wdGlvbjtcclxuICAgIGNvbnN0IG9wdGlvbnMgPSB0aGlzLmdyaWRPcHRpb25zIHx8IHRoaXMuYXJncy5jb2x1bW4ucGFyYW1zIHx8IHt9O1xyXG4gICAgaWYgKG9wdGlvbnMgJiYgb3B0aW9ucy5pMThuIGluc3RhbmNlb2YgVHJhbnNsYXRlU2VydmljZSkge1xyXG4gICAgICB0aGlzLl90cmFuc2xhdGUgPSBvcHRpb25zLmkxOG47XHJcbiAgICB9XHJcbiAgICAvLyBnZXQgbG9jYWxlcyBwcm92aWRlZCBieSB1c2VyIGluIGZvclJvb3Qgb3IgZWxzZSB1c2UgZGVmYXVsdCBFbmdsaXNoIGxvY2FsZXMgdmlhIHRoZSBDb25zdGFudHNcclxuICAgIHRoaXMuX2xvY2FsZXMgPSB0aGlzLmdyaWRPcHRpb25zICYmIHRoaXMuZ3JpZE9wdGlvbnMubG9jYWxlcyB8fCBDb25zdGFudHMubG9jYWxlcztcclxuXHJcbiAgICB0aGlzLmluaXQoKTtcclxuICB9XHJcblxyXG4gIC8qKiBHZXQgQ29sdW1uIERlZmluaXRpb24gb2JqZWN0ICovXHJcbiAgZ2V0IGNvbHVtbkRlZigpOiBDb2x1bW4gfCB1bmRlZmluZWQge1xyXG4gICAgcmV0dXJuIHRoaXMuYXJncyAmJiB0aGlzLmFyZ3MuY29sdW1uO1xyXG4gIH1cclxuXHJcbiAgLyoqIEdldCBDb2x1bW4gRWRpdG9yIG9iamVjdCAqL1xyXG4gIGdldCBjb2x1bW5FZGl0b3IoKTogQ29sdW1uRWRpdG9yIHtcclxuICAgIHJldHVybiB0aGlzLmNvbHVtbkRlZiAmJiB0aGlzLmNvbHVtbkRlZi5pbnRlcm5hbENvbHVtbkVkaXRvciB8fCB7fTtcclxuICB9XHJcblxyXG4gIC8qKiBHZXQgdGhlIEVkaXRvciBET00gRWxlbWVudCAqL1xyXG4gIGdldCBlZGl0b3JEb21FbGVtZW50KCk6IGFueSB7XHJcbiAgICByZXR1cm4gdGhpcy5fJHRleHRhcmVhO1xyXG4gIH1cclxuXHJcbiAgZ2V0IGhhc0F1dG9Db21taXRFZGl0KCkge1xyXG4gICAgcmV0dXJuIHRoaXMuZ3JpZC5nZXRPcHRpb25zKCkuYXV0b0NvbW1pdEVkaXQ7XHJcbiAgfVxyXG5cclxuICAvKiogR2V0IHRoZSBWYWxpZGF0b3IgZnVuY3Rpb24sIGNhbiBiZSBwYXNzZWQgaW4gRWRpdG9yIHByb3BlcnR5IG9yIENvbHVtbiBEZWZpbml0aW9uICovXHJcbiAgZ2V0IHZhbGlkYXRvcigpOiBFZGl0b3JWYWxpZGF0b3IgfCB1bmRlZmluZWQge1xyXG4gICAgcmV0dXJuICh0aGlzLmNvbHVtbkVkaXRvciAmJiB0aGlzLmNvbHVtbkVkaXRvci52YWxpZGF0b3IpIHx8ICh0aGlzLmNvbHVtbkRlZiAmJiB0aGlzLmNvbHVtbkRlZi52YWxpZGF0b3IpO1xyXG4gIH1cclxuXHJcbiAgaW5pdCgpOiB2b2lkIHtcclxuICAgIGxldCBjYW5jZWxUZXh0ID0gJyc7XHJcbiAgICBsZXQgc2F2ZVRleHQgPSAnJztcclxuXHJcbiAgICBpZiAodGhpcy5fdHJhbnNsYXRlICYmIHRoaXMuX3RyYW5zbGF0ZS5pbnN0YW50ICYmIHRoaXMuX3RyYW5zbGF0ZS5jdXJyZW50TGFuZykge1xyXG4gICAgICBjb25zdCB0cmFuc2xhdGlvblByZWZpeCA9IGdldFRyYW5zbGF0aW9uUHJlZml4KHRoaXMuZ3JpZE9wdGlvbnMpO1xyXG4gICAgICBjYW5jZWxUZXh0ID0gdGhpcy5fdHJhbnNsYXRlLmluc3RhbnQoYCR7dHJhbnNsYXRpb25QcmVmaXh9Q0FOQ0VMYCk7XHJcbiAgICAgIHNhdmVUZXh0ID0gdGhpcy5fdHJhbnNsYXRlLmluc3RhbnQoYCR7dHJhbnNsYXRpb25QcmVmaXh9U0FWRWApO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgY2FuY2VsVGV4dCA9IHRoaXMuX2xvY2FsZXMgJiYgdGhpcy5fbG9jYWxlcy5URVhUX0NBTkNFTDtcclxuICAgICAgc2F2ZVRleHQgPSB0aGlzLl9sb2NhbGVzICYmIHRoaXMuX2xvY2FsZXMuVEVYVF9TQVZFO1xyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IGNvbHVtbklkID0gdGhpcy5jb2x1bW5EZWYgJiYgdGhpcy5jb2x1bW5EZWYuaWQ7XHJcbiAgICBjb25zdCBwbGFjZWhvbGRlciA9IHRoaXMuY29sdW1uRWRpdG9yICYmIHRoaXMuY29sdW1uRWRpdG9yLnBsYWNlaG9sZGVyIHx8ICcnO1xyXG4gICAgY29uc3QgdGl0bGUgPSB0aGlzLmNvbHVtbkVkaXRvciAmJiB0aGlzLmNvbHVtbkVkaXRvci50aXRsZSB8fCAnJztcclxuICAgIGNvbnN0IG1heExlbmd0aCA9IHRoaXMuY29sdW1uRWRpdG9yICYmIHRoaXMuY29sdW1uRWRpdG9yLm1heExlbmd0aCB8fCBERUZBVUxUX01BWF9MRU5HVEg7XHJcbiAgICBjb25zdCB0ZXh0QXJlYVJvd3MgPSB0aGlzLmNvbHVtbkVkaXRvciAmJiB0aGlzLmNvbHVtbkVkaXRvci5wYXJhbXMgJiYgdGhpcy5jb2x1bW5FZGl0b3IucGFyYW1zLnRleHRBcmVhUm93cyB8fCA2O1xyXG5cclxuICAgIGNvbnN0ICRjb250YWluZXIgPSAkKCdib2R5Jyk7XHJcbiAgICB0aGlzLl8kd3JhcHBlciA9ICQoYDxkaXYgY2xhc3M9XCJzbGljay1sYXJnZS1lZGl0b3ItdGV4dCBlZGl0b3ItJHtjb2x1bW5JZH1cIiAvPmApLmFwcGVuZFRvKCRjb250YWluZXIpO1xyXG4gICAgdGhpcy5fJHRleHRhcmVhID0gJChgPHRleHRhcmVhIGhpZGVmb2N1cyByb3dzPVwiJHt0ZXh0QXJlYVJvd3N9XCIgcGxhY2Vob2xkZXI9XCIke3BsYWNlaG9sZGVyfVwiIHRpdGxlPVwiJHt0aXRsZX1cIj5gKS5hcHBlbmRUbyh0aGlzLl8kd3JhcHBlcik7XHJcblxyXG4gICAgY29uc3QgZWRpdG9yRm9vdGVyRWxtID0gJChgPGRpdiBjbGFzcz1cImVkaXRvci1mb290ZXJcIi8+YCk7XHJcbiAgICBjb25zdCBjb3VudENvbnRhaW5lckVsbSA9ICQoYDxzcGFuIGNsYXNzPVwiY291bnRlclwiLz5gKTtcclxuICAgIHRoaXMuXyRjdXJyZW50TGVuZ3RoRWxtID0gJChgPHNwYW4gY2xhc3M9XCJ0ZXh0LWxlbmd0aFwiPjA8L3NwYW4+YCk7XHJcbiAgICBjb25zdCB0ZXh0TWF4TGVuZ3RoRWxtID0gJChgPHNwYW4+Lzwvc3Bhbj48c3BhbiBjbGFzcz1cIm1heC1sZW5ndGhcIj4ke21heExlbmd0aH08L3NwYW4+YCk7XHJcbiAgICB0aGlzLl8kY3VycmVudExlbmd0aEVsbS5hcHBlbmRUbyhjb3VudENvbnRhaW5lckVsbSk7XHJcbiAgICB0ZXh0TWF4TGVuZ3RoRWxtLmFwcGVuZFRvKGNvdW50Q29udGFpbmVyRWxtKTtcclxuXHJcbiAgICBjb25zdCBjYW5jZWxCdG5FbG0gPSAkKGA8YnV0dG9uIGNsYXNzPVwiYnRuIGJ0bi1jYW5jZWwgYnRuLWRlZmF1bHQgYnRuLXhzXCI+JHtjYW5jZWxUZXh0fTwvYnV0dG9uPmApO1xyXG4gICAgY29uc3Qgc2F2ZUJ0bkVsbSA9ICQoYDxidXR0b24gY2xhc3M9XCJidG4gYnRuLXNhdmUgYnRuLXByaW1hcnkgYnRuLXhzXCI+JHtzYXZlVGV4dH08L2J1dHRvbj5gKTtcclxuICAgIGNvdW50Q29udGFpbmVyRWxtLmFwcGVuZFRvKGVkaXRvckZvb3RlckVsbSk7XHJcbiAgICBjYW5jZWxCdG5FbG0uYXBwZW5kVG8oZWRpdG9yRm9vdGVyRWxtKTtcclxuICAgIHNhdmVCdG5FbG0uYXBwZW5kVG8oZWRpdG9yRm9vdGVyRWxtKTtcclxuICAgIGVkaXRvckZvb3RlckVsbS5hcHBlbmRUbyh0aGlzLl8kd3JhcHBlcik7XHJcblxyXG4gICAgdGhpcy5fJHdyYXBwZXIuZmluZCgnLmJ0bi1zYXZlJykub24oJ2NsaWNrJywgKCkgPT4gdGhpcy5zYXZlKCkpO1xyXG4gICAgdGhpcy5fJHdyYXBwZXIuZmluZCgnLmJ0bi1jYW5jZWwnKS5vbignY2xpY2snLCAoKSA9PiB0aGlzLmNhbmNlbCgpKTtcclxuICAgIHRoaXMuXyR0ZXh0YXJlYS5vbigna2V5ZG93bicsIHRoaXMuaGFuZGxlS2V5RG93bi5iaW5kKHRoaXMpKTtcclxuICAgIHRoaXMuXyR0ZXh0YXJlYS5vbignaW5wdXQnLCB0aGlzLmhhbmRsZU9uSW5wdXRDaGFuZ2UuYmluZCh0aGlzKSk7XHJcblxyXG4gICAgdGhpcy5wb3NpdGlvbih0aGlzLmFyZ3MgJiYgdGhpcy5hcmdzLnBvc2l0aW9uKTtcclxuICAgIHRoaXMuXyR0ZXh0YXJlYS5mb2N1cygpLnNlbGVjdCgpO1xyXG4gIH1cclxuXHJcbiAgY2FuY2VsKCkge1xyXG4gICAgY29uc3QgdmFsdWUgPSB0aGlzLmRlZmF1bHRWYWx1ZSB8fCAnJztcclxuICAgIHRoaXMuXyR0ZXh0YXJlYS52YWwodmFsdWUpO1xyXG4gICAgdGhpcy5fJGN1cnJlbnRMZW5ndGhFbG0udGV4dCh2YWx1ZS5sZW5ndGgpO1xyXG4gICAgaWYgKHRoaXMuYXJncyAmJiB0aGlzLmFyZ3MuY2FuY2VsQ2hhbmdlcykge1xyXG4gICAgICB0aGlzLmFyZ3MuY2FuY2VsQ2hhbmdlcygpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgaGlkZSgpIHtcclxuICAgIHRoaXMuXyR3cmFwcGVyLmhpZGUoKTtcclxuICB9XHJcblxyXG4gIHNob3coKSB7XHJcbiAgICB0aGlzLl8kd3JhcHBlci5zaG93KCk7XHJcbiAgfVxyXG5cclxuICBkZXN0cm95KCkge1xyXG4gICAgaWYgKHRoaXMuXyR0ZXh0YXJlYSkge1xyXG4gICAgICB0aGlzLl8kdGV4dGFyZWEub2ZmKCdrZXlkb3duJyk7XHJcbiAgICAgIHRoaXMuXyR0ZXh0YXJlYS5vZmYoJ2lucHV0Jyk7XHJcbiAgICB9XHJcbiAgICBpZiAodGhpcy5fJHdyYXBwZXIpIHtcclxuICAgICAgdGhpcy5fJHdyYXBwZXIuZmluZCgnLmJ0bi1zYXZlJykub2ZmKCdjbGljaycpO1xyXG4gICAgICB0aGlzLl8kd3JhcHBlci5maW5kKCcuYnRuLWNhbmNlbCcpLm9mZignY2xpY2snKTtcclxuICAgICAgdGhpcy5fJHdyYXBwZXIucmVtb3ZlKCk7XHJcbiAgICB9XHJcbiAgICB0aGlzLl8kd3JhcHBlciA9IG51bGw7XHJcbiAgfVxyXG5cclxuICBmb2N1cygpIHtcclxuICAgIHRoaXMuXyR0ZXh0YXJlYS5mb2N1cygpO1xyXG4gIH1cclxuXHJcbiAgZ2V0VmFsdWUoKTogc3RyaW5nIHtcclxuICAgIHJldHVybiB0aGlzLl8kdGV4dGFyZWEudmFsKCk7XHJcbiAgfVxyXG5cclxuICBzZXRWYWx1ZSh2YWw6IHN0cmluZykge1xyXG4gICAgdGhpcy5fJHRleHRhcmVhLnZhbCh2YWwpO1xyXG4gICAgdGhpcy5fJGN1cnJlbnRMZW5ndGhFbG0udGV4dCh2YWwubGVuZ3RoKTtcclxuICB9XHJcblxyXG4gIGFwcGx5VmFsdWUoaXRlbTogYW55LCBzdGF0ZTogYW55KSB7XHJcbiAgICBjb25zdCBmaWVsZE5hbWUgPSB0aGlzLmNvbHVtbkRlZiAmJiB0aGlzLmNvbHVtbkRlZi5maWVsZDtcclxuICAgIGNvbnN0IGlzQ29tcGxleE9iamVjdCA9IGZpZWxkTmFtZSAmJiBmaWVsZE5hbWUuaW5kZXhPZignLicpID4gMDsgLy8gaXMgdGhlIGZpZWxkIGEgY29tcGxleCBvYmplY3QsIFwiYWRkcmVzcy5zdHJlZXROdW1iZXJcIlxyXG5cclxuICAgIC8vIHZhbGlkYXRlIHRoZSB2YWx1ZSBiZWZvcmUgYXBwbHlpbmcgaXQgKGlmIG5vdCB2YWxpZCB3ZSdsbCBzZXQgYW4gZW1wdHkgc3RyaW5nKVxyXG4gICAgY29uc3QgdmFsaWRhdGlvbiA9IHRoaXMudmFsaWRhdGUoc3RhdGUpO1xyXG4gICAgY29uc3QgbmV3VmFsdWUgPSAodmFsaWRhdGlvbiAmJiB2YWxpZGF0aW9uLnZhbGlkKSA/IHN0YXRlIDogJyc7XHJcblxyXG4gICAgLy8gc2V0IHRoZSBuZXcgdmFsdWUgdG8gdGhlIGl0ZW0gZGF0YWNvbnRleHRcclxuICAgIGlmIChpc0NvbXBsZXhPYmplY3QpIHtcclxuICAgICAgc2V0RGVlcFZhbHVlKGl0ZW0sIGZpZWxkTmFtZSwgbmV3VmFsdWUpO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgaXRlbVtmaWVsZE5hbWVdID0gbmV3VmFsdWU7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBpc1ZhbHVlQ2hhbmdlZCgpOiBib29sZWFuIHtcclxuICAgIGNvbnN0IGVsbVZhbHVlID0gdGhpcy5fJHRleHRhcmVhLnZhbCgpO1xyXG4gICAgcmV0dXJuICghKGVsbVZhbHVlID09PSAnJyAmJiAodGhpcy5kZWZhdWx0VmFsdWUgPT09IG51bGwgfHwgdGhpcy5kZWZhdWx0VmFsdWUgPT09IHVuZGVmaW5lZCkpKSAmJiAoZWxtVmFsdWUgIT09IHRoaXMuZGVmYXVsdFZhbHVlKTtcclxuICB9XHJcblxyXG4gIGxvYWRWYWx1ZShpdGVtOiBhbnkpIHtcclxuICAgIGNvbnN0IGZpZWxkTmFtZSA9IHRoaXMuY29sdW1uRGVmICYmIHRoaXMuY29sdW1uRGVmLmZpZWxkO1xyXG5cclxuICAgIGlmIChpdGVtICYmIGZpZWxkTmFtZSAhPT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgIC8vIGlzIHRoZSBmaWVsZCBhIGNvbXBsZXggb2JqZWN0LCBcImFkZHJlc3Muc3RyZWV0TnVtYmVyXCJcclxuICAgICAgY29uc3QgaXNDb21wbGV4T2JqZWN0ID0gZmllbGROYW1lICYmIGZpZWxkTmFtZS5pbmRleE9mKCcuJykgPiAwO1xyXG4gICAgICBjb25zdCB2YWx1ZSA9IChpc0NvbXBsZXhPYmplY3QpID8gZ2V0RGVzY2VuZGFudFByb3BlcnR5KGl0ZW0sIGZpZWxkTmFtZSkgOiBpdGVtW2ZpZWxkTmFtZV07XHJcblxyXG4gICAgICB0aGlzLmRlZmF1bHRWYWx1ZSA9IHZhbHVlIHx8ICcnO1xyXG4gICAgICB0aGlzLl8kdGV4dGFyZWEudmFsKHRoaXMuZGVmYXVsdFZhbHVlKTtcclxuICAgICAgdGhpcy5fJGN1cnJlbnRMZW5ndGhFbG0udGV4dCh0aGlzLmRlZmF1bHRWYWx1ZS5sZW5ndGgpO1xyXG4gICAgICB0aGlzLl8kdGV4dGFyZWFbMF0uZGVmYXVsdFZhbHVlID0gdGhpcy5kZWZhdWx0VmFsdWU7XHJcbiAgICAgIHRoaXMuXyR0ZXh0YXJlYS5zZWxlY3QoKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHBvc2l0aW9uKHBhcmVudFBvc2l0aW9uOiBIdG1sRWxlbWVudFBvc2l0aW9uKSB7XHJcbiAgICBjb25zdCBjb250YWluZXJPZmZzZXQgPSBnZXRIdG1sRWxlbWVudE9mZnNldCh0aGlzLmFyZ3MuY29udGFpbmVyKTtcclxuXHJcbiAgICB0aGlzLl8kd3JhcHBlclxyXG4gICAgICAuY3NzKCd0b3AnLCAoY29udGFpbmVyT2Zmc2V0LnRvcCB8fCBwYXJlbnRQb3NpdGlvbi50b3AgfHwgMCkpXHJcbiAgICAgIC5jc3MoJ2xlZnQnLCAoY29udGFpbmVyT2Zmc2V0LmxlZnQgfHwgcGFyZW50UG9zaXRpb24ubGVmdCB8fCAwKSk7XHJcbiAgfVxyXG5cclxuICBzYXZlKCkge1xyXG4gICAgY29uc3QgdmFsaWRhdGlvbiA9IHRoaXMudmFsaWRhdGUoKTtcclxuICAgIGNvbnN0IGlzVmFsaWQgPSAodmFsaWRhdGlvbiAmJiB2YWxpZGF0aW9uLnZhbGlkKSB8fCBmYWxzZTtcclxuXHJcbiAgICBpZiAodGhpcy5oYXNBdXRvQ29tbWl0RWRpdCAmJiBpc1ZhbGlkKSB7XHJcbiAgICAgIC8vIGRvIG5vdCB1c2UgYXJncy5jb21taXRDaGFuZ2VzKCkgYXMgdGhpcyBzZXRzIHRoZSBmb2N1cyB0byB0aGUgbmV4dCByb3cuXHJcbiAgICAgIC8vIGFsc28gdGhlIHNlbGVjdCBsaXN0IHdpbGwgc3RheSBzaG93biB3aGVuIGNsaWNraW5nIG9mZiB0aGUgZ3JpZFxyXG4gICAgICB0aGlzLmdyaWQuZ2V0RWRpdG9yTG9jaygpLmNvbW1pdEN1cnJlbnRFZGl0KCk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICB0aGlzLmFyZ3MuY29tbWl0Q2hhbmdlcygpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgc2VyaWFsaXplVmFsdWUoKSB7XHJcbiAgICByZXR1cm4gdGhpcy5fJHRleHRhcmVhLnZhbCgpO1xyXG4gIH1cclxuXHJcbiAgdmFsaWRhdGUoaW5wdXRWYWx1ZT86IGFueSk6IEVkaXRvclZhbGlkYXRvck91dHB1dCB7XHJcbiAgICBjb25zdCBlbG1WYWx1ZSA9IChpbnB1dFZhbHVlICE9PSB1bmRlZmluZWQpID8gaW5wdXRWYWx1ZSA6IHRoaXMuXyR0ZXh0YXJlYSAmJiB0aGlzLl8kdGV4dGFyZWEudmFsICYmIHRoaXMuXyR0ZXh0YXJlYS52YWwoKTtcclxuICAgIHJldHVybiB0ZXh0VmFsaWRhdG9yKGVsbVZhbHVlLCB7XHJcbiAgICAgIGVkaXRvckFyZ3M6IHRoaXMuYXJncyxcclxuICAgICAgZXJyb3JNZXNzYWdlOiB0aGlzLmNvbHVtbkVkaXRvci5lcnJvck1lc3NhZ2UsXHJcbiAgICAgIG1pbkxlbmd0aDogdGhpcy5jb2x1bW5FZGl0b3IubWluTGVuZ3RoLFxyXG4gICAgICBtYXhMZW5ndGg6IHRoaXMuY29sdW1uRWRpdG9yLm1heExlbmd0aCxcclxuICAgICAgb3BlcmF0b3JDb25kaXRpb25hbFR5cGU6IHRoaXMuY29sdW1uRWRpdG9yLm9wZXJhdG9yQ29uZGl0aW9uYWxUeXBlLFxyXG4gICAgICByZXF1aXJlZDogdGhpcy5jb2x1bW5FZGl0b3IucmVxdWlyZWQsXHJcbiAgICAgIHZhbGlkYXRvcjogdGhpcy52YWxpZGF0b3IsXHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIC8vIC0tXHJcbiAgLy8gcHJpdmF0ZSBmdW5jdGlvbnNcclxuICAvLyAtLS0tLS0tLS0tLS0tLS0tLS1cclxuXHJcbiAgcHJpdmF0ZSBoYW5kbGVLZXlEb3duKGV2ZW50OiBLZXlib2FyZEV2ZW50KSB7XHJcbiAgICBjb25zdCBrZXlDb2RlID0gZXZlbnQua2V5Q29kZSB8fCBldmVudC5jb2RlO1xyXG4gICAgaWYgKGtleUNvZGUgPT09IEtleUNvZGUuRU5URVIgJiYgZXZlbnQuY3RybEtleSkge1xyXG4gICAgICB0aGlzLnNhdmUoKTtcclxuICAgIH0gZWxzZSBpZiAoa2V5Q29kZSA9PT0gS2V5Q29kZS5FU0NBUEUpIHtcclxuICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcclxuICAgICAgdGhpcy5jYW5jZWwoKTtcclxuICAgIH0gZWxzZSBpZiAoa2V5Q29kZSA9PT0gS2V5Q29kZS5UQUIgJiYgZXZlbnQuc2hpZnRLZXkpIHtcclxuICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcclxuICAgICAgaWYgKHRoaXMuYXJncyAmJiB0aGlzLmdyaWQpIHtcclxuICAgICAgICB0aGlzLmdyaWQubmF2aWdhdGVQcmV2KCk7XHJcbiAgICAgIH1cclxuICAgIH0gZWxzZSBpZiAoa2V5Q29kZSA9PT0gS2V5Q29kZS5UQUIpIHtcclxuICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcclxuICAgICAgaWYgKHRoaXMuYXJncyAmJiB0aGlzLmdyaWQpIHtcclxuICAgICAgICB0aGlzLmdyaWQubmF2aWdhdGVOZXh0KCk7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8qKiBPbiBldmVyeSBpbnB1dCBjaGFuZ2UgZXZlbnQsIHdlJ2xsIHVwZGF0ZSB0aGUgY3VycmVudCB0ZXh0IGxlbmd0aCBjb3VudGVyICovXHJcbiAgcHJpdmF0ZSBoYW5kbGVPbklucHV0Q2hhbmdlKGV2ZW50OiBLZXlib2FyZEV2ZW50ICYgeyB0YXJnZXQ6IEhUTUxUZXh0QXJlYUVsZW1lbnQgfSkge1xyXG4gICAgY29uc3QgdGV4dExlbmd0aCA9IGV2ZW50LnRhcmdldC52YWx1ZS5sZW5ndGg7XHJcbiAgICB0aGlzLl8kY3VycmVudExlbmd0aEVsbS50ZXh0KHRleHRMZW5ndGgpO1xyXG4gIH1cclxufVxyXG4iXX0=