import { Pipe } from "@angular/core";
import * as ɵngcc0 from '@angular/core';
export class OrderPipe {
    /**
     * Check if a value is a string
     *
     * @param value
     */
    static isString(value) {
        return typeof value === "string" || value instanceof String;
    }
    /**
     * Sorts values ignoring the case
     *
     * @param a
     * @param b
     */
    static caseInsensitiveSort(a, b) {
        if (OrderPipe.isString(a) && OrderPipe.isString(b)) {
            return a.localeCompare(b);
        }
        return OrderPipe.defaultCompare(a, b);
    }
    /**
     * Default compare method
     *
     * @param a
     * @param b
     */
    static defaultCompare(a, b) {
        if (a && a instanceof Date) {
            a = a.getTime();
        }
        if (b && b instanceof Date) {
            b = b.getTime();
        }
        if (a === b) {
            return 0;
        }
        if (a == null) {
            return 1;
        }
        if (b == null) {
            return -1;
        }
        return a > b ? 1 : -1;
    }
    /**
     * Parse expression, split into items
     * @param expression
     * @returns {string[]}
     */
    static parseExpression(expression) {
        expression = expression.replace(/\[(\w+)\]/g, ".$1");
        expression = expression.replace(/^\./, "");
        return expression.split(".");
    }
    /**
     * Get value by expression
     *
     * @param object
     * @param expression
     * @returns {any}
     */
    static getValue(object, expression) {
        for (let i = 0, n = expression.length; i < n; ++i) {
            if (!object) {
                return;
            }
            const k = expression[i];
            if (!(k in object)) {
                return;
            }
            if (typeof object[k] === "function") {
                object = object[k]();
            }
            else {
                object = object[k];
            }
        }
        return object;
    }
    /**
     * Set value by expression
     *
     * @param object
     * @param value
     * @param expression
     */
    static setValue(object, value, expression) {
        let i;
        for (i = 0; i < expression.length - 1; i++) {
            object = object[expression[i]];
        }
        object[expression[i]] = value;
    }
    transform(value, expression, reverse, isCaseInsensitive = false, comparator) {
        if (!value) {
            return value;
        }
        if (Array.isArray(expression)) {
            return this.multiExpressionTransform(value, expression, reverse, isCaseInsensitive, comparator);
        }
        if (Array.isArray(value)) {
            return this.sortArray(value.slice(), expression, reverse, isCaseInsensitive, comparator);
        }
        if (typeof value === "object") {
            return this.transformObject(Object.assign({}, value), expression, reverse, isCaseInsensitive, comparator);
        }
        return value;
    }
    /**
     * Sort array
     *
     * @param value
     * @param expression
     * @param reverse
     * @param isCaseInsensitive
     * @param comparator
     * @returns {any[]}
     */
    sortArray(value, expression, reverse, isCaseInsensitive, comparator) {
        const isDeepLink = expression && expression.indexOf(".") !== -1;
        if (isDeepLink) {
            expression = OrderPipe.parseExpression(expression);
        }
        let compareFn;
        if (comparator && typeof comparator === "function") {
            compareFn = comparator;
        }
        else {
            compareFn = isCaseInsensitive
                ? OrderPipe.caseInsensitiveSort
                : OrderPipe.defaultCompare;
        }
        const array = value.sort((a, b) => {
            if (!expression) {
                return compareFn(a, b);
            }
            if (!isDeepLink) {
                if (a && b) {
                    return compareFn(a[expression], b[expression]);
                }
                return compareFn(a, b);
            }
            return compareFn(OrderPipe.getValue(a, expression), OrderPipe.getValue(b, expression));
        });
        if (reverse) {
            return array.reverse();
        }
        return array;
    }
    /**
     * Transform Object
     *
     * @param value
     * @param expression
     * @param reverse
     * @param isCaseInsensitive
     * @param comparator
     * @returns {any[]}
     */
    transformObject(value, expression, reverse, isCaseInsensitive, comparator) {
        const parsedExpression = OrderPipe.parseExpression(expression);
        let lastPredicate = parsedExpression.pop();
        let oldValue = OrderPipe.getValue(value, parsedExpression);
        if (!Array.isArray(oldValue)) {
            parsedExpression.push(lastPredicate);
            lastPredicate = null;
            oldValue = OrderPipe.getValue(value, parsedExpression);
        }
        if (!oldValue) {
            return value;
        }
        OrderPipe.setValue(value, this.transform(oldValue, lastPredicate, reverse, isCaseInsensitive), parsedExpression);
        return value;
    }
    /**
     * Apply multiple expressions
     *
     * @param value
     * @param {any[]} expressions
     * @param {boolean} reverse
     * @param {boolean} isCaseInsensitive
     * @param {Function} comparator
     * @returns {any}
     */
    multiExpressionTransform(value, expressions, reverse, isCaseInsensitive = false, comparator) {
        return expressions.reverse().reduce((result, expression) => {
            return this.transform(result, expression, reverse, isCaseInsensitive, comparator);
        }, value);
    }
}
OrderPipe.ɵfac = function OrderPipe_Factory(t) { return new (t || OrderPipe)(); };
OrderPipe.ɵpipe = ɵngcc0.ɵɵdefinePipe({ name: "orderBy", type: OrderPipe, pure: false });
/*@__PURE__*/ (function () { ɵngcc0.ɵsetClassMetadata(OrderPipe, [{
        type: Pipe,
        args: [{
                name: "orderBy",
                pure: false
            }]
    }], null, null); })();

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmd4LW9yZGVyLnBpcGUuanMiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uL3ZhZGltZGV6L0RvY3VtZW50cy9teV9kZXYvbmd4LW9yZGVyLXBpcGUvc3JjL2FwcC9vcmRlci1waXBlL25neC1vcmRlci5waXBlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxJQUFJLEVBQWlCLE1BQU0sZUFBZSxDQUFDOztBQU1wRCxNQUFNLE9BQU8sU0FBUztBQUFHLElBQ3ZCO0FBQ0Y7QUFDRTtBQUNFO0FBRUosT0FESztBQUNMLElBQUUsTUFBTSxDQUFDLFFBQVEsQ0FBQyxLQUFVO0FBQzVCLFFBQUksT0FBTyxPQUFPLEtBQUssS0FBSyxRQUFRLElBQUksS0FBSyxZQUFZLE1BQU0sQ0FBQztBQUNoRSxJQUFFLENBQUM7QUFDSCxJQUNFO0FBQ0Y7QUFDRTtBQUNFO0FBQ0U7QUFFSixPQURHO0FBQ0wsSUFBRSxNQUFNLENBQUMsbUJBQW1CLENBQUMsQ0FBTSxFQUFFLENBQU07QUFDM0MsUUFBSSxJQUFJLFNBQVMsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLElBQUksU0FBUyxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsRUFBRTtBQUN4RCxZQUFNLE9BQU8sQ0FBQyxDQUFDLGFBQWEsQ0FBQyxDQUFDLENBQUMsQ0FBQztBQUNoQyxTQUFLO0FBQ0wsUUFBSSxPQUFPLFNBQVMsQ0FBQyxjQUFjLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDO0FBQzFDLElBQUUsQ0FBQztBQUNILElBQ0U7QUFDRjtBQUNFO0FBQ0U7QUFDRTtBQUVKLE9BREc7QUFDTCxJQUFFLE1BQU0sQ0FBQyxjQUFjLENBQUMsQ0FBTSxFQUFFLENBQU07QUFDdEMsUUFBSSxJQUFJLENBQUMsSUFBSSxDQUFDLFlBQVksSUFBSSxFQUFFO0FBQ2hDLFlBQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxPQUFPLEVBQUUsQ0FBQztBQUN0QixTQUFLO0FBQ0ws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QixRQUNDLE9BQU8sV0FBVyxDQUFDLE9BQU8sRUFBRSxDQUFDLE1BQU0sQ0FBQyxDQUFDLE1BQVcsRUFBRSxVQUFlLEVBQUUsRUFBRTtBQUN6RSxZQUFNLE9BQU8sSUFBSSxDQUFDLFNBQVMsQ0FDbkIsTUFBTSxFQUNOLFVBQVUsRUFDVixPQUFPLEVBQ1AsaUJBQWlCLEVBQ2pCLFVBQVUsQ0FDWCxDQUFDO0FBQ1IsUUFBSSxDQUFDLEVBQUUsS0FBSyxDQUFDLENBQUM7QUFDZCxJQUFFLENBQUM7QUFDSDtxQ0FsUkMsSUFBSSxTQUFDLGtCQUNKLElBQUksRUFBRTtBQUFTLGtCQUNmLElBQUksRUFBRSxLQUFLLGVBQ1o7Ozs7Ozs7MEJBQ0k7QUFBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFBpcGUsIFBpcGVUcmFuc2Zvcm0gfSBmcm9tIFwiQGFuZ3VsYXIvY29yZVwiO1xuXG5AUGlwZSh7XG4gIG5hbWU6IFwib3JkZXJCeVwiLFxuICBwdXJlOiBmYWxzZSxcbn0pXG5leHBvcnQgY2xhc3MgT3JkZXJQaXBlIGltcGxlbWVudHMgUGlwZVRyYW5zZm9ybSB7XG4gIC8qKlxuICAgKiBDaGVjayBpZiBhIHZhbHVlIGlzIGEgc3RyaW5nXG4gICAqXG4gICAqIEBwYXJhbSB2YWx1ZVxuICAgKi9cbiAgc3RhdGljIGlzU3RyaW5nKHZhbHVlOiBhbnkpIHtcbiAgICByZXR1cm4gdHlwZW9mIHZhbHVlID09PSBcInN0cmluZ1wiIHx8IHZhbHVlIGluc3RhbmNlb2YgU3RyaW5nO1xuICB9XG5cbiAgLyoqXG4gICAqIFNvcnRzIHZhbHVlcyBpZ25vcmluZyB0aGUgY2FzZVxuICAgKlxuICAgKiBAcGFyYW0gYVxuICAgKiBAcGFyYW0gYlxuICAgKi9cbiAgc3RhdGljIGNhc2VJbnNlbnNpdGl2ZVNvcnQoYTogYW55LCBiOiBhbnkpIHtcbiAgICBpZiAoT3JkZXJQaXBlLmlzU3RyaW5nKGEpICYmIE9yZGVyUGlwZS5pc1N0cmluZyhiKSkge1xuICAgICAgcmV0dXJuIGEubG9jYWxlQ29tcGFyZShiKTtcbiAgICB9XG4gICAgcmV0dXJuIE9yZGVyUGlwZS5kZWZhdWx0Q29tcGFyZShhLCBiKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBEZWZhdWx0IGNvbXBhcmUgbWV0aG9kXG4gICAqXG4gICAqIEBwYXJhbSBhXG4gICAqIEBwYXJhbSBiXG4gICAqL1xuICBzdGF0aWMgZGVmYXVsdENvbXBhcmUoYTogYW55LCBiOiBhbnkpIHtcbiAgICBpZiAoYSAmJiBhIGluc3RhbmNlb2YgRGF0ZSkge1xuICAgICAgYSA9IGEuZ2V0VGltZSgpO1xuICAgIH1cbiAgICBpZiAoYiAmJiBiIGluc3RhbmNlb2YgRGF0ZSkge1xuICAgICAgYiA9IGIuZ2V0VGltZSgpO1xuICAgIH1cblxuICAgIGlmIChhID09PSBiKSB7XG4gICAgICByZXR1cm4gMDtcbiAgICB9XG4gICAgaWYgKGEgPT0gbnVsbCkge1xuICAgICAgcmV0dXJuIDE7XG4gICAgfVxuICAgIGlmIChiID09IG51bGwpIHtcbiAgICAgIHJldHVybiAtMTtcbiAgICB9XG4gICAgcmV0dXJuIGEgPiBiID8gMSA6IC0xO1xuICB9XG5cbiAgLyoqXG4gICAqIFBhcnNlIGV4cHJlc3Npb24sIHNwbGl0IGludG8gaXRlbXNcbiAgICogQHBhcmFtIGV4cHJlc3Npb25cbiAgICogQHJldHVybnMge3N0cmluZ1tdfVxuICAgKi9cbiAgc3RhdGljIHBhcnNlRXhwcmVzc2lvbihleHByZXNzaW9uOiBzdHJpbmcpOiBzdHJpbmdbXSB7XG4gICAgZXhwcmVzc2lvbiA9IGV4cHJlc3Npb24ucmVwbGFjZSgvXFxbKFxcdyspXFxdL2csIFwiLiQxXCIpO1xuICAgIGV4cHJlc3Npb24gPSBleHByZXNzaW9uLnJlcGxhY2UoL15cXC4vLCBcIlwiKTtcbiAgICByZXR1cm4gZXhwcmVzc2lvbi5zcGxpdChcIi5cIik7XG4gIH1cblxuICAvKipcbiAgICogR2V0IHZhbHVlIGJ5IGV4cHJlc3Npb25cbiAgICpcbiAgICogQHBhcmFtIG9iamVjdFxuICAgKiBAcGFyYW0gZXhwcmVzc2lvblxuICAgKiBAcmV0dXJucyB7YW55fVxuICAgKi9cbiAgc3RhdGljIGdldFZhbHVlKG9iamVjdDogYW55LCBleHByZXNzaW9uOiBzdHJpbmdbXSkge1xuICAgIGZvciAobGV0IGkgPSAwLCBuID0gZXhwcmVzc2lvbi5sZW5ndGg7IGkgPCBuOyArK2kpIHtcbiAgICAgIGlmICghb2JqZWN0KSB7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cbiAgICAgIGNvbnN0IGsgPSBleHByZXNzaW9uW2ldO1xuICAgICAgaWYgKCEoayBpbiBvYmplY3QpKSB7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cbiAgICAgIGlmICh0eXBlb2Ygb2JqZWN0W2tdID09PSBcImZ1bmN0aW9uXCIpIHtcbiAgICAgICAgb2JqZWN0ID0gb2JqZWN0W2tdKCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBvYmplY3QgPSBvYmplY3Rba107XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIG9iamVjdDtcbiAgfVxuXG4gIC8qKlxuICAgKiBTZXQgdmFsdWUgYnkgZXhwcmVzc2lvblxuICAgKlxuICAgKiBAcGFyYW0gb2JqZWN0XG4gICAqIEBwYXJhbSB2YWx1ZVxuICAgKiBAcGFyYW0gZXhwcmVzc2lvblxuICAgKi9cbiAgc3RhdGljIHNldFZhbHVlKG9iamVjdDogYW55LCB2YWx1ZTogYW55LCBleHByZXNzaW9uOiBzdHJpbmdbXSkge1xuICAgIGxldCBpO1xuICAgIGZvciAoaSA9IDA7IGkgPCBleHByZXNzaW9uLmxlbmd0aCAtIDE7IGkrKykge1xuICAgICAgb2JqZWN0ID0gb2JqZWN0W2V4cHJlc3Npb25baV1dO1xuICAgIH1cblxuICAgIG9iamVjdFtleHByZXNzaW9uW2ldXSA9IHZhbHVlO1xuICB9XG5cbiAgdHJhbnNmb3JtKFxuICAgIHZhbHVlOiBhbnkgfCBhbnlbXSxcbiAgICBleHByZXNzaW9uPzogYW55LFxuICAgIHJldmVyc2U/OiBib29sZWFuLFxuICAgIGlzQ2FzZUluc2Vuc2l0aXZlOiBib29sZWFuID0gZmFsc2UsXG4gICAgY29tcGFyYXRvcj86IEZ1bmN0aW9uXG4gICk6IGFueSB7XG4gICAgaWYgKCF2YWx1ZSkge1xuICAgICAgcmV0dXJuIHZhbHVlO1xuICAgIH1cblxuICAgIGlmIChBcnJheS5pc0FycmF5KGV4cHJlc3Npb24pKSB7XG4gICAgICByZXR1cm4gdGhpcy5tdWx0aUV4cHJlc3Npb25UcmFuc2Zvcm0oXG4gICAgICAgIHZhbHVlLFxuICAgICAgICBleHByZXNzaW9uLFxuICAgICAgICByZXZlcnNlLFxuICAgICAgICBpc0Nhc2VJbnNlbnNpdGl2ZSxcbiAgICAgICAgY29tcGFyYXRvclxuICAgICAgKTtcbiAgICB9XG5cbiAgICBpZiAoQXJyYXkuaXNBcnJheSh2YWx1ZSkpIHtcbiAgICAgIHJldHVybiB0aGlzLnNvcnRBcnJheShcbiAgICAgICAgdmFsdWUuc2xpY2UoKSxcbiAgICAgICAgZXhwcmVzc2lvbixcbiAgICAgICAgcmV2ZXJzZSxcbiAgICAgICAgaXNDYXNlSW5zZW5zaXRpdmUsXG4gICAgICAgIGNvbXBhcmF0b3JcbiAgICAgICk7XG4gICAgfVxuXG4gICAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gXCJvYmplY3RcIikge1xuICAgICAgcmV0dXJuIHRoaXMudHJhbnNmb3JtT2JqZWN0KFxuICAgICAgICBPYmplY3QuYXNzaWduKHt9LCB2YWx1ZSksXG4gICAgICAgIGV4cHJlc3Npb24sXG4gICAgICAgIHJldmVyc2UsXG4gICAgICAgIGlzQ2FzZUluc2Vuc2l0aXZlLFxuICAgICAgICBjb21wYXJhdG9yXG4gICAgICApO1xuICAgIH1cblxuICAgIHJldHVybiB2YWx1ZTtcbiAgfVxuXG4gIC8qKlxuICAgKiBTb3J0IGFycmF5XG4gICAqXG4gICAqIEBwYXJhbSB2YWx1ZVxuICAgKiBAcGFyYW0gZXhwcmVzc2lvblxuICAgKiBAcGFyYW0gcmV2ZXJzZVxuICAgKiBAcGFyYW0gaXNDYXNlSW5zZW5zaXRpdmVcbiAgICogQHBhcmFtIGNvbXBhcmF0b3JcbiAgICogQHJldHVybnMge2FueVtdfVxuICAgKi9cbiAgcHJpdmF0ZSBzb3J0QXJyYXkoXG4gICAgdmFsdWU6IGFueVtdLFxuICAgIGV4cHJlc3Npb24/OiBhbnksXG4gICAgcmV2ZXJzZT86IGJvb2xlYW4sXG4gICAgaXNDYXNlSW5zZW5zaXRpdmU/OiBib29sZWFuLFxuICAgIGNvbXBhcmF0b3I/OiBGdW5jdGlvblxuICApOiBhbnlbXSB7XG4gICAgY29uc3QgaXNEZWVwTGluayA9IGV4cHJlc3Npb24gJiYgZXhwcmVzc2lvbi5pbmRleE9mKFwiLlwiKSAhPT0gLTE7XG5cbiAgICBpZiAoaXNEZWVwTGluaykge1xuICAgICAgZXhwcmVzc2lvbiA9IE9yZGVyUGlwZS5wYXJzZUV4cHJlc3Npb24oZXhwcmVzc2lvbik7XG4gICAgfVxuXG4gICAgbGV0IGNvbXBhcmVGbjogRnVuY3Rpb247XG5cbiAgICBpZiAoY29tcGFyYXRvciAmJiB0eXBlb2YgY29tcGFyYXRvciA9PT0gXCJmdW5jdGlvblwiKSB7XG4gICAgICBjb21wYXJlRm4gPSBjb21wYXJhdG9yO1xuICAgIH0gZWxzZSB7XG4gICAgICBjb21wYXJlRm4gPSBpc0Nhc2VJbnNlbnNpdGl2ZVxuICAgICAgICA/IE9yZGVyUGlwZS5jYXNlSW5zZW5zaXRpdmVTb3J0XG4gICAgICAgIDogT3JkZXJQaXBlLmRlZmF1bHRDb21wYXJlO1xuICAgIH1cblxuICAgIGNvbnN0IGFycmF5OiBhbnlbXSA9IHZhbHVlLnNvcnQoKGE6IGFueSwgYjogYW55KTogbnVtYmVyID0+IHtcbiAgICAgIGlmICghZXhwcmVzc2lvbikge1xuICAgICAgICByZXR1cm4gY29tcGFyZUZuKGEsIGIpO1xuICAgICAgfVxuXG4gICAgICBpZiAoIWlzRGVlcExpbmspIHtcbiAgICAgICAgaWYgKGEgJiYgYikge1xuICAgICAgICAgIHJldHVybiBjb21wYXJlRm4oYVtleHByZXNzaW9uXSwgYltleHByZXNzaW9uXSk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGNvbXBhcmVGbihhLCBiKTtcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIGNvbXBhcmVGbihcbiAgICAgICAgT3JkZXJQaXBlLmdldFZhbHVlKGEsIGV4cHJlc3Npb24pLFxuICAgICAgICBPcmRlclBpcGUuZ2V0VmFsdWUoYiwgZXhwcmVzc2lvbilcbiAgICAgICk7XG4gICAgfSk7XG5cbiAgICBpZiAocmV2ZXJzZSkge1xuICAgICAgcmV0dXJuIGFycmF5LnJldmVyc2UoKTtcbiAgICB9XG5cbiAgICByZXR1cm4gYXJyYXk7XG4gIH1cblxuICAvKipcbiAgICogVHJhbnNmb3JtIE9iamVjdFxuICAgKlxuICAgKiBAcGFyYW0gdmFsdWVcbiAgICogQHBhcmFtIGV4cHJlc3Npb25cbiAgICogQHBhcmFtIHJldmVyc2VcbiAgICogQHBhcmFtIGlzQ2FzZUluc2Vuc2l0aXZlXG4gICAqIEBwYXJhbSBjb21wYXJhdG9yXG4gICAqIEByZXR1cm5zIHthbnlbXX1cbiAgICovXG4gIHByaXZhdGUgdHJhbnNmb3JtT2JqZWN0KFxuICAgIHZhbHVlOiBhbnkgfCBhbnlbXSxcbiAgICBleHByZXNzaW9uPzogYW55LFxuICAgIHJldmVyc2U/OiBib29sZWFuLFxuICAgIGlzQ2FzZUluc2Vuc2l0aXZlPzogYm9vbGVhbixcbiAgICBjb21wYXJhdG9yPzogRnVuY3Rpb25cbiAgKTogYW55IHtcbiAgICBjb25zdCBwYXJzZWRFeHByZXNzaW9uID0gT3JkZXJQaXBlLnBhcnNlRXhwcmVzc2lvbihleHByZXNzaW9uKTtcbiAgICBsZXQgbGFzdFByZWRpY2F0ZSA9IHBhcnNlZEV4cHJlc3Npb24ucG9wKCk7XG4gICAgbGV0IG9sZFZhbHVlID0gT3JkZXJQaXBlLmdldFZhbHVlKHZhbHVlLCBwYXJzZWRFeHByZXNzaW9uKTtcblxuICAgIGlmICghQXJyYXkuaXNBcnJheShvbGRWYWx1ZSkpIHtcbiAgICAgIHBhcnNlZEV4cHJlc3Npb24ucHVzaChsYXN0UHJlZGljYXRlKTtcbiAgICAgIGxhc3RQcmVkaWNhdGUgPSBudWxsO1xuICAgICAgb2xkVmFsdWUgPSBPcmRlclBpcGUuZ2V0VmFsdWUodmFsdWUsIHBhcnNlZEV4cHJlc3Npb24pO1xuICAgIH1cblxuICAgIGlmICghb2xkVmFsdWUpIHtcbiAgICAgIHJldHVybiB2YWx1ZTtcbiAgICB9XG5cbiAgICBPcmRlclBpcGUuc2V0VmFsdWUoXG4gICAgICB2YWx1ZSxcbiAgICAgIHRoaXMudHJhbnNmb3JtKG9sZFZhbHVlLCBsYXN0UHJlZGljYXRlLCByZXZlcnNlLCBpc0Nhc2VJbnNlbnNpdGl2ZSksXG4gICAgICBwYXJzZWRFeHByZXNzaW9uXG4gICAgKTtcbiAgICByZXR1cm4gdmFsdWU7XG4gIH1cblxuICAvKipcbiAgICogQXBwbHkgbXVsdGlwbGUgZXhwcmVzc2lvbnNcbiAgICpcbiAgICogQHBhcmFtIHZhbHVlXG4gICAqIEBwYXJhbSB7YW55W119IGV4cHJlc3Npb25zXG4gICAqIEBwYXJhbSB7Ym9vbGVhbn0gcmV2ZXJzZVxuICAgKiBAcGFyYW0ge2Jvb2xlYW59IGlzQ2FzZUluc2Vuc2l0aXZlXG4gICAqIEBwYXJhbSB7RnVuY3Rpb259IGNvbXBhcmF0b3JcbiAgICogQHJldHVybnMge2FueX1cbiAgICovXG4gIHByaXZhdGUgbXVsdGlFeHByZXNzaW9uVHJhbnNmb3JtKFxuICAgIHZhbHVlOiBhbnksXG4gICAgZXhwcmVzc2lvbnM6IGFueVtdLFxuICAgIHJldmVyc2U6IGJvb2xlYW4sXG4gICAgaXNDYXNlSW5zZW5zaXRpdmU6IGJvb2xlYW4gPSBmYWxzZSxcbiAgICBjb21wYXJhdG9yPzogRnVuY3Rpb25cbiAgKTogYW55IHtcbiAgICByZXR1cm4gZXhwcmVzc2lvbnMucmV2ZXJzZSgpLnJlZHVjZSgocmVzdWx0OiBhbnksIGV4cHJlc3Npb246IGFueSkgPT4ge1xuICAgICAgcmV0dXJuIHRoaXMudHJhbnNmb3JtKFxuICAgICAgICByZXN1bHQsXG4gICAgICAgIGV4cHJlc3Npb24sXG4gICAgICAgIHJldmVyc2UsXG4gICAgICAgIGlzQ2FzZUluc2Vuc2l0aXZlLFxuICAgICAgICBjb21wYXJhdG9yXG4gICAgICApO1xuICAgIH0sIHZhbHVlKTtcbiAgfVxufVxuIl19